!function(){class e{constructor(){this.cacheKey="solarTool_continueCache",this.cacheTimeout=864e5,this.debounceTimeout=null,this.debounceDelay=500}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return console.warn("localStorage nicht verf√ºgbar:",e),!1}}saveData(e){this.isLocalStorageAvailable()?(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{try{const t={...e,timestamp:Date.now(),version:"1.0"};localStorage.setItem(this.cacheKey,JSON.stringify(t)),console.log("Cache gespeichert:",(new Date).toLocaleString())}catch(e){console.error("Fehler beim Speichern des Caches:",e)}},this.debounceDelay)):console.warn("localStorage nicht verf√ºgbar - Cache wird nicht gespeichert")}loadData(){if(!this.isLocalStorageAvailable())return console.warn("localStorage nicht verf√ºgbar - Cache wird nicht geladen"),null;try{const e=localStorage.getItem(this.cacheKey);if(!e)return console.log("Kein Cache gefunden"),null;const t=JSON.parse(e);return Date.now()-t.timestamp>this.cacheTimeout?(console.log("Cache ist abgelaufen (24h) - wird gel√∂scht"),this.clearCache(),null):(console.log("Cache geladen:",(new Date).toLocaleString()),t)}catch(e){return console.error("Fehler beim Laden des Caches:",e),this.clearCache(),null}}clearCache(){try{localStorage.removeItem(this.cacheKey),console.log("Cache gel√∂scht")}catch(e){console.error("Fehler beim L√∂schen des Caches:",e)}}isCacheValid(){return null!==this.loadData()}}const t={Endklemmen:20,Schrauben:50,Dachhaken:20,Mittelklemmen:20,Endkappen:50,Schienenverbinder:10,Schiene_240_cm:1,Schiene_360_cm:1,Solarmodul:1,UlicaSolarBlackJadeFlow:1,SolarmodulPalette:36,UlicaSolarBlackJadeFlowPalette:36,MC4_Stecker:50,Solarkabel:1,Holzunterleger:50,Ringkabelschuhe:100,BlechBohrschrauben:100,Kabelbinder:100,Erdungsband:1,Tellerkopfschraube:100,HuaweiOpti:1,BRCOpti:1},i={Solarmodul:59.7,UlicaSolarBlackJadeFlow:67.9,SolarmodulPalette:2012.4,UlicaSolarBlackJadeFlowPalette:2264.4,Endklemmen:19.8,Schrauben:11,Dachhaken:69,Mittelklemmen:19.8,Endkappen:7,Schienenverbinder:13,Schiene_240_cm:11.99,Schiene_360_cm:17.49,MC4_Stecker:39.5,Solarkabel:86.9,Holzunterleger:17.5,Ringkabelschuhe:21.4,BlechBohrschrauben:24.7,Kabelbinder:3.41,Erdungsband:8.7,Tellerkopfschraube:26,HuaweiOpti:39.68,BRCOpti:38.53};function n(e,t){const n=function(e){return i[e]||0}(e)||0;return Number.isFinite(n)?n:0}const s={Solarmodul:"Ulica Solar Black Jade-Flow 450 W",UlicaSolarBlackJadeFlow:"Ulica Solar Black Jade-Flow 500 W",SolarmodulPalette:"36x Ulica Solar Black Jade-Flow 450 W - Palette",UlicaSolarBlackJadeFlowPalette:"36x Ulica Solar Black Jade-Flow 500 W  - Palette",Endklemmen:"Endklemmen - 20 St√ºck",Mittelklemmen:"Mittelklemmen - 20 St√ºck",Endkappen:"Endkappen - 50 St√ºck",Dachhaken:"Dachhaken 3-fach verstellbar - 20 St√ºck",Schienenverbinder:"Schienenverbinder - 10 St√ºck",Schiene_360_cm:"Schiene 360 cm",Schiene_240_cm:"Schiene 240cm",MC4_Stecker:"MC4 Stecker - 50 Steckerpaare",Schrauben:"Schraube M10x25 - 50 St√ºck inkl. Muttern",Tellerkopfschraube:"Tellerkopfschraube 8x100 - 100 St√ºck",Ringkabelschuhe:"Ringkabelschuhe - 100 St√ºck",BlechBohrschrauben:"Blech-Bohrschrauben mit EPDM Dichtung - 100 St√ºck",Kabelbinder:"Kabelbinder - 100 St√ºck",Erdungsband:"Erdungsband - 6M",Solarkabel:"Solarkabel 100M",Holzunterleger:"Unterlegholz f√ºr Dachhacken - 50 St√ºck",HuaweiOpti:"Huawei Smart PV Optimierer 600W",BRCOpti:"BRC M600M Optimierer"},o={Solarmodul:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",UlicaSolarBlackJadeFlow:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",SolarmodulPalette:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",UlicaSolarBlackJadeFlowPalette:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Endklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c316b21cb7d04ba2ed22_DSC04815-min.jpg",Schrauben:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg",Dachhaken:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c1c8a2835b7879f46811_DSC04760-min.jpg",Mittelklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c0d0c2d922d926976bd4_DSC04810-min.jpg",Endkappen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bdfbe7cffc653f6a4605_DSC04788-min.jpg",Schienenverbinder:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c21f0c39e927fce0db3b_DSC04780-min.jpg",Schiene_240_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bce018164af4b4a187f1_DSC04825-min.jpg",Schiene_360_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bcd5726d1d33d4b86ba4_DSC04824-min.jpg",MC4_Stecker:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fcdab153f840ea15b5e7b_iStock-2186771695.jpg",Solarkabel:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fd566bdbb6de2e5f362f0_DSC04851.jpg",Holzunterleger:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Ringkabelschuhe:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6887614c64676f0b0c8d5037_Kabelschuh%20Platzhalter.jpg",BlechBohrschrauben:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/68f81013b62d8044fc41024d_blechschraube.jpg",Kabelbinder:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/68f80b1a4a90df59dba640e9_1_9.png",Erdungsband:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Tellerkopfschraube:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg"};const l=new class{constructor(){this.worker=null,this.pendingCalculations=new Map,this.calculationId=0,this.isWorkerReady=!1,this.initWorker()}initWorker(){try{this.worker=new Worker("./calculation-worker.js"),this.worker.onmessage=e=>{const{type:t,id:i,data:n,error:s}=e.data;if("ready"!==t){if("result"===t&&this.pendingCalculations.has(i)){const{resolve:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(n)}if("error"===t&&this.pendingCalculations.has(i)){const{reject:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(new Error(s.message))}"debug"===t&&console.log(...n)}else this.isWorkerReady=!0},this.worker.onerror=e=>{this.isWorkerReady=!1}}catch(e){this.isWorkerReady=!1}}cleanup(){try{this.worker&&(this.worker.terminate(),this.worker=null),this.isWorkerReady=!1,this.pendingCalculations.clear()}catch(e){console.warn("[CalculationManager] Cleanup error:",e)}}async calculate(e,t){return this.isWorkerReady&&this.worker?new Promise((i,n)=>{const s=++this.calculationId;this.pendingCalculations.set(s,{resolve:i,reject:n}),setTimeout(()=>{this.pendingCalculations.has(s)&&(this.pendingCalculations.delete(s),n(new Error("Calculation timeout")))},1e4),this.worker.postMessage({type:e,data:t,id:s})}):this.calculateSync(e,t)}calculateSync(e,t){switch(e){case"calculateParts":return this.calculatePartsSync(t);case"calculateExtendedParts":return this.calculateExtendedPartsSync(t);default:throw new Error(`Unsupported sync calculation: ${e}`)}}calculatePartsSync(e){try{const{selection:t,rows:i,cols:n,cellWidth:s,cellHeight:o,orientation:l,options:a={}}=e,r={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let c=0;c<n;c++)t[e]?.[c]?i++:i&&(this.processGroupSync(i,r,s,o,l,a),i=0);i&&this.processGroupSync(i,r,s,o,l,a)}return r}catch(e){return console.error("calculatePartsSync error:",e),{Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0}}}processGroupSync(e,t,i,n,s,o={}){const l=e*("vertical"===s?n:i),a=Math.floor(l/360),r=l-360*a,c=[{cnt360:a,cnt240:Math.ceil(r/240)},{cnt360:Math.ceil(l/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(l/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-l})),h=Math.min(...c.map(e=>e.rails)),d=c.filter(e=>e.rails===h).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:u,cnt240:m}=d;t.Schiene_360_cm+=2*u,t.Schiene_240_cm+=2*m,t.Schienenverbinder+=4*(u+m-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,!0===o.ulicaModule&&(t.UlicaSolarBlackJadeFlow+=e),t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}calculateExtendedPartsSync(e){let i=this.calculatePartsSync(e);const{options:n}=e;if(n.includeModules||delete i.Solarmodul,!0!==n.ulicaModule&&delete i.UlicaSolarBlackJadeFlow,n.mc4Connectors){const n=e.selection.flat().filter(e=>e).length,s=t.MC4_Stecker||50,o=Math.ceil(n/30);i.MC4_Stecker=o*s}return n.solarkabel&&(i.Solarkabel=1),n.woodUnderlay&&(i.Holzunterleger=1),n.erdungsband,i}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingCalculations.clear(),this.isWorkerReady=!1}};class a{constructor(e){this.solarGrid=e,this.jsPDF=window.jspdf?.jsPDF,this.html2canvas=window.html2canvas,this.companyLogoUrl="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/688f3fff157b70cefcaa97df_Schneider%20logo.png",this.headerLogoBlueUrl="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6893249274128869974e58ec_schneider%20logo%20png.png"}isTouchDevice(){try{const e=navigator.userAgent||"",t=/iPad|iPhone|iPod|Android|Mobile/i.test(e),i="ontouchstart"in window||navigator.maxTouchPoints>0;return t||i}catch(e){return!1}}isAvailable(){return!(!this.jsPDF||!this.html2canvas)}async generatePDFFromSnapshot(e){if(!this.jsPDF||!this.html2canvas)return console.error("jsPDF/html2canvas nicht verf√ºgbar"),void this.solarGrid.showToast("PDF-Generierung nicht verf√ºgbar",3e3);if(e?.configs?.length)try{await this.renderSnapshotIntoPdfTemplate(e);const t=document.getElementById("pdf-root");if(!t)throw new Error("#pdf-root nicht gefunden");const i=t.getAttribute("style")||"";t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.opacity="0.01",t.style.pointerEvents="none",t.style.zIndex="9999",t.style.background="#ffffff",await function(e){const t=Array.from(e.querySelectorAll("img"));return 0===t.length?Promise.resolve():Promise.all(t.map(e=>new Promise(t=>{if(e.complete&&e.naturalWidth>0)return t();const i=()=>t();e.addEventListener("load",i,{once:!0}),e.addEventListener("error",i,{once:!0})})))}(t),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,30));const n=Array.from(t.querySelectorAll(".pdf-page"));if(0===n.length)throw new Error("Keine .pdf-page Elemente");console.log("[PDF] capturing pages:",n.length);const s=new this.jsPDF({unit:"px",format:[794,1123],orientation:"portrait"});for(let e=0;e<n.length;e++){const t=n[e];t.style.width="794px",t.style.height="1123px",t.style.boxSizing="border-box";const i=await this.html2canvas(t,{scale:2,backgroundColor:"#ffffff",useCORS:!0,allowTaint:!0,logging:!0});console.log("[PDF] canvas created",{w:i.width,h:i.height});const o=i.toDataURL("image/jpeg",.98);e>0&&s.addPage(),s.addImage(o,"JPEG",0,0,794,1123)}const o=this.generateFileName(e.configs);if(this.isTouchDevice())try{const e=s.output("blob"),t=URL.createObjectURL(e);window.open(t,"_blank"),setTimeout(()=>{try{URL.revokeObjectURL(t)}catch(e){}},15e3)}catch(e){s.save(o)}else s.save(o);t.setAttribute("style",i)}catch(e){console.error("PDF-Erstellung fehlgeschlagen:",e),this.solarGrid.showToast("PDF-Erstellung fehlgeschlagen",3e3)}else this.solarGrid.showToast("Keine Konfiguration zum Exportieren",3e3)}async renderSnapshotIntoPdfTemplate(e){const t=document.getElementById("pdf-root");if(!t)return;t.innerHTML="";const i=(new Date).toLocaleDateString("de-DE");for(let n=0;n<e.configs.length;n++){const s=e.configs[n],o=document.createElement("div");o.className="pdf-page",o.style.width="794px",o.style.minHeight="1123px",o.style.padding="48px 48px 64px 48px",o.style.boxSizing="border-box",o.style.position="relative",o.innerHTML=`\n            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10mm;">\n              <div>\n                <div style="font-size:18pt; font-weight:700; color:#0e1e34;">${s.name||"Konfiguration"}</div>\n                <div style="font-size:10pt; color:#677; margin-top:2mm;">${i}</div>\n              </div>\n              <div style="display:flex; align-items:center; gap:8px; color:#0e1e34; font-size:10pt;"><img src="${this.headerLogoBlueUrl}" alt="Logo" style="height:12mm; width:auto;"/></div>\n            </header>\n            <section style="border:1px solid #e5e7eb; border-radius:8px; padding:6mm; margin-bottom:8mm;">\n              <div style="font-size:12pt; font-weight:700; color:#0e1e34;">Projekt</div>\n              <div style="font-size:10pt; color:#111; margin-top:2mm; display:flex; justify-content:space-between; gap:6mm;">\n                <div><span style="font-weight:700;">Projekttitel:</span> ${s.name||"Unbenannt"}</div>\n                <div><span style="font-weight:700;">Datum:</span> ${i}</div>\n              </div>\n              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:4mm;">\n                <div>\n                  <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                    <div style="width:28mm; color:#0e1e34;">Name:</div>\n                    <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                  </div>\n                  <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                    <div style="width:28mm; color:#0e1e34;">Firma:</div>\n                    <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                  </div>\n                  <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                    <div style="width:28mm; color:#0e1e34;">Adresse:</div>\n                    <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                  </div>\n                  <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                    <div style="width:28mm; color:#0e1e34;">Telefon:</div>\n                    <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                  </div>\n                  <div style="display:flex; align-items:flex-end; gap:4mm;">\n                    <div style="width:28mm; color:#0e1e34;">E-Mail:</div>\n                    <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                  </div>\n                </div>\n                <div>\n                  <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                    <div style="flex:0 0 auto; font-weight:700; color:#0e1e34;">Weitere Informationen:</div>\n                    <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                  </div>\n                  <div style="height:6mm; border-bottom:1px solid #e5e7eb; margin-bottom:3mm;"></div>\n                  <div style="height:6mm; border-bottom:1px solid #e5e7eb; margin-bottom:3mm;"></div>\n                  <div style="height:6mm; border-bottom:1px solid #e5e7eb; margin-bottom:3mm;"></div>\n                  <div style="height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n              </div>\n            </section>\n            <section style="margin-bottom:8mm;">\n              <div style="font-size:11pt; font-weight:700; color:#0e1e34; margin-bottom:4mm;">Grid-√úbersicht</div>\n              <div style="font-size:10pt; color:#111; margin-bottom:4mm;">\n                Grid: ${s.cols} √ó ${s.rows} Module (${s.selectedCells} ausgew√§hlt) ¬∑ Orientierung: ${"vertical"===s.orientation?"Vertikal":"Horizontal"}\n              </div>\n              <img class="pdf-grid-image" alt="Grid" style="width:100%; max-width:100%; border-radius:6px; border:1px solid #e5e7eb; box-shadow:0 2px 8px rgba(0,0,0,0.06);" />\n            </section>\n          `;try{const e=await this.captureGridVisualizationFromSnapshot(s);e&&(o.querySelector(".pdf-grid-image").src=e)}catch{}const l=document.createElement("div");l.className="pdf-page",l.style.width="794px",l.style.minHeight="1123px",l.style.padding="48px 48px 64px 48px",l.style.boxSizing="border-box",l.style.position="relative",l.innerHTML=`\n            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10mm;">\n              <div>\n                <div style="font-size:18pt; font-weight:700; color:#0e1e34;">${s.name||"Konfiguration"}</div>\n                <div style="font-size:10pt; color:#677; margin-top:2mm;">${i}</div>\n              </div>\n              <div style="display:flex; align-items:center; gap:8px; color:#0e1e34; font-size:10pt;"><img src="${this.headerLogoBlueUrl}" alt="Logo" style="height:12mm; width:auto;"/></div>\n            </header>\n            <div style="background:#FFB101; color:#000; border-radius:8px; padding:6mm; font-weight:700; margin-bottom:6mm;">PRODUKT-LISTE</div>\n            <table style="width:100%; border-collapse:collapse; font-size:10pt;">\n              <thead>\n                <tr style="background:#0e1e34; color:#fff;">\n                  <th style="text-align:left; padding:3mm 4mm; border-top-left-radius:6px; width:20mm;">Anzahl</th>\n                  <th style="text-align:left; padding:3mm 4mm;">Produkt</th>\n                  <th style="text-align:right; padding:3mm 4mm; width:35mm;">Ben√∂tigte Menge</th>\n                  <th style="text-align:right; padding:3mm 4mm; border-top-right-radius:6px; width:30mm;">Preis</th>\n                </tr>\n              </thead>\n              <tbody class="pdf-table-body"></tbody>\n            </table>\n            <div class="pdf-total" style="margin-top:8mm; background:#0e1e34; color:#fff; border-radius:8px; padding:6mm; display:grid; grid-template-columns: 1fr auto; align-items:start; column-gap:6mm;">\n              <div style="font-weight:700; line-height:1; margin:0;">GESAMTPREIS</div>\n              <div class="pdf-total-price" style="font-size:14pt; font-weight:700; line-height:1; margin:0;"></div>\n            </div>\n          `;const a=l.querySelector(".pdf-total-price");await this.renderProductsIntoTable(s,l.querySelector(".pdf-table-body"),a,{htmlLayout:!0,excludeAdditionalProducts:!0});const r=l.querySelector(".pdf-table-body");r&&!r.innerHTML.trim()&&(r.innerHTML='<tr><td style="padding:3mm 4mm;" colspan="4">Keine Produkte ausgew√§hlt</td></tr>');let c=null;try{const e=document.getElementById("pdf-root");e&&!l.parentNode&&e.appendChild(l);const t=e=>{const t=e&&e.getBoundingClientRect&&e.getBoundingClientRect().height||1123,i=e.querySelector(".pdf-total");let n=0;try{if(i){const e=i.style.display;"none"===e&&(i.style.display="");const t=i.getBoundingClientRect();n=Math.ceil(t.height)+8,i.style.display=e}}catch(e){n=80}const s=e.querySelector(".pdf-table-body"),o=e.querySelector("thead");e.querySelector(".pdf-total");if(!s||!o)return[e];const l=Array.from(s.querySelectorAll("tr"));if(0===l.length)return[e];const a=()=>{const t=e.cloneNode(!0),i=t.querySelector(".pdf-table-body");i&&(i.innerHTML="");const n=t.querySelector(".pdf-total");return n&&(n.style.display="none"),t},r=a();e.parentNode&&e.parentNode.replaceChild(r,e);const c=[r];let h=0;for(;h<l.length;){const e=c[c.length-1],i=e.querySelector(".pdf-table-body"),s=e.getBoundingClientRect(),o=(i.getBoundingClientRect().top,s.top,t-120-n);for(;h<l.length;){const e=l[h].cloneNode(!0);i.appendChild(e);if(e.getBoundingClientRect().bottom-s.top>o){i.removeChild(e);break}h++}if(h<l.length){const e=a();r.parentNode&&r.parentNode.appendChild(e),c.push(e)}}return c.forEach((e,t)=>{const i=e.querySelector(".pdf-total");i&&(i.style.display=t===c.length-1?"":"none")}),c};c=t(l),c&&c.length&&(l=c[0])}catch(e){console.warn("PDF-Paginierung fehlgeschlagen (fallback auf Einzel-Seite):",e)}const h=()=>{const e=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.height="18mm",e.style.background="#0e1e34",e.style.color="#fff",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="space-between",e.style.padding="0 16mm",e.style.boxSizing="border-box",e.style.fontSize="8pt";const t=document.createElement("div");t.textContent="Schneider Unterkonstruktion - Solar Konfigurator";const i=document.createElement("img");return i.src=this.companyLogoUrl,i.alt="Logo",i.style.height="12mm",i.style.width="auto",e.appendChild(t),e.appendChild(i),e};o.appendChild(h());const d=c&&c.length?c:[l];d.forEach(e=>{Array.from(e.children).some(e=>e.style&&"absolute"===e.style.position&&"0px"===e.style.bottom)||e.appendChild(h()),e.parentNode===t&&t.removeChild(e)}),t.appendChild(o),d.forEach(e=>t.appendChild(e))}try{const i=this.computeAdditionalProductsForSnapshot(e);if(Object.keys(i).filter(e=>i[e]>0).length>0){const i=(new Date).toLocaleDateString("de-DE"),n=document.createElement("div");n.className="pdf-page",n.style.width="794px",n.style.minHeight="1123px",n.style.padding="48px 48px 64px 48px",n.style.boxSizing="border-box",n.style.position="relative",n.innerHTML=`\n              <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10mm;">\n                <div>\n                  <div style="font-size:18pt; font-weight:700; color:#0e1e34;">F√ºr alle Konfigurationen</div>\n                  <div style="font-size:10pt; color:#677; margin-top:2mm;">${i}</div>\n                </div>\n                <div style="display:flex; align-items:center; gap:8px; color:#0e1e34; font-size:10pt;"><img src="${this.headerLogoBlueUrl}" alt="Logo" style="height:12mm; width:auto;"/></div>\n              </header>\n              <div style="background:#FFB101; color:#000; border-radius:8px; padding:6mm; font-weight:700; margin-bottom:6mm;">ZUSATZPRODUKTE</div>\n              <table style="width:100%; border-collapse:collapse; font-size:10pt;">\n                <thead>\n                  <tr style="background:#0e1e34; color:#fff;">\n                    <th style="text-align:left; padding:3mm 4mm; border-top-left-radius:6px; width:20mm;">Anzahl</th>\n                    <th style="text-align:left; padding:3mm 4mm;">Produkt</th>\n                    <th style="text-align:right; padding:3mm 4mm; width:35mm;">Ben√∂tigte Menge</th>\n                    <th style="text-align:right; padding:3mm 4mm; border-top-right-radius:6px; width:30mm;">Preis</th>\n                  </tr>\n                </thead>\n                <tbody class="pdf-additional-table-body"></tbody>\n              </table>\n              <div class="pdf-total" style="margin-top:8mm; background:#0e1e34; color:#fff; border-radius:8px; padding:6mm; display:grid; grid-template-columns: 1fr auto; align-items:start; column-gap:6mm; position:relative;">\n                <div style="font-weight:700; line-height:1; margin:0;">GESAMTPREIS</div>\n                <div class="pdf-additional-total-price" style="font-size:14pt; font-weight:700; line-height:1; margin:0;"></div>\n              </div>\n            `;const s=n.querySelector(".pdf-additional-total-price");await this.renderAdditionalProductsIntoTable(e,n.querySelector(".pdf-additional-table-body"),s);const o=document.createElement("div");o.style.position="absolute",o.style.left="0",o.style.right="0",o.style.bottom="0",o.style.height="18mm",o.style.background="#0e1e34",o.style.color="#fff",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.padding="0 16mm",o.style.boxSizing="border-box",o.style.fontSize="8pt";const l=document.createElement("div");l.textContent="Schneider Unterkonstruktion - Solar Konfigurator";const a=document.createElement("img");a.src=this.companyLogoUrl,a.alt="Logo",a.style.height="12mm",a.style.width="auto",o.appendChild(l),o.appendChild(a),n.appendChild(o),t.appendChild(n)}}catch(e){console.warn("Zusatzprodukte-Seite konnte nicht erzeugt werden:",e)}}async renderProductsIntoTable(e,i,o,l={}){const a={...await this.calculatePartsFromSnapshot(e)};try{const t=!0===e.ulicaModule,i=t?"UlicaSolarBlackJadeFlow":"Solarmodul",n=t?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",s=Number(a[i]||0);if(s>0){const e=Math.floor(s/36),t=s%36;e>0&&(a[n]=(a[n]||0)+36*e),a[i]=t}}catch(e){}let r=0;const c=[],h=new Set(["MC4_Stecker","Solarkabel","Holzunterleger","Ringkabelschuhe","Kabelbinder","BlechBohrschrauben"]);for(const[e,i]of Object.entries(a||{})){if(i<=0)continue;if(l.excludeAdditionalProducts&&h.has(e))continue;const s=t[e]||1,o=Math.ceil(i/s),a=o*n(e);r+=a,c.push({key:e,value:i,ve:s,packs:o,rowPrice:a})}c.sort((e,t)=>e.key.localeCompare(t.key)),l.htmlLayout?i.innerHTML=c.map(e=>{const t=s[e.key]||e.key.replace(/_/g," ");return`\n              <tr style="border-bottom:1px solid #eee;">\n                <td style="padding:3mm 4mm; width:20mm; font-weight:700;">${e.packs}x</td>\n                <td style="padding:3mm 4mm;">\n                  <div style="font-weight:700; font-size:11pt;">${t}</div>\n                  <div style="color:#888; font-size:9pt;">${e.ve} St√ºck</div>\n                </td>\n                <td style="padding:3mm 4mm; text-align:right; width:35mm;">${e.value}</td>\n                <td style="padding:3mm 4mm; text-align:right; width:30mm;">${e.rowPrice.toFixed(2)} ‚Ç¨</td>\n              </tr>\n            `}).join(""):i.innerHTML=c.map(e=>`\n            <tr style="border-bottom:1px solid #eee;">\n              <td style="padding:3mm 4mm;">${e.key}</td>\n              <td style="padding:3mm 4mm; text-align:right;">${e.value}</td>\n              <td style="padding:3mm 4mm; text-align:right;">${e.ve}</td>\n              <td style="padding:3mm 4mm; text-align:right;">${e.rowPrice.toFixed(2)} ‚Ç¨</td>\n            </tr>\n          `).join(""),o&&(o.textContent=`${r.toFixed(2)} ‚Ç¨`)}computeAdditionalProductsForSnapshot(e){try{const t=Array.isArray(e?.configs)?e.configs:[],i=t.some(e=>!0===e.mc4),n=t.some(e=>!0===e.cable||!0===e.solarkabel),s=t.some(e=>!0===e.wood||!0===e.holz),o=t.some(e=>!0===e.quetschkabelschuhe),l=t.reduce((e,t)=>"number"==typeof t.selectedCells?e+t.selectedCells:Array.isArray(t.selection)?e+t.selection.flat().filter(Boolean).length:e,0),a={};i&&(a.MC4_Stecker=Math.max(1,Math.ceil((l||0)/30))),n&&(a.Solarkabel=1),s&&(a.Holzunterleger=1),o&&(a.Ringkabelschuhe=1);try{const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty");if(i){const n=Math.max(1,parseInt(i.value||"1",10));e&&e.checked&&(a.HuaweiOpti=(a.HuaweiOpti||0)+n),t&&t.checked&&(a.BRCOpti=(a.BRCOpti||0)+n)}}catch(e){}return a}catch(e){return console.warn("computeAdditionalProductsForSnapshot failed:",e),{}}}async renderAdditionalProductsIntoTable(e,i,o){const l=this.computeAdditionalProductsForSnapshot(e);let a=0;const r=Object.entries(l).map(([e,i])=>{const s=t[e]||1,o=Math.ceil(i/s),l=o*n(e);return a+=l,{key:e,value:i,ve:s,packs:o,rowPrice:l}});r.sort((e,t)=>e.key.localeCompare(t.key)),i.innerHTML=r.map(e=>{const t=s[e.key]||e.key.replace(/_/g," ");return`\n            <tr style="border-bottom:1px solid #eee;">\n              <td style="padding:3mm 4mm; width:20mm; font-weight:700;">${e.packs}x</td>\n              <td style="padding:3mm 4mm;">\n                <div style="font-weight:700; font-size:11pt;">${t}</div>\n                <div style="color:#888; font-size:9pt;">${e.ve} St√ºck</div>\n              </td>\n              <td style="padding:3mm 4mm; text-align:right; width:35mm;">${e.value}</td>\n              <td style="padding:3mm 4mm; text-align:right; width:30mm;">${e.rowPrice.toFixed(2)} ‚Ç¨</td>\n            </tr>\n          `}).join(""),o&&(o.textContent=`${a.toFixed(2)} ‚Ç¨`)}async generatePDF(e="current"){if(!this.isAvailable())return console.warn("PDF Libraries nicht verf√ºgbar"),void this.solarGrid?.showToast?.("PDF-Generierung nicht verf√ºgbar",3e3);try{const t=this.solarGrid?.createConfigSnapshot?this.solarGrid.createConfigSnapshot():null;if(!t||!Array.isArray(t.configs)||0===t.configs.length)return void this.solarGrid?.showToast?.("Keine Konfiguration zum Exportieren",3e3);let i=t;if("current"===e){const e="number"==typeof t.currentConfigIndex?t.currentConfigIndex:0,n=t.configs[e]||t.configs[0];i={timestamp:t.timestamp,totalConfigs:1,currentConfigIndex:0,configs:[n]}}await this.generatePDFFromSnapshot(i)}catch(e){console.error("generatePDF wrapper failed:",e),this.solarGrid?.showToast?.("PDF-Erstellung fehlgeschlagen",3e3)}}addHeader(e,t,i){return e.setTextColor(14,30,52),e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Ihre Konfiguration",20,20),e.setFontSize(10),e.setFont("helvetica","normal"),e.text((new Date).toLocaleDateString("de-DE"),t-40,20),e.setTextColor(0,0,0),28}async getInvertedLogoBase64(e){return this._invertedLogoBase64Promise||(this._invertedLogoBase64Promise=new Promise((t,i)=>{try{const n=new Image;n.onload=()=>{try{const e=document.createElement("canvas");e.width=n.width,e.height=n.height;const i=e.getContext("2d");i.drawImage(n,0,0);const s=i.getImageData(0,0,e.width,e.height),o=s.data;for(let e=0;e<o.length;e+=4)o[e]=255-o[e],o[e+1]=255-o[e+1],o[e+2]=255-o[e+2];i.putImageData(s,0,0),t(e.toDataURL("image/png"))}catch(e){i(e)}},n.onerror=i,n.src=e}catch(e){i(e)}})),this._invertedLogoBase64Promise}async addFooter(e,t,i){const n=i-25;e.setFillColor(14,30,52),e.rect(0,n,t,25,"F"),e.setTextColor(255,255,255),e.setFontSize(8),e.setFont("helvetica","normal"),e.text("Schneider Unterkonstruktion - Solar Konfigurator",20,n+8),e.text("unterkonstruktion.de",20,n+15);try{const i=await this.loadImageAsBase64(this.companyLogoUrl),s=await this.getInvertedLogoBase64(i),o=15,l=3.1338028169*o,a=t-l-20,r=n+5;e.addImage(s,"PNG",a,r,l,o)}catch(i){console.warn("Logo konnte nicht geladen werden:",i),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("Schneider Unterkonstruktion",t-120,n+12)}}async loadImageAsBase64(e){return new Promise((t,i)=>{try{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{try{const e=document.createElement("canvas");e.width=n.naturalWidth||n.width,e.height=n.naturalHeight||n.height;const i=e.getContext("2d");i.imageSmoothingEnabled=!0,i.drawImage(n,0,0),t(e.toDataURL("image/png"))}catch(e){i(e)}},n.onerror=i,n.src=e}catch(e){i(e)}})}async calculateTotalPriceFromSnapshot(e){const i=await this.calculatePartsFromSnapshot(e);let s=0;return Object.entries(i).forEach(([e,i])=>{if(i>0){const o=Math.ceil(i/(t[e]||1)),l=n(e);s+=o*l}}),s}async addConfigurationToPDFFromSnapshot(e,t,i){const n=210,s=297,o={y:25},l=async(i=20)=>o.y+i>267&&(await this.addFooter(e,n,s),e.addPage(),this.addHeader(e,n,t),o.y=28,!0);o.y=this.addHeader(e,n,t),await l(20),e.setDrawColor(229,231,235),e.setLineWidth(.5),e.rect(15,o.y-4,180,14),e.setFont("helvetica","bold"),e.setFontSize(12),e.setTextColor(14,30,52),e.text(`Projekt: ${t.name||"Unbenannt"}`,20,o.y+6),e.setTextColor(0,0,0),o.y+=22,await l(20),e.setFontSize(11),e.setFont("helvetica","normal"),e.text(`Grid: ${t.cols} √ó ${t.rows} Module (${t.selectedCells} ausgew√§hlt)`,20,o.y),e.text("Orientierung: "+("vertical"===t.orientation?"Vertikal":"Horizontal"),20,o.y+8),o.y+=20;try{const i=await this.captureGridVisualizationFromSnapshot(t);if(i){const t=Math.floor(148.5),s=170;let a=Math.round(3*s/4);if(a>t){const e=t/a;a=Math.round(a*e)}await l(a+15);const r=(n-s)/2,c=o.y;e.addImage(i,"PNG",r,c,s,a),o.y+=a+10}}catch(e){console.warn("Grid-Screenshot fehlgeschlagen:",e),o.y+=10}await this.addFooter(e,n,s),e.addPage(),this.addHeader(e,n,t),o.y=28,await l(60),o.y=await this.addProductTableFromSnapshot(e,t,o.y,l),await l(25);const a=await this.calculateTotalPriceFromSnapshot(t);e.setFillColor(14,30,52),e.rect(15,o.y-5,180,20,"F"),e.setTextColor(255,255,255),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("GESAMTPREIS:",20,o.y+8);const r=`${a.toFixed(2)} ‚Ç¨ (exkl. MwSt)`;e.text(r,170,o.y+8),e.setTextColor(0,0,0),o.y+=30,await this.addFooter(e,n,s)}async captureGridVisualization(e){try{const t=e.selection||[],i=e.cols||5,n=e.rows||5,s=document.createElement("div");s.style.position="absolute",s.style.left="-10000px",s.style.top="-10000px",s.style.padding="20px",s.style.backgroundColor="#ffffff",document.body.appendChild(s);const o=50,l=2,a=document.createElement("div");a.style.display="grid",a.style.gap=`${l}px`,a.style.gridTemplateColumns=`repeat(${i}, ${o}px)`,a.style.gridTemplateRows=`repeat(${n}, ${o}px)`,a.style.padding="2px",a.style.backgroundColor="#ffffff",a.style.border="1px solid #000000",a.style.borderRadius="1rem";const r=Array.from({length:n},(e,n)=>Array.from({length:i},(e,i)=>!!(t[n]&&Array.isArray(t[n])&&i<t[n].length)&&!0===t[n][i]));for(let e=0;e<n;e++)for(let t=0;t<i;t++){const i=document.createElement("div"),n=r[e][t];i.style.width=`${o}px`,i.style.height=`${o}px`,i.style.borderRadius="1rem",i.style.border="1px solid #000000",i.style.backgroundColor=n?"#072544":"#f3f4f6",a.appendChild(i)}s.appendChild(a),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,100));const c=await this.html2canvas(s,{backgroundColor:"#ffffff",scale:2,logging:!1,useCORS:!0,allowTaint:!0,width:s.offsetWidth,height:s.offsetHeight});return document.body.removeChild(s),c.toDataURL("image/png")}catch(e){return console.warn("Grid-Screenshot fehlgeschlagen:",e),null}}async captureGridImageForWebhook(e){try{const t=e.selection||[],i=e.cols||5,n=e.rows||5,s=document.createElement("div");s.style.position="absolute",s.style.left="-10000px",s.style.top="-10000px",s.style.padding="20px",s.style.backgroundColor="#ffffff",document.body.appendChild(s);const o="vertical"===e.orientation,l=58,a=o?Math.round(.62*l):l,r=o?l:Math.round(.62*l),c=2,h=document.createElement("div");h.style.display="grid",h.style.gap=`${c}px`,h.style.gridTemplateColumns=`repeat(${i}, ${a}px)`,h.style.gridTemplateRows=`repeat(${n}, ${r}px)`,h.style.padding="16px",h.style.backgroundColor="#f5f7fa",h.style.border="1px solid #e5e7eb",h.style.borderRadius="12px",h.style.boxShadow="0 2px 8px rgba(0,0,0,0.08)";for(let e=0;e<n;e++)for(let n=0;n<i;n++){const i=document.createElement("div"),s=t[e]&&!0===t[e][n];if(i.style.width=`${a}px`,i.style.height=`${r}px`,i.style.borderRadius="6px",i.style.border="1px solid #d1d5db",i.style.transition="all 0.2s ease",s){i.style.backgroundColor="#0b0b0b",i.style.border="2px solid #cccccc",i.style.boxShadow="inset 0 2px 4px rgba(0,0,0,0.25)";const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.background="linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0) 40%),\n                  linear-gradient(135deg, #0b0b0b 0%, #111111 50%, #0b0b0b 100%)",e.style.borderRadius="4px",e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.top="2px",t.style.left="2px",t.style.right="2px",t.style.bottom="2px",t.style.backgroundImage="\n                  linear-gradient(to right, rgba(255,255,255,0.08) 1px, transparent 1px),\n                  linear-gradient(to bottom, rgba(255,255,255,0.08) 1px, transparent 1px)\n                ",t.style.backgroundSize="33% 50%",e.appendChild(t),i.appendChild(e)}else i.style.backgroundColor="#f3f4f6",i.style.border="1px solid #e5e7eb";h.appendChild(i)}s.appendChild(h),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,150));const d=document.createElement("canvas"),u=d.getContext("2d"),m=i*a+(i-1)*c+40,g=n*r+(n-1)*c+40;d.width=m,d.height=g,u.fillStyle="#ffffff",u.fillRect(0,0,d.width,d.height);const p=20,f=20;for(let e=0;e<n;e++)for(let n=0;n<i;n++){const i=p+n*(a+c),s=f+e*(r+c);if(t[e]&&!0===t[e][n]){u.fillStyle="#072544",u.fillRect(i,s,a,r),u.strokeStyle="#0a4d75",u.lineWidth=2,u.strokeRect(i,s,a,r),u.strokeStyle="rgba(255,255,255,0.2)",u.lineWidth=1;for(let e=1;e<3;e++){const t=i+a/3*e;u.beginPath(),u.moveTo(t,s+2),u.lineTo(t,s+r-2),u.stroke()}const e=s+r/2;u.beginPath(),u.moveTo(i+2,e),u.lineTo(i+a-2,e),u.stroke()}else u.fillStyle="#f8f9fa",u.fillRect(i,s,a,r),u.strokeStyle="#e9ecef",u.lineWidth=1,u.strokeRect(i,s,a,r)}u.strokeStyle="#e5e7eb",u.lineWidth=1,u.strokeRect(10,10,m-20,g-20);const b=d.toDataURL("image/png");return console.log("Canvas generated:",{canvasWidth:d.width,canvasHeight:d.height,dataURLLength:b.length,dataURLStart:b.substring(0,50)+"..."}),document.body.removeChild(s),b}catch(e){return console.error("Grid-Bild-Generierung fehlgeschlagen:",e),null}}async captureGridVisualizationFromSnapshot(e){try{const t=e.selection||[],i=e.cols||5,n=e.rows||5,s=698,o=Math.floor(561.5),l=Number(e.cellWidth||179),a=Number(e.cellHeight||113),r="vertical"===e.orientation,c=r?a:l,h=r?l:a,d=2,u=16,m=c*i+d*(i-1)+2*u,g=h*n+d*(n-1)+2*u,p=Math.min(s/m,o/g,1),f=Math.max(1,c*p),b=Math.max(1,h*p),y=Math.max(1,Math.round(d*p)),k=document.createElement("div");k.style.position="absolute",k.style.left="-10000px",k.style.top="-10000px",k.style.width=`${Math.ceil(i*f+(i-1)*y+2*u)}px`,k.style.height=`${Math.ceil(n*b+(n-1)*y+2*u)}px`;const w=document.createElement("div");w.className="canvas",w.style.width="100%",w.style.height="100%",w.style.padding=`${u}px`,w.style.background="#d0d0d0",w.style.borderRadius="6px",w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.boxSizing="border-box";const v=document.createElement("div");v.style.overflow="hidden",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center";const S=document.createElement("div");S.style.display="grid",S.style.gap=`${y}px`,S.style.gridTemplateColumns=`repeat(${i}, ${Math.round(f)}px)`,S.style.gridTemplateRows=`repeat(${n}, ${Math.round(b)}px)`;for(let e=0;e<n;e++)for(let n=0;n<i;n++){const i=document.createElement("div");i.style.width=`${Math.round(f)}px`,i.style.height=`${Math.round(b)}px`,i.style.borderRadius="6px",i.style.boxSizing="border-box";!(!t[e]||!t[e][n])?(i.style.background="#0b0b0b",i.style.border="2px solid #cccccc"):(i.style.background="#f3f4f6",i.style.border="1px solid #e5e7eb"),S.appendChild(i)}v.appendChild(S),w.appendChild(v),k.appendChild(w),document.body.appendChild(k),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,50));const C=await this.html2canvas(k,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1});return document.body.removeChild(k),C.toDataURL("image/png")}catch(e){return console.error("Grid-Screenshot fehlgeschlagen:",e),null}}async addProductTableFromSnapshot(e,i,o,l){try{console.log("addProductTableFromSnapshot called for:",i.name);const a=await this.calculatePartsFromSnapshot(i);if(console.log("Received parts:",a,"Keys count:",Object.keys(a||{}).length),console.log("Parts entries:",Object.entries(a||{})),console.log("UlicaSolarBlackJadeFlow in parts:",a?.UlicaSolarBlackJadeFlow),!a||0===Object.keys(a).length)return console.log("No parts calculated, returning early"),o;await l(30),e.setFillColor(255,177,1),e.roundedRect?e.roundedRect(15,o-5,180,15,3,3,"F"):e.rect(15,o-5,180,15,"F"),e.setTextColor(255,255,255),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("PRODUKT-LISTE",20,o+5),e.setTextColor(0,0,0),o+=20,await l(15),e.setFillColor(14,30,52),e.roundedRect?e.roundedRect(15,o-3,180,12,3,3,"F"):e.rect(15,o-3,180,12,"F"),e.setTextColor(255,255,255),e.setFontSize(9),e.setFont("helvetica","bold"),e.text("Anzahl",20,o+3),e.text("Produkt",45,o+3),e.text("Ben√∂tigte Menge",120,o+3),e.text("Preis",170,o+3),e.setTextColor(0,0,0),o+=15,e.setFont("helvetica","normal"),e.setFontSize(8);let r=0,c=0;for(const[i,h]of Object.entries(a))if(console.log("Processing product:",i,"quantity:",h),h>0){console.log("Adding to PDF:",i,"quantity:",h),await l(12),c%2==1&&(e.setFillColor(245,245,245),e.rect(15,o-2,180,10,"F"));const a=s[i]||i.replace(/_/g," "),d=t[i]||1,u=Math.ceil(h/d),m=u*n(i);r+=m,e.setFont("helvetica","bold"),e.text(`${u}x`,22,o+2,{align:"left"}),e.setFont("helvetica","bold"),e.setFontSize(10),e.text(a,45,o+1),e.setFont("helvetica","normal"),e.setFontSize(8),e.setTextColor(128,128,128),e.text(`${d} St√ºck`,45,o+6),e.setTextColor(0,0,0),e.setFont("helvetica","normal"),e.setFontSize(9),e.text(`${h}`,140,o+2,{align:"right"}),e.setFont("helvetica","bold"),e.text(`${m.toFixed(2)} ‚Ç¨`,190,o+2,{align:"right"}),o+=12,c++}return await l(15),e.setDrawColor(233,236,239),e.setLineWidth(1),e.line(15,o,195,o),o+=5}catch(e){return console.error("Produkttabelle fehlgeschlagen:",e),o}}async calculatePartsFromSnapshot(e){try{console.log("Calculating parts for config:",e.name,{selectedCells:e.selectedCells,rows:e.rows,cols:e.cols,includeModules:e.includeModules});const t={selection:e.selection,rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation||"horizontal",options:{erdungsband:e.erdungsband||!1,ulicaModule:!0===e.ulicaModule,includeModules:!0===e.includeModules||!0===e.incM}};let i;try{i=await l.calculate("calculateParts",t)}catch(e){console.warn("calculationManager failed, using fallback:",e),i=this.calculatePartsDirectly(t)}console.log("Parts calculated:",i),console.log("Config checkbox states:",{includeModules:e.includeModules,incM:e.incM,ulicaModule:e.ulicaModule}),console.log("Config object keys:",Object.keys(e)),console.log("Config ulicaModule value:",e.ulicaModule,"type:",typeof e.ulicaModule),console.log("CalculationData options:",t.options),e.includeModules||e.incM||(console.log("Deleting Solarmodul - both checkboxes false"),delete i.Solarmodul),!0!==e.ulicaModule?(console.log("Deleting UlicaSolarBlackJadeFlow - ulicaModule is not true"),delete i.UlicaSolarBlackJadeFlow):console.log("Keeping UlicaSolarBlackJadeFlow - ulicaModule is true"),e.mc4||(console.log("Deleting MC4 - mc4 checkbox false"),delete i.MC4),e.cable||(console.log("Deleting Solarkabel - cable checkbox false"),delete i.Solarkabel),e.wood||(console.log("Deleting Holzunterleger - wood checkbox false"),delete i.Holzunterleger),e.quetschkabelschuhe||(console.log("Deleting Ringkabelschuhe - ringkabelschuhe checkbox false"),delete i.Ringkabelschuhe),e.kabelbinder||(console.log("Deleting Kabelbinder - kabelbinder checkbox false"),delete i.Kabelbinder),e.erdungsband?i.Erdungsband=this.solarGrid.calculateErdungsband():delete i.Erdungsband;try{const t=!0===e.ulicaModule,n=t?"UlicaSolarBlackJadeFlow":"Solarmodul",s=t?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",o=Number(i[n]||0);if(o>0){const e=Math.floor(o/36),t=o%36;e>0&&(i[s]=(i[s]||0)+36*e),i[n]=t}}catch(e){}return console.log("Final parts after processing:",i),i}catch(e){return console.error("Part calculation from snapshot failed:",e),{}}}async addProductTable(e,i,o,l){await l(30),e.setFillColor(255,177,1),e.roundedRect?e.roundedRect(15,o-5,180,15,3,3,"F"):e.rect(15,o-5,180,15,"F"),e.setTextColor(14,30,52),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("PRODUKT-LISTE",20,o+5),e.setTextColor(0,0,0),o+=20;const a=await this.calculateConfigParts(i);if(!a||0===Object.keys(a).length)return e.setFontSize(10),e.setFont("helvetica","italic"),e.text("Keine Produkte berechnet.",20,o),o+10;await l(15),e.setFillColor(14,30,52),e.roundedRect?e.roundedRect(15,o-3,180,12,3,3,"F"):e.rect(15,o-3,180,12,"F"),e.setTextColor(255,255,255),e.setFontSize(9),e.setFont("helvetica","bold"),e.text("Produkt",20,o+3),e.text("Menge",70,o+3),e.text("Pack",100,o+3),e.text("Preis/Pack",130,o+3),e.text("Gesamt",170,o+3),e.setTextColor(0,0,0),o+=15,e.setFont("helvetica","normal"),e.setFontSize(8);let r=0,c=0;for(const[i,h]of Object.entries(a))if(h>0){await l(12),c%2==1&&(e.setFillColor(245,245,245),e.rect(15,o-2,180,10,"F"));const a=t[i]||1,d=Math.ceil(h/a),u=n(i),m=d*u;r+=m;const g=s[i]||i.replace(/_/g," ");e.text(g,20,o+2),e.text(h.toString(),70,o+2),e.text(`${d}√ó`,100,o+2),e.text(`${u.toFixed(2)} ‚Ç¨`,130,o+2),e.text(`${m.toFixed(2)} ‚Ç¨`,170,o+2),o+=10,c++}return await l(15),e.setDrawColor(233,236,239),e.setLineWidth(1),e.line(15,o,195,o),o+=5}async calculateConfigParts(e){if(!e.selection||!e.cols||!e.rows)return{};const i={selection:e.selection,rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation,options:{erdungsband:e.erdungsband||!1,ulicaModule:!0===e.ulicaModule,includeModules:!0===e.includeModules||!0===e.incM}};let n;try{n=await l.calculate("calculateParts",i)}catch(e){console.warn("calculationManager failed, using fallback:",e),n=this.calculatePartsDirectly(i)}if(e.includeModules||e.incM||(console.log("Deleting Solarmodul - both includeModules and incM false"),delete n.Solarmodul),!0!==e.ulicaModule?(console.log("Deleting UlicaSolarBlackJadeFlow - ulicaModule is not true"),delete n.UlicaSolarBlackJadeFlow):console.log("Keeping UlicaSolarBlackJadeFlow - ulicaModule is true"),e.mc4){const i=e.selection.flat().filter(e=>e).length,s=t.MC4_Stecker||50,o=Math.ceil(i/30);n.MC4_Stecker=o*s,console.log("Added MC4_Stecker packs:",o,"=> pieces",n.MC4_Stecker,"for",i,"modules")}return e.cable&&(n.Solarkabel=1,console.log("Added Solarkabel: 1")),e.wood&&(n.Holzunterleger=1,console.log("Added Holzunterleger: 1")),n}generateFileName(e){const t=new Date,i=t.toISOString().slice(0,10),n=t.toTimeString().slice(0,5).replace(":","-");let s="Solar-Konfiguration";return 1===e.length?s=e[0].name||"Konfiguration":e.length>1&&(s=`${e.length}-Konfigurationen`),s=s.replace(/[<>:"/\\|?*]/g,"-"),`${s}_${i}_${n}.pdf`}}class r{constructor(e){this.solarGrid=e,this.firstClick=null,this.isSelecting=!1,this.bulkMode=!1,this.isDragging=!1,this.dragStart=null,this.mousePressed=!1,this.setupKeyListener(),this.setupGlobalMouseEvents()}setupKeyListener(){}toggleBulkMode(){this.bulkMode=!this.bulkMode,this.bulkMode?(this.showBulkModeIndicator(!0),this.firstClick=null):(this.showBulkModeIndicator(!1),this.firstClick=null,this.clearHighlight())}showBulkModeIndicator(e){if(document.querySelectorAll(".bulk-mode-indicator").forEach(e=>e.remove()),e){const e=document.createElement("div");e.className="bulk-mode-indicator",e.innerHTML="üîÑ Bulk-Modus aktiv - Klicke auf zwei Zellen um einen Bereich auszuw√§hlen",e.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #f5a623;\n            color: white;\n            padding: 8px 16px;\n            border-radius: 8px;\n            font-size: 14px;\n            font-weight: bold;\n            z-index: 1000;\n            box-shadow: 0 4px 12px rgba(245, 166, 35, 0.3);\n            animation: slideIn 0.3s ease;\n          ";const t=document.createElement("style");t.textContent="\n            @keyframes slideIn {\n              from { transform: translateX(100%); opacity: 0; }\n              to { transform: translateX(0); opacity: 1; }\n            }\n          ",document.head&&document.head.appendChild(t),document.body&&document.body.appendChild(e)}}initializeBulkSelection(){const e=this.solarGrid.buildGrid.bind(this.solarGrid);this.solarGrid.buildGrid=()=>{e(),setTimeout(()=>{this.addBulkSelectionToGrid()},10)},setTimeout(()=>{this.addBulkSelectionToGrid()},100)}addBulkSelectionToGrid(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach((e,t)=>{const i=t%this.solarGrid.cols,n=Math.floor(t/this.solarGrid.cols),s=e.cloneNode(!0);e.parentNode.replaceChild(s,e),s.addEventListener("mousedown",e=>{e.preventDefault(),this.handleDragStart(e,i,n,s)}),s.addEventListener("touchstart",e=>{e.preventDefault(),this.handleDragStart(e,i,n,s)}),s.addEventListener("mouseenter",e=>{this.mousePressed&&this.dragStart&&(this.isDragging=!0,this.highlightRange(this.dragStart,{x:i,y:n}))}),s.addEventListener("touchmove",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.isDragging=!0,this.highlightRange(this.dragStart,{x:i,y:n}))}),s.addEventListener("mouseup",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.handleDragEnd(e,i,n))}),s.addEventListener("touchend",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.handleDragEnd(e,i,n))}),s.addEventListener("click",e=>{this.isDragging||this.mousePressed&&this.dragStart||(this.solarGrid.selection[n]||(this.solarGrid.selection[n]=[]),e.ctrlKey||e.metaKey,this.solarGrid.selection[n][i]=!this.solarGrid.selection[n][i],s.classList.toggle("selected"),this.solarGrid.trackInteraction(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),null!==this.solarGrid.currentConfig&&(this.solarGrid.updateConfig(),this.solarGrid.updateConfigList()))}),s.addEventListener("mouseleave",()=>{this.mousePressed||this.clearHighlight()})})}selectRange(e,t){const i=Math.min(e.x,t.x),n=Math.max(e.x,t.x),s=Math.min(e.y,t.y),o=Math.max(e.y,t.y),l=!e.wasSelected;for(let e=s;e<=o;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=i;t<=n;t++)this.solarGrid.selection[e][t]=l}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}highlightRange(e,t){this.clearHighlight();const i=Math.min(e.x,t.x),n=Math.max(e.x,t.x),s=Math.min(e.y,t.y),o=Math.max(e.y,t.y),l=this.solarGrid.gridEl.querySelectorAll(".grid-cell"),a=void 0===e.wasSelected||!e.wasSelected;for(let e=s;e<=o;e++)for(let t=i;t<=n;t++){const i=e*this.solarGrid.cols+t;l[i]&&(l[i].classList.add("bulk-highlight"),a?l[i].classList.add("drag-preview-select"):l[i].classList.add("drag-preview-deselect"))}}clearHighlight(){this.solarGrid.gridEl.querySelectorAll(".bulk-highlight, .drag-preview-select, .drag-preview-deselect").forEach(e=>{e.classList.remove("bulk-highlight","drag-preview-select","drag-preview-deselect")});this.solarGrid.gridEl.querySelectorAll(".drag-start-marker, .drag-select-mode, .drag-deselect-mode").forEach(e=>{e.classList.remove("drag-start-marker","drag-select-mode","drag-deselect-mode")})}resetDragState(){this.mousePressed=!1,this.isDragging=!1,this.dragStart=null,this.clearHighlight()}calculateRangeSize(e,t){const i=Math.min(e.x,t.x),n=Math.max(e.x,t.x),s=Math.min(e.y,t.y);return(n-i+1)*(Math.max(e.y,t.y)-s+1)}clearFirstClickMarker(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach(e=>e.classList.remove("first-click-marker"))}getClampedCellFromPointer(e){const t=this.solarGrid.gridEl.getBoundingClientRect(),i=e&&e.touches&&e.touches[0]||e&&e.changedTouches&&e.changedTouches[0]||e,n=i?i.clientX:0,s=i?i.clientY:0,o=Math.min(Math.max(n-t.left,0),t.width),l=Math.min(Math.max(s-t.top,0),t.height),a=t.width/this.solarGrid.cols,r=t.height/this.solarGrid.rows;return{x:Math.min(this.solarGrid.cols-1,Math.max(0,a>0?Math.floor(o/a):0)),y:Math.min(this.solarGrid.rows-1,Math.max(0,r>0?Math.floor(l/r):0))}}handleDragStart(e,t,i,n){const s=this.solarGrid.selection[i]?.[t]||!1;this.mousePressed=!0,this.isDragging=!1,this.dragStart={x:t,y:i,wasSelected:s},this.clearHighlight(),n.classList.add("drag-start-marker"),s?n.classList.add("drag-deselect-mode"):n.classList.add("drag-select-mode")}handleDragEnd(e,t,i){(this.isDragging||this.dragStart.x===t&&this.dragStart.y===i)&&this.selectRange(this.dragStart,{x:t,y:i}),this.resetDragState()}setupGlobalMouseEvents(){document.addEventListener("mousemove",e=>{if(this.mousePressed&&this.dragStart){this.isDragging=!0;const t=this.getClampedCellFromPointer(e);this.highlightRange(this.dragStart,t)}}),document.addEventListener("mouseup",e=>{if(this.mousePressed&&this.dragStart){const t=this.getClampedCellFromPointer(e);this.handleDragEnd(e,t.x,t.y)}}),document.addEventListener("touchmove",e=>{if(this.mousePressed&&this.dragStart){e.preventDefault(),this.isDragging=!0;const t=this.getClampedCellFromPointer(e);this.highlightRange(this.dragStart,t)}},{passive:!1}),document.addEventListener("touchend",e=>{if(this.mousePressed&&this.dragStart){const t=this.getClampedCellFromPointer(e);this.handleDragEnd(e,t.x,t.y)}}),this.solarGrid.gridEl.addEventListener("mouseleave",()=>{}),this.solarGrid.gridEl.addEventListener("touchcancel",()=>{}),this.solarGrid.gridEl.addEventListener("contextmenu",e=>{(this.isDragging||this.mousePressed)&&e.preventDefault()}),this.solarGrid.gridEl.addEventListener("touchmove",e=>{(this.isDragging||this.mousePressed)&&e.preventDefault()})}}class c{constructor(){this.isProcessing=!1}async execute(e,t){for(;this.isProcessing;)await new Promise(e=>setTimeout(e,50));this.isProcessing=!0;try{console.log(`[SimpleCartQueue] Processing: ${t}`);return await e()}finally{this.isProcessing=!1}}}class h{readExtrasFromSummaryList(){const e=["MC4_Stecker","Solarkabel","Holzunterleger","Ringkabelschuhe","Kabelbinder","BlechBohrschrauben","Erdungsband"],t={};try{if(this.lastExtras&&"object"==typeof this.lastExtras)return this.lastExtras;const i=document.getElementById("summary-list")||document,n=Array.from(i.querySelectorAll(".produkt-item")),o=e=>{const t=n.find(t=>(t.textContent||"").toLowerCase().includes(String(e).toLowerCase()));if(!t)return 0;const i=t.querySelector("span");if(!i||!i.textContent)return 0;const s=i.textContent.trim().match(/^(\d+)\s*√ó/);return s?parseInt(s[1],10):0};e.forEach(e=>{if("MC4_Stecker"===e)return void(t[e]=this.mc4&&this.mc4.checked?1:0);const i=(s[e]||e).split(" - ")[0];let n=o(i);"Solarkabel"===e&&!n&&this.solarkabel&&this.solarkabel.checked&&(n=1),"Holzunterleger"===e&&!n&&this.holz&&this.holz.checked&&(n=1),"Ringkabelschuhe"===e&&!n&&this.quetschkabelschuhe&&this.quetschkabelschuhe.checked&&(n=1),"Kabelbinder"===e&&!n&&this.kabelbinder&&this.kabelbinder.checked&&(n=1),"BlechBohrschrauben"===e&&!n&&this.erdungsband&&this.erdungsband.checked&&(n=1),t[e]=Number.isFinite(n)?n:0}),this.lastExtras=t}catch(i){e.forEach(e=>t[e]=0)}return t}bundleTotalModulesIntoPallets(e){try{const t="Solarmodul",i="UlicaSolarBlackJadeFlow",n="SolarmodulPalette",s="UlicaSolarBlackJadeFlowPalette",o=Number(e[t]||0),l=Number(e[i]||0),a=e=>{if(!e||e<36)return{single:e,pallets:0};const t=Math.floor(e/36);return{single:e-36*t,pallets:t}},r=a(o),c=a(l);r.pallets>0&&(e[n]=(e[n]||0)+36*r.pallets),c.pallets>0&&(e[s]=(e[s]||0)+36*c.pallets),e[t]=r.single,e[i]=c.single}catch(e){}}constructor(){this.gridEl=document.getElementById("grid"),this.wrapper=document.querySelector(".grid-wrapper"),this.wIn=document.getElementById("width-input"),this.hIn=document.getElementById("height-input"),this.orH=document.getElementById("orient-h"),this.orV=document.getElementById("orient-v"),this.incM=document.getElementById("include-modules"),this.mc4=document.getElementById("mc4"),this.solarkabel=document.getElementById("solarkabel"),this.holz=document.getElementById("holz"),this.quetschkabelschuhe=document.getElementById("quetschkabelschuhe"),this.kabelbinder=document.getElementById("kabelbinder"),this.erdungsband=document.getElementById("erdungsband"),this.ulicaModule=document.getElementById("ulica-module"),this.totalPartsCache=null,this.listHolder=document.querySelector(".product-section"),this.prodList=document.querySelector(".product-section #produktliste"),this.saveBtn=document.getElementById("save-config-btn"),this.addBtn=document.getElementById("add-to-cart-btn"),this.summaryBtn=document.getElementById("summary-add-cart-btn"),this.configListEl=document.getElementById("config-list"),this.resetBtn=document.getElementById("reset-btn"),this.continueLaterBtn=document.getElementById("continue-later-btn"),this.moduleSelect=document.getElementById("module-select"),this.moduleData={"ulica-500":{name:"Ulica Black Jade-Flow 500W",width:195.2,height:113.4},"ulica-450":{name:"Ulica Black Jade-Flow 450W",width:176.2,height:113.4},"trina-vertex-s-plus":{name:"Trina Vertex S+",width:176.2,height:113.4},"aiko-neostar-3s-plus":{name:"Aiko Neostar 3S+",width:176.2,height:113.4}},this.moduleCheckboxMapping={"include-modules":"ulica-450","ulica-module":"ulica-500"},this.selection=[],this.configs=[],this.currentConfig=null,this.default={cols:5,rows:5,width:176,height:113},this.updateTimeout=null,this.updateDelay=100,this.cartAckObserver=null,this.cartAckResolve=null,this.resizeObserver=null,this.resizeTimeout=null,this.sessionId=this.generateSessionId(),this.sessionStartTime=Date.now(),this.firstInteractionTime=null,this.lastInteractionTime=Date.now(),this.interactionCount=0,this.webhookUrl="https://hook.eu2.make.com/c7lkudk1v2a2xsr291xbvfs2cb25b84k",this.pdfGenerator=new a(this),this.cacheManager=new e,this.loadingOverlay=null,this.loadingTextEl=null,this.cachedElements={huaweiOpti:null,brcOpti:null,optiQty:null,ulicaModule:null,erdungsband:null,kabelbinder:null,quetschkabelschuhe:null},this.boundGlobalAddAllClick=null,this.boundMobileDisableClick=null,this.boundMobileDisableTouch=null,this.init()}getCachedElement(e,t){return this.cachedElements[e]||(this.cachedElements[e]=document.getElementById(t)),this.cachedElements[e]}showLoading(e="Vorgang l√§uft‚Ä¶ bitte warten"){try{this.loadingOverlay||(this.loadingOverlay=document.getElementById("loading-overlay")),this.loadingTextEl||(this.loadingTextEl=document.getElementById("loading-text")),this.loadingTextEl&&"string"==typeof e&&(this.loadingTextEl.textContent=e),this.loadingOverlay&&(this.loadingOverlay.style.display="flex")}catch(e){}}hideLoading(){try{this.loadingOverlay||(this.loadingOverlay=document.getElementById("loading-overlay")),this.loadingOverlay&&(this.loadingOverlay.style.display="none")}catch(e){}}generateSessionId(){return`session_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}trackInteraction(){this.firstInteractionTime||(this.firstInteractionTime=Date.now()),this.lastInteractionTime=Date.now(),this.interactionCount++}formatDuration(e){if(!e||e<0)return"00:00:00";const t=Math.floor(e/1e3),i=Math.floor(t/3600),n=Math.floor(t%3600/60),s=t%60;return`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}getSessionData(){const e=Date.now(),t=e-this.sessionStartTime,i=this.firstInteractionTime?this.firstInteractionTime-this.sessionStartTime:0,n=e-this.lastInteractionTime;return{sessionDuration:this.formatDuration(t),timeToFirstInteraction:this.formatDuration(i),timeSinceLastInteraction:this.formatDuration(n),interactionCount:this.interactionCount,sessionStartTime:this.sessionStartTime,firstInteractionTime:this.firstInteractionTime,lastInteractionTime:this.lastInteractionTime}}getProductSummary(){const e=this.calculateParts();this.incM.checked||delete e.Solarmodul;try{const t=!0===currentConfig.ulicaModule,i=t?"UlicaSolarBlackJadeFlow":"Solarmodul",n=t?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",s=Number(e[i]||0);if(s>0){const t=Math.floor(s/36),o=s%36;t>0&&(e[n]=(e[n]||0)+36*t),e[i]=o}}catch(e){}const i=Object.entries(e).filter(([,e])=>e>0);let s=0;const o={};return i.forEach(([e,i])=>{const l=Math.ceil(i/t[e]),a=n(e);s+=l*a;const r=e.replace(/_/g,"");o[r]=i}),{totalPrice:s}}generateGridVisualization(e,t,i,n,s){let o=`<div class="grid" style="--cols: ${t}; --rows: ${i}; --cell-size: ${n}px; --cell-height: ${s}px; --cell-gap: 2px;">`;for(let n=0;n<i;n++)for(let i=0;i<t;i++){o+=`<div class="${e[n]&&e[n][i]?"cell selected":"cell"}"></div>`}o+="</div>";return{html:o,css:".grid { \n          display: grid; \n          gap: var(--cell-gap); \n          grid-template-columns: repeat(var(--cols), var(--cell-size)); \n          grid-template-rows: repeat(var(--rows), var(--cell-height)); \n          margin: auto; \n          background: transparent; \n        } \n        .cell { \n          background: #000000; \n          border-radius: 6px; \n          width: var(--cell-size); \n          height: var(--cell-height); \n          transition: all 0.15s ease; \n        } \n        .cell.selected { \n          background: #7f7f7f; \n        }"}}getConfigData(e=null){const i=e||{cols:this.cols,rows:this.rows,cellWidth:parseFloat(this.wIn.value),cellHeight:parseFloat(this.hIn.value),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked},s=this.getProductSummary(),o=this.generateGridVisualization(i.selection,i.cols,i.rows,i.cellWidth,i.cellHeight),l=this.calculatePartsDirectly({selection:i.selection,cols:i.cols,rows:i.rows,cellWidth:i.cellWidth,cellHeight:i.cellHeight,orientation:i.orientation,incM:i.incM}),a={Solarmodul:l.Solarmodul||0,Endklemmen:l.Endklemmen||0,Schrauben:l.Schrauben||0,Dachhaken:l.Dachhaken||0,Mittelklemmen:l.Mittelklemmen||0,Endkappen:l.Endkappen||0,Schienenverbinder:l.Schienenverbinder||0,Schiene240cm:l.Schiene_240_cm||0,Schiene360cm:l.Schiene_360_cm||0},r=Object.fromEntries(Object.entries(a).filter(([,e])=>e>0)),c=[];for(let e=0;e<i.rows;e++){const t=i.selection[e]||[];for(let n=0;n<i.cols;n++)t[n]&&c.push([n,e])}const h={selectedCount:c.length,selectedCoords:c},d=Object.entries(r).reduce((e,[i,s])=>{const o="Schiene240cm"===i?"Schiene_240_cm":"Schiene360cm"===i?"Schiene_360_cm":i,l=t[o]||1;return e+Math.ceil(s/l)*n(o)},0);return{timestamp:(new Date).toISOString(),sessionId:this.sessionId,sessionData:this.getSessionData(),config:{cols:i.cols,rows:i.rows,cellWidth:i.cellWidth,cellHeight:i.cellHeight,orientation:i.orientation,gridVisualization:o,options:{includeModules:i.incM}},summary:s,productQuantities:a,productQuantitiesCompact:r,selectionMeta:h,totalPrice:Number.isFinite(d)?d:s.totalPrice,analytics:{totalCells:i.cols*i.rows,selectedCells:i.selection.flat().filter(e=>e).length,selectionPercentage:(i.selection.flat().filter(e=>e).length/(i.cols*i.rows)*100).toFixed(2),gridArea:i.cols*i.rows,averageCellSize:((i.cellWidth+i.cellHeight)/2).toFixed(2)}}}async sendConfigToWebhook(e){try{const t={sessionId:e.sessionId,timestamp:e.timestamp,config:{cols:e?.config?.cols,rows:e?.config?.rows,cellWidth:e?.config?.cellWidth,cellHeight:e?.config?.cellHeight,orientation:e?.config?.orientation},selection:e.selectionMeta||void 0,productQuantities:e.productQuantitiesCompact||e.productQuantities,totalPrice:e.totalPrice,session:{duration:e.sessionData?.sessionDuration,interactions:e.sessionData?.interactionCount}};("number"==typeof e.configIndex||e.configName||"number"==typeof e.totalConfigsInSession)&&(t.meta={configIndex:e.configIndex,configName:e.configName,totalConfigsInSession:e.totalConfigsInSession});return(await fetch(this.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok}catch(e){return console.error("Webhook send error:",e),!1}}async sendCurrentConfigToWebhook(){const e=this.getConfigData();return await this.sendConfigToWebhook(e)}async sendAllConfigsToWebhook(){const e=[];let t=0;for(let i=0;i<this.configs.length;i++){const n=this.configs[i];let s;s=i===this.currentConfig?{cols:this.cols,rows:this.rows,cellWidth:parseFloat(this.wIn.value),cellHeight:parseFloat(this.hIn.value),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked}:{cols:n.cols,rows:n.rows,cellWidth:parseFloat(n.cellWidth),cellHeight:parseFloat(n.cellHeight),orientation:n.orientation,selection:n.selection,incM:n.incM,mc4:n.mc4,solarkabel:n.solarkabel,holz:n.holz};const o=this.selection,l=!!this.orV&&this.orV.checked,a=!!this.solarkabel&&this.solarkabel.checked,r=!!this.incM&&this.incM.checked,c=!!this.mc4&&this.mc4.checked,h=!!this.holz&&this.holz.checked;this.selection=s.selection,this.orV&&(this.orV.checked="vertical"===s.orientation),this.orH&&(this.orH.checked=!("vertical"===s.orientation)),this.solarkabel&&(this.solarkabel.checked=s.solarkabel),this.incM&&(this.incM.checked=s.incM),this.mc4&&(this.mc4.checked=s.mc4),this.holz&&(this.holz.checked=s.holz);const d=this.getConfigData(s);d.configIndex=i,d.configName=n.name,d.totalConfigsInSession=this.configs.length,this.selection=o,this.orV&&(this.orV.checked=l),this.orH&&(this.orH.checked=!l),this.solarkabel&&(this.solarkabel.checked=a),this.incM&&(this.incM.checked=r),this.mc4&&(this.mc4.checked=c),this.holz&&(this.holz.checked=h);try{const n=await this.sendConfigToWebhook(d);n&&t++,e.push(n),i<this.configs.length-1&&await new Promise(e=>setTimeout(e,100))}catch(t){e.push(!1)}}return t===this.configs.length}checkMobileDevice(){(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window&&window.innerWidth<=1024)&&this.redirectToDesktopSite()}disableMobileFunctionality(){try{const e=document.querySelector(".main-container, #solar-configurator, .configurator-wrapper");e&&(e.style.display="none");document.querySelectorAll(".grid-container, .config-sidebar, .button-bar, .checkbox-bar").forEach(e=>{e&&(e.style.display="none")}),this.boundMobileDisableClick=e=>{e.preventDefault(),e.stopPropagation()},document.addEventListener("click",this.boundMobileDisableClick,!0),this.boundMobileDisableTouch=e=>{e.preventDefault(),e.stopPropagation()},document.addEventListener("touchstart",this.boundMobileDisableTouch,!0),console.log("[SolarGrid] Mobile functionality disabled - Desktop required")}catch(e){console.warn("[SolarGrid] Error disabling mobile functionality:",e)}}redirectToDesktopSite(){try{this.disableMobileFunctionality();const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: #0e1e34;\n            color: white;\n            padding: 20px;\n            border-radius: 8px;\n            text-align: center;\n            z-index: 10000;\n            font-family: Arial, sans-serif;\n            width: 95vw;\n            max-width: 400px;\n            box-sizing: border-box;\n          ",e.innerHTML="\n            <h3>Weiterleitung zur Homepage</h3>\n            <p>Der Konfigurator ist nur auf Desktop-Ger√§ten verf√ºgbar.</p>\n            <p>Sie werden automatisch weitergeleitet...</p>\n          ",document.body.appendChild(e),setTimeout(()=>{window.location.href="https://unterkonstruktion.de/"},2e3),console.log("[SolarGrid] Redirecting mobile users to unterkonstruktion.de")}catch(e){console.warn("[SolarGrid] Error redirecting to desktop site:",e),window.location.href="https://unterkonstruktion.de/"}}maybeShowIntroOverlay(e,t){try{const i=document.getElementById("intro-overlay");if(!i)return;if(e||t)return;const n=document.getElementById("intro-close"),s=document.getElementById("intro-ok"),o=()=>{i.classList.add("hidden"),i.setAttribute("aria-hidden","true")};i.classList.remove("hidden"),i.setAttribute("aria-hidden","false"),n?.addEventListener("click",o),s?.addEventListener("click",o),i.addEventListener("click",e=>{e.target===i&&o()}),i.addEventListener("click",e=>{const t=e.target;t&&("intro-ok"===t.id||t.closest&&t.closest("#intro-ok"))&&(e.preventDefault(),e.stopPropagation(),o())}),i.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),o()),"Enter"===e.key&&document.activeElement&&"intro-ok"===document.activeElement.id&&(e.preventDefault(),o())})}catch(e){console.warn("Intro Overlay konnte nicht initialisiert werden:",e)}}init(){this.checkMobileDevice();const e=this.loadFromCache();if(!e){const e=new URLSearchParams(window.location.search).get("configData");if(e)try{const t=decodeURIComponent(atob(e)),i=JSON.parse(t);Array.isArray(i)?(this.configs=i,this.loadConfig(0)):(this.configs.push(i),this.loadConfig(0))}catch(e){}}try{const t=new URLSearchParams(window.location.search).has("configData");this.maybeShowIntroOverlay(e,t)}catch(e){}this.setupAllEventListeners(),this.saveBtn&&this.saveBtn.addEventListener("click",()=>{this.trackInteraction(),this.saveNewConfig()}),this.addBtn&&this.addBtn.addEventListener("click",()=>{this.trackInteraction(),this.addCurrentToCart()}),this.summaryBtn&&this.summaryBtn.addEventListener("click",()=>{this.trackInteraction(),this.addAllToCart()}),this.resetBtn&&this.resetBtn.addEventListener("click",()=>{this.trackInteraction(),this.resetGridToDefault()}),this.continueLaterBtn&&this.continueLaterBtn.addEventListener("click",()=>{this.trackInteraction(),this.generateContinueLink()});document.getElementById("sidebar-toggle");if(this.initSidebarNavigation(),this.loadingOverlay=document.getElementById("loading-overlay"),this.loadingTextEl=document.getElementById("loading-text"),0===this.configs.length){this.cols=this.default.cols,this.rows=this.default.rows,this.setup();const e=this._makeConfigObject();if(this.configs.push(e),this.loadConfig(0),this.orH&&this.orV){this.orH.checked=!1,this.orV.checked=!0;const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t&&(e.classList.remove("active"),t.classList.add("active"))}}this.setupResizeObserver(),this.bulkSelector=new r(this),this.bulkSelector.initializeBulkSelection(),this.initAutoSaveIndicator(),this.initConfigList()}initSidebarNavigation(){const e=document.getElementById("back-to-overview");document.getElementById("config-detail-view"),document.getElementById("config-overview");e&&e.addEventListener("click",()=>{this.showOverview()});const t=document.getElementById("edit-config-name");t&&t.addEventListener("click",()=>{this.editConfigName()});const i=document.getElementById("delete-current-config");i&&(i.addEventListener("click",()=>{this.deleteCurrentConfig()}),i.style.display=this.configs.length>=2?"":"none");const n=document.getElementById("express-checkout-btn");if(n){try{n.setAttribute("aria-label","Gesamte Auswahl in den Warenkorb")}catch(e){}try{n.setAttribute("title","Gesamte Auswahl in den Warenkorb")}catch(e){}n.addEventListener("click",()=>{this.addAllConfigsToCart()})}const s=document.getElementById("next-config-btn");s&&s.addEventListener("click",()=>{this.saveNewConfig()}),this.boundGlobalAddAllClick=e=>{try{var t=e.target;if(!t||!t.closest)return;if(!t.closest('#add-all-to-cart-btn, .add-all-to-cart-btn, [data-action="add-all-to-cart"], [data-add-all-to-cart="true"]'))return;try{e.preventDefault()}catch(e){}this.addAllConfigsToCart()}catch(e){}},document.addEventListener("click",this.boundGlobalAddAllClick,!0);const o=document.getElementById("continue-later-btn");o&&o.addEventListener("click",()=>{this.resetAllConfigurations()});const l=document.getElementById("add-config-btn");l&&l.addEventListener("click",()=>{this.saveNewConfig()})}showOverview(){null!==this.currentConfig&&this.updateConfig();const e=document.getElementById("config-detail-view"),t=document.getElementById("config-overview");e&&t&&(e.classList.remove("active"),t.classList.add("active"),this.clearAllInputFields(),this.updateConfigList())}clearAllInputFields(){const e=document.getElementById("current-config-title");if(e){e.parentNode.querySelectorAll(".config-title-input").forEach(e=>e.remove()),e.style.display="block"}document.querySelectorAll(".config-item").forEach(e=>{const t=e.querySelector(".config-item-name");if(t){t.parentNode.querySelectorAll('input[type="text"]').forEach(e=>e.remove()),t.style.display="block"}})}initConfigList(){document.getElementById("config-overview")?.classList.contains("active")&&this.updateConfigList(),this.initAdditionalProductsListeners()}showDetailView(e=null){const t=document.getElementById("config-detail-view"),i=document.getElementById("config-overview");if(t&&i){i.classList.remove("active"),t.classList.add("active"),null!==e&&this.loadConfig(e),this.updateDetailView();const n=document.getElementById("delete-current-config");n&&(n.style.display=this.configs.length>=2?"":"none")}}updateDetailView(){const e=this.configs[this.currentConfig];if(!e)return;const t=document.getElementById("current-config-title");t&&(t.textContent=e.name||`Konfiguration #${this.currentConfig+1}`),this.updateCurrentTotalPrice();const i=document.getElementById("delete-current-config");i&&(i.style.display=this.configs.length>=2?"":"none")}updateCurrentTotalPrice(){const e=document.getElementById("current-total-price");if(e){const t=null!==this.currentConfig&&this.configs[this.currentConfig]?this.configs[this.currentConfig]:null,i=t?{selection:Array.isArray(t.selection)?t.selection:[],cols:Number(t.cols||this.cols),rows:Number(t.rows||this.rows),cellWidth:Number(t.cellWidth||parseInt(this.wIn?.value||"179")),cellHeight:Number(t.cellHeight||parseInt(this.hIn?.value||"113")),orientation:t.orientation||(this.orV?.checked?"vertical":"horizontal"),incM:!1!==t.incM,ulicaModule:!!t.ulicaModule}:{selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?.value||"179"),cellHeight:parseInt(this.hIn?.value||"113"),orientation:this.orV?.checked?"vertical":"horizontal",incM:!1!==(this.incM&&this.incM.checked),ulicaModule:document.getElementById("ulica-module")?.checked||!1};let n=0;try{n=this.calculateConfigPrice(i)}catch(e){}e.textContent=`${n.toFixed(2).replace(".",",")} ‚Ç¨`;const s=e.closest(".total-section"),o=s?s.querySelector(".total-subtitle"):null;o&&(o.style.display="none",o.textContent="exkl. MwSt");let l=s?s.querySelector(".total-disclaimer"):null;!l&&s&&(l=document.createElement("div"),l.className="total-disclaimer",l.style.fontSize="12px",l.style.color="#666",l.style.marginTop="4px",l.style.lineHeight="1.3",l.style.textAlign="right",s.appendChild(l)),l&&(l.textContent="Der sichtbare Preis ist eine Vorberechnung, minimale Mengenanpassungen und Optimierungen werden im Warenkorb potentiell einen anderen Preis ergeben.")}}updateConfigList(){this.renderConfigList(),this.updateOverviewTotalPrice(),this.renderAdditionalProducts(),this.updateCurrentTotalPrice()}initAutoSaveIndicator(){this.autoSaveTimeout=null}showAutoSaveIndicator(){const e=document.getElementById("auto-save-indicator");if(!e)return;e.classList.remove("hidden");const t=e.querySelector(".save-icon");t&&(t.style.animation="none",t.offsetHeight,t.style.animation="rotate360 0.8s ease-in-out"),this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(()=>{e.classList.add("hidden")},1e3)}updateOverviewTotalPrice(){const e=document.getElementById("overview-total-price");if(!e)return;let t=0;try{const e=this.computeAllTotalsSnapshot();Object.entries(e||{}).forEach(([e,n])=>{const s=i[e]||0;t+=(Number(n)||0)*s})}catch(e){}e.textContent=`${t.toFixed(2).replace(".",",")} ‚Ç¨`;const n=e.closest(".total-section"),s=n?n.querySelector(".total-subtitle"):null;s&&(s.style.display="none",s.textContent="exkl. MwSt");let o=n?n.querySelector(".total-disclaimer"):null;!o&&n&&(o=document.createElement("div"),o.className="total-disclaimer",o.style.fontSize="12px",o.style.color="#666",o.style.marginTop="4px",o.style.lineHeight="1.3",o.style.textAlign="right",n.appendChild(o)),o&&(o.textContent="Der sichtbare Preis ist eine Vorberechnung, minimale Mengenanpassungen und Optimierungen werden im Warenkorb potentiell einen anderen Preis ergeben.")}calculateAdditionalProductsPrice(){let e=0;if(document.getElementById("mc4")?.checked){const t=this.configs.reduce((e,t)=>e+t.selection.flat().filter(e=>e).length,0);e+=Math.ceil(t/30)*n("MC4_Stecker")}if(document.getElementById("solarkabel")?.checked){e+=1*n("Solarkabel")}if(document.getElementById("holz")?.checked){e+=1*n("Holzunterleger")}if(document.getElementById("quetschkabelschuhe")?.checked){e+=1*n("Ringkabelschuhe")}const t=document.getElementById("huawei-opti"),i=document.getElementById("brc-opti"),s=document.getElementById("opti-qty");if(t&&i&&s&&(t.checked||i.checked)){const t=i.checked?"BRCOpti":"HuaweiOpti";e+=Math.max(1,parseInt(s.value||"1",10))*n(t)}return e}renderAdditionalProducts(){const e=document.getElementById("additional-products-list");if(!e)return;if(e.replaceChildren(),document.getElementById("mc4")?.checked){const i=this.configs.reduce((e,t)=>e+t.selection.flat().filter(e=>e).length,0),s=Math.ceil(i/30),o=s*n("MC4_Stecker"),l=document.createElement("div");l.className="additional-product-item produkt-item",l.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">${s}√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">MC4 Stecker</span>\n                              <span class="item-ve">${t.MC4_Stecker} St√ºck</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${o.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(l)}if(document.getElementById("solarkabel")?.checked){const t=1*n("Solarkabel"),i=document.createElement("div");i.className="additional-product-item produkt-item",i.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">1√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">Solarkabel</span>\n                              <span class="item-ve">100 m</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${t.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(i)}if(document.getElementById("holz")?.checked){const i=1*n("Holzunterleger"),s=document.createElement("div");s.className="additional-product-item produkt-item",s.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">1√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">Unterlegholz f√ºr Dachhaken</span>\n                              <span class="item-ve">${t.Holzunterleger} St√ºck</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${i.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(s)}if(document.getElementById("quetschkabelschuhe")?.checked){const i=1*n("Ringkabelschuhe"),s=document.createElement("div");s.className="additional-product-item produkt-item",s.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">1√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">Ringkabelschuhe</span>\n                              <span class="item-ve">${t.Ringkabelschuhe} St√ºck</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${i.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(s)}if(document.getElementById("kabelbinder")?.checked){const i=1*n("Kabelbinder"),s=document.createElement("div");s.className="additional-product-item produkt-item",s.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">1√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">Kabelbinder</span>\n                              <span class="item-ve">${t.Kabelbinder} St√ºck</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${i.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(s)}if(document.getElementById("erdungsband")?.checked){const i=1*n("BlechBohrschrauben"),s=document.createElement("div");s.className="additional-product-item produkt-item",s.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">1√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">Blech-Bohrschrauben</span>\n                              <span class="item-ve">${t.BlechBohrschrauben} St√ºck</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${i.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(s)}const i=document.getElementById("huawei-opti"),o=document.getElementById("brc-opti"),l=document.getElementById("opti-qty");if(i&&o&&l&&(i.checked||o.checked)){const t=o.checked?"BRCOpti":"HuaweiOpti",i=Math.max(1,parseInt(l.value||"1",10)),a=i*n(t),r=document.createElement("div");r.className="additional-product-item produkt-item",r.innerHTML=`\n                      <div class="item-left">\n                          <span class="item-quantity">${i}√ó</span>\n                          <div class="item-info">\n                              <span class="item-name">${s[t]||t}</span>\n                              <span class="item-ve">1 St√ºck</span>\n                          </div>\n                      </div>\n                      <span class="item-price">${a.toFixed(2).replace(".",",")} ‚Ç¨</span>\n                  `,e.appendChild(r)}}initAdditionalProductsListeners(){["mc4","solarkabel","holz","quetschkabelschuhe","kabelbinder","erdungsband","huawei-opti","brc-opti","opti-qty"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{this.updateOverviewTotalPrice(),this.renderAdditionalProducts(),this.saveToCache?.()})});const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty"),n=()=>{e&&t&&i&&(i.style.display=e.checked||t.checked?"":"none",this.renderAdditionalProducts(),this.updateOverviewTotalPrice(),this.saveToCache?.())};e&&(e.addEventListener("click",()=>{e.checked&&t&&(t.checked=!1),n()}),e.addEventListener("change",n)),t&&(t.addEventListener("click",()=>{t.checked&&e&&(e.checked=!1),n()}),t.addEventListener("change",n)),i&&i.addEventListener("input",()=>{n()}),n()}editConfigName(){const e=document.getElementById("current-config-title");if(!e)return;e.parentNode.querySelectorAll(".config-title-input").forEach(e=>e.remove()),e.style.display="block";const t=document.createElement("input");t.type="text",t.value=e.textContent,t.className="config-title-input",t.style.cssText="\n                  position: absolute;\n                  top: 0;\n                  left: 0;\n                  font-size: 24px;\n                  font-weight: bold;\n                  color: #000000;\n                  background: white;\n                  border: 2px solid #FFB101;\n                  border-radius: 8px;\n                  padding: 4px 8px;\n                  width: 200px;\n                  outline: none;\n                  z-index: 1000;\n              ",e.parentNode.appendChild(t),t.focus(),t.select();const i=function(){const i=t.value.trim();i&&null!==this.currentConfig&&(this.configs[this.currentConfig].name=i,e.textContent=i,this.updateConfigList(),this.updateConfig(),this.saveToCache(),this.showAutoSaveIndicator()),t.remove()}.bind(this),n=function(){t.remove()}.bind(this);t.addEventListener("blur",i),t.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),i()):"Escape"===e.key&&(e.preventDefault(),n())})}editConfigNameInList(e){const t=this.configs[e];if(!t)return;const i=document.querySelectorAll(".config-item")[e];if(!i)return;const n=i.querySelector(".config-item-name");if(!n)return;n.parentNode.querySelectorAll('input[type="text"]').forEach(e=>e.remove()),n.style.display="block";const s=document.createElement("input");s.type="text",s.value=n.textContent,s.className="inline-edit-input",n.appendChild(s),["click","mousedown","pointerdown"].forEach(e=>{s.addEventListener(e,e=>e.stopPropagation())}),s.focus(),s.select();const o=function(){const e=s.value.trim();e&&(t.name=e,n.textContent=e,this.updateConfig(),this.saveToCache(),this.showAutoSaveIndicator()),s.parentNode&&s.remove(),this.updateConfigList()}.bind(this),l=function(){s.parentNode&&s.remove()}.bind(this);s.addEventListener("blur",o),s.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),o()):"Escape"===e.key&&(e.preventDefault(),l())})}deleteCurrentConfig(){if(this.configs.length<=1)return void alert("Die letzte Konfiguration kann nicht gel√∂scht werden.");const e=this.configs[this.currentConfig],t=e?.name||`Konfiguration #${this.currentConfig+1}`;confirm(`M√∂chten Sie "${t}" wirklich l√∂schen?`)&&(this.configs.splice(this.currentConfig,1),this.currentConfig>=this.configs.length&&(this.currentConfig=this.configs.length-1),this.loadConfig(this.currentConfig),this.showOverview())}deleteConfigFromList(e){if(this.configs.length<=1)return void alert("Die letzte Konfiguration kann nicht gel√∂scht werden.");const t=this.configs[e];confirm(`M√∂chten Sie "${t?.name||`Konfiguration #${e+1}`}" wirklich l√∂schen?`)&&(this.configs.splice(e,1),this.currentConfig>=this.configs.length?this.currentConfig=this.configs.length-1:this.currentConfig>e&&this.currentConfig--,this.loadConfig(this.currentConfig),this.updateConfigList()),event.stopPropagation()}calculateConfigPrice(e){const i={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0,UlicaSolarBlackJadeFlow:0,SolarmodulPalette:0,UlicaSolarBlackJadeFlowPalette:0};for(let t=0;t<e.rows;t++){if(!Array.isArray(e.selection[t]))continue;let n=0;for(let s=0;s<e.cols;s++)e.selection[t]?.[s]?n++:n&&(this.processGroupDirectly(n,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1),n=0);n&&this.processGroupDirectly(n,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1)}const s=!e||!1!==e.incM,o=e&&!0===e.ulicaModule;!1===s&&delete i.Solarmodul,!0!==o&&delete i.UlicaSolarBlackJadeFlow;try{const e=o?"UlicaSolarBlackJadeFlow":"Solarmodul",t=o?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",n=Number(i[e]||0);if(n>0){const s=Math.floor(n/36),o=n%36;s>0&&(i[t]=(i[t]||0)+36*s),i[e]=o}}catch(e){}let l=0;return Object.entries(i).forEach(([e,i])=>{if(i>0){const s=Math.ceil(i/(t[e]||1)),o=n(e);l+=s*o}}),l}addAllConfigsToCart(){this.addAllToCart()}setup(){if(this.cols&&this.rows||(this.cols=this.default.cols,this.rows=this.default.rows),this.cols&&this.rows){if(!Array.isArray(this.selection)||this.selection.length!==this.rows||this.selection[0]?.length!==this.cols){const e=this.selection;this.selection=Array.from({length:this.rows},(t,i)=>Array.from({length:this.cols},(t,n)=>e?.[i]?.[n]||!1))}this.listHolder&&(this.listHolder.style.display="block"),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSaveButtons()}else alert("Spalten und Zeilen m√ºssen > 0 sein")}setupAllEventListeners(){[this.wIn,this.hIn].filter(e=>e).forEach(e=>{e.removeEventListener("change",this.handleInputChange),e.addEventListener("change",this.handleInputChange.bind(this))}),this.moduleSelect&&(this.moduleSelect.removeEventListener("change",this.handleModuleSelectChange),this.moduleSelect.addEventListener("change",this.handleModuleSelectChange.bind(this))),this.orH&&this.orV&&([this.orH,this.orV].forEach(e=>{e.removeEventListener("change",this.handleOrientationChange),e.addEventListener("change",this.handleOrientationChange.bind(this))}),setTimeout(()=>{this.syncOrientationButtons()},10)),[this.incM,this.mc4,this.solarkabel,this.holz,this.quetschkabelschuhe,this.erdungsband,this.ulicaModule].filter(e=>e).forEach(e=>{e.removeEventListener("change",this.handleCheckboxChange),e.addEventListener("change",this.handleCheckboxChange.bind(this))}),document.querySelectorAll("#include-modules, #ulica-module").forEach(e=>{e.removeEventListener("change",this.handleCheckboxChange),e.addEventListener("change",this.handleCheckboxChange.bind(this))}),this.boundExpansionClick||(this.boundExpansionClick=this.handleExpansionClick.bind(this)),document.querySelectorAll('[data-dir="right"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)}),document.querySelectorAll('[data-dir="left"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)}),document.querySelectorAll('[data-dir="top"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)}),document.querySelectorAll('[data-dir="bottom"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)});const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t?(this.boundOrientationClick||(this.boundOrientationClick=this.handleOrientationButtonClick.bind(this)),[e,t].forEach(e=>{e.removeEventListener("click",this.boundOrientationClick),e.addEventListener("click",this.boundOrientationClick)}),this.syncOrientationButtons()):setTimeout(()=>{const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t&&(this.boundOrientationClick||(this.boundOrientationClick=this.handleOrientationButtonClick.bind(this)),[e,t].forEach(e=>{e.removeEventListener("click",this.boundOrientationClick),e.addEventListener("click",this.boundOrientationClick)}),this.syncOrientationButtons())},50)}ensureOrientationButtonsSync(){const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");if(!(e&&t&&this.orH&&this.orV))return;const i=t.classList.contains("active"),n=e.classList.contains("active"),s=this.orV.checked,o=this.orH.checked;i===s&&n===o||this.syncOrientationButtons()}handleModuleSelectChange(){this.trackInteraction();const e=this.moduleSelect.value;if(""===e||"custom"===e)this.enableInputs(),this.updateSize(),this.buildList(),this.updateSummaryOnChange(),this.clearModuleCheckboxes();else if(this.moduleData[e]){const t=this.moduleData[e];this.wIn.value=t.width,this.hIn.value=t.height,null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=t.width,this.configs[this.currentConfig].cellHeight=t.height),this.disableInputs(),this.updateSize(),this.buildList(),this.updateSummaryOnChange(),this.clearModuleCheckboxes()}}handleModuleCheckboxChange(e){this.trackInteraction(),"include-modules"===e&&this.incM.checked?(this.ulicaModule&&(this.ulicaModule.checked=!1),this.moduleSelect&&(this.moduleSelect.value="ulica-450",this.wIn&&(this.wIn.value="176.2"),this.hIn&&(this.hIn.value="113.4"),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=176.2,this.configs[this.currentConfig].cellHeight=113.4),this.disableInputs())):"ulica-module"===e&&this.ulicaModule.checked&&(this.incM&&(this.incM.checked=!1),this.moduleSelect&&(this.moduleSelect.value="ulica-500",this.wIn&&(this.wIn.value="195.2"),this.hIn&&(this.hIn.value="113.4"),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=195.2,this.configs[this.currentConfig].cellHeight=113.4),this.disableInputs())),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange(),this.updateConfig(),this.updateAllConfigurationsForCheckboxes()}clearModuleCheckboxes(){this.incM&&(this.incM.checked=!1),this.ulicaModule&&(this.ulicaModule.checked=!1)}handleInputChange(){this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange()}handleOrientationChange(){this.trackInteraction(),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}handleCheckboxChange(){this.trackInteraction();const e=event.target.id;"include-modules"===e||"ulica-module"===e?this.handleModuleCheckboxChange(e):this.updateAllConfigurationsForCheckboxes()}handleExpansionClick(e){this.trackInteraction();const t=e.target.dataset.dir,i=e.target.classList.contains("plus-btn");"right"===t?i?this.addColumnRight():this.removeColumnRight():"left"===t?i?this.addColumnLeft():this.removeColumnLeft():"top"===t?i?this.addRowTop():this.removeRowTop():"bottom"===t&&(i?this.addRowBottom():this.removeRowBottom())}handleOrientationButtonClick(e){const t=document.getElementById("orient-h"),i=document.getElementById("orient-v");if(!t||!i)return;if(this.orientationProcessing)return;this.orientationProcessing=!0;const n=e.currentTarget||e.target,s=n===i;t.classList.remove("active"),i.classList.remove("active"),n&&n.classList&&n.classList.add("active"),this.orV&&(this.orV.checked=s),this.orH&&(this.orH.checked=!s),this.trackInteraction(),this.updateSize(),this.buildGrid(),setTimeout(()=>{this.buildList(),this.updateSummaryOnChange(),this.orientationProcessing=!1,this.ensureOrientationButtonsSync()},10)}syncOrientationButtons(){const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t&&this.orH&&this.orV&&(e.classList.remove("active"),t.classList.remove("active"),this.orV.checked?t.classList.add("active"):this.orH.checked?e.classList.add("active"):(this.orV.checked=!0,this.orH.checked=!1,t.classList.add("active")))}disableInputs(){this.wIn&&(this.wIn.disabled=!0,this.wIn.style.backgroundColor="#f0f0f0",this.wIn.style.cursor="not-allowed"),this.hIn&&(this.hIn.disabled=!0,this.hIn.style.backgroundColor="#f0f0f0",this.hIn.style.cursor="not-allowed")}enableInputs(){this.wIn&&(this.wIn.disabled=!1,this.wIn.style.backgroundColor="",this.wIn.style.cursor=""),this.hIn&&(this.hIn.disabled=!1,this.hIn.style.backgroundColor="",this.hIn.style.cursor="")}updateSaveButtons(){this.saveBtn&&(this.saveBtn.style.display="inline-block")}addColumnRight(){this.cols+=1;for(let e of this.selection)e.push(!1);this.updateGridAfterStructureChange()}removeColumnRight(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.pop();this.updateGridAfterStructureChange()}}addColumnLeft(){this.cols+=1;for(let e of this.selection)e.unshift(!1);this.updateGridAfterStructureChange()}removeColumnLeft(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.shift();this.updateGridAfterStructureChange()}}addRowBottom(){this.rows+=1,this.selection.push(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowBottom(){this.rows<=1||(this.rows-=1,this.selection.pop(),this.updateGridAfterStructureChange())}addRowTop(){this.rows+=1,this.selection.unshift(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowTop(){this.rows<=1||(this.rows-=1,this.selection.shift(),this.updateGridAfterStructureChange())}updateGridAfterStructureChange(){this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}updateSize(){parseFloat(getComputedStyle(document.documentElement).fontSize);const e=parseFloat(this.wIn?this.wIn.value:"179")||179,t=parseFloat(this.hIn?this.hIn.value:"113")||113,i=!!this.orV&&this.orV.checked,n=i?t:e,s=i?e:t,o=this.wrapper?this.wrapper.clientWidth-160:800,l=this.wrapper?this.wrapper.clientHeight-160:600,a=o/(this.cols*n+2*(this.cols-1)),r=l/(this.rows*s+2*(this.rows-1)),c=Math.min(a,r,1),h=n*c,d=s*c,u=this.cols>=15||this.rows>=10?0:2*c;document.documentElement.style.setProperty("--cell-size",h+"px"),document.documentElement.style.setProperty("--cell-width",h+"px"),document.documentElement.style.setProperty("--cell-height",d+"px"),document.documentElement.style.setProperty("--cell-gap",u+"px");const m=Math.min(this.cols*h+(this.cols-1)*u,o),g=Math.min(this.rows*d+(this.rows-1)*u,l);this.gridEl&&(this.gridEl.style.width=m+"px",this.gridEl.style.height=g+"px")}buildGrid(){if(!Array.isArray(this.selection))return;this.gridEl&&this.gridEl.replaceChildren();const e=document.createDocumentFragment();document.documentElement.style.setProperty("--cols",this.cols),document.documentElement.style.setProperty("--rows",this.rows);for(let t=0;t<this.rows;t++)if(Array.isArray(this.selection[t]))for(let i=0;i<this.cols;i++){const n=document.createElement("div");n.className="grid-cell",this.selection[t]?.[i]&&n.classList.add("selected"),n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.setAttribute("aria-label",`Modul ${i+1}, ${t+1} - ${this.selection[t]?.[i]?"ausgew√§hlt":"nicht ausgew√§hlt"}`),n.setAttribute("aria-pressed",this.selection[t]?.[i]?"true":"false"),n.addEventListener("click",()=>{this.selection[t]||(this.selection[t]=[]),this.selection[t][i]=!this.selection[t][i],n.classList.toggle("selected"),n.setAttribute("aria-pressed",this.selection[t][i]?"true":"false"),n.setAttribute("aria-label",`Modul ${i+1}, ${t+1} - ${this.selection[t][i]?"ausgew√§hlt":"nicht ausgew√§hlt"}`),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].selection=this.selection,this.updateConfig()),this.trackInteraction(),this.buildList(),this.updateSummaryOnChange(),null!==this.currentConfig&&this.updateConfigList()}),n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())}),e.appendChild(n)}this.gridEl.appendChild(e)}async buildList(){try{this.selection.flat().filter(e=>e).length;const e={selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?.value||"179"),cellHeight:parseInt(this.hIn?.value||"113"),orientation:this.orV?.checked?"vertical":"horizontal",ulicaModule:document.getElementById("ulica-module")?.checked||!1},i={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0,UlicaSolarBlackJadeFlow:0};for(let t=0;t<e.rows;t++){if(!Array.isArray(e.selection[t]))continue;let n=0;for(let s=0;s<e.cols;s++)e.selection[t]?.[s]?n++:n&&(this.processGroupDirectly(n,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1),n=0);n&&this.processGroupDirectly(n,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1)}const o=document.getElementById("include-modules")?.checked||!1,l=document.getElementById("ulica-module")?.checked||!1;this.kabelbinder;o||delete i.Solarmodul,l||delete i.UlicaSolarBlackJadeFlow,this.erdungsband&&this.erdungsband.checked?i.Erdungsband=this.calculateErdungsband():delete i.Erdungsband,delete i.Kabelbinder,delete i.BlechBohrschrauben;try{const e=l?"UlicaSolarBlackJadeFlow":"Solarmodul",t=l?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",n=Number(i[e]||0);if(n>0){const s=Math.floor(n/36),o=n%36;s>0&&(i[t]=(i[t]||0)+36*s),i[e]=o}}catch(e){}const a=Object.entries(i).filter(([,e])=>e>0);if(!a.length)return void(this.listHolder&&(this.listHolder.style.display="none"));if(this.listHolder&&(this.listHolder.style.display="block"),this.prodList){const e=document.createDocumentFragment();a.forEach(([i,o])=>{const l=Math.ceil(o/t[i]),a=l*n(i),r=document.createElement("div");r.className="produkt-item";let c=`(${o})`,h=`${t[i]} St√ºck`;"Erdungsband"===i&&this.erdungsbandtotal&&(c=`(${Number(this.erdungsbandtotal).toFixed(2)} cm)`,h="600 cm"),"Solarkabel"===i&&(h="100 m"),"MC4_Stecker"===i&&(h=`${t[i]} St√ºck`),r.innerHTML=`\n              <div class="item-left">\n                <span class="item-quantity">${l}√ó</span>\n                <div class="item-info">\n                  <span class="item-name">${s[i]||i.replace(/_/g," ")}</span>\n                  <span class="item-ve">${h}</span>\n                </div>\n                <span class="item-details">${c}</span>\n              </div>\n              <span class="item-price">${a.toFixed(2).replace(".",",")} ‚Ç¨</span>\n            `,e.appendChild(r)}),this.prodList&&(this.prodList.replaceChildren(),this.prodList.appendChild(e),this.prodList.style.display="block")}this.updateCurrentTotalPrice()}catch(e){this.listHolder&&(this.listHolder.style.display="none")}}resetGridToDefault(){const{cols:e,rows:t,width:i,height:n}=this.default;this.wIn.value=i,this.hIn.value=n;const s=!0;this.orH&&(this.orH.checked=!1),this.orV&&(this.orV.checked=s);const o=document.getElementById("orient-h-setup"),l=document.getElementById("orient-v-setup");o&&l&&(o.checked=!1,l.checked=s),this.incM&&(this.incM.checked=!1),this.mc4&&(this.mc4.checked=!1),this.solarkabel&&(this.solarkabel.checked=!1),this.holz&&(this.holz.checked=!1),this.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=!1),this.kabelbinder&&(this.kabelbinder.checked=!1),this.erdungsband&&(this.erdungsband.checked=!1),this.ulicaModule&&(this.ulicaModule.checked=!1);try{const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty");e&&(e.checked=!1,e.dispatchEvent(new Event("change"))),t&&(t.checked=!1,t.dispatchEvent(new Event("change"))),i&&(i.value="1")}catch(e){}this.moduleSelect&&(this.moduleSelect.value="",this.enableInputs()),this.cols=e,this.rows=t,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}resetToDefaultGrid(){this.colsIn&&(this.colsIn.value=this.default.cols),this.rowsIn&&(this.rowsIn.value=this.default.rows),this.wIn&&(this.wIn.value=this.default.width),this.hIn&&(this.hIn.value=this.default.height),this.orH&&(this.orH.checked=!1),this.orV&&(this.orV.checked=!0),this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup()}async calculateParts(){return this.calculatePartsSync()}calculatePartsSync(){const e={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0,Erdungsband:0};for(let t=0;t<this.rows;t++){if(!Array.isArray(this.selection[t]))continue;let i=0;for(let n=0;n<this.cols;n++)this.selection[t]?.[n]?i++:i&&(this.processGroup(i,e),i=0);i&&this.processGroup(i,e)}return this.erdungsband&&this.erdungsband.checked&&(e.Erdungsband=this.calculateErdungsband()),e.Tellerkopfschraube=2*(e.Dachhaken||0),e}processGroup(e,t){const i=this.orV?.checked,n=e*(i?parseFloat(this.hIn?.value||"113"):parseFloat(this.wIn?.value||"179")),s=Math.floor(n/360),o=n-360*s,l=[{cnt360:s,cnt240:Math.ceil(o/240)},{cnt360:Math.ceil(n/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(n/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-n})),a=Math.min(...l.map(e=>e.rails)),r=l.filter(e=>e.rails===a).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:c,cnt240:h}=r;t.Schiene_360_cm+=2*c,t.Schiene_240_cm+=2*h,t.Schienenverbinder+=4*(c+h-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,this.ulicaModule&&this.ulicaModule.checked&&(t.UlicaSolarBlackJadeFlow+=e),t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=0}mapImage(e){return o[e]||""}calculateErdungsband(){const e=this.orV?.checked,t=e?parseFloat(this.wIn?.value||"179"):parseFloat(this.hIn?.value||"113"),i=this.selection.map(e=>[...e]);let n=0;for(let e=0;e<this.rows;e++)for(let s=0;s<this.cols;s++){n+=this.analyzeFieldForErdungsband(s,e,i,t,2)}return this.erdungsbandtotal=n,Math.ceil(n/600)}analyzeFieldForErdungsband(e,t,i,n,s){return i[t]?.[e]?t+1>=this.rows||!i[t+1]?.[e]?0:0!==e&&i[t]?.[e-1]?t+1>=this.rows||!i[t+1]?.[e-1]?this.assignErdungsbandLength(e,t,i,n,s):this.checkLeftFieldsErdungsband(e,t,i,n,s):this.assignErdungsbandLength(e,t,i,n,s):0}checkLeftFieldsErdungsband(e,t,i,n,s){const o=i[t]?.[e-1],l=i[t+1]?.[e-1];return o&&l?"erdungsband"===o&&"erdungsband"===l?0:"erdungsband"===o&&"erdungsband"!==l?this.assignErdungsbandLength(e,t,i,n,s):this.checkLeftFieldsRecursive(e,t,i,n,s):this.assignErdungsbandLength(e,t,i,n,s)}checkLeftFieldsRecursive(e,t,i,n,s){let o=e-2;for(;o>=0;){if(!i[t]?.[o])return this.assignErdungsbandLength(e,t,i,n,s);if(t+1>=this.rows||!i[t+1]?.[o])return this.assignErdungsbandLength(e,t,i,n,s);const l=i[t]?.[o],a=i[t+1]?.[o];if("erdungsband"===l&&"erdungsband"===a)return 0;if("erdungsband"===l&&"erdungsband"!==a)return this.assignErdungsbandLength(e,t,i,n,s);o--}return this.assignErdungsbandLength(e,t,i,n,s)}assignErdungsbandLength(e,t,i,n,s){return"erdungsband"===i[t][e]?(i[t+1][e]="erdungsband",n+s):(i[t][e]="erdungsband",i[t+1][e]="erdungsband",2*n+s)}loadConfig(e){const t=this.configs[e];this.currentConfig=e,this.wIn.value=t.cellWidth,this.hIn.value=t.cellHeight,this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.syncOrientationButtons(),this.incM.checked=t.incM,this.erdungsband&&(this.erdungsband.checked=t.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=t.ulicaModule||!1),this.cols=t.cols,this.rows=t.rows,this.selection=t.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView(),this.updateOverviewTotalPrice()}loadConfigFromCache(e){const t=this.configs[e];this.currentConfig=e,this.wIn.value=t.cellWidth,this.hIn.value=t.cellHeight,this.orV&&this.orH&&"string"==typeof t.orientation&&(this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.syncOrientationButtons?.()),this.incM.checked=t.incM,this.erdungsband&&(this.erdungsband.checked=t.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=t.ulicaModule||!1),this.cols=t.cols,this.rows=t.rows,this.selection=t.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView(),this.updateOverviewTotalPrice()}loadFirstConfigFromCache(){if(0===this.configs.length)return;const e=this.configs[0];this.currentConfig=0,this.wIn.value=e.cellWidth,this.hIn.value=e.cellHeight,this.orV&&this.orH&&"string"==typeof e.orientation&&(this.orV.checked="vertical"===e.orientation,this.orH.checked=!this.orV.checked,this.syncOrientationButtons?.()),this.incM.checked=e.incM,this.mc4.checked=e.mc4,this.solarkabel.checked=e.solarkabel||!1,this.holz.checked=e.holz,this.quetschkabelschuhe.checked=e.quetschkabelschuhe||!1,this.erdungsband&&(this.erdungsband.checked=e.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=e.ulicaModule||!1),this.cols=e.cols,this.rows=e.rows,this.selection=e.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView(),this.updateOverviewTotalPrice()}updateFirstConfigOrientation(e){this.configs.length>0&&(this.configs[0].orientation=e)}showToast(e="Gespeichert",t=1500){const i=document.getElementById("toast");i&&(i.textContent=e,i.classList.remove("hidden"),clearTimeout(this.toastTimeout),this.toastTimeout=setTimeout(()=>{i.classList.add("hidden")},t))}saveNewConfig(e=null){null!==this.currentConfig&&this.updateConfig(),this.currentConfig=null,this.orH&&this.orV&&(this.orH.checked=!1,this.orV.checked=!0,this.syncOrientationButtons?.());const t=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1));this.selection;this.selection=t;const i=this._makeConfigObject(e);this.configs.push(i),this.currentConfig=this.configs.length-1,this.setup(),this.showDetailView(this.currentConfig),this.renderConfigList(),this.updateConfigList(),this.updateSaveButtons(),this.updateDetailView(),this.showToast(`Neue Konfiguration "${i.name}" erstellt`)}renameCurrentConfig(e){if(null!==this.currentConfig&&this.currentConfig>=0&&this.currentConfig<this.configs.length){this.configs[this.currentConfig].name=e;const t=document.getElementById("current-config-title");if(t&&(t.textContent=e),this.configListEl){const t=this.configListEl.querySelectorAll(".config-item");if(t&&t[this.currentConfig]){const i=t[this.currentConfig].querySelector(".config-item-name");i&&(i.textContent=e)}}this.renderConfigList(),this.updateSaveButtons(),this.updateConfig(),this.saveToCache(),this.showAutoSaveIndicator()}}updateConfig(){const e=this.currentConfig;this.configs[e]=this._makeConfigObject(),this.renderConfigList(),this.updateSaveButtons(),this.updateCurrentTotalPrice()}deleteConfig(e){const t=this.configs[e].name;if(confirm(`Willst du "${t}" wirklich l√∂schen?`)){if(this.configs.splice(e,1),this.configs.length>0)if(e===this.currentConfig){const t=Math.min(e,this.configs.length-1);this.loadConfig(t)}else e<this.currentConfig?(this.currentConfig--,this.renderConfigList()):this.renderConfigList();else this.createNewConfig();this.updateSaveButtons()}}createNewConfig(){this.currentConfig=null;const e=this.cols,t=this.rows,i=Array.from({length:t},()=>Array.from({length:e},()=>!1));this.selection;this.selection=i;const n=this._makeConfigObject();this.configs.push(n),this.currentConfig=this.configs.length-1,this.setup(),this.renderConfigList(),this.updateSaveButtons()}_makeConfigObject(e=null){let t;if(e)t=e;else if(null!==this.currentConfig)t=this.configs[this.currentConfig].name;else{let e=1;for(;this.configs.some(t=>t.name===`Konfiguration ${e}`);)e++;t=`Konfiguration ${e}`}return{name:t,selection:this.selection.map(e=>[...e]),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",incM:this.incM&&this.incM.checked,mc4:this.mc4&&this.mc4.checked,solarkabel:this.solarkabel&&this.solarkabel.checked,holz:this.holz&&this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,kabelbinder:this.kabelbinder&&this.kabelbinder.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked,cols:this.cols,rows:this.rows,cellWidth:parseFloat(this.wIn?this.wIn.value:"179"),cellHeight:parseFloat(this.hIn?this.hIn.value:"113")}}renderConfigList(){this.configListEl&&this.configListEl.replaceChildren(),this.configs.forEach((e,t)=>{const i=document.createElement("div");i.className="config-item"+(t===this.currentConfig?" active":"");const n=this.calculateConfigPrice(e),s=this.configs.length>=2;i.innerHTML=`\n            <div class="config-item-info">\n              <div class="config-item-name">${e.name||`Konfiguration #${t+1}`}</div>\n              <div class="config-item-price">${n.toFixed(2).replace(".",",")} ‚Ç¨</div>\n            </div>\n            <div class="config-item-actions">\n              <button class="icon-btn" onclick="solarGrid.editConfigNameInList(${t})" title="Bearbeiten">\n                <img src="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/689369877a18221f25a4b743_Pen.png" alt="Bearbeiten" style="width: 16px; height: 16px;">\n              </button>\n              ${s?`\n              <button class="icon-btn delete" onclick="solarGrid.deleteConfigFromList(${t})" title="L√∂schen">\n                <img src="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/68936c5481f2a4db850a01f5_Trashbin.png" alt="L√∂schen" style="width: 16px; height: 16px;">\n              </button>`:""}\n              <div class="config-item-arrow">\n                <img src="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/68936986bd441749c46190e8_ChevronRight.png" alt="Pfeil" style="width: 10px; height: 16px;">\n              </div>\n            </div>\n          `,i.addEventListener("click",e=>{e.target.closest(".config-item-actions")||(null!==this.currentConfig&&this.currentConfig!==t&&this.updateConfig(),this.showDetailView(t),this.showToast("Konfiguration geladen",1e3))}),this.configListEl.appendChild(i)})}arraysEqual(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++){if(e[i].length!==t[i].length)return!1;for(let n=0;n<e[i].length;n++)if(e[i][n]!==t[i][n])return!1}return!0}updateSummaryOnChange(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(async()=>{this.showAutoSaveIndicator(),document.getElementById("config-detail-view")?.classList.contains("active")&&this.updateDetailView();try{null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=parseFloat(this.wIn?this.wIn.value:"179"),this.configs[this.currentConfig].cellHeight=parseFloat(this.hIn?this.hIn.value:"113"),this.configs[this.currentConfig].cols=this.cols,this.configs[this.currentConfig].rows=this.rows)}catch(e){}try{this.recomputeTotalsDebounced&&this.recomputeTotalsDebounced()}catch(e){}try{const e=this.totalPartsCache||this.computeAllTotalsSnapshot();this.saveTotalsToCache(e)}catch(e){}this.updateCurrentTotalPrice(),this.updateOverviewTotalPrice(),null!==this.currentConfig&&(this.updateConfig(),this.updateConfigList()),this.saveToCache(),this.updateTimeout=null},this.updateDelay)}calculatePartsDirectly(e){const{selection:t,rows:i,cols:n,cellWidth:s,cellHeight:o,orientation:l,options:a}=e,r=!0===a?.ulicaModule,c={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let a=0;a<n;a++)t[e]?.[a]?i++:i&&(this.processGroupDirectly(i,c,s,o,l,r),i=0);i&&this.processGroupDirectly(i,c,s,o,l,r)}return c}processGroupDirectly(e,t,i,n,s,o=!1){const l=e*("vertical"===s?n:i),a=Math.floor(l/360),r=l-360*a,c=[{cnt360:a,cnt240:Math.ceil(r/240)},{cnt360:Math.ceil(l/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(l/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-l})),h=Math.min(...c.map(e=>e.rails)),d=c.filter(e=>e.rails===h).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:u,cnt240:m}=d;t.Schiene_360_cm+=2*u,t.Schiene_240_cm+=2*m,t.Schienenverbinder+=4*(u+m-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,o&&(t.UlicaSolarBlackJadeFlow+=e),t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}resetAllConfigurations(){if(confirm("M√∂chten Sie wirklich alle Konfigurationen l√∂schen und von vorne anfangen?")){this.cacheManager.clearCache(),this.configs=[],this.currentConfig=null,this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.buildGrid(),this.wIn&&(this.wIn.value=this.default.width),this.hIn&&(this.hIn.value=this.default.height),this.incM&&(this.incM.checked=!1),this.mc4&&(this.mc4.checked=!1);try{const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty");e&&(e.checked=!1),t&&(t.checked=!1),i&&(i.value="1")}catch(e){}this.solarkabel&&(this.solarkabel.checked=!1),this.holz&&(this.holz.checked=!1),this.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=!1),this.kabelbinder&&(this.kabelbinder.checked=!1),this.erdungsband&&(this.erdungsband.checked=!1),this.ulicaModule&&(this.ulicaModule.checked=!1),this.moduleSelect&&(this.moduleSelect.value="",this.enableInputs()),this.createNewConfig();try{const e=document.getElementById("additional-products-list");e&&e.replaceChildren()}catch(e){}this.updateCurrentTotalPrice(),this.updateOverviewTotalPrice&&this.updateOverviewTotalPrice(),this.showToast("Alle Konfigurationen wurden zur√ºckgesetzt",2e3)}}saveToCache(){try{this.manageCacheSize();const e=e=>{if(!Array.isArray(e))return e;return e.reduce((e,t)=>e+(Array.isArray(t)?t.length:0),0)<=100?e.slice():e.map(e=>Array.isArray(e)?e.slice():e)},t=t=>({...t,selection:e(t.selection)}),i={configs:Array.isArray(this.configs)?this.configs.map(t):[],currentConfig:this.currentConfig,selection:e(this.selection),cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",includeModules:!!this.incM&&this.incM.checked,mc4:!!this.mc4&&this.mc4.checked,solarkabel:!!this.solarkabel&&this.solarkabel.checked,holz:!!this.holz&&this.holz.checked,quetschkabelschuhe:!!this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,kabelbinder:!!this.kabelbinder&&this.kabelbinder.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked,huaweiOpti:document.getElementById("huawei-opti")?.checked||!1,brcOpti:document.getElementById("brc-opti")?.checked||!1,optiQty:parseInt(document.getElementById("opti-qty")?.value||"1",10),moduleSelectValue:this.moduleSelect?this.moduleSelect.value:"",gridStructure:{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10)}};this.cacheManager.saveData(i),this.showAutoSaveIndicator()}catch(e){console.error("Fehler beim Speichern des Caches:",e)}}loadFromCache(){try{const e=this.cacheManager.loadData();if(!e)return console.log("Kein Cache gefunden oder Cache abgelaufen"),!1;if(!this.cacheManager.isLocalStorageAvailable())return this.showToast("Es wurde nichts im Speicher gefunden",3e3),!1;if(e.configs&&Array.isArray(e.configs)){const t=e=>Array.isArray(e)?e.map(e=>Array.isArray(e)?e.slice():e):e,i=e=>({...e,selection:t(e.selection)});this.configs=e.configs.map(i),this.currentConfig=e.currentConfig,e.selection&&Array.isArray(e.selection)&&(this.selection=e.selection.map(e=>Array.isArray(e)?e.slice():e)),e.cols&&e.rows&&(this.cols=e.cols,this.rows=e.rows),this.incM&&"boolean"==typeof e.includeModules&&(this.incM.checked=e.includeModules),this.mc4&&"boolean"==typeof e.mc4&&(this.mc4.checked=e.mc4),this.solarkabel&&"boolean"==typeof e.solarkabel&&(this.solarkabel.checked=e.solarkabel),this.holz&&"boolean"==typeof e.holz&&(this.holz.checked=e.holz),this.quetschkabelschuhe&&"boolean"==typeof e.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=e.quetschkabelschuhe),this.kabelbinder&&"boolean"==typeof e.kabelbinder&&(this.kabelbinder.checked=e.kabelbinder),this.erdungsband&&"boolean"==typeof e.erdungsband&&(this.erdungsband.checked=e.erdungsband),this.ulicaModule&&"boolean"==typeof e.ulicaModule&&(this.ulicaModule.checked=e.ulicaModule);try{const t=this.getCachedElement("huaweiOpti","huawei-opti"),i=this.getCachedElement("brcOpti","brc-opti"),n=this.getCachedElement("optiQty","opti-qty");t&&"boolean"==typeof e.huaweiOpti&&(t.checked=e.huaweiOpti),i&&"boolean"==typeof e.brcOpti&&(i.checked=e.brcOpti),n&&"number"==typeof e.optiQty&&(n.value=String(Math.max(1,e.optiQty))),n&&(n.style.display=t&&t.checked||i&&i.checked?"":"none")}catch(e){}this.moduleSelect&&"string"==typeof e.moduleSelectValue&&(this.moduleSelect.value=e.moduleSelectValue,e.moduleSelectValue&&"custom"!==e.moduleSelectValue?this.disableInputs():this.enableInputs()),this.wIn&&e.cellWidth&&(this.wIn.value=e.cellWidth),this.hIn&&e.cellHeight&&(this.hIn.value=e.cellHeight);const n=Number.isInteger(e.currentConfig)&&e.currentConfig>=0&&e.currentConfig<this.configs.length?e.currentConfig:0;return this.configs.length>0&&this.loadConfigFromCache(n),this.setup(),this.buildGrid(),this.buildList(),this.setupAllEventListeners(),this.updateConfigList(),this.updateCurrentTotalPrice(),this.updateOverviewTotalPrice(),this.showToast("Konfiguration aus Cache geladen",2e3),!0}}catch(e){console.error("Fehler beim Laden des Caches:",e),this.cacheManager.clearCache(),this.showToast("Datei im Speicher ist besch√§digt und konnte nicht geladen werden!",3e3)}return!1}generateHiddenCartForms(){this.hideWebflowForms()}hideWebflowForms(){document.querySelectorAll('form[data-node-type="commerce-add-to-cart-form"]').forEach(e=>{e&&e.style&&(e.style.cssText="\n              position: absolute !important;\n              left: -9999px !important;\n              top: -9999px !important;\n              width: 1px !important;\n              height: 1px !important;\n              overflow: hidden !important;\n              clip: rect(0, 0, 0, 0) !important;\n              white-space: nowrap !important;\n              border: 0 !important;\n              margin: 0 !important;\n              padding: 0 !important;\n              visibility: hidden !important;\n            ",e.setAttribute("aria-hidden","true"),e.setAttribute("tabindex","-1"))})}initFoxyFormMap(){this.foxyFormsByName=new Map;let e=15;const t=()=>{this.refreshFoxyFormMap(),0===this.foxyFormsByName.size&&e-- >0&&setTimeout(t,300)};t();try{this._foxyObserver&&this._foxyObserver.disconnect()}catch(e){}this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);let i=0;const n=()=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.refreshFoxyFormMap(),60)};this._foxyObserver=new MutationObserver(e=>{const t=Date.now();if(!(t-i<100)){i=t;for(const t of e)if(t.addedNodes&&t.addedNodes.length){n();break}}}),this._foxyObserver.observe(document.body,{childList:!0,subtree:!0})}refreshFoxyFormMap(){const e=new Map,t=new Map;document.querySelectorAll('form[action*="foxycart.com/cart"]').forEach(i=>{const n=e=>{const t=i.querySelector(e);return t&&"string"==typeof t.value?t.value.trim():""},s=i.querySelector('input[name="name"]'),o=s&&"string"==typeof s.value?s.value.trim():"";o&&(e.set(o,i),t.set(o,{name:o,price:n('input[name="price"]'),code:n('input[name="code"]'),image:n('input[name="image"]'),url:n('input[name="url"]'),description:n('input[name="description"]'),weight:n('input[name="weight"]'),width:n('input[name="width"]'),height:n('input[name="height"]'),length:n('input[name="length"]'),discount_price_amount:n('input[name="discount_price_amount"]')}))}),this.foxyFormsByName=e,this.foxyDataByName=t,console.log(`[Foxy Debug] Formular-Map aktualisiert: ${e.size} Formulare gefunden`)}findFoxyFormByName(e){const t=String(e||"").trim();if(!t)return null;const i=e=>e.replace(/[\u2013\u2014]/g,"-").replace(/\s+/g," ").trim().toLowerCase();if(this.foxyFormsByName&&this.foxyFormsByName.has(t))return this.foxyFormsByName.get(t);try{const e=`form[action*="foxycart.com/cart"] input[name="name"][value="${CSS.escape(t)}"]`,i=document.querySelector(e);if(i)return i.closest("form")}catch(e){}const n=document.querySelectorAll('form[action*="foxycart.com/cart"]'),s=i(t);let o=null;return n.forEach(e=>{const t=e.querySelector('input[name="name"]')?.value;t&&(i(t)!==s||o||(o=e))}),o||(n.forEach(e=>{if(o)return;const t=e.querySelector('input[name="name"]')?.value;t&&i(t).includes(s)&&(o=e)}),o)}addProductToCart(e,t){if(!e||""===e.trim())return void console.warn("[SolarGrid] Leerer productKey √ºbersprungen");const i=s[e]||e.replace(/_/g," ");if(!i||""===i.trim())return void console.warn("[SolarGrid] Leerer displayName √ºbersprungen f√ºr productKey:",e);const o=this.findFoxyFormByName?this.findFoxyFormByName(i):null;if(!o)try{this._ensureFoxySilentTarget();const s=document.createElement("form");s.action="https://unterkonstruktion.foxycart.com/cart",s.method="POST",s.target="foxy_silent",s.style.position="absolute",s.style.left="-9999px",s.style.top="-9999px";const o=n(e);return s.innerHTML=`\n              <input type="hidden" name="name" value="${i}">\n              <input type="hidden" name="price" value="${Number(o).toFixed(2)}">\n              <input type="hidden" name="code" value="">\n              <input type="hidden" name="quantity" value="${Math.max(1,parseInt(t,10)||1)}">\n            `,document.body.appendChild(s),s.submit(),void setTimeout(()=>{try{s.remove()}catch(e){}},2e3)}catch(e){return void console.warn(`[SolarGrid] Foxy-Fallback fehlgeschlagen f√ºr '${i}':`,e)}try{const e=o.querySelector('input[name="quantity"]');e&&(e.value=Math.max(1,parseInt(t,10)||1));const i=o.querySelector('input[name="customer_type"]');try{const e=localStorage.getItem("solarTool_customerType");if(i&&e){const t=JSON.parse(e),n=t&&t.type?String(t.type):"";n&&(i.value=n)}}catch(e){}const n=o.querySelector("button[data-fc-add-to-cart]")||o.querySelector('button[type="submit"]');"function"==typeof o.requestSubmit?o.requestSubmit(n||void 0):n&&n.click()||o.submit()}catch(e){console.warn("[SolarGrid] Foxy-Submit Fehler:",e)}}_ensureFoxySilentTarget(){try{let e=document.getElementById("foxy_silent");e||(e=document.createElement("iframe"),e.name="foxy_silent",e.id="foxy_silent",e.width="1",e.height="1",e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",e.setAttribute("aria-hidden","true"),e.setAttribute("tabindex","-1"),document.body.appendChild(e))}catch(e){}}async _waitForFoxyIframeAck(e=2500){return new Promise(t=>{try{const i=document.getElementById("foxy_silent");if(!i)return t(!1);let n=!1;const s=()=>{n||(n=!0,t(!0))};i.addEventListener("load",s,{once:!0}),setTimeout(()=>{n||(n=!0,t(!1))},e)}catch(e){t(!1)}})}clickWebflowButtonSafely(e,t,i,n,s){const o=e.querySelector('input[name="commerce-add-to-cart-quantity-input"]');o&&(o.value=n);try{e.querySelectorAll("select[required]").forEach(e=>{if(!e.value){const t=e.querySelector('option[value]:not([value=""])');t&&(e.value=t.value)}})}catch(e){}t.click()}addPartsListToCart(e){let i=this.loadTotalsFromCache()||null;if(!i)try{i=this.computeAllTotalsSnapshot(),this.saveTotalsToCache(i)}catch(t){i=e||{}}const o=Object.entries(i).filter(([e,t])=>t>0).sort(([e],[t])=>e.localeCompare(t));if(o.length){try{this.showLoading("Warenkorb wird bef√ºllt‚Ä¶")}catch(e){}const e=e=>{const t="string"==typeof e?e.replace(/[^0-9.,-]/g,"").replace(/,/g,"."):String(e||""),i=parseFloat(t);return Number.isFinite(i)?i.toFixed(2):"0.00"},i=e=>new Promise(t=>setTimeout(t,e));return void(async()=>{const l=e=>this.foxyDataByName&&this.foxyDataByName.get(e);this.foxyDataByName&&this.foxyDataByName.size>0?(console.log(`[Foxy Debug] Verf√ºgbare Produkte in Formular-Map (${this.foxyDataByName.size}):`),this.foxyDataByName.forEach((e,t)=>{console.log(`  - ${t}${e.discount_price_amount?" (mit Mengenrabatt)":""}`)})):console.warn("[Foxy Debug] WARNUNG: Keine Formulare in foxyDataByName gefunden!"),console.log(`[Foxy Debug] Starte Hinzuf√ºgen von ${o.length} Produkten...`);for(const[a,r]of o){const o=t[a]||1,c=Number(r)||0;if(c<=0){await i(200);continue}const h=c>o?Math.ceil(c/o):Math.max(1,Math.ceil(c));if(!h||h<=0){await i(200);continue}if(!a||""===a.trim()){await i(200);continue}const d=s[a]||a.replace(/_/g," ");if(!d||""===d.trim()){await i(200);continue}const u=l(d)||{};u&&0!==Object.keys(u).length||console.warn(`[Foxy Debug] ‚ö† Keine Formular-Daten f√ºr "${d}" gefunden ‚Äì verwende Fallback-Preis`);const m=u.price?e(u.price):e(n(a));console.log(`[Foxy Debug] Link-Produkt ${a}:`,{displayName:d,price:m,packs:h,hasDiscount:!!u.discount_price_amount,meta:u});const g=new URLSearchParams;g.append("name",d),g.append("price",m),g.append("quantity",String(h)),u.code&&g.append("code",u.code),u.image&&g.append("image",u.image),u.url&&g.append("url",u.url),u.description&&g.append("description",u.description),u.weight&&g.append("weight",u.weight),u.width&&g.append("width",u.width),u.height&&g.append("height",u.height),u.length&&g.append("length",u.length),u.discount_price_amount&&g.append("discount_price_amount",u.discount_price_amount),u.coupon&&g.append("coupon",u.coupon);const p=`https://unterkonstruktion.foxycart.com/cart?${g.toString()}`;console.log(`[Foxy Debug] GET-URL: ${p}`),console.log(`[Foxy Debug] SENDEN: ${d} - Pack-Menge: ${h}`);const f=document.createElement("a");f.href=p,f.style.position="absolute",f.style.left="-9999px",f.style.top="-9999px",f.style.visibility="hidden",document.body.appendChild(f);try{f.click(),console.log(`[Foxy Debug] ‚úì LINK GESENDET: ${d} ‚Äì Menge ${h}`)}catch(e){console.error(`[Foxy Debug] ‚úó Link-Klick Fehler f√ºr ${d}:`,e)}try{f.remove()}catch(e){}await i(500)}try{this.hideLoading()}catch(e){}console.log("[Foxy Debug] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("[Foxy Debug] ZUSAMMENFASSUNG - Gesendete Produkte:");for(const[e,i]of o){const n=Math.max(0,Math.floor(Number(i))),o=t[e]||1,a="Solarmodul"===e||"UlicaSolarBlackJadeFlow"===e,r="SolarmodulPalette"===e||"UlicaSolarBlackJadeFlowPalette"===e?Math.floor(n/o):a?n:Math.ceil(n/o);if(r>0){const t=s[e]||e.replace(/_/g," "),i=!!(l(t)||{}).discount_price_amount;console.log(`[Foxy Debug]   ‚úì ${t}: ${r} St√ºck${i?" (mit Mengenrabatt)":""}`)}}console.log("[Foxy Debug] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("[Foxy Debug] Bitte vergleiche diese Mengen mit dem Warenkorb!")})()}}async addSingleItemAndWait(e,t,i){console.warn("[Legacy] addSingleItemAndWait() aufgerufen - sollte nicht mehr verwendet werden")}async ensureCartObservers(){if(!this.cartAckObserver){const e=document.querySelector(".w-commerce-commercecartlist")||document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(this.cartAckObserver=new MutationObserver(()=>{if(this.cartAckResolve){const e=this.cartAckResolve;this.cartAckResolve=null,e()}}),this.cartAckObserver.observe(e,{childList:!0,subtree:!0}))}}waitForCartAcknowledge(e=1500){return new Promise(t=>{let i=!1;const n=setTimeout(()=>{i||(i=!0,this.cartAckResolve===t&&(this.cartAckResolve=null),t())},e);this.cartAckResolve=()=>{i||(i=!0,clearTimeout(n),t())}})}hideCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(e.style.display="none",e.classList.add("st-cart-hidden"))}showCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");if(e){e.style.display="",e.classList.remove("st-cart-hidden");try{const e=()=>{try{const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");if(!e)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;if(document.body&&document.body.classList&&(document.body.classList.contains("w-commerce-commercecartopen")||document.body.classList.contains("wf-commerce-cart-open")))return!0;const i=e.querySelector('[role="dialog"], .w-commerce-commercecartcontainer');if(i){const e=window.getComputedStyle(i);if("none"!==e.display&&"hidden"!==e.visibility)return!0}return!1}catch(e){return!1}},t=e=>{if(!e)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;if(e.disabled)return!1;let i=e;for(;i;){const e=window.getComputedStyle(i);if("none"===e.display||"hidden"===e.visibility)return!1;i=i.parentElement}return null!==e.offsetParent||e.getClientRects().length>0},i=(n=0)=>{if(e())return;const s=['[data-node-type="commerce-cart-open-link"]',".w-commerce-commercecartopenlink",'[data-node-type*="cart-open"], [data-node-type*="commerce-cart-open"]','a[href="#cart"]'].join(","),o=Array.from(document.querySelectorAll(s)),l=o.find(t)||o[0]||null;if(l&&"function"==typeof l.click)return l.click(),void setTimeout(()=>{},0);n<8&&setTimeout(()=>i(n+1),160)};setTimeout(()=>i(0),80)}catch(e){}}}async addCurrentToCart(){try{this.showLoading("PDF wird erstellt und Warenkorb wird bef√ºllt‚Ä¶");const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked,!!this.kabelbinder&&this.kabelbinder.checked,!!this.erdungsband&&this.erdungsband.checked,!!this.ulicaModule&&this.ulicaModule.checked),t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return this.showToast("Keine Produkte ausgew√§hlt ‚ö†Ô∏è",2e3),void this.hideLoading();this.sendCurrentConfigToWebhook().then(e=>{});try{const t=this.getCachedElement("huaweiOpti","huawei-opti"),i=this.getCachedElement("brcOpti","brc-opti"),n=this.getCachedElement("optiQty","opti-qty");if(t&&i&&n&&(t.checked||i.checked)){const t=Math.max(1,parseInt(n.value||"1",10));i.checked?e.BRCOpti=(e.BRCOpti||0)+t:e.HuaweiOpti=(e.HuaweiOpti||0)+t}}catch(e){}this.addPartsListToCart(e),this.showToast(`${t} Produkte werden zum Warenkorb hinzugef√ºgt...`,3e3),this.pdfGenerator&&this.pdfGenerator.isAvailable()&&setTimeout(()=>{this.pdfGenerator.generatePDF("current")},500)}catch(e){this.showToast("Fehler beim Berechnen der Produkte ‚ùå",2e3),this.hideLoading()}}async addAllToCart(){return this.simpleCartQueue||(this.simpleCartQueue=new c),await this.simpleCartQueue.execute(async()=>{try{this.showLoading("PDF wird erstellt und Warenkorb wird bef√ºllt‚Ä¶");const e=this.createConfigSnapshot();this.pdfGenerator&&this.pdfGenerator.isAvailable()&&(this.showToast("PDF wird erstellt...",2e3),await this.pdfGenerator.generatePDFFromSnapshot(e),this.showToast("PDF erfolgreich erstellt",1500));const t=await Promise.all(this.configs.map(async(e,t)=>{const i=t===this.currentConfig?await this._buildPartsFor(this.selection,!1!==(this.incM&&this.incM.checked),this.mc4&&this.mc4.checked,this.solarkabel&&this.solarkabel.checked,this.holz&&this.holz.checked,this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,!!this.kabelbinder&&this.kabelbinder.checked,!!this.erdungsband&&this.erdungsband.checked,!!this.ulicaModule&&this.ulicaModule.checked):await this._buildPartsFor(e.selection,!1!==e.incM,!!e.mc4,!!e.solarkabel,!!e.holz,!!e.quetschkabelschuhe,!!e.kabelbinder,!!e.erdungsband,!!e.ulicaModule);return delete i.MC4_Stecker,delete i.Solarkabel,delete i.Holzunterleger,delete i.Ringkabelschuhe,delete i.Kabelbinder,delete i.BlechBohrschrauben,delete i.Erdungsband,i}));if(null===this.currentConfig&&0===this.configs.length){const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked,!!this.kabelbinder&&this.kabelbinder.checked,!!this.erdungsband&&this.erdungsband.checked,!!this.ulicaModule&&this.ulicaModule.checked);t.push(e)}const i={};t.forEach(e=>{Object.entries(e).forEach(([e,t])=>{i[e]=(i[e]||0)+t})}),this.bundleTotalModulesIntoPallets(i);try{const e=this.readExtrasFromSummaryList();Object.entries(e).forEach(([e,t])=>{t>0&&(i[e]=t),"MC4_Stecker"===e&&t>0&&(i[e]=1)})}catch(e){}try{const e=this.getCachedElement("huaweiOpti","huawei-opti"),t=this.getCachedElement("brcOpti","brc-opti"),n=this.getCachedElement("optiQty","opti-qty");if(e&&t&&n&&(e.checked||t.checked)){const e=Math.max(1,parseInt(n.value||"1",10));t.checked?i.BRCOpti=(i.BRCOpti||0)+e:i.HuaweiOpti=(i.HuaweiOpti||0)+e}}catch(e){}const n=Object.values(i).reduce((e,t)=>e+t,0);if(0===n)return void this.showToast("Keine Konfigurationen vorhanden ‚ö†Ô∏è",2e3);await this.sendAllConfigsToWebhook();this.addPartsListToCart(i),this.showToast(`${n} Produkte aus allen Konfigurationen werden hinzugef√ºgt...`,3e3)}catch(e){console.error("Fehler in addAllToCart:",e),this.showToast("Fehler beim Berechnen der Konfigurationen ‚ùå",2e3),this.hideLoading()}},"addAllToCart")}async _buildPartsFor(e,i,n,s,o,l,a,r,c){try{const h={selection:e,rows:this.rows,cols:this.cols,cellWidth:this.cellWidth||179,cellHeight:this.cellHeight||113,orientation:this.orV&&this.orV.checked?"vertical":"horizontal"};let d=await this.calculatePartsIsolated(h);!1===i&&delete d.Solarmodul,!1===c&&delete d.UlicaSolarBlackJadeFlow;const u=(e||[]).flat().filter(Boolean).length;if(n&&u>0){const e=t.MC4_Stecker||20,i=Math.ceil(u/30);d.MC4_Stecker=i*e}else delete d.MC4_Stecker;s?d.Solarkabel=1:delete d.Solarkabel,o?d.Holzunterleger=1:delete d.Holzunterleger,l?d.Ringkabelschuhe=1:delete d.Ringkabelschuhe,a?d.Kabelbinder=1:delete d.Kabelbinder,r?(d.Erdungsband=this.calculateErdungsbandIsolated(e),d.BlechBohrschrauben=1):(delete d.Erdungsband,delete d.BlechBohrschrauben);try{const e=!0===c,t=e?"UlicaSolarBlackJadeFlow":"Solarmodul",i=e?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",n=Number(d[t]||0);if(n>0){const e=Math.floor(n/36),s=n%36;e>0&&(d[i]=e),s>0?d[t]=s:delete d[t]}}catch(e){}return d}catch(e){return console.warn("[SolarGrid] _buildPartsFor isolation error:",e),{}}}async calculatePartsIsolated(e){try{const t=this.selection,i=this.rows,n=this.cols,s=this.orV&&this.orV.checked;try{this.selection=e.selection,this.rows=e.rows,this.cols=e.cols,this.orV&&(this.orV.checked="vertical"===e.orientation);return this.calculatePartsSync()}finally{this.selection=t,this.rows=i,this.cols=n,this.orV&&(this.orV.checked=s)}}catch(e){return console.warn("[SolarGrid] calculatePartsIsolated error:",e),{}}}calculateErdungsbandIsolated(e){try{const t=(e||[]).flat().filter(Boolean).length;return Math.ceil(t/10)}catch(e){return 0}}getCurrentConfigData(){return{name:null!==this.currentConfig&&this.configs[this.currentConfig]?this.configs[this.currentConfig].name:"Aktuelle Konfiguration",cols:this.cols,rows:this.rows,selection:this.selection.map(e=>[...e]),orientation:this.orV.checked?"vertical":"horizontal",includeModules:this.incM.checked,mc4:this.mc4.checked,cable:this.solarkabel.checked,wood:this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked}}updateAllConfigurationsForCheckboxes(){this.configs.forEach((e,t)=>{e.incM=this.incM.checked,e.mc4=this.mc4.checked,e.solarkabel=this.solarkabel.checked,e.holz=this.holz.checked,e.quetschkabelschuhe=this.quetschkabelschuhe.checked,this.erdungsband&&(e.erdungsband=this.erdungsband.checked),this.ulicaModule&&(e.ulicaModule=this.ulicaModule.checked)}),this.updateSummaryOnChange(),this.buildList()}createConfigSnapshot(){null!==this.currentConfig&&this.updateConfig();const e={timestamp:(new Date).toISOString(),totalConfigs:this.configs.length,currentConfigIndex:this.currentConfig,configs:[]};for(let t=0;t<this.configs.length;t++){const i=this.configs[t];let n,s,o,l,a,r,c,h,d,u,m,g,p;t===this.currentConfig?(n=this.selection?this.selection.map(e=>[...e]):[],s=this.cols,o=this.rows,l=this.orV.checked?"vertical":"horizontal",a=this.incM.checked,r=this.mc4.checked,c=this.solarkabel.checked,h=this.holz.checked,d=this.quetschkabelschuhe.checked,u=!!this.erdungsband&&this.erdungsband.checked,m=!!this.ulicaModule&&this.ulicaModule.checked,console.log("Current ulicaModule checkbox state:",m),g=parseInt(this.wIn.value,10),p=parseInt(this.hIn.value,10)):(n=i.selection?i.selection.map(e=>[...e]):[],s=i.cols,o=i.rows,l=i.orientation,a=i.incM,r=i.mc4,c=i.solarkabel,h=i.holz,d=i.quetschkabelschuhe,u=i.erdungsband,m=i.ulicaModule,g=i.cellWidth,p=i.cellHeight);const f=Array.from({length:o||5},(e,t)=>Array.from({length:s||5},(e,i)=>!!(n[t]&&Array.isArray(n[t])&&i<n[t].length)&&!0===n[t][i])),b={name:i.name||`Konfiguration ${t+1}`,index:t,cols:s||5,rows:o||5,selection:f,cellWidth:g||179,cellHeight:p||113,orientation:l||"horizontal",includeModules:!0===a,mc4:r||!1,cable:c||!1,wood:h||!1,quetschkabelschuhe:d||!1,erdungsband:u||!1,ulicaModule:!0===m,selectedCells:f.flat().filter(e=>e).length,totalCells:(s||5)*(o||5)};e.configs.push(b)}return e}setupResizeObserver(){this.wrapper&&window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(e=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.updateSize(),this.resizeTimeout=null},150)}),this.resizeObserver.observe(this.wrapper))}cleanup(){this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null),this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.toastTimeout&&(clearTimeout(this.toastTimeout),this.toastTimeout=null),this.autoSaveTimeout&&(clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=null),this._recomputeTotalsTimer&&(clearTimeout(this._recomputeTotalsTimer),this._recomputeTotalsTimer=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this._foxyObserver&&(this._foxyObserver.disconnect(),this._foxyObserver=null),this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.cleanupEventListeners(),this.cleanupDOMReferences(),this.cleanupWorkers()}cleanupEventListeners(){try{this.boundGlobalAddAllClick&&(document.removeEventListener("click",this.boundGlobalAddAllClick,!0),this.boundGlobalAddAllClick=null),this.boundMobileDisableClick&&(document.removeEventListener("click",this.boundMobileDisableClick,!0),this.boundMobileDisableClick=null),this.boundMobileDisableTouch&&(document.removeEventListener("touchstart",this.boundMobileDisableTouch,!0),this.boundMobileDisableTouch=null);[this.wIn,this.hIn].filter(e=>e).forEach(e=>{e.removeEventListener("change",this.handleInputChange)}),this.moduleSelect&&this.moduleSelect.removeEventListener("change",this.handleModuleSelectChange),this.orH&&this.orV&&[this.orH,this.orV].forEach(e=>{e.removeEventListener("change",this.handleOrientationChange)}),[this.incM,this.mc4,this.solarkabel,this.holz,this.quetschkabelschuhe,this.kabelbinder,this.erdungsband,this.ulicaModule].filter(e=>e).forEach(e=>{e.removeEventListener("change",this.handleCheckboxChange)}),this.boundExpansionClick&&(document.querySelectorAll('[data-dir="right"], [data-dir="left"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick)}),this.boundExpansionClick=null),this.gridEl&&this.gridEl.removeEventListener("click",this.handleGridClick)}catch(e){console.warn("[SolarGrid] Event listener cleanup error:",e)}}cleanupDOMReferences(){try{this.gridEl=null,this.wrapper=null,this.prodList=null,this.listHolder=null,this.wIn=null,this.hIn=null,this.moduleSelect=null,this.orH=null,this.orV=null,this.incM=null,this.mc4=null,this.solarkabel=null,this.holz=null,this.quetschkabelschuhe=null,this.kabelbinder=null,this.erdungsband=null,this.ulicaModule=null,this.configListEl=null,this.foxyFormsByName=null,this.cleanupArrays()}catch(e){console.warn("[SolarGrid] DOM reference cleanup error:",e)}}cleanupWorkers(){try{this.calculationManager&&"function"==typeof this.calculationManager.cleanup&&(this.calculationManager.cleanup(),this.calculationManager=null),this.worker&&(this.worker.terminate(),this.worker=null)}catch(e){console.warn("[SolarGrid] Worker cleanup error:",e)}}manageCacheSize(){try{const e=20,t=864e5;if(this.configs&&this.configs.length>e&&(this.configs=this.configs.slice(-e),console.log(`[SolarGrid] Cache size limited to ${e} configurations`)),this.configs&&this.configs.length>0){const e=Date.now();this.configs=this.configs.filter(i=>{if(!i.timestamp)return!0;return e-new Date(i.timestamp).getTime()<t})}this.configs&&this.configs.forEach(e=>{if(e.selection&&Array.isArray(e.selection)){e.selection.reduce((e,t)=>e+(Array.isArray(t)?t.length:0),0)>500&&(e.selection=e.selection.map(e=>Array.isArray(e)?e.slice(0,25):e))}})}catch(e){console.warn("[SolarGrid] Cache size management error:",e)}}cleanupArrays(){try{this.selection&&(this.selection.forEach(e=>{Array.isArray(e)&&(e.length=0)}),this.selection.length=0,this.selection=null),this.configs&&(this.configs.forEach(e=>{e.selection&&Array.isArray(e.selection)&&(e.selection.forEach(e=>{Array.isArray(e)&&(e.length=0)}),e.selection.length=0)}),this.configs.length=0,this.configs=null),this.moduleData&&(Object.keys(this.moduleData).forEach(e=>{delete this.moduleData[e]}),this.moduleData=null),"function"==typeof gc&&gc()}catch(e){console.warn("[SolarGrid] Array cleanup error:",e)}this.gridEl&&this.gridEl.replaceChildren(),this.pdfGenerator&&(this.pdfGenerator=null)}computeAllTotalsSnapshot(){const e={},i=(t,i)=>{!i||i<=0||(e[t]=(e[t]||0)+i)};for(let e=0;e<(this.configs?.length||0);e++){const t=this.configs[e];if(!t)continue;const n=this.selection,s=this.rows,o=this.cols,l=this.orV&&this.orV.checked,a=this.erdungsband&&this.erdungsband.checked,r=this.ulicaModule&&this.ulicaModule.checked,c=this.wIn&&this.wIn.value,h=this.hIn&&this.hIn.value;try{this.selection=(t.selection||[]).map(e=>Array.isArray(e)?e.slice():e),this.rows=t.rows,this.cols=t.cols,this.orV&&(this.orV.checked="vertical"===t.orientation),this.wIn&&(this.wIn.value=t.cellWidth||179),this.hIn&&(this.hIn.value=t.cellHeight||113),this.erdungsband&&(this.erdungsband.checked=t.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=t.ulicaModule||!1);const e=this.calculatePartsSync();Object.entries(e).forEach(([e,t])=>i(e,t))}catch(e){}finally{this.selection=n,this.rows=s,this.cols=o,this.orV&&(this.orV.checked=l),this.wIn&&(this.wIn.value=c),this.hIn&&(this.hIn.value=h),this.erdungsband&&(this.erdungsband.checked=a),this.ulicaModule&&(this.ulicaModule.checked=r)}}try{const n=this.getCachedElement("mc4","mc4");if(n?.checked){const e=this.configs.reduce((e,t)=>e+(t.selection||[]).flat().filter(e=>e).length,0),n=Math.ceil(e/30);if(n>0){i("MC4_Stecker",n*(t.MC4_Stecker||50))}}const s=this.getCachedElement("solarkabel","solarkabel");s?.checked&&i("Solarkabel",1);const o=this.getCachedElement("holz","holz");o?.checked&&i("Holzunterleger",1);const l=this.getCachedElement("huaweiOpti","huawei-opti"),a=this.getCachedElement("brcOpti","brc-opti"),r=this.getCachedElement("optiQty","opti-qty"),c=Math.max(1,parseInt(r&&r.value||"1",10));l&&l.checked&&i("HuaweiOpti",c),a&&a.checked&&i("BRCOpti",c);const h=this.getCachedElement("kabelbinder","kabelbinder");h?.checked&&i("Kabelbinder",1);const d=this.getCachedElement("quetschkabelschuhe","quetschkabelschuhe");d?.checked&&i("Ringkabelschuhe",1),e.Erdungsband&&e.Erdungsband>0&&i("BlechBohrschrauben",1)}catch(e){}e.Dachhaken&&!e.Tellerkopfschraube&&i("Tellerkopfschraube",2*e.Dachhaken);try{const t=!this.incM||!1!==this.incM.checked,i=!!this.ulicaModule&&!0===this.ulicaModule.checked;t||delete e.Solarmodul,i||delete e.UlicaSolarBlackJadeFlow}catch(e){}try{this.bundleTotalModulesIntoPallets(e)}catch(e){}const n={};try{Object.entries(e).forEach(([e,i])=>{const s=t[e]||1,o=Math.ceil((Number(i)||0)/s);o>0&&(n[e]=o)})}catch(e){}try{const e=Object.entries(n).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>({key:e,name:s[e]||e,qty:t}));console.groupCollapsed("[Totals] Aktualisiert (Packs)"),console.table(e),console.groupEnd()}catch(e){}return n}saveTotalsToCache(e){try{const t=e=>Array.isArray(e)?e.map(e=>Array.isArray(e)?e.slice():e):e,i=e=>({...e,selection:t(e.selection)}),n={configs:Array.isArray(this.configs)?this.configs.map(i):[],currentConfig:this.currentConfig,selection:t(this.selection),cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",includeModules:!!this.incM&&this.incM.checked,mc4:!!this.mc4&&this.mc4.checked,solarkabel:!!this.solarkabel&&this.solarkabel.checked,holz:!!this.holz&&this.holz.checked,quetschkabelschuhe:!!this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked,huaweiOpti:document.getElementById("huawei-opti")?.checked||!1,brcOpti:document.getElementById("brc-opti")?.checked||!1,optiQty:parseInt(document.getElementById("opti-qty")?.value||"1",10),moduleSelectValue:this.moduleSelect?this.moduleSelect.value:"",gridStructure:{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10)},totals:e};this.cacheManager.saveData(n),this.totalPartsCache=e}catch(e){}}loadTotalsFromCache(){try{const e=this.cacheManager.loadData(),t=e&&e.totals?e.totals:null;return t&&(this.totalPartsCache=t),t}catch(e){return null}}recomputeTotalsDebounced(){this._recomputeTotalsTimer&&clearTimeout(this._recomputeTotalsTimer),this._recomputeTotalsTimer=setTimeout(()=>{const e=this.computeAllTotalsSnapshot();this.saveTotalsToCache(e)},150)}}document.addEventListener("DOMContentLoaded",()=>{const e=new h;"function"==typeof e.initFoxyFormMap&&e.initFoxyFormMap();try{document.querySelectorAll(".w-dyn-list, .w-dyn-items, .w-dyn-item, .rt-component-section").forEach(e=>{e&&e.style&&(e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",e.style.width="1px",e.style.height="1px",e.style.overflow="hidden",e.style.clip="rect(0, 0, 0, 0)",e.style.whiteSpace="nowrap")})}catch(e){}window.solarGrid=e}),window.addEventListener("beforeunload",()=>{try{l&&l.destroy(),window.solarGrid&&"function"==typeof window.solarGrid.cleanup&&window.solarGrid.cleanup();const e=setTimeout(()=>{},0);for(let t=0;t<e;t++)clearTimeout(t);const t=setInterval(()=>{},0);for(let e=0;e<t;e++)clearInterval(e)}catch(e){console.warn("[SolarGrid] Cleanup on unload error:",e)}}),window.debugFoxy={list:()=>{const e=[];try{if(!window.solarGrid||!window.solarGrid.foxyDataByName)return e;window.solarGrid.foxyDataByName.forEach((t,i)=>e.push({key:i,...t}))}catch(e){}return console.table(e),e},get:e=>{try{if(window.solarGrid&&window.solarGrid.foxyDataByName)return window.solarGrid.foxyDataByName.get(e)||null}catch(e){}return null}}}();
//# sourceMappingURL=script-new.min.js.map