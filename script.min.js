!function(){const e={Endklemmen:100,Schrauben:100,Dachhaken:20,Mittelklemmen:100,Endkappen:50,Schienenverbinder:50,Schiene_240_cm:8,Schiene_360_cm:8,Solarmodul:1,MC4_Stecker:1,Solarkabel:1,Holzunterleger:50,Erdungsklemme:1,Quetschkabelschuhe:100,Erdungsband:1,Tellerkopfschraube:100},t={Solarmodul:59,Endklemmen:9.99,Schrauben:9.99,Dachhaken:9.99,Mittelklemmen:4.99,Endkappen:9.99,Schienenverbinder:9.99,Schiene_240_cm:8.99,Schiene_360_cm:9.99,MC4_Stecker:99,Solarkabel:29.99,Holzunterleger:25,Erdungsklemme:25,Quetschkabelschuhe:10,Erdungsband:0,Tellerkopfschraube:30},i={Solarmodul:{productId:"685003af0e41d945fb0198d8",variantId:"685003af4a8e88cb58c89d46"},Endklemmen:{productId:"6853c34fe99f6e3d878db38b",variantId:"6853c350edab8f13fc18c1b9"},Schrauben:{productId:"6853c2782b14f4486dd26f52",variantId:"6853c2798bf6755ddde26a8e"},Dachhaken:{productId:"6853c1d0f350bf620389664c",variantId:"6853c1d04d7c01769211b8d6"},Mittelklemmen:{productId:"68531088654d1468dca962c",variantId:"6853c1084c04541622ba3e26"},Endkappen:{productId:"6853be0895a5a578324f9682",variantId:"6853be0805e96b5a16c705cd"},Schienenverbinder:{productId:"6853c2018bf6755ddde216a8",variantId:"6853c202c488ee61eb51a3dc"},Schiene_240_cm:{productId:"6853bd882f00db0c9a42d653",variantId:"6853bd88c4173dbe72bab10f"},Schiene_360_cm:{productId:"6853bc8f3f6abf360c605142",variantId:"6853bc902f00db0c9a423d97"},MC4_Stecker:{productId:"687fcc9f66078f7098826ccc",variantId:"687fcca02c6537b9a9493fa7"},Solarkabel:{productId:"687fd60dc599f5e95d783f99",variantId:"687fd60dd3a8ae1f00a6d6d1"},Holzunterleger:{productId:"688780821dbbf26153a85117",variantId:"688780ad795c82663cd6e69b"},Erdungsklemme:{productId:"6887e8aaa6ca43c15254d224",variantId:"6887e8abb439562cbc88db5d"},Quetschkabelschuhe:{productId:"68876153200e1a5e28a1b709",variantId:"6887615388988b2ccda11067"},Erdungsband:{productId:"688760e01c9c7973ee287386",variantId:"688760e0835845affc493354"},Tellerkopfschraube:{productId:"688760a7124e867cf2b20051",variantId:"688760a7f246d23f70575fb1"}},s={Solarmodul:"Ulica Solar Black Jade-Flow 450 W",Schrauben:"Schraube M10x25",Solarkabel:"Solarkabel 100M",Holzunterleger:"Unterlegholz für Dachhaken - 50 Stück",Erdungsklemme:"Erdungsklemme - ?? Stücl",Quetschkabelschuhe:"Quetschkabelschuhe - 100 Stück",Erdungsband:"Erdungsband",Tellerkopfschraube:"Tellerkopfschraube 8x100"},n={Solarmodul:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Endklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c316b21cb7d04ba2ed22_DSC04815-min.jpg",Schrauben:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg",Dachhaken:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c1c8a2835b7879f46811_DSC04760-min.jpg",Mittelklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c0d0c2d922d926976bd4_DSC04810-min.jpg",Endkappen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bdfbe7cffc653f6a4605_DSC04788-min.jpg",Schienenverbinder:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c21f0c39e927fce0db3b_DSC04780-min.jpg",Schiene_240_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bce018164af4b4a187f1_DSC04825-min.jpg",Schiene_360_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bcd5726d1d33d4b86ba4_DSC04824-min.jpg",MC4_Stecker:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fcdab153f840ea15b5e7b_iStock-2186771695.jpg",Solarkabel:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fd566bdbb6de2e5f362f0_DSC04851.jpg",Holzunterleger:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Erdungsklemme:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Quetschkabelschuhe:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6887614c64676f0b0c8d5037_Kabelschuh%20Platzhalter.jpg",Erdungsband:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Tellerkopfschraube:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg"};const o=new class{constructor(){this.worker=null,this.pendingCalculations=new Map,this.calculationId=0,this.isWorkerReady=!1,this.initWorker()}initWorker(){try{this.worker=new Worker("./calculation-worker.js"),this.worker.onmessage=e=>{const{type:t,id:i,data:s,error:n}=e.data;if("ready"!==t){if("result"===t&&this.pendingCalculations.has(i)){const{resolve:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(s)}if("error"===t&&this.pendingCalculations.has(i)){const{reject:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(new Error(n.message))}"debug"===t&&console.log(...s)}else this.isWorkerReady=!0},this.worker.onerror=e=>{this.isWorkerReady=!1}}catch(e){this.isWorkerReady=!1}}async calculate(e,t){return this.isWorkerReady&&this.worker?new Promise((i,s)=>{const n=++this.calculationId;this.pendingCalculations.set(n,{resolve:i,reject:s}),setTimeout(()=>{this.pendingCalculations.has(n)&&(this.pendingCalculations.delete(n),s(new Error("Calculation timeout")))},1e4),this.worker.postMessage({type:e,data:t,id:n})}):this.calculateSync(e,t)}calculateSync(e,t){switch(e){case"calculateParts":return this.calculatePartsSync(t);case"calculateExtendedParts":return this.calculateExtendedPartsSync(t);default:throw new Error(`Unsupported sync calculation: ${e}`)}}calculatePartsSync(e){try{const{selection:t,rows:i,cols:s,cellWidth:n,cellHeight:o,orientation:r}=e,a={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let l=0;l<s;l++)t[e]?.[l]?i++:i&&(this.processGroupSync(i,a,n,o,r),i=0);i&&this.processGroupSync(i,a,n,o,r)}return a}catch(e){return console.error("calculatePartsSync error:",e),{Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0}}}processGroupSync(e,t,i,s,n){const o=e*("vertical"===n?s:i),r=Math.floor(o/360),a=o-360*r,l=[{cnt360:r,cnt240:Math.ceil(a/240)},{cnt360:Math.ceil(o/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(o/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-o})),c=Math.min(...l.map(e=>e.rails)),h=l.filter(e=>e.rails===c).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:d,cnt240:u}=h;t.Schiene_360_cm+=2*d,t.Schiene_240_cm+=2*u,t.Schienenverbinder+=4*(d+u-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}calculateExtendedPartsSync(e){let t=this.calculatePartsSync(e);const{options:i}=e;if(i.includeModules||delete t.Solarmodul,i.mc4Connectors){const i=e.selection.flat().filter(e=>e).length;t.MC4_Stecker=Math.ceil(i/30)}return i.solarkabel&&(t.Solarkabel=1),i.woodUnderlay&&(t.Holzunterleger=1),t}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingCalculations.clear(),this.isWorkerReady=!1}};const r=new class{constructor(){this.cache=new Map,this.lastUpdate=null,this.cacheKey="solarTool_priceCache",this.timestampKey="solarTool_priceTimestamp",this.cacheDuration=864e5,this.isUpdating=!1,this.loadFromStorage(),this.scheduleNextUpdate()}loadFromStorage(){try{const e=localStorage.getItem(this.cacheKey),t=localStorage.getItem(this.timestampKey);if(e&&t){const i=JSON.parse(e);if(this.lastUpdate=parseInt(t,10),Date.now()-this.lastUpdate<this.cacheDuration)return void(this.cache=new Map(Object.entries(i)))}}catch(e){}this.updatePricesFromHTML()}saveToStorage(){try{const e=Object.fromEntries(this.cache);localStorage.setItem(this.cacheKey,JSON.stringify(e)),localStorage.setItem(this.timestampKey,this.lastUpdate.toString())}catch(e){}}async updatePricesFromHTML(){if(this.isUpdating)return;this.isUpdating=!0;const e=Object.keys(i).map(async e=>{const t=await this.getPriceFromHTMLAsync(e);return this.cache.set(e,t),{productKey:e,price:t}});try{const t=await Promise.all(e);this.lastUpdate=Date.now(),this.saveToStorage(),t.forEach(({productKey:e,price:t})=>{})}catch(e){}finally{this.isUpdating=!1}}async getPriceFromHTMLAsync(e){return new Promise(t=>{setTimeout(()=>{const i=this.extractPriceFromHTML(e);t(i)},0)})}extractPriceFromHTML(e){try{const s=i[e];if(!s)return t[e]||0;const n=s.productId,o=s.variantId,r=document.querySelector(`[data-commerce-product-id="${n}"]`)||document.querySelector(`[data-commerce-sku-id="${o}"]`);if(r){const e=r.querySelector('[data-wf-sku-bindings*="f_price_"]');if(e){let t=e.textContent||e.innerHTML;t=t.replace(/&nbsp;/g," ").replace(/&euro;/g,"€");const i=t.match(/(\d+(?:[.,]\d{1,2})?)/);if(i){return parseFloat(i[1].replace(",","."))}}}}catch(e){}return t[e]||0}getPrice(e){if(this.cache.has(e))return this.cache.get(e);return t[e]||0}scheduleNextUpdate(){const e=this.lastUpdate?this.lastUpdate+this.cacheDuration:Date.now()+this.cacheDuration,t=Math.max(0,e-Date.now());setTimeout(()=>{this.updatePricesFromHTML(),this.scheduleNextUpdate()},t)}forceUpdate(){return this.updatePricesFromHTML()}};function a(e){return r.getPrice(e)}window.debugPriceCache={forceUpdate:()=>r.forceUpdate(),getCache:()=>Object.fromEntries(r.cache),getCacheAge:()=>{if(!r.lastUpdate)return"Nie aktualisiert";const e=Date.now()-r.lastUpdate;return`${Math.round(e/36e5)} Stunden alt`},clearCache:()=>{localStorage.removeItem(r.cacheKey),localStorage.removeItem(r.timestampKey),r.cache.clear(),r.lastUpdate=null},testQuetschkabelschuhe:()=>(console.log("Testing Quetschkabelschuhe price..."),console.log("PRICE_MAP:",t.Quetschkabelschuhe),console.log("Cache value:",r.getPrice("Quetschkabelschuhe")),console.log("Direct fallback:",t.Quetschkabelschuhe||0),{priceMap:t.Quetschkabelschuhe,cacheValue:r.getPrice("Quetschkabelschuhe"),fallback:t.Quetschkabelschuhe||0}),resetAndReload:()=>{console.log("Resetting price cache..."),window.debugPriceCache.clearCache(),r.loadFromStorage(),r.forceUpdate(),console.log("Cache reset complete")}};class l{constructor(e){this.solarGrid=e,this.jsPDF=window.jspdf?.jsPDF,this.html2canvas=window.html2canvas}isAvailable(){return!(!this.jsPDF||!this.html2canvas)}async generatePDFFromSnapshot(e){if(!this.isAvailable())return console.warn("PDF Libraries nicht verfügbar"),void this.solarGrid.showToast("PDF-Generierung nicht verfügbar",3e3);try{if(console.log("PDF-Generation startet mit Snapshot:",{totalConfigs:e.totalConfigs,timestamp:e.timestamp,configs:e.configs.map(e=>({name:e.name,dimensions:`${e.cols}x${e.rows}`,selectedCells:e.selectedCells,totalCells:e.totalCells}))}),!e.configs||0===e.configs.length)return void this.solarGrid.showToast("Keine Konfiguration zum Exportieren",3e3);const t=new this.jsPDF("p","mm","a4");let i=!0;for(const s of e.configs)i||t.addPage(),await this.addConfigurationToPDFFromSnapshot(t,s,i),i=!1;const s=this.generateFileName(e.configs);t.save(s),console.log("PDF erfolgreich generiert:",s)}catch(e){throw console.error("PDF-Generierung fehlgeschlagen:",e),this.solarGrid.showToast("PDF-Erstellung fehlgeschlagen",3e3),e}}async generatePDF(e="current"){const t=this.solarGrid.createConfigSnapshot();await this.generatePDFFromSnapshot(t)}async calculateTotalPrice(t){const i=this.solarGrid.calculatePartsDirectly({selection:t.selection,cols:t.cols,rows:t.rows,cellWidth:t.cellWidth,cellHeight:t.cellHeight,orientation:t.orientation,incM:t.incM,mc4:t.mc4,solarkabel:t.solarkabel,holz:t.holz});let s=0;return Object.entries(i).forEach(([t,i])=>{if(i>0){const n=Math.ceil(i/e[t]),o=a(t);s+=n*o}}),s}addFooter(e,t,i){const s=i-25;e.setFillColor(14,30,52),e.rect(0,s,t,25,"F"),e.setTextColor(255,255,255),e.setFontSize(8),e.setFont("helvetica","normal"),e.text("Schneider Unterkonstruktion - Solar Konfigurator",20,s+8),e.text("unterkonstruktion.de",20,s+15);try{const i="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAb0AAACOCAYAAAClt9bzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAExWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDI1LTA4LTAzPC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPmJlZjYxZjQ1LTc4ZDEtNGYxMi1iNjdlLWJkYjlhMmNlNjVjMTwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz5TY2huZWlkZXIgbG9nbyAtIDE8L3JkZjpsaT4KICAgPC9yZGY6QWx0PgogIDwvZGM6dGl0bGU+CiA8L3JkZjpEZXNjcmlwdGlvbj4KCiA8cmRmOkRlc2NyaXB0aW9u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",n=15,o=3.1338028169*n,r=t-o-20,a=s+5;e.addImage(i,"PNG",r,a,o,n)}catch(i){console.warn("Logo konnte nicht geladen werden:",i),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("Schneider Unterkonstruktion",t-120,s+12)}}async calculateTotalPriceFromSnapshot(t){const i=await this.calculatePartsFromSnapshot(t);let s=0;return Object.entries(i).forEach(([t,i])=>{if(i>0){const n=Math.ceil(i/(e[t]||1)),o=a(t);s+=n*o}}),s}async addConfigurationToPDFFromSnapshot(e,t,i){const s=210,n={y:25},o=(t=20)=>n.y+t>267&&(this.addFooter(e,s,297),e.addPage(),n.y=25,!0);console.log(`PDF-Seite für Konfiguration: ${t.name}`,{dimensions:`${t.cols}x${t.rows}`,selectedCells:t.selectedCells,totalCells:t.totalCells}),e.setFillColor(14,30,52),e.rect(0,0,s,35,"F"),e.setTextColor(255,255,255),e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Ihre Konfiguration",20,22),e.setFontSize(10),e.setFont("helvetica","normal"),e.text((new Date).toLocaleDateString("de-DE"),170,22),e.setTextColor(0,0,0),n.y=45,o(25),e.setFillColor(245,166,35),e.rect(15,n.y-5,180,20,"F"),e.setTextColor(255,255,255),e.setFontSize(12),e.setFont("helvetica","bold"),e.text(`Projekt: ${t.name||"Unbenannt"}`,20,n.y+10),e.setTextColor(0,0,0),n.y+=30,o(20),e.setFontSize(11),e.setFont("helvetica","normal"),e.text(`Grid: ${t.cols} × ${t.rows} Module (${t.selectedCells} ausgewählt)`,20,n.y),e.text("Orientierung: "+("vertical"===t.orientation?"Vertikal":"Horizontal"),20,n.y+8),n.y+=20;try{const i=await this.captureGridVisualizationFromSnapshot(t);if(i){const t=140,r=105;o(r+15),e.setDrawColor(14,30,52),e.setLineWidth(2);const a=(s-t)/2,l=n.y;e.rect(a-2,l-2,t+4,r+4),e.addImage(i,"PNG",a,l,t,r),n.y+=r+10}}catch(e){console.warn("Grid-Screenshot fehlgeschlagen:",e),n.y+=10}o(60),n.y=await this.addProductTableFromSnapshot(e,t,n.y,o),o(25);const r=await this.calculateTotalPriceFromSnapshot(t);e.setFillColor(14,30,52),e.rect(15,n.y-5,180,20,"F"),e.setTextColor(255,255,255),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("GESAMTPREIS:",20,n.y+8),e.text(`${r.toFixed(2)} €`,170,n.y+8),e.setTextColor(0,0,0),n.y+=30,this.addFooter(e,s,297)}async captureGridVisualization(e){try{const t=e.selection||[],i=e.cols||5,s=e.rows||5,n=document.createElement("div");n.style.position="absolute",n.style.left="-10000px",n.style.top="-10000px",n.style.padding="20px",n.style.backgroundColor="#ffffff",document.body.appendChild(n);const o=50,r=2,a=document.createElement("div");a.style.display="grid",a.style.gap=`${r}px`,a.style.gridTemplateColumns=`repeat(${i}, ${o}px)`,a.style.gridTemplateRows=`repeat(${s}, ${o}px)`,a.style.padding="2px",a.style.backgroundColor="#ffffff",a.style.border="1px solid #000000",a.style.borderRadius="1rem";const l=Array.from({length:s},(e,s)=>Array.from({length:i},(e,i)=>!!(t[s]&&Array.isArray(t[s])&&i<t[s].length)&&!0===t[s][i]));console.log("Grid Debug - Normalized:",{originalRows:t.length,originalCols:t[0]?t[0].length:0,targetRows:s,targetCols:i,normalizedSelection:l});for(let e=0;e<s;e++)for(let t=0;t<i;t++){const n=document.createElement("div"),r=l[e][t];(e>=s-2||t>=i-2)&&console.log(`Cell [${e}][${t}]: isSelected =`,r),n.style.width=`${o}px`,n.style.height=`${o}px`,n.style.borderRadius="1rem",n.style.border="1px solid #000000",n.style.backgroundColor=r?"#072544":"#f3f4f6",a.appendChild(n)}n.appendChild(a),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,100));const c=await this.html2canvas(n,{backgroundColor:"#ffffff",scale:2,logging:!1,useCORS:!0,allowTaint:!0,width:n.offsetWidth,height:n.offsetHeight});return document.body.removeChild(n),c.toDataURL("image/png")}catch(e){return console.warn("Grid-Screenshot fehlgeschlagen:",e),null}}async captureGridImageForWebhook(e){try{const t=e.selection||[],i=e.cols||5,s=e.rows||5,n=document.createElement("div");n.style.position="absolute",n.style.left="-10000px",n.style.top="-10000px",n.style.padding="20px",n.style.backgroundColor="#ffffff",document.body.appendChild(n);const o="vertical"===e.orientation,r=60,a=o?.6*r:r,l=o?r:.6*r,c=2,h=document.createElement("div");h.style.display="grid",h.style.gap=`${c}px`,h.style.gridTemplateColumns=`repeat(${i}, ${a}px)`,h.style.gridTemplateRows=`repeat(${s}, ${l}px)`,h.style.padding="20px",h.style.backgroundColor="#ffffff",h.style.border="2px solid #072544",h.style.borderRadius="12px",h.style.boxShadow="0 4px 12px rgba(0,0,0,0.1)";for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=document.createElement("div"),n=t[e]&&!0===t[e][s];if(i.style.width=`${a}px`,i.style.height=`${l}px`,i.style.borderRadius="6px",i.style.border="1px solid #ddd",i.style.transition="all 0.2s ease",n){i.style.backgroundColor="#072544",i.style.border="2px solid #0a4d75",i.style.boxShadow="inset 0 2px 4px rgba(0,0,0,0.2)";const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.background="linear-gradient(135deg, \n                #072544 0%, #0a4d75 50%, #072544 100%)",e.style.borderRadius="4px",e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.top="2px",t.style.left="2px",t.style.right="2px",t.style.bottom="2px",t.style.backgroundImage="\n                linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),\n                linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)\n              ",t.style.backgroundSize="33% 50%",e.appendChild(t),i.appendChild(e)}else i.style.backgroundColor="#f8f9fa",i.style.border="1px solid #e9ecef";h.appendChild(i)}n.appendChild(h),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,150));const d=document.createElement("canvas"),u=d.getContext("2d"),m=i*a+(i-1)*c+40,g=s*l+(s-1)*c+40;d.width=m,d.height=g,u.fillStyle="#ffffff",u.fillRect(0,0,d.width,d.height);const p=20,f=20;for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=p+s*(a+c),n=f+e*(l+c);if(t[e]&&!0===t[e][s]){u.fillStyle="#072544",u.fillRect(i,n,a,l),u.strokeStyle="#0a4d75",u.lineWidth=2,u.strokeRect(i,n,a,l),u.strokeStyle="rgba(255,255,255,0.2)",u.lineWidth=1;for(let e=1;e<3;e++){const t=i+a/3*e;u.beginPath(),u.moveTo(t,n+2),u.lineTo(t,n+l-2),u.stroke()}const e=n+l/2;u.beginPath(),u.moveTo(i+2,e),u.lineTo(i+a-2,e),u.stroke()}else u.fillStyle="#f8f9fa",u.fillRect(i,n,a,l),u.strokeStyle="#e9ecef",u.lineWidth=1,u.strokeRect(i,n,a,l)}u.strokeStyle="#072544",u.lineWidth=2,u.strokeRect(10,10,m-20,g-20);const b=d.toDataURL("image/png");return console.log("Canvas generated:",{canvasWidth:d.width,canvasHeight:d.height,dataURLLength:b.length,dataURLStart:b.substring(0,50)+"..."}),document.body.removeChild(n),b}catch(e){return console.error("Grid-Bild-Generierung fehlgeschlagen:",e),null}}async captureGridVisualizationFromSnapshot(e){try{console.log(`Grid-Capture für ${e.name}:`,{dimensions:`${e.cols}x${e.rows}`,selectedCells:e.selectedCells,selection:e.selection.slice(0,3).map(e=>e.slice(0,5))});const t=e.selection||[],i=e.cols||5,s=e.rows||5,n=document.createElement("div");n.style.position="absolute",n.style.left="-10000px",n.style.top="-10000px",n.style.padding="20px",n.style.backgroundColor="#ffffff",n.style.zIndex="-1000",document.body.appendChild(n);const o="vertical"===e.orientation,r=40,a=o?.6*r:r,l=1,c=170,h=i*a+(i-1)*l+4,d=h>3.78*c?3.78*c/h:1,u=a*d,m=(o?r:.6*r)*d,g=l*d,p=document.createElement("div");p.style.display="grid",p.style.gap=`${g}px`,p.style.gridTemplateColumns=`repeat(${i}, ${u}px)`,p.style.gridTemplateRows=`repeat(${s}, ${m}px)`,p.style.padding="2px",p.style.backgroundColor="#ffffff",p.style.border="1px solid #000000",p.style.borderRadius="3px",p.style.imageRendering="crisp-edges",p.style.imageRendering="-webkit-optimize-contrast",p.style.transform="translateZ(0)",p.style.backfaceVisibility="hidden";for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=document.createElement("div"),n=t[e]&&!0===t[e][s];i.style.width=`${u}px`,i.style.height=`${m}px`,i.style.borderRadius="2px",i.style.border="1px solid #000000",i.style.imageRendering="crisp-edges",i.style.imageRendering="-webkit-optimize-contrast",i.style.transform="translateZ(0)",i.style.backfaceVisibility="hidden",i.style.backgroundColor=n?"#072544":"#f3f4f6",p.appendChild(i)}n.appendChild(p),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,100));const f=20,b=20,y=Math.ceil(i*u+(i-1)*g+f),w=Math.ceil(s*m+(s-1)*g+b);console.log("Grid Screenshot Debug:",{cols:i,rows:s,finalCellWidth:u,finalCellHeight:m,finalGap:g,calculatedWidth:y,calculatedHeight:w,paddingX:f,paddingY:b});const k=await this.html2canvas(p,{backgroundColor:"#ffffff",width:y,height:w,scale:4,logging:!1,useCORS:!0,allowTaint:!0,foreignObjectRendering:!1,removeContainer:!1,pixelRatio:window.devicePixelRatio||1,imageTimeout:15e3,onclone:e=>{const t=e.createElement("style");t.textContent="\n              * {\n                image-rendering: -webkit-optimize-contrast !important;\n                image-rendering: crisp-edges !important;\n                image-rendering: pixelated !important;\n                text-rendering: optimizeLegibility !important;\n                -webkit-font-smoothing: antialiased !important;\n                -moz-osx-font-smoothing: grayscale !important;\n              }\n            ",e.head.appendChild(t)}});return document.body.removeChild(n),k.toDataURL("image/jpeg",.95)}catch(e){return console.error("Grid-Screenshot fehlgeschlagen:",e),null}}async addProductTableFromSnapshot(t,i,n,o){try{console.log("addProductTableFromSnapshot called for:",i.name);const r=await this.calculatePartsFromSnapshot(i);if(console.log("Received parts:",r,"Keys count:",Object.keys(r||{}).length),!r||0===Object.keys(r).length)return console.log("No parts calculated, returning early"),n;o(30),t.setFillColor(245,166,35),t.rect(15,n-5,180,15,"F"),t.setTextColor(255,255,255),t.setFontSize(12),t.setFont("helvetica","bold"),t.text("PRODUKT-LISTE",20,n+5),t.setTextColor(0,0,0),n+=20,o(15),t.setFillColor(14,30,52),t.rect(15,n-3,180,12,"F"),t.setTextColor(255,255,255),t.setFontSize(9),t.setFont("helvetica","bold"),t.text("Produkt",20,n+3),t.text("Menge",70,n+3),t.text("Pack",100,n+3),t.text("Preis/Pack",130,n+3),t.text("Gesamt",170,n+3),t.setTextColor(0,0,0),n+=15,t.setFont("helvetica","normal"),t.setFontSize(8);let l=0,c=0;return Object.entries(r).forEach(([i,r])=>{if(r>0){o(12),c%2==1&&(t.setFillColor(248,249,250),t.rect(15,n-2,180,10,"F"));const h=s[i]||i.replace(/_/g," "),d=Math.ceil(r/(e[i]||1)),u=a(i),m=d*u;l+=m,t.text(h,20,n+2),t.text(r.toString(),70,n+2),t.text(`${d}x`,100,n+2),t.text(`${u.toFixed(2)} €`,130,n+2),t.text(`${m.toFixed(2)} €`,170,n+2),n+=10,c++}}),o(15),t.setDrawColor(14,30,52),t.setLineWidth(1),t.line(15,n,195,n),n+=5}catch(e){return console.error("Produkttabelle fehlgeschlagen:",e),n}}async calculatePartsFromSnapshot(e){try{console.log("Calculating parts for config:",e.name,{selectedCells:e.selectedCells,rows:e.rows,cols:e.cols,includeModules:e.includeModules});const t={selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation||"horizontal"};let i;try{i=await o.calculate("calculateParts",t)}catch(e){console.warn("calculationManager failed, using fallback:",e),i=this.calculatePartsDirectly(t)}if(console.log("Parts calculated:",i),e.includeModules||delete i.Solarmodul,e.mc4){const t=e.selectedCells;i.MC4_Stecker=Math.ceil(t/30)}return e.cable&&(i.Solarkabel=1),e.wood&&(i.Holzunterleger=1),console.log("Final parts after processing:",i),i}catch(e){return console.error("Part calculation from snapshot failed:",e),{}}}async addProductTable(t,i,n,o){o(30),t.setFillColor(245,166,35),t.rect(15,n-5,180,15,"F"),t.setTextColor(255,255,255),t.setFontSize(12),t.setFont("helvetica","bold"),t.text("PRODUKT-LISTE",20,n+5),t.setTextColor(0,0,0),n+=20;const r=await this.calculateConfigParts(i);if(!r||0===Object.keys(r).length)return t.setFontSize(10),t.setFont("helvetica","italic"),t.text("Keine Produkte berechnet.",20,n),n+10;o(15),t.setFillColor(14,30,52),t.rect(15,n-3,180,12,"F"),t.setTextColor(255,255,255),t.setFontSize(9),t.setFont("helvetica","bold"),t.text("Produkt",20,n+3),t.text("Menge",70,n+3),t.text("Pack",100,n+3),t.text("Preis/Pack",130,n+3),t.text("Gesamt",170,n+3),t.setTextColor(0,0,0),n+=15,t.setFont("helvetica","normal"),t.setFontSize(8);let l=0,c=0;return Object.entries(r).forEach(([i,r])=>{if(r>0){o(12),c%2==1&&(t.setFillColor(248,249,250),t.rect(15,n-2,180,10,"F"));const h=e[i]||1,d=Math.ceil(r/h),u=a(i),m=d*u;l+=m;const g=s[i]||i.replace(/_/g," ");t.text(g,20,n+2),t.text(r.toString(),70,n+2),t.text(`${d}×`,100,n+2),t.text(`${u.toFixed(2)} €`,130,n+2),t.text(`${m.toFixed(2)} €`,170,n+2),n+=10,c++}}),o(15),t.setDrawColor(14,30,52),t.setLineWidth(1),t.line(15,n,195,n),n+=5}async calculateConfigParts(e){if(!e.selection||!e.cols||!e.rows)return{};const t={selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation};let i;try{i=await o.calculate("calculateParts",t)}catch(e){console.warn("calculationManager failed, using fallback:",e),i=this.calculatePartsDirectly(t)}if(e.includeModules||delete i.Solarmodul,e.mc4){const t=e.selection.flat().filter(e=>e).length;i.MC4_Stecker=Math.ceil(t/30)}return e.cable&&(i.Solarkabel=1),e.wood&&(i.Holzunterleger=1),i}processGroup(e,t,i,s,n){}generateFileName(e){const t=new Date,i=t.toISOString().slice(0,10),s=t.toTimeString().slice(0,5).replace(":","-");let n="Solar-Konfiguration";return 1===e.length?n=e[0].name||"Konfiguration":e.length>1&&(n=`${e.length}-Konfigurationen`),n=n.replace(/[<>:"/\\|?*]/g,"-"),`${n}_${i}_${s}.pdf`}}class c{constructor(e){this.solarGrid=e,this.patterns={gridSize:/(\d+)\s*[x×]\s*(\d+)(?!\s*mal)/i,moduleCount:/(\d+)\s*modul[e]?[n]?/i,moduleCheckbox:/(?:mit|ohne)[\s-]*modul[e]?[n]?(?!\s*\d)/i,orientation:/(?:horizontal|vertikal|vertical)/i,mc4:/(?:mit|ohne)[\s-]*mc4/i,cable:/(?:mit|ohne)[\s-]*(?:kabel|solarkabel)/i,wood:/(?:mit|ohne)[\s-]*holz(?:unterleger)?/i,quetschkabelschuhe:/(?:mit|ohne)[\s-]*(?:quetschkabelschuhe|kabelschuhe)/i,rowPattern:/(?:(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?)\s*(?:mit|à|a)?\s*(\d+)\s*modul[e]?[n]?)|(?:(\d+)\s*modul[e]?[n]?\s*(?:in|auf)?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?))|(?:(\d+)\s*mal\s*(\d+)\s*modul[e]?[n]?)/i,spacing:/(?:(?:mit|ohne)\s*(?:abstand|lücke))|(?:(\d+)\s*(?:reihen?|zeilen?)\s*(?:abstand|lücke))/i,gridCompact:/(?:kompakt|ohne\s*lücken)/i,gridSpaced:/(?:mit\s*lücken|mit\s*abstand)/i,checkboxCombination:/(?:^|\s)(?:mit|und)\s+(.+?)(?:\s+und\s+(.+?))*(?:\s*$)/i,saveConfig:/^(?:(?:konfiguration|konfig|config)\s*)?(?:speichern|save)$/i,deleteConfig:/^(?:konfiguration|konfig|config)\s*(?:löschen|delete)$/i,deleteModules:/^modul[e]?[n]?\s*löschen$/i,resetGrid:/^(?:reset|zurücksetzen|zurücksetzen)$/i,distributionEqual:/(?:gleichmäßig|gleich|optimal)/i,distributionRows:/(?:in\s*reihen|reihenweise)/i,distributionColumns:/(?:in\s*spalten|spaltenweise)/i,distributionRandom:/(?:zufällig|random)/i,spacingDouble:/(?:doppelter|doppeltem)\s*abstand/i,spacingRowsOnly:/(?:nur\s*)?(?:zwischen\s*)?reihen/i,spacingColumnsOnly:/(?:nur\s*)?(?:zwischen\s*)?spalten/i,checkboxAllExcept:/(?:alles\s*außer|alle\s*außer)/i,checkboxOnly:/(?:nur|only)/i,checkboxWithout:/(?:ohne\s*zubehör|ohne\s*extras)/i,checkboxWithAll:/(?:mit\s*allem|alles\s*mit)/i,saveWithName:/(?:speichern\s*als\s*['"]?([^'"]+)['"]?)/i}}parseWordNumber(e){const t={ein:1,eine:1,zwei:2,drei:3,vier:4,"fünf":5,sechs:6,sieben:7,acht:8,neun:9,zehn:10};return"string"==typeof e&&t[e.toLowerCase()]?t[e.toLowerCase()]:parseInt(e)||0}parseCheckboxCombinations(e){const t={modules:null,mc4:null,cable:null,wood:null,quetschkabelschuhe:null};let i=e.toLowerCase().replace(/modulen?/g,"module").replace(/solarkabeln?/g,"solarkabel").replace(/holzunterlegern?/g,"holzunterleger").split(/\s*(?:und|,)\s*/);i[0]&&(i[0].includes("mit ")||i[0].includes("ohne "))&&(i[0]=i[0].replace(/.*(?:mit|ohne)\s+/,"")),i=i.filter(e=>e.trim().length>0);for(const s of i){const i=s.trim();!/\bmodul[e]?[n]?\b/.test(i)||/\d+\s*modul/.test(i)||/reihen/.test(i)||(/\bohne[\s-]+modul[e]?[n]?\b/.test(i)||/\bohne[\s-]+modul[e]?[n]?\b/.test(e.toLowerCase())?t.modules=!1:t.modules=!0),/\bmc4\b/.test(i)&&(/\bohne[\s-]+mc4\b/.test(i)||/\bohne[\s-]+mc4\b/.test(e.toLowerCase())?t.mc4=!1:t.mc4=!0),/\b(?:kabel|solarkabel)\b/.test(i)&&(/\bohne[\s-]+(?:kabel|solarkabel)\b/.test(i)||/\bohne[\s-]+(?:kabel|solarkabel)\b/.test(e.toLowerCase())?t.cable=!1:t.cable=!0),/\b(?:holz|holzunterleger)\b/.test(i)&&(/\bohne[\s-]+(?:holz|holzunterleger)\b/.test(i)||/\bohne[\s-]+(?:holz|holzunterleger)\b/.test(e.toLowerCase())?t.wood=!1:t.wood=!0),/\b(?:quetschkabelschuhe|kabelschuhe)\b/.test(i)&&(/\bohne[\s-]+(?:quetschkabelschuhe|kabelschuhe)\b/.test(i)||/\bohne[\s-]+(?:quetschkabelschuhe|kabelschuhe)\b/.test(e.toLowerCase())?t.quetschkabelschuhe=!1:t.quetschkabelschuhe=!0)}return t}parseInput(e){const t={},i=e.match(this.patterns.gridSize);if(i){t.cols=parseInt(i[1]),t.rows=parseInt(i[2]);const s=e.match(this.patterns.spacing);let n=0;if(s&&(s[0].toLowerCase().includes("mit")&&!s[1]?n=1:s[1]&&(n=parseInt(s[1])),n>=0)){if(this.solarGrid.selection&&this.solarGrid.selection.some(e=>e&&e.some(e=>!0===e)))t.adjustSpacing={spacing:n,targetCols:t.cols,targetRows:t.rows};else{const e=Math.ceil(t.rows/(1+Math.max(n,1))),i=t.cols*e;t.rowConfig={rows:e,modulesPerRow:t.cols,spacing:n,totalModules:i}}}const o=e.match(this.patterns.gridCompact),r=e.match(this.patterns.gridSpaced);o?t.gridCompact=!0:r&&(t.gridSpaced=!0)}const s=e.match(this.patterns.rowPattern);if(!(i||s||e.match(this.patterns.moduleCount))){const i=e.match(this.patterns.spacing);if(i){let e=0;i[0].toLowerCase().includes("ohne")?e=0:i[0].toLowerCase().includes("mit")&&!i[1]?e=1:i[1]&&(e=parseInt(i[1]));return this.solarGrid.selection&&this.solarGrid.selection.some(e=>e&&e.some(e=>!0===e))?(t.adjustSpacing={spacing:e,targetCols:null,targetRows:null},t):(this.solarGrid.showToast("⚠️ Keine Module vorhanden - erst Module auswählen, dann Abstand anpassen",3e3),{})}}if(s){let i,n;if(s[1]&&s[2])i=this.parseWordNumber(s[1]),n=parseInt(s[2]);else if(s[3]&&s[4]){const e=parseInt(s[3]);i=this.parseWordNumber(s[4]),n=Math.ceil(e/i),t.intelligentDistribution={totalModules:e,numRows:i,baseModulesPerRow:Math.floor(e/i),extraModules:e%i}}else s[5]&&s[6]&&(i=parseInt(s[5]),n=parseInt(s[6]));if(i&&n){const s=e.match(this.patterns.spacing);let o=0;s&&(s[0].toLowerCase().includes("mit")&&!s[1]?o=1:s[1]&&(o=parseInt(s[1]))),t.rowConfig={rows:i,modulesPerRow:n,spacing:o,totalModules:i*n};const r=i+(i-1)*o;t.cols=n,t.rows=r}}const n=e.match(this.patterns.distributionEqual),o=e.match(this.patterns.distributionRows),r=e.match(this.patterns.distributionColumns),a=e.match(this.patterns.distributionRandom);if(n)t.distribution="equal";else if(o)t.distribution="rows";else if(r)t.distribution="columns";else if(a)t.distribution="random";else{const s=e.match(this.patterns.moduleCount);if(s&&!i){t.moduleCount=parseInt(s[1]);const i=e.match(this.patterns.spacing),n=e.match(this.patterns.spacingDouble),o=e.match(this.patterns.spacingRowsOnly),r=e.match(this.patterns.spacingColumnsOnly);let a=0;n?a=2:o?(a=1,t.spacingRowsOnly=!0):r?(a=1,t.spacingColumnsOnly=!0):i&&(i[0].toLowerCase().includes("mit")&&!i[1]?a=1:i[1]&&(a=parseInt(i[1])));const l=this.calculateOptimalGrid(t.moduleCount);if(t.cols=l.cols,t.rows=l.rows,a>0){const e=Math.ceil(Math.sqrt(t.moduleCount/l.cols)),i=Math.ceil(t.moduleCount/e);t.rowConfig={rows:e,modulesPerRow:i,spacing:a,totalModules:t.moduleCount},t.rows=e+(e-1)*a,t.cols=Math.max(t.cols,i)}}}const l=e.match(this.patterns.orientation);l&&(t.orientation=l[0].toLowerCase().includes("vertikal")||l[0].toLowerCase().includes("vertical")?"vertical":"horizontal");const c=e.match(this.patterns.checkboxAllExcept),h=e.match(this.patterns.checkboxOnly),d=e.match(this.patterns.checkboxWithout),u=e.match(this.patterns.checkboxWithAll);if(c){const i=e.toLowerCase().match(/(?:alles\s*außer|alle\s*außer)\s+(\w+)/);if(i){const e=i[1];t.includeModules="module"!==e&&"modulen"!==e,t.mc4="mc4"!==e,t.cable="kabel"!==e&&"solarkabel"!==e,t.wood="holz"!==e&&"holzunterleger"!==e,t.quetschkabelschuhe="quetschkabelschuhe"!==e&&"kabelschuhe"!==e}}else if(h){const i=e.toLowerCase().match(/(?:nur|only)\s+(.+?)(?:\s+und\s+(.+?))*(?:\s*$)/);if(i){const e=[i[1],i[2]].filter(Boolean);t.includeModules=e.some(e=>e.includes("module")),t.mc4=e.some(e=>e.includes("mc4")),t.cable=e.some(e=>e.includes("kabel")||e.includes("solarkabel")),t.wood=e.some(e=>e.includes("holz")),t.quetschkabelschuhe=e.some(e=>e.includes("quetschkabelschuhe")||e.includes("kabelschuhe"))}}else if(d)t.includeModules=!0,t.mc4=!1,t.cable=!1,t.wood=!1,t.quetschkabelschuhe=!1;else if(u)t.includeModules=!0,t.mc4=!0,t.cable=!0,t.wood=!0,t.quetschkabelschuhe=!0;else{const i=this.parseCheckboxCombinations(e);if(Object.values(i).some(e=>null!==e))null!==i.modules&&(t.includeModules=i.modules),null!==i.mc4&&(t.mc4=i.mc4),null!==i.cable&&(t.cable=i.cable),null!==i.wood&&(t.wood=i.wood),null!==i.quetschkabelschuhe&&(t.quetschkabelschuhe=i.quetschkabelschuhe);else{const i=e.match(this.patterns.moduleCheckbox);i&&(t.includeModules=i[0].toLowerCase().includes("mit"));const s=e.match(this.patterns.mc4);s&&(t.mc4=s[0].toLowerCase().includes("mit"));const n=e.match(this.patterns.cable);n&&(t.cable=n[0].toLowerCase().includes("mit"));const o=e.match(this.patterns.wood);o&&(t.wood=o[0].toLowerCase().includes("mit"));const r=e.match(this.patterns.quetschkabelschuhe);r&&(t.quetschkabelschuhe=r[0].toLowerCase().includes("mit"))}}const m=e.match(this.patterns.saveWithName);if(m)return t.action="saveConfig",t.configName=m[1],t;if(e.match(this.patterns.saveConfig))return t.action="saveConfig",t;e.length<20&&!e.match(/\d/)&&(t.cols=this.solarGrid.cols,t.rows=this.solarGrid.rows,t.useCurrentGrid=!0);if(e.match(this.patterns.deleteConfig))return t.action="deleteConfig",t;if(e.match(this.patterns.deleteModules))return t.action="deleteModules",t;return e.match(this.patterns.resetGrid)?(t.action="resetGrid",t):t}calculateOptimalGrid(e){const t=[];for(let i=1;i<=Math.sqrt(e);i++)e%i===0&&t.push([i,e/i]);const i=t.reduce((e,t)=>Math.max(e[0],e[1])/Math.min(e[0],e[1])<=Math.max(t[0],t[1])/Math.min(t[0],t[1])?e:t);return{cols:Math.max(i[0],i[1]),rows:Math.min(i[0],i[1])}}applyConfiguration(e){const t=this.solarGrid.selection?this.solarGrid.selection.map(e=>[...e]):null,i=this.solarGrid.cols,s=this.solarGrid.rows;if(e.cols&&e.rows&&(this.solarGrid.cols=e.cols,this.solarGrid.rows=e.rows),e.orientation&&(this.solarGrid.orV&&(this.solarGrid.orV.checked="vertical"===e.orientation),this.solarGrid.orH&&(this.solarGrid.orH.checked="horizontal"===e.orientation)),e.action)return void this.handleAction(e.action,e);e.hasOwnProperty("includeModules")&&this.solarGrid.incM&&(this.solarGrid.incM.checked=e.includeModules),e.hasOwnProperty("mc4")&&this.solarGrid.mc4&&(this.solarGrid.mc4.checked=e.mc4),e.hasOwnProperty("cable")&&this.solarGrid.solarkabel&&(this.solarGrid.solarkabel.checked=e.cable),e.hasOwnProperty("wood")&&this.solarGrid.holz&&(this.solarGrid.holz.checked=e.wood),e.hasOwnProperty("quetschkabelschuhe")&&this.solarGrid.quetschkabelschuhe&&(this.solarGrid.quetschkabelschuhe.checked=e.quetschkabelschuhe);let n;n=e.cols&&e.cols!==i||e.rows&&e.rows!==s?e.moduleCount||e.rowConfig?Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)):Array.from({length:this.solarGrid.rows},(e,i)=>Array.from({length:this.solarGrid.cols},(e,s)=>!!(t&&i<t.length&&s<t[i].length)&&t[i][s])):t||Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)),this.solarGrid.selection=n,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),e.adjustSpacing?this.adjustGridSpacing(e.adjustSpacing):e.rowConfig?this.applyRowConfiguration(e.rowConfig,e.intelligentDistribution):e.moduleCount&&this.autoSelectModules(e.moduleCount),this.hideHelpAfterFirstUse()}applyPreviewToMainGrid(e){this.solarGrid.hidePreviewGrid(),this.solarGrid.showMainGrid(),this.applyConfiguration(e)}handleAction(e,t={}){switch(e){case"saveConfig":t.configName?(this.solarGrid.renameCurrentConfig(t.configName),this.solarGrid.showToast(`💾 Konfiguration umbenannt zu "${t.configName}"`,2e3)):(this.solarGrid.saveNewConfig(),this.solarGrid.showToast("💾 Konfiguration gespeichert",2e3));break;case"deleteConfig":if(this.solarGrid.configs.length<=1)return void this.solarGrid.showToast("⚠️ Kann letzte Konfiguration nicht löschen",3e3);null!==this.solarGrid.currentConfig&&(this.solarGrid.deleteConfig(this.solarGrid.currentConfig),this.solarGrid.showToast("🗑️ Konfiguration gelöscht",2e3));break;case"deleteModules":this.clearModuleSelection(),this.solarGrid.showToast("🔄 Module-Auswahl gelöscht",2e3);break;case"resetGrid":this.solarGrid.resetGridToDefault(),this.solarGrid.showToast("⚡ Grid zurückgesetzt",2e3);break;default:console.warn("Unbekannte Action:",e)}}clearModuleSelection(){for(let e=0;e<this.solarGrid.rows;e++)for(let t=0;t<this.solarGrid.cols;t++)this.solarGrid.selection[e]&&(this.solarGrid.selection[e][t]=!1);this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}hideHelpAfterFirstUse(){const e=document.querySelector(".bulk-selection-help");e&&(e.style.display="none",localStorage.setItem("solarTool_hideHelp","true"))}autoSelectModules(e){this.solarGrid.cols*this.solarGrid.rows<e&&this.expandGridForModules(e),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1));let t=0;for(let i=0;i<this.solarGrid.rows&&t<e;i++)for(let s=0;s<this.solarGrid.cols&&t<e;s++)this.solarGrid.selection[i][s]=!0,t++;this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForModules(e){if(this.solarGrid.cols*this.solarGrid.rows>=e)return;this.calculateOptimalGrid(e);let t=this.solarGrid.cols,i=this.solarGrid.rows;for(;t*i<e;)t<=i?t++:i++;this.solarGrid.cols=t,this.solarGrid.rows=i;const s=this.solarGrid.selection||[];this.solarGrid.selection=Array.from({length:i},(e,i)=>Array.from({length:t},(e,t)=>i<s.length&&t<s[i].length&&s[i][t])),this.solarGrid.updateSize()}adjustGridSpacing(e){const{spacing:t,targetCols:i,targetRows:s}=e,n=[];for(let e=0;e<this.solarGrid.rows;e++)if(this.solarGrid.selection[e]&&this.solarGrid.selection[e].some(e=>!0===e)){const t=[];for(let i=0;i<this.solarGrid.cols;i++)!0===this.solarGrid.selection[e][i]&&t.push(i);n.push({originalRow:e,modules:t})}if(0===n.length)return;let o;o=0===t?n.length:n.length+(n.length-1)*t;const r=Math.max(...n.map(e=>e.modules.length>0?Math.max(...e.modules):0)),a=Math.max(i||this.solarGrid.cols,r+1);this.solarGrid.cols=a,this.solarGrid.rows=o;const l=Array.from({length:o},()=>Array.from({length:a},()=>!1));let c=0;for(let e=0;e<n.length;e++){const i=n[e];for(const e of i.modules)e<a&&(l[c][e]=!0);e<n.length-1&&(c+=1+t)}this.solarGrid.selection=l,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),0===t?this.solarGrid.showToast(`🔧 Abstände entfernt - ${n.length} Reihen kompakt`,2e3):this.solarGrid.showToast(`📏 ${t} Reihen Abstand hinzugefügt - ${o} Reihen total`,2e3)}applyRowConfiguration(e,t=null){const{rows:i,modulesPerRow:s,spacing:n,totalModules:o}=e,r=i+(i-1)*n,a=s;(this.solarGrid.rows<r||this.solarGrid.cols<a)&&this.expandGridForRowConfig(a,r);for(let e=0;e<this.solarGrid.rows;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=0;t<this.solarGrid.cols;t++)this.solarGrid.selection[e][t]=!1}let l=0,c=0;for(let e=0;e<i;e++){let i;if(t){const{baseModulesPerRow:s,extraModules:n}=t;i=s+(e<n?1:0)}else i=Math.min(s,o-c);for(let e=0;e<i&&e<this.solarGrid.cols;e++)l<this.solarGrid.rows&&(this.solarGrid.selection[l]||(this.solarGrid.selection[l]=[]),this.solarGrid.selection[l][e]=!0,c++);l+=1+n}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForRowConfig(e,t){const i=this.solarGrid.selection||[];this.solarGrid.cols=Math.max(this.solarGrid.cols,e),this.solarGrid.rows=Math.max(this.solarGrid.rows,t),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},(e,t)=>Array.from({length:this.solarGrid.cols},(e,s)=>t<i.length&&s<i[t].length&&i[t][s])),this.solarGrid.updateSize()}}class h{constructor(e){this.solarGrid=e,this.firstClick=null,this.isSelecting=!1,this.bulkMode=!1,this.isDragging=!1,this.dragStart=null,this.mousePressed=!1,this.setupKeyListener(),this.setupGlobalMouseEvents()}setupKeyListener(){}toggleBulkMode(){this.bulkMode=!this.bulkMode,this.bulkMode?(this.showBulkModeIndicator(!0),this.firstClick=null):(this.showBulkModeIndicator(!1),this.firstClick=null,this.clearHighlight())}showBulkModeIndicator(e){if(document.querySelectorAll(".bulk-mode-indicator").forEach(e=>e.remove()),e){const e=document.createElement("div");e.className="bulk-mode-indicator",e.innerHTML="🔄 Bulk-Modus aktiv - Klicke auf zwei Zellen um einen Bereich auszuwählen",e.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background: #f5a623;\n          color: white;\n          padding: 8px 16px;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: bold;\n          z-index: 1000;\n          box-shadow: 0 4px 12px rgba(245, 166, 35, 0.3);\n          animation: slideIn 0.3s ease;\n        ";const t=document.createElement("style");t.textContent="\n          @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n          }\n        ",document.head&&document.head.appendChild(t),document.body&&document.body.appendChild(e)}}initializeBulkSelection(){const e=this.solarGrid.buildGrid.bind(this.solarGrid);this.solarGrid.buildGrid=()=>{e(),setTimeout(()=>{this.addBulkSelectionToGrid()},10)},setTimeout(()=>{this.addBulkSelectionToGrid()},100)}addBulkSelectionToGrid(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach((e,t)=>{const i=t%this.solarGrid.cols,s=Math.floor(t/this.solarGrid.cols),n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),n.addEventListener("mousedown",e=>{e.preventDefault(),this.handleDragStart(e,i,s,n)}),n.addEventListener("touchstart",e=>{e.preventDefault(),this.handleDragStart(e,i,s,n)}),n.addEventListener("mouseenter",e=>{this.mousePressed&&this.dragStart&&(this.isDragging=!0,this.highlightRange(this.dragStart,{x:i,y:s}))}),n.addEventListener("touchmove",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.isDragging=!0,this.highlightRange(this.dragStart,{x:i,y:s}))}),n.addEventListener("mouseup",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.handleDragEnd(e,i,s))}),n.addEventListener("touchend",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.handleDragEnd(e,i,s))}),n.addEventListener("click",e=>{this.isDragging||this.mousePressed&&this.dragStart||(this.solarGrid.selection[s]||(this.solarGrid.selection[s]=[]),e.ctrlKey||e.metaKey,this.solarGrid.selection[s][i]=!this.solarGrid.selection[s][i],n.classList.toggle("selected"),this.solarGrid.trackInteraction(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange())}),n.addEventListener("mouseleave",()=>{this.mousePressed||this.clearHighlight()})})}selectRange(e,t){const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),n=Math.min(e.y,t.y),o=Math.max(e.y,t.y),r=!e.wasSelected;for(let e=n;e<=o;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=i;t<=s;t++)this.solarGrid.selection[e][t]=r}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}highlightRange(e,t){this.clearHighlight();const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),n=Math.min(e.y,t.y),o=Math.max(e.y,t.y),r=this.solarGrid.gridEl.querySelectorAll(".grid-cell"),a=void 0===e.wasSelected||!e.wasSelected;for(let e=n;e<=o;e++)for(let t=i;t<=s;t++){const i=e*this.solarGrid.cols+t;r[i]&&(r[i].classList.add("bulk-highlight"),a?r[i].classList.add("drag-preview-select"):r[i].classList.add("drag-preview-deselect"))}}clearHighlight(){this.solarGrid.gridEl.querySelectorAll(".bulk-highlight, .drag-preview-select, .drag-preview-deselect").forEach(e=>{e.classList.remove("bulk-highlight","drag-preview-select","drag-preview-deselect")});this.solarGrid.gridEl.querySelectorAll(".drag-start-marker, .drag-select-mode, .drag-deselect-mode").forEach(e=>{e.classList.remove("drag-start-marker","drag-select-mode","drag-deselect-mode")})}resetDragState(){this.mousePressed=!1,this.isDragging=!1,this.dragStart=null,this.clearHighlight()}calculateRangeSize(e,t){const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),n=Math.min(e.y,t.y);return(s-i+1)*(Math.max(e.y,t.y)-n+1)}clearFirstClickMarker(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach(e=>e.classList.remove("first-click-marker"))}handleDragStart(e,t,i,s){const n=this.solarGrid.selection[i]?.[t]||!1;this.mousePressed=!0,this.isDragging=!1,this.dragStart={x:t,y:i,wasSelected:n},this.clearHighlight(),s.classList.add("drag-start-marker"),n?s.classList.add("drag-deselect-mode"):s.classList.add("drag-select-mode")}handleDragEnd(e,t,i){(this.isDragging||this.dragStart.x===t&&this.dragStart.y===i)&&this.selectRange(this.dragStart,{x:t,y:i}),this.resetDragState()}setupGlobalMouseEvents(){document.addEventListener("mouseup",e=>{this.mousePressed&&this.resetDragState()}),document.addEventListener("touchend",e=>{this.mousePressed&&this.resetDragState()}),this.solarGrid.gridEl.addEventListener("mouseleave",()=>{this.mousePressed&&!this.isDragging&&this.resetDragState()}),this.solarGrid.gridEl.addEventListener("touchcancel",()=>{this.mousePressed&&!this.isDragging&&this.resetDragState()}),this.solarGrid.gridEl.addEventListener("contextmenu",e=>{(this.isDragging||this.mousePressed)&&e.preventDefault()}),this.solarGrid.gridEl.addEventListener("touchmove",e=>{(this.isDragging||this.mousePressed)&&e.preventDefault()})}}class d{constructor(){this.gridEl=document.getElementById("grid"),this.wrapper=document.querySelector(".grid-wrapper"),this.wIn=document.getElementById("width-input"),this.hIn=document.getElementById("height-input"),this.orH=document.getElementById("orient-h"),this.orV=document.getElementById("orient-v"),this.incM=document.getElementById("include-modules"),this.mc4=document.getElementById("mc4"),this.solarkabel=document.getElementById("solarkabel"),this.holz=document.getElementById("holz"),this.quetschkabelschuhe=document.getElementById("quetschkabelschuhe"),this.listHolder=document.querySelector(".product-section"),this.prodList=document.getElementById("produktliste"),this.summaryHolder=document.getElementById("summary-list-holder"),this.summaryList=document.getElementById("summary-list"),this.saveBtn=document.getElementById("save-config-btn"),this.addBtn=document.getElementById("add-to-cart-btn"),this.summaryBtn=document.getElementById("summary-add-cart-btn"),this.configListEl=document.getElementById("config-list"),this.resetBtn=document.getElementById("reset-btn"),this.continueLaterBtn=document.getElementById("continue-later-btn"),this.selection=[],this.configs=[],this.currentConfig=null,this.default={cols:5,rows:5,width:176,height:113},this.updateTimeout=null,this.updateDelay=100,this.resizeObserver=null,this.resizeTimeout=null,this.zoomLevel=1,this.minZoom=.5,this.maxZoom=3,this.zoomObserver=null,this.performanceMetrics={gridRenderTime:0,updateTime:0,memoryUsage:0,fps:0,errorCount:0},this.sessionId=this.generateSessionId(),this.sessionStartTime=Date.now(),this.firstInteractionTime=null,this.lastInteractionTime=Date.now(),this.interactionCount=0,this.webhookUrl="https://hook.eu2.make.com/c7lkudk1v2a2xsr291xbvfs2cb25b84k",this.pdfGenerator=new l(this),this.init()}generateSessionId(){return`session_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}trackInteraction(){this.firstInteractionTime||(this.firstInteractionTime=Date.now()),this.lastInteractionTime=Date.now(),this.interactionCount++}formatDuration(e){if(!e||e<0)return"00:00:00";const t=Math.floor(e/1e3),i=Math.floor(t/3600),s=Math.floor(t%3600/60),n=t%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}getSessionData(){const e=Date.now(),t=e-this.sessionStartTime,i=this.firstInteractionTime?this.firstInteractionTime-this.sessionStartTime:0,s=e-this.lastInteractionTime;return{sessionDuration:this.formatDuration(t),timeToFirstInteraction:this.formatDuration(i),timeSinceLastInteraction:this.formatDuration(s),interactionCount:this.interactionCount,sessionStartTime:this.sessionStartTime,firstInteractionTime:this.firstInteractionTime,lastInteractionTime:this.lastInteractionTime,performanceMetrics:this.performanceMetrics}}getProductSummary(){const t=this.calculateParts();this.incM.checked||delete t.Solarmodul;const i=Object.entries(t).filter(([,e])=>e>0);let s=0;const n={};return i.forEach(([t,i])=>{const o=Math.ceil(i/e[t]),r=a(t);s+=o*r;const l=t.replace(/_/g,"");n[l]=i}),{totalPrice:s}}generateGridVisualization(e,t,i,s,n){let o=`<div class="grid" style="--cols: ${t}; --rows: ${i}; --cell-size: ${s}px; --cell-height: ${n}px; --cell-gap: 2px;">`;for(let s=0;s<i;s++)for(let i=0;i<t;i++){o+=`<div class="${e[s]&&e[s][i]?"cell selected":"cell"}"></div>`}o+="</div>";return{html:o,css:".grid { \n        display: grid; \n        gap: var(--cell-gap); \n        grid-template-columns: repeat(var(--cols), var(--cell-size)); \n        grid-template-rows: repeat(var(--rows), var(--cell-height)); \n        margin: auto; \n        background: transparent; \n      } \n      .cell { \n        background: #000000; \n        border-radius: 6px; \n        width: var(--cell-size); \n        height: var(--cell-height); \n        transition: all 0.15s ease; \n      } \n      .cell.selected { \n        background: #7f7f7f; \n      }"}}getConfigData(e=null){const t=e||{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked},i=this.getProductSummary(),s=this.generateGridVisualization(t.selection,t.cols,t.rows,t.cellWidth,t.cellHeight),n=this.calculatePartsDirectly({selection:t.selection,cols:t.cols,rows:t.rows,cellWidth:t.cellWidth,cellHeight:t.cellHeight,orientation:t.orientation,incM:t.incM}),o={Solarmodul:n.Solarmodul||0,Endklemmen:n.Endklemmen||0,Schrauben:n.Schrauben||0,Dachhaken:n.Dachhaken||0,Mittelklemmen:n.Mittelklemmen||0,Endkappen:n.Endkappen||0,Schienenverbinder:n.Schienenverbinder||0,Schiene240cm:n.Schiene_240_cm||0,Schiene360cm:n.Schiene_360_cm||0};return{timestamp:(new Date).toISOString(),sessionId:this.sessionId,sessionData:this.getSessionData(),config:{cols:t.cols,rows:t.rows,cellWidth:t.cellWidth,cellHeight:t.cellHeight,orientation:t.orientation,gridVisualization:s,options:{includeModules:t.incM}},summary:i,productQuantities:o,totalPrice:i.totalPrice,analytics:{totalCells:t.cols*t.rows,selectedCells:t.selection.flat().filter(e=>e).length,selectionPercentage:(t.selection.flat().filter(e=>e).length/(t.cols*t.rows)*100).toFixed(2),gridArea:t.cols*t.rows,averageCellSize:((t.cellWidth+t.cellHeight)/2).toFixed(2)}}}async sendConfigToWebhook(e){try{const t={...e,analytics:{sessionData:this.getSessionData(),performanceMetrics:this.performanceMetrics,userAgent:navigator.userAgent,screenResolution:`${screen.width}x${screen.height}`,timestamp:(new Date).toISOString(),featureUsage:{dragToSelect:this.interactionCount>0,smartConfig:e.smartConfigUsed||!1,mobileDevice:this.checkMobileDevice(),zoomLevel:this.zoomLevel||1}}},i=await this.pdfGenerator.captureGridImageForWebhook(e);if(i){const s=e.cols||5,n=e.rows||5,o=2,r=40,a=s*60+(s-1)*o+r,l=n*60+(n-1)*o+r;console.log("Grid Image Dimensions:",{cols:s,rows:n,width:a,height:l});const c=i.split(",")[1];t.gridImage={data:i,base64:c,format:"data-url",mimeType:"image/png",width:a,height:l}}return!!(await fetch(this.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok}catch(e){return console.error("Webhook send error:",e),!1}}async sendCurrentConfigToWebhook(){const e=this.getConfigData();return await this.sendConfigToWebhook(e)}async sendAllConfigsToWebhook(){const e=[];let t=0;for(let i=0;i<this.configs.length;i++){const s=this.configs[i];let n;n=i===this.currentConfig?{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked}:{cols:s.cols,rows:s.rows,cellWidth:s.cellWidth,cellHeight:s.cellHeight,orientation:s.orientation,selection:s.selection,incM:s.incM,mc4:s.mc4,solarkabel:s.solarkabel,holz:s.holz};const o=this.selection,r=!!this.orV&&this.orV.checked,a=!!this.solarkabel&&this.solarkabel.checked,l=!!this.incM&&this.incM.checked,c=!!this.mc4&&this.mc4.checked,h=!!this.holz&&this.holz.checked;this.selection=n.selection,this.orV&&(this.orV.checked="vertical"===n.orientation),this.orH&&(this.orH.checked=!("vertical"===n.orientation)),this.solarkabel&&(this.solarkabel.checked=n.solarkabel),this.incM&&(this.incM.checked=n.incM),this.mc4&&(this.mc4.checked=n.mc4),this.holz&&(this.holz.checked=n.holz);const d=this.getConfigData(n);d.configIndex=i,d.configName=s.name,d.totalConfigsInSession=this.configs.length,this.selection=o,this.orV&&(this.orV.checked=r),this.orH&&(this.orH.checked=!r),this.solarkabel&&(this.solarkabel.checked=a),this.incM&&(this.incM.checked=l),this.mc4&&(this.mc4.checked=c),this.holz&&(this.holz.checked=h);try{const s=await this.sendConfigToWebhook(d);s&&t++,e.push(s),i<this.configs.length-1&&await new Promise(e=>setTimeout(e,100))}catch(t){e.push(!1)}}return t===this.configs.length}checkMobileDevice(){(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window&&window.innerWidth<=1024)&&this.showMobileWarning()}showMobileWarning(){const e=document.getElementById("mobile-warning"),t=document.getElementById("mobile-continue"),i=document.getElementById("mobile-close");if(e){sessionStorage.getItem("mobile-warning-seen")||(e.classList.remove("hidden"),t?.addEventListener("click",()=>{e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),i?.addEventListener("click",()=>{e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),e.addEventListener("click",t=>{t.target===e&&(e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true"))}))}}init(){this.checkMobileDevice();const e=new URLSearchParams(window.location.search).get("configData");if(e)try{const t=decodeURIComponent(atob(e)),i=JSON.parse(t);return void(Array.isArray(i)?(this.configs=i,this.loadConfig(0)):(this.configs.push(i),this.loadConfig(0)))}catch(e){}if([this.wIn,this.hIn].filter(e=>e).forEach(e=>e.addEventListener("change",()=>{this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange()})),this.orH&&this.orV){let e=this.orH.checked?"horizontal":"vertical";[this.orH,this.orV].forEach(t=>t.addEventListener("change",()=>{if(!t.checked)return;const i=t===this.orH?"horizontal":"vertical";if(i===e)return;const s=document.getElementById("orient-h-setup"),n=document.getElementById("orient-v-setup");s&&n&&(s.checked=t===this.orH,n.checked=t===this.orV),this.trackInteraction(),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange(),e=i}))}[this.incM,this.mc4,this.solarkabel,this.holz,this.quetschkabelschuhe].filter(e=>e).forEach(e=>e.addEventListener("change",()=>{this.trackInteraction(),this.updateAllConfigurationsForCheckboxes()}));const t=document.getElementById("orient-h-setup"),i=document.getElementById("orient-v-setup");t&&i&&[t,i].forEach(e=>e.addEventListener("change",()=>{if(!e.checked)return;const t=e===i;this.orV&&(this.orV.checked=t),this.orH&&(this.orH.checked=!t),this.trackInteraction(),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()})),document.querySelectorAll('[data-dir="right"]').forEach(e=>{e.classList.contains("plus-btn")?e.addEventListener("click",()=>{this.trackInteraction(),this.addColumnRight()}):e.classList.contains("minus-btn")&&e.addEventListener("click",()=>{this.trackInteraction(),this.removeColumnRight()})}),document.querySelectorAll('[data-dir="left"]').forEach(e=>{e.classList.contains("plus-btn")?e.addEventListener("click",()=>{this.trackInteraction(),this.addColumnLeft()}):e.classList.contains("minus-btn")&&e.addEventListener("click",()=>{this.trackInteraction(),this.removeColumnLeft()})}),document.querySelectorAll('[data-dir="bottom"]').forEach(e=>{e.classList.contains("plus-btn")?e.addEventListener("click",()=>{this.trackInteraction(),this.addRowBottom()}):e.classList.contains("minus-btn")&&e.addEventListener("click",()=>{this.trackInteraction(),this.removeRowBottom()})}),document.querySelectorAll('[data-dir="top"]').forEach(e=>{e.classList.contains("plus-btn")?e.addEventListener("click",()=>{this.trackInteraction(),this.addRowTop()}):e.classList.contains("minus-btn")&&e.addEventListener("click",()=>{this.trackInteraction(),this.removeRowTop()})}),this.saveBtn&&this.saveBtn.addEventListener("click",()=>{this.trackInteraction(),this.saveNewConfig()}),this.addBtn&&this.addBtn.addEventListener("click",()=>{this.trackInteraction(),this.addCurrentToCart()}),this.summaryBtn&&this.summaryBtn.addEventListener("click",()=>{this.trackInteraction(),this.addAllToCart()}),this.resetBtn&&this.resetBtn.addEventListener("click",()=>{this.trackInteraction(),this.resetGridToDefault()}),this.continueLaterBtn&&this.continueLaterBtn.addEventListener("click",()=>{this.trackInteraction(),this.generateContinueLink()});document.getElementById("sidebar-toggle");if(this.initSidebarNavigation(),window.addEventListener("resize",()=>{this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}),0===this.configs.length){this.cols=this.default.cols,this.rows=this.default.rows,this.setup();const e=this._makeConfigObject();this.configs.push(e),this.loadConfig(0)}this.setupResizeObserver(),this.setupPinchToZoom(),this.initSmartConfigFeatures(),this.initAutoSaveIndicator(),this.initConfigList()}initSidebarNavigation(){const e=document.getElementById("back-to-overview");document.getElementById("config-detail-view"),document.getElementById("config-overview");e&&e.addEventListener("click",()=>{this.showOverview()});const t=document.getElementById("edit-config-name");t&&t.addEventListener("click",()=>{this.editConfigName()});const i=document.getElementById("delete-current-config");i&&i.addEventListener("click",()=>{this.deleteCurrentConfig()});const s=document.getElementById("express-checkout-btn");s&&s.addEventListener("click",()=>{this.addCurrentToCart()});const n=document.getElementById("next-config-btn");n&&n.addEventListener("click",()=>{this.saveNewConfig()});const o=document.getElementById("add-all-to-cart-btn");o&&o.addEventListener("click",()=>{this.addAllConfigsToCart()});const r=document.getElementById("continue-later-btn");r&&r.addEventListener("click",()=>{this.generateContinueLink()})}showOverview(){null!==this.currentConfig&&this.updateConfig();const e=document.getElementById("config-detail-view"),t=document.getElementById("config-overview");e&&t&&(e.classList.remove("active"),t.classList.add("active"),this.clearAllInputFields(),this.updateConfigList())}clearAllInputFields(){const e=document.getElementById("current-config-title");if(e){e.parentNode.querySelectorAll(".config-title-input").forEach(e=>e.remove()),e.style.display="block"}document.querySelectorAll(".config-item").forEach(e=>{const t=e.querySelector(".config-item-name");if(t){t.parentNode.querySelectorAll('input[type="text"]').forEach(e=>e.remove()),t.style.display="block"}})}initConfigList(){document.getElementById("config-overview")?.classList.contains("active")&&this.updateConfigList(),this.initAdditionalProductsListeners()}showDetailView(e=null){const t=document.getElementById("config-detail-view"),i=document.getElementById("config-overview");t&&i&&(i.classList.remove("active"),t.classList.add("active"),null!==e&&this.loadConfig(e),this.updateDetailView())}updateDetailView(){const e=this.configs[this.currentConfig];if(!e)return;const t=document.getElementById("current-config-title");t&&(t.textContent=e.name||`Konfiguration #${this.currentConfig+1}`),this.updateCurrentTotalPrice()}updateCurrentTotalPrice(){const t=document.getElementById("current-total-price");if(t){const i=this.calculatePartsDirectly({selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?.value||"179"),cellHeight:parseInt(this.hIn?.value||"113"),orientation:this.orV?.checked?"vertical":"horizontal",incM:document.getElementById("include-modules")?.checked||!1,mc4:document.getElementById("mc4")?.checked||!1,solarkabel:document.getElementById("solarkabel")?.checked||!1,holz:document.getElementById("holz")?.checked||!1,quetschkabelschuhe:document.getElementById("quetschkabelschuhe")?.checked||!1});let s=0;Object.entries(i).forEach(([t,i])=>{if(i>0){const n=Math.ceil(i/(e[t]||1)),o=a(t);s+=n*o}}),t.textContent=`${s.toFixed(2).replace(".",",")} €`}}updateConfigList(){const e=document.getElementById("config-list");e&&(e.innerHTML="",this.configs.forEach((t,i)=>{const s=document.createElement("div");s.className="config-item",i===this.currentConfig&&s.classList.add("active");const n=this.calculateConfigPrice(t);s.innerHTML=`\n\t\t\t\t\t<div class="config-item-info">\n\t\t\t\t\t\t<div class="config-item-name">${t.name||`Konfiguration #${i+1}`}</div>\n\t\t\t\t\t\t<div class="config-item-price">${n.toFixed(2).replace(".",",")} €</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="config-item-actions">\n\t\t\t\t\t\t<button class="icon-btn" onclick="solarGrid.editConfigNameInList(${i})" title="Bearbeiten">\n\t\t\t\t\t\t\t<span>✏️</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button class="icon-btn delete" onclick="solarGrid.deleteConfigFromList(${i})" title="Löschen">\n\t\t\t\t\t\t\t<span>🗑️</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<div class="config-item-arrow">▶</div>\n\t\t\t\t\t</div>\n\t\t\t\t`,s.addEventListener("click",e=>{e.target.closest(".config-item-actions")||this.showDetailView(i)}),e.appendChild(s)}),this.updateOverviewTotalPrice(),this.renderAdditionalProducts())}initAutoSaveIndicator(){this.autoSaveTimeout=null}showAutoSaveIndicator(){const e=document.getElementById("auto-save-indicator");e&&(e.classList.remove("hidden"),this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(()=>{e.classList.add("hidden")},1e3))}updateOverviewTotalPrice(){const e=document.getElementById("overview-total-price");if(!e)return;let t=0;this.configs.forEach(e=>{t+=this.calculateConfigPrice(e)});const i=this.calculateAdditionalProductsPrice();t+=i,e.textContent=`${t.toFixed(2).replace(".",",")} €`}calculateAdditionalProductsPrice(){let e=0;if(document.getElementById("mc4")?.checked){const t=this.configs.reduce((e,t)=>e+t.selection.flat().filter(e=>e).length,0);e+=Math.ceil(t/30)*a("MC4_Stecker")}if(document.getElementById("solarkabel")?.checked){e+=1*a("Solarkabel")}if(document.getElementById("holz")?.checked){e+=1*a("Holzunterleger")}if(document.getElementById("quetschkabelschuhe")?.checked){e+=1*a("Quetschkabelschuhe")}return e}renderAdditionalProducts(){const e=document.getElementById("additional-products-list");if(e){if(e.innerHTML="",document.getElementById("mc4")?.checked){const t=this.configs.reduce((e,t)=>e+t.selection.flat().filter(e=>e).length,0),i=Math.ceil(t/30),s=i*a("MC4_Stecker"),n=document.createElement("div");n.className="additional-product-item",n.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">${i}x</span>\n\t\t\t\t\t\t<span class="item-name">MC4 Stecker</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="item-price">${s.toFixed(2).replace(".",",")} €</div>\n\t\t\t\t`,e.appendChild(n)}if(document.getElementById("solarkabel")?.checked){const t=1*a("Solarkabel"),i=document.createElement("div");i.className="additional-product-item",i.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">1x</span>\n\t\t\t\t\t\t<span class="item-name">Solarkabel 100M</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="item-price">${t.toFixed(2).replace(".",",")} €</div>\n\t\t\t\t`,e.appendChild(i)}if(document.getElementById("holz")?.checked){const t=1*a("Holzunterleger"),i=document.createElement("div");i.className="additional-product-item",i.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">1x</span>\n\t\t\t\t\t\t<span class="item-name">Unterlegholz für Dachhaken - 50 Stück</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="item-price">${t.toFixed(2).replace(".",",")} €</div>\n\t\t\t\t`,e.appendChild(i)}if(document.getElementById("quetschkabelschuhe")?.checked){const t=1*a("Quetschkabelschuhe"),i=document.createElement("div");i.className="additional-product-item",i.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">1x</span>\n\t\t\t\t\t\t<span class="item-name">Quetschkabelschuhe - 100 Stück</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="item-price">${t.toFixed(2).replace(".",",")} €</div>\n\t\t\t\t`,e.appendChild(i)}}}initAdditionalProductsListeners(){["mc4","solarkabel","holz","quetschkabelschuhe"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{this.updateOverviewTotalPrice(),this.renderAdditionalProducts()})})}editConfigName(){const e=document.getElementById("current-config-title");if(!e)return;e.parentNode.querySelectorAll(".config-title-input").forEach(e=>e.remove()),e.style.display="block";const t=document.createElement("input");t.type="text",t.value=e.textContent,t.className="config-title-input",t.style.cssText="\n\t\t\t\tfont-size: 24px;\n\t\t\t\tfont-weight: bold;\n\t\t\t\tcolor: #000000;\n\t\t\t\tbackground: transparent;\n\t\t\t\tborder: 2px solid #FFB101;\n\t\t\t\tborder-radius: 8px;\n\t\t\t\tpadding: 4px 8px;\n\t\t\t\twidth: 100%;\n\t\t\t\toutline: none;\n\t\t\t",e.style.display="none",e.parentNode.insertBefore(t,e),t.focus(),t.select();const i=function(){const i=t.value.trim();i&&null!==this.currentConfig&&(this.configs[this.currentConfig].name=i,e.textContent=i,this.updateConfigList(),this.updateConfig(),this.showAutoSaveIndicator()),e.style.display="block",t.remove()}.bind(this),s=function(){e.style.display="block",t.remove()}.bind(this);t.addEventListener("blur",i),t.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),i()):"Escape"===e.key&&(e.preventDefault(),s())})}editConfigNameInList(e){const t=this.configs[e];if(!t)return;const i=document.querySelectorAll(".config-item")[e];if(!i)return;const s=i.querySelector(".config-item-name");if(!s)return;s.parentNode.querySelectorAll('input[type="text"]').forEach(e=>e.remove()),s.style.display="block";const n=document.createElement("input");n.type="text",n.value=s.textContent,n.style.cssText="\n\t\t\t\tfont-size: 16px;\n\t\t\t\tfont-weight: normal;\n\t\t\t\tcolor: #000000;\n\t\t\t\tbackground: white;\n\t\t\t\tborder: 1px solid #FFB101;\n\t\t\t\tborder-radius: 4px;\n\t\t\t\tpadding: 2px 6px;\n\t\t\t\twidth: 80%;\n\t\t\t\toutline: none;\n\t\t\t",s.style.display="none",s.parentNode.insertBefore(n,s),n.focus(),n.select();const o=function(){const e=n.value.trim();e&&(t.name=e,s.textContent=e,this.updateConfig(),this.showAutoSaveIndicator()),s.style.display="block",n.parentNode&&n.remove(),this.updateConfigList()}.bind(this),r=function(){s.style.display="block",n.parentNode&&n.remove()}.bind(this);n.addEventListener("blur",o),n.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),o()):"Escape"===e.key&&(e.preventDefault(),r())})}deleteCurrentConfig(){if(this.configs.length<=1)return void alert("Die letzte Konfiguration kann nicht gelöscht werden.");const e=this.configs[this.currentConfig],t=e?.name||`Konfiguration #${this.currentConfig+1}`;confirm(`Möchten Sie "${t}" wirklich löschen?`)&&(this.configs.splice(this.currentConfig,1),this.currentConfig>=this.configs.length&&(this.currentConfig=this.configs.length-1),this.loadConfig(this.currentConfig),this.saveToUrl(),this.showOverview())}deleteConfigFromList(e){if(this.configs.length<=1)return void alert("Die letzte Konfiguration kann nicht gelöscht werden.");const t=this.configs[e];confirm(`Möchten Sie "${t?.name||`Konfiguration #${e+1}`}" wirklich löschen?`)&&(this.configs.splice(e,1),this.currentConfig>=this.configs.length?this.currentConfig=this.configs.length-1:this.currentConfig>e&&this.currentConfig--,this.loadConfig(this.currentConfig),this.saveToUrl(),this.updateConfigList()),event.stopPropagation()}calculateConfigPrice(t){const i={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<t.rows;e++){if(!Array.isArray(t.selection[e]))continue;let s=0;for(let n=0;n<t.cols;n++)t.selection[e]?.[n]?s++:s&&(this.processGroupDirectly(s,i,t.cellWidth||179,t.cellHeight||113,t.orientation||"vertical"),s=0);s&&this.processGroupDirectly(s,i,t.cellWidth||179,t.cellHeight||113,t.orientation||"vertical")}let s=0;return Object.entries(i).forEach(([t,i])=>{if(i>0){const n=Math.ceil(i/(e[t]||1)),o=a(t);s+=n*o}}),s}calculateCurrentTotalPrice(){const t=this.calculatePartsDirectly({selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?.value||"179"),cellHeight:parseInt(this.hIn?.value||"113"),orientation:this.orV?.checked?"vertical":"horizontal",incM:document.getElementById("include-modules")?.checked||!1});let i=0;return Object.entries(t).forEach(([t,s])=>{if(s>0){const n=Math.ceil(s/(e[t]||1)),o=a(t);i+=n*o}}),i}addAllConfigsToCart(){this.addAllToCart()}initSmartConfigFeatures(){this.smartParser=new c(this),this.bulkSelector=new h(this),this.bulkSelector.initializeBulkSelection(),this.initQuickConfigInterface(),this.ensurePermanentVisibility(),this.checkAndHideHelp(),this.initSmartConfigCloseButton()}ensurePermanentVisibility(){setTimeout(()=>{const e=document.querySelector(".usage-tips");e&&(e.style.display="block",e.classList.remove("hidden"));document.querySelectorAll(".smart-config-container").forEach(e=>{e.style.display="flex",e.classList.remove("hidden")}),localStorage.removeItem("solarTool_hideHelp"),localStorage.removeItem("solarTool_hideSmartConfig")},100)}checkAndHideHelp(){}initSmartConfigCloseButton(){setTimeout(()=>{const e=document.getElementById("smart-config-close"),t=document.querySelector(".smart-config-container");e&&t&&e.addEventListener("click",()=>{})},600)}initQuickConfigInterface(){setTimeout(()=>{const e=document.getElementById("quick-config-input"),t=document.getElementById("apply-quick-config");e&&t&&(t.addEventListener("click",()=>{const t=e.value.trim();if(t)try{this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null);const i=this.smartParser.parseInput(t);this.smartParser.applyPreviewToMainGrid(i),e.value=""}catch(e){this.showToast("Fehler: Konfiguration konnte nicht angewendet werden ❌",2e3)}}),e.addEventListener("keypress",e=>{"Enter"===e.key&&t.click()}),e.addEventListener("input",t=>{const i=t.target.value.trim();if(this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null),this.updateInputValidation(e,i),i.length>0)try{const e=this.smartParser.parseInput(i);if(e.cols||e.rows||e.moduleCount||e.orientation||e.adjustSpacing||e.rowConfig||e.action){this.showConfigPreview(e);const t=this;this.previewTimeout=setTimeout(()=>{t&&t.clearGridPreview&&t.clearGridPreview()},3e3)}else this.clearGridPreview()}catch(e){this.clearGridPreview()}else this.clearGridPreview()})),this.initializeSmartConfigHelp()},500)}updateInputValidation(e,t){e.classList.remove("input-valid","input-invalid","input-loading"),0!==t.length&&(e.classList.add("input-loading"),setTimeout(()=>{try{const i=this.smartParser.parseInput(t);i.cols||i.rows||i.moduleCount||i.orientation||i.adjustSpacing||i.rowConfig||i.action?(e.classList.remove("input-loading"),e.classList.add("input-valid")):(e.classList.remove("input-loading"),e.classList.add("input-invalid"))}catch(t){e.classList.remove("input-loading"),e.classList.add("input-invalid")}},100))}showConfigPreview(e){(e.cols||e.rows||e.moduleCount||e.orientation||e.adjustSpacing||e.rowConfig)&&(this&&"function"==typeof this.showGridPreview?this.showGridPreview(e):console.error("showGridPreview not available!"))}initializeSmartConfigHelp(){const e=document.getElementById("smart-help-trigger"),t=document.getElementById("smart-help-dropdown");if(!e||!t)return;let i=!1,s=null;const n=()=>{t.style.opacity="0",t.style.visibility="hidden",t.style.transform="translateY(-10px)"};e.addEventListener("mouseenter",()=>{i=!0,s&&clearTimeout(s),t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"}),e.addEventListener("mouseleave",()=>{i=!1,s=setTimeout(()=>{i||n()},100)}),t.addEventListener("mouseenter",()=>{i=!0,s&&clearTimeout(s)}),t.addEventListener("mouseleave",()=>{i=!1,s=setTimeout(()=>{i||n()},100)}),t.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("click",s=>{e.contains(s.target)||t.contains(s.target)||(i=!1,n())}),document.querySelectorAll(".example").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const s=document.getElementById("quick-config-input");if(s){if(s.value=e.textContent.replace(/"/g,""),s.focus(),s.value.length>3)try{const e=this.smartParser.parseInput(s.value);this.showConfigPreview(e)}catch(e){}i=!1,n(),setTimeout(()=>{s.scrollIntoView({behavior:"smooth",block:"center"})},100)}})})}setup(){if(this.cols&&this.rows||(this.cols=this.default.cols,this.rows=this.default.rows),this.cols&&this.rows){if(!Array.isArray(this.selection)||this.selection.length!==this.rows||this.selection[0]?.length!==this.cols){const e=this.selection;this.selection=Array.from({length:this.rows},(t,i)=>Array.from({length:this.cols},(t,s)=>e?.[i]?.[s]||!1))}this.listHolder&&(this.listHolder.style.display="block"),this.updateSize(),this.buildGrid(),this.buildList(),this.renderProductSummary(),this.updateSaveButtons()}else alert("Spalten und Zeilen müssen > 0 sein")}updateSaveButtons(){this.saveBtn&&(this.saveBtn.style.display="inline-block")}addColumnRight(){this.cols+=1;for(let e of this.selection)e.push(!1);this.updateGridAfterStructureChange()}removeColumnRight(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.pop();this.updateGridAfterStructureChange()}}addColumnLeft(){this.cols+=1;for(let e of this.selection)e.unshift(!1);this.updateGridAfterStructureChange()}removeColumnLeft(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.shift();this.updateGridAfterStructureChange()}}addRowBottom(){this.rows+=1,this.selection.push(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowBottom(){this.rows<=1||(this.rows-=1,this.selection.pop(),this.updateGridAfterStructureChange())}addRowTop(){this.rows+=1,this.selection.unshift(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowTop(){this.rows<=1||(this.rows-=1,this.selection.shift(),this.updateGridAfterStructureChange())}updateGridAfterStructureChange(){this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}updateSize(){parseFloat(getComputedStyle(document.documentElement).fontSize);const e=parseInt(this.wIn?this.wIn.value:"179",10)||179,t=parseInt(this.hIn?this.hIn.value:"113",10)||113,i=!!this.orV&&this.orV.checked,s=i?t:e,n=i?e:t,o=this.wrapper?this.wrapper.clientWidth-100:800,r=this.wrapper?this.wrapper.clientHeight-100:600,a=o/(this.cols*s+2*(this.cols-1)),l=r/(this.rows*n+2*(this.rows-1)),c=Math.min(a,l,1),h=s*c,d=n*c,u=this.cols>=15||this.rows>=10?0:2*c;document.documentElement.style.setProperty("--cell-size",h+"px"),document.documentElement.style.setProperty("--cell-width",h+"px"),document.documentElement.style.setProperty("--cell-height",d+"px"),document.documentElement.style.setProperty("--cell-gap",u+"px");const m=Math.min(this.cols*h+(this.cols-1)*u,o),g=Math.min(this.rows*d+(this.rows-1)*u,r);this.gridEl&&(this.gridEl.style.width=m+"px",this.gridEl.style.height=g+"px")}buildGrid(){if(!Array.isArray(this.selection))return;const e=performance.now(),t=document.createDocumentFragment();document.documentElement.style.setProperty("--cols",this.cols),document.documentElement.style.setProperty("--rows",this.rows);const i=(this.cols-1)/2,s=(this.rows-1)/2;for(let e=0;e<this.rows;e++)if(Array.isArray(this.selection[e]))for(let n=0;n<this.cols;n++){const o=document.createElement("div");o.className="grid-cell animate-in",this.selection[e]?.[n]&&o.classList.add("selected"),o.setAttribute("role","button"),o.setAttribute("tabindex","0"),o.setAttribute("aria-label",`Modul ${n+1}, ${e+1} - ${this.selection[e]?.[n]?"ausgewählt":"nicht ausgewählt"}`),o.setAttribute("aria-pressed",this.selection[e]?.[n]?"true":"false"),o.addEventListener("click",()=>{this.selection[e]||(this.selection[e]=[]),this.selection[e][n]=!this.selection[e][n],o.classList.toggle("selected"),o.setAttribute("aria-pressed",this.selection[e][n]?"true":"false"),o.setAttribute("aria-label",`Modul ${n+1}, ${e+1} - ${this.selection[e][n]?"ausgewählt":"nicht ausgewählt"}`),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].selection=this.selection),this.trackInteraction(),this.buildList(),this.updateSummaryOnChange()}),o.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),o.click())});const r=n-i,a=e-s,l=60*Math.sqrt(r*r+a*a);o.style.animationDelay=`${l}ms`,setTimeout(()=>o.classList.remove("animate-in"),400),t.appendChild(o)}this.gridEl.innerHTML="",this.gridEl.appendChild(t),this.performanceMetrics.gridRenderTime=performance.now()-e}async buildList(){try{this.selection.flat().filter(e=>e).length;const t=await this.calculateParts();this.incM&&!this.incM.checked&&delete t.Solarmodul;const i=Object.entries(t).filter(([,e])=>e>0);if(!i.length)return void(this.listHolder&&(this.listHolder.style.display="none"));if(this.listHolder&&(this.listHolder.style.display="block"),this.prodList){const t=document.createDocumentFragment();i.forEach(([i,n])=>{const o=Math.ceil(n/e[i]),r=o*a(i),l=document.createElement("div");l.className="produkt-item",l.innerHTML=`\n            <div class="item-left">\n              <span class="item-quantity">${o}×</span>\n              <span class="item-name">${s[i]||i.replace(/_/g," ")}</span>\n              <span class="item-details">(${n})</span>\n            </div>\n            <span class="item-price">${r.toFixed(2).replace(".",",")} €</span>\n          `,t.appendChild(l)}),this.prodList.innerHTML="",this.prodList.appendChild(t),this.prodList.style.display="block"}}catch(e){this.listHolder&&(this.listHolder.style.display="none")}}resetGridToDefault(){const{cols:e,rows:t,width:i,height:s}=this.default,n=[];for(let i=0;i<t;i++){n[i]=[];for(let t=0;t<e;t++)n[i][t]=this.selection?.[i]?.[t]||!1}this.wIn.value=i,this.hIn.value=s;const o=!!document.getElementById("orient-v")&&document.getElementById("orient-v").hasAttribute("checked");this.orH&&(this.orH.checked=!o),this.orV&&(this.orV.checked=o);const r=document.getElementById("orient-h-setup"),a=document.getElementById("orient-v-setup");r&&a&&(r.checked=!o,a.checked=o),this.incM&&(this.incM.checked=!1),this.mc4&&(this.mc4.checked=!1),this.solarkabel&&(this.solarkabel.checked=!1),this.holz&&(this.holz.checked=!1),this.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=!1),this.cols=e,this.rows=t,this.setup(),this.selection=n,this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}resetToDefaultGrid(){this.colsIn&&(this.colsIn.value=this.default.cols),this.rowsIn&&(this.rowsIn.value=this.default.rows),this.wIn&&(this.wIn.value=this.default.width),this.hIn&&(this.hIn.value=this.default.height),this.orH&&(this.orH.checked=!0),this.orV&&(this.orV.checked=!1),this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup()}async calculateParts(){return this.calculatePartsSync()}calculatePartsSync(){const e={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let t=0;t<this.rows;t++){if(!Array.isArray(this.selection[t]))continue;let i=0;for(let s=0;s<this.cols;s++)this.selection[t]?.[s]?i++:i&&(this.processGroup(i,e),i=0);i&&this.processGroup(i,e)}return e}processGroup(e,t){const i=this.orV?.checked,s=e*(i?parseInt(this.hIn?.value||"113"):parseInt(this.wIn?.value||"179")),n=Math.floor(s/360),o=s-360*n,r=[{cnt360:n,cnt240:Math.ceil(o/240)},{cnt360:Math.ceil(s/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(s/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-s})),a=Math.min(...r.map(e=>e.rails)),l=r.filter(e=>e.rails===a).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:c,cnt240:h}=l;t.Schiene_360_cm+=2*c,t.Schiene_240_cm+=2*h,t.Schienenverbinder+=4*(c+h-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}mapImage(e){return n[e]||""}loadConfig(e){const t=this.configs[e];this.currentConfig=e,this.wIn.value=t.cellWidth,this.hIn.value=t.cellHeight,this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.incM.checked=t.incM,this.mc4.checked=t.mc4,this.solarkabel.checked=t.solarkabel||!1,this.holz.checked=t.holz,this.quetschkabelschuhe.checked=t.quetschkabelschuhe||!1,this.cols=t.cols,this.rows=t.rows,this.selection=t.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView()}showToast(e="Gespeichert ✅",t=1500){const i=document.getElementById("toast");i&&(i.textContent=e,i.classList.remove("hidden"),clearTimeout(this.toastTimeout),this.toastTimeout=setTimeout(()=>{i.classList.add("hidden")},t))}saveNewConfig(e=null){null!==this.currentConfig&&this.updateConfig(),this.currentConfig=null;const t=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1));this.selection;this.selection=t;const i=this._makeConfigObject(e);this.configs.push(i),this.currentConfig=this.configs.length-1,this.setup(),this.renderConfigList(),this.updateConfigList(),this.updateSaveButtons(),this.updateDetailView(),this.showToast(`Neue Konfiguration "${i.name}" erstellt ✅`)}renameCurrentConfig(e){null!==this.currentConfig&&this.currentConfig>=0&&this.currentConfig<this.configs.length&&(this.configs[this.currentConfig].name=e,this.renderConfigList(),this.updateSaveButtons())}updateConfig(){const e=this.currentConfig;this.configs[e]=this._makeConfigObject(),this.renderConfigList(),this.updateSaveButtons()}deleteConfig(e){const t=this.configs[e].name;if(confirm(`Willst du "${t}" wirklich löschen?`)){if(this.configs.splice(e,1),this.configs.length>0)if(e===this.currentConfig){const t=Math.min(e,this.configs.length-1);this.loadConfig(t)}else e<this.currentConfig?(this.currentConfig--,this.renderConfigList()):this.renderConfigList();else this.createNewConfig();this.updateSaveButtons()}}createNewConfig(){this.currentConfig=null,this.resetGridToDefault(),this.renderConfigList(),this.updateSaveButtons()}_makeConfigObject(e=null){let t;if(e)t=e;else if(null!==this.currentConfig)t=this.configs[this.currentConfig].name;else{let e=1;for(;this.configs.some(t=>t.name===`Konfiguration ${e}`);)e++;t=`Konfiguration ${e}`}return{name:t,selection:this.selection.map(e=>[...e]),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",incM:this.incM&&this.incM.checked,mc4:this.mc4&&this.mc4.checked,solarkabel:this.solarkabel&&this.solarkabel.checked,holz:this.holz&&this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10)}}renderConfigList(){const e=document.createDocumentFragment();this.configs.forEach((t,i)=>{const s=document.createElement("div");s.className="config-item"+(i===this.currentConfig?" active":""),s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="space-between",s.style.gap="0.5rem";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="0.25rem",n.style.flex="1";const o=document.createElement("span");o.textContent=t.name,o.style.cursor="pointer",o.addEventListener("click",()=>{null!==this.currentConfig&&this.currentConfig!==i&&this.updateConfig(),this.currentConfig!==i&&(this.loadConfig(i),this.showToast("Konfiguration geladen",1e3))});const r=document.createElement("button");r.innerHTML="✎",r.title="Namen bearbeiten",Object.assign(r.style,{border:"none",background:"none",cursor:"pointer",fontSize:"1rem",color:"#fff",padding:"0",marginLeft:"0.5rem",lineHeight:"1"}),r.addEventListener("click",e=>{e.stopPropagation();const i=document.createElement("input");i.type="text",i.value=t.name,i.style.flex="1",i.addEventListener("keydown",e=>{"Enter"===e.key&&(t.name=i.value.trim()||t.name,this.renderConfigList())}),i.addEventListener("blur",()=>{t.name=i.value.trim()||t.name,this.renderConfigList()}),n.replaceChild(i,o),i.focus()});let a=null;this.configs.length>1&&(a=document.createElement("button"),a.innerHTML="🗑️",a.title="Konfiguration löschen",Object.assign(a.style,{background:"none",border:"none",cursor:"pointer",fontSize:"1rem",color:"#fff",padding:"0",marginLeft:"0.5rem",lineHeight:"1"}),a.addEventListener("click",e=>{e.stopPropagation(),this.deleteConfig(i)}));const l=document.createElement("button");l.textContent="🔗",l.title="Später weitermachen - Link kopieren",Object.assign(l.style,{background:"none",border:"none",cursor:"pointer",color:"inherit"}),l.addEventListener("click",e=>{e.stopPropagation(),this.generateContinueLink()}),n.appendChild(o),n.appendChild(r),s.appendChild(n),a&&s.appendChild(a),s.appendChild(l),e.appendChild(s)}),this.configListEl.innerHTML="",this.configListEl.appendChild(e)}arraysEqual(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++){if(e[i].length!==t[i].length)return!1;for(let s=0;s<e[i].length;s++)if(e[i][s]!==t[i][s])return!1}return!0}updateSummaryOnChange(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(async()=>{const e=performance.now();this.renderProductSummary(),this.showAutoSaveIndicator(),document.getElementById("config-detail-view")?.classList.contains("active")&&this.updateDetailView(),this.updateCurrentTotalPrice(),this.performanceMetrics.updateTime=performance.now()-e,this.updateTimeout=null},this.updateDelay)}async renderProductSummary(){let t=this.configs.map((e,t)=>({selection:e.selection,rows:e.rows,cols:e.cols,cellWidth:e.cellWidth,cellHeight:e.cellHeight,orientation:e.orientation,incM:this.incM&&this.incM.checked,mc4:this.mc4&&this.mc4.checked,solarkabel:this.solarkabel&&this.solarkabel.checked,holz:this.holz&&this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe&&this.quetschkabelschuhe.checked}));if(null===this.currentConfig)t.push({selection:this.selection,rows:this.rows,cols:this.cols,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",incM:this.incM&&this.incM.checked,mc4:this.mc4&&this.mc4.checked,solarkabel:this.solarkabel&&this.solarkabel.checked,holz:this.holz&&this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe&&this.quetschkabelschuhe.checked});else{const e=this.selection,i=this.configs[this.currentConfig].selection;this.arraysEqual(e,i);t.push({selection:e,rows:this.rows,cols:this.cols,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",incM:this.incM&&this.incM.checked,mc4:this.mc4&&this.mc4.checked,solarkabel:this.solarkabel&&this.solarkabel.checked,holz:this.holz&&this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe&&this.quetschkabelschuhe.checked})}const i={};try{(await Promise.all(t.map(async e=>{const t={selection:e.selection,rows:e.rows,cols:e.cols,cellWidth:e.cellWidth,cellHeight:e.cellHeight,orientation:e.orientation};let i;try{i=await o.calculate("calculateParts",t)}catch(e){i=this.calculatePartsDirectly(t)}return i}))).forEach((e,t)=>{Object.entries(e).forEach(([e,t])=>{i[e]=(i[e]||0)+t})}),this.incM&&!this.incM.checked&&delete i.Solarmodul}catch(e){console.error("Error in renderProductSummary:",e)}const n=Object.entries(i).filter(([,e])=>e>0),r=Math.ceil(n.length/4);let l=0,c="";for(let t=0;t<r;t++){c+=`<div class="summary-column">${n.slice(4*t,4*(t+1)).map(([t,i])=>{const n=Math.ceil(i/e[t]),o=n*a(t);l+=o;const r=s[t]||t.replace(/_/g," ");return`<div class="produkt-item">\n        \t\t<span>${n}×</span>\n        \t\t<img src="${this.mapImage(t)}" alt="${r}" onerror="this.src='https://via.placeholder.com/32?text=${encodeURIComponent(r)}'">\n        \t\t<span>${r} (${i})</span>\n        \t\t<span style="margin-left:auto; font-weight:bold;">${o.toFixed(2)} €</span>\n      \t\t</div>`}).join("")}</div>`}c+=`<div class="summary-total">Gesamtpreis: ${l.toFixed(2)} €</div>`,this.summaryList.innerHTML=c,this.summaryHolder.style.display=n.length?"block":"none",this.summaryList.style.display=n.length?"flex":"none",0===n.length?(this.summaryList.innerHTML='<div class="summary-total">Keine Produkte berechnet. Bitte wählen Sie Module aus.</div>',this.summaryList.style.display="flex"):(this.summaryList.innerHTML=c,this.summaryList.style.display="flex")}calculatePartsDirectly(e){const{selection:t,rows:i,cols:s,cellWidth:n,cellHeight:o,orientation:r}=e,a={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let l=0;l<s;l++)t[e]?.[l]?i++:i&&(this.processGroupDirectly(i,a,n,o,r),i=0);i&&this.processGroupDirectly(i,a,n,o,r)}return a}processGroupDirectly(e,t,i,s,n){const o=e*("vertical"===n?s:i),r=Math.floor(o/360),a=o-360*r,l=[{cnt360:r,cnt240:Math.ceil(a/240)},{cnt360:Math.ceil(o/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(o/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-o})),c=Math.min(...l.map(e=>e.rails)),h=l.filter(e=>e.rails===c).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:d,cnt240:u}=h;t.Schiene_360_cm+=2*d,t.Schiene_240_cm+=2*u,t.Schienenverbinder+=4*(d+u-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}generateContinueLink(){null!==this.currentConfig&&this.updateConfig();const e=JSON.stringify(this.configs),t=btoa(encodeURIComponent(e)),i=`${window.location.origin}${window.location.pathname}?configData=${t}`;navigator.clipboard.writeText(i),this.showToast("Später-weitermachen Link kopiert ✅",2e3)}generateHiddenCartForms(){const e=document.querySelectorAll('form[data-node-type="commerce-add-to-cart-form"]');this.webflowFormMap={},e.forEach(e=>{const t=e.getAttribute("data-commerce-product-id"),s=e.getAttribute("data-commerce-sku-id"),n=Object.keys(i).find(e=>i[e].productId===t||i[e].variantId===s);n&&(this.webflowFormMap[n]=e)}),this.hideWebflowForms()}hideWebflowForms(){Object.values(this.webflowFormMap).forEach(e=>{e&&e.style&&(e.style.cssText="\n            position: absolute !important;\n            left: -9999px !important;\n            top: -9999px !important;\n            width: 1px !important;\n            height: 1px !important;\n            overflow: hidden !important;\n            clip: rect(0, 0, 0, 0) !important;\n            white-space: nowrap !important;\n            border: 0 !important;\n            margin: 0 !important;\n            padding: 0 !important;\n            visibility: hidden !important;\n          ")})}addProductToCart(e,t,s=!1){if(!i[e])return;const n=this.webflowFormMap[e];if(!n)return;const o=n.querySelector('input[name="commerce-add-to-cart-quantity-input"]');o&&(o.value=t);const r=n.querySelector('input[data-node-type="commerce-add-to-cart-button"]');r&&this.clickWebflowButtonSafely(n,r,e,t,s)}clickWebflowButtonSafely(e,t,i,s,n){const o=e.querySelector('input[name="commerce-add-to-cart-quantity-input"]');if(o&&(o.value=s),n)return void t.click();const r=document.createElement("iframe");r.name="safe-cart-"+Date.now()+Math.random(),r.style.cssText="\n        position: absolute;\n        left: -10000px;\n        top: -10000px;\n        width: 1px;\n        height: 1px;\n        border: none;\n        visibility: hidden;\n        opacity: 0;\n      ",document.body.appendChild(r);const a=e.target||"";e.target=r.name;let l=!1;r.onload=()=>{l||(l=!0,e.target=a,o&&(o.value=1),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},1e3))},r.onerror=()=>{e.target=a,document.body.contains(r)&&document.body.removeChild(r)},t.click()}addPartsListToCart(t){const i=Object.entries(t).filter(([e,t])=>t>0);if(!i.length)return;this.hideCartContainer();const s=i.slice(0,-1),n=i[i.length-1];s.forEach(([t,i])=>{const s=Math.ceil(i/e[t]);this.addProductToCart(t,s,!1)}),setTimeout(()=>{this.showCartContainer();const[t,i]=n,s=Math.ceil(i/e[t]);this.addProductToCart(t,s,!0)},500)}hideCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(e.style.display="none")}showCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(e.style.display="")}async addCurrentToCart(){try{const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked),t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return void this.showToast("Keine Produkte ausgewählt ⚠️",2e3);this.sendCurrentConfigToWebhook().then(e=>{}),this.addPartsListToCart(e),this.showToast(`${t} Produkte werden zum Warenkorb hinzugefügt...`,3e3),this.pdfGenerator&&this.pdfGenerator.isAvailable()&&setTimeout(()=>{this.pdfGenerator.generatePDF("current")},500)}catch(e){this.showToast("Fehler beim Berechnen der Produkte ❌",2e3)}}async addAllToCart(){try{null!==this.currentConfig&&this.updateConfig();const e=this.createConfigSnapshot();this.pdfGenerator&&this.pdfGenerator.isAvailable()&&(this.showToast("PDF wird erstellt...",2e3),await this.pdfGenerator.generatePDFFromSnapshot(e),this.showToast("PDF erfolgreich erstellt ✅",1500));const t=await Promise.all(this.configs.map(async(e,t)=>t===this.currentConfig?await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked):await this._buildPartsFor(e.selection,e.incM,e.mc4,e.solarkabel,e.holz,e.quetschkabelschuhe)));if(null===this.currentConfig&&0===this.configs.length){const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked);t.push(e)}const i={};t.forEach(e=>{Object.entries(e).forEach(([e,t])=>{i[e]=(i[e]||0)+t})});const s=Object.values(i).reduce((e,t)=>e+t,0);if(0===s)return void this.showToast("Keine Konfigurationen vorhanden ⚠️",2e3);await this.sendAllConfigsToWebhook();this.addPartsListToCart(i),this.showToast(`${s} Produkte aus allen Konfigurationen werden hinzugefügt...`,3e3)}catch(e){console.error("Fehler in addAllToCart:",e),this.showToast("Fehler beim Berechnen der Konfigurationen ❌",2e3)}}async _buildPartsFor(e,t,i,s,n,o){const r=this.selection.map(e=>[...e]);try{this.selection=e;let i=await this.calculateParts();return t||delete i.Solarmodul,i}finally{this.selection=r}}_buildCartItems(t){return Object.entries(t).map(([t,s])=>{const n=Math.ceil(s/e[t]),o=i[t];return!o||n<=0?null:{productId:o.productId,variantId:o.variantId,quantity:n}}).filter(Boolean)}getCurrentConfigData(){return{name:null!==this.currentConfig&&this.configs[this.currentConfig]?this.configs[this.currentConfig].name:"Aktuelle Konfiguration",cols:this.cols,rows:this.rows,selection:this.selection.map(e=>[...e]),orientation:this.orV.checked?"vertical":"horizontal",includeModules:this.incM.checked,mc4:this.mc4.checked,cable:this.solarkabel.checked,wood:this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe.checked}}updateAllConfigurationsForCheckboxes(){this.configs.forEach((e,t)=>{e.incM=this.incM.checked,e.mc4=this.mc4.checked,e.solarkabel=this.solarkabel.checked,e.holz=this.holz.checked,e.quetschkabelschuhe=this.quetschkabelschuhe.checked}),this.updateSummaryOnChange()}createConfigSnapshot(){null!==this.currentConfig&&this.updateConfig();const e={timestamp:(new Date).toISOString(),totalConfigs:this.configs.length,currentConfigIndex:this.currentConfig,configs:[]};for(let t=0;t<this.configs.length;t++){const i=this.configs[t];let s,n,o,r,a,l,c,h,d,u,m;t===this.currentConfig?(s=this.selection?this.selection.map(e=>[...e]):[],n=this.cols,o=this.rows,r=this.orV.checked?"vertical":"horizontal",a=this.incM.checked,l=this.mc4.checked,c=this.solarkabel.checked,h=this.holz.checked,d=this.quetschkabelschuhe.checked,u=parseInt(this.wIn.value,10),m=parseInt(this.hIn.value,10)):(s=i.selection?i.selection.map(e=>[...e]):[],n=i.cols,o=i.rows,r=i.orientation,a=i.incM,l=i.mc4,c=i.solarkabel,h=i.holz,d=i.quetschkabelschuhe,u=i.cellWidth,m=i.cellHeight);const g=Array.from({length:o||5},(e,t)=>Array.from({length:n||5},(e,i)=>!!(s[t]&&Array.isArray(s[t])&&i<s[t].length)&&!0===s[t][i])),p={name:i.name||`Konfiguration ${t+1}`,index:t,cols:n||5,rows:o||5,selection:g,cellWidth:u||179,cellHeight:m||113,orientation:r||"horizontal",includeModules:!1!==a,mc4:l||!1,cable:c||!1,wood:h||!1,quetschkabelschuhe:d||!1,selectedCells:g.flat().filter(e=>e).length,totalCells:(n||5)*(o||5)};e.configs.push(p)}return e}getAllConfigsData(){return this.createConfigSnapshot().configs}showGridPreview(e){this.originalPreviewState={selection:this.selection?this.selection.map(e=>[...e]):null,cols:this.cols,rows:this.rows,orientation:!!this.orV&&this.orV.checked,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10)},this.createPreviewGrid(e),this.hideMainGrid(),this.showPreviewGrid();const t=document.getElementById("grid"),i=document.getElementById("preview-grid");t&&t.classList.add("grid-fade-out"),i&&i.classList.add("grid-fade-in")}createPreviewGrid(e){const t=document.getElementById("preview-grid");if(!t)return void console.error("Preview grid element not found");let i=this.cols,s=this.rows,n=this.selection?this.selection.map(e=>[...e]):Array.from({length:s},()=>Array.from({length:i},()=>!1));if(e.useCurrentGrid)i=e.cols,s=e.rows,n=this.selection?this.selection.map(e=>[...e]):Array.from({length:s},()=>Array.from({length:i},()=>!1));else if(e.cols&&e.rows)i=e.cols,s=e.rows,n=e.moduleCount?this.createModuleSelection(e.moduleCount,i,s):Array.from({length:s},()=>Array.from({length:i},()=>!1));else if(e.moduleCount){const t="withSpacing"===e.adjustSpacing||e.rowConfig&&e.rowConfig.spacing;n=this.createModuleSelection(e.moduleCount,i,s,t)}else if(e.rowConfig){const{numRows:t,modulesPerRow:o,spacing:r}=e.rowConfig;s=t+(r?1:0),n=Array.from({length:s},(e,s)=>Array.from({length:i},(e,i)=>(!r||s!==Math.floor(t/2))&&(s<t&&i<o)))}else if(e.adjustSpacing&&"withSpacing"===e.adjustSpacing){const e=s+Math.ceil(s/2),t=Array.from({length:e},()=>Array.from({length:i},()=>!1));let o=0;for(let e=0;e<s;e++){for(let s=0;s<i;s++)n[e]&&n[e][s]&&(t[o][s]=!0);o+=2}s=e,n=t}this.buildPreviewGrid(t,n,i,s)}buildPreviewGrid(e,t,i,s){parseFloat(getComputedStyle(document.documentElement).fontSize);const n=parseInt(this.wIn?this.wIn.value:"179",10)||179,o=parseInt(this.hIn?this.hIn.value:"113",10)||113,r=!!this.orV&&this.orV.checked,a=r?o:n,l=r?n:o,c=(this.wrapper?this.wrapper.clientWidth-100:800)/(i*a+2*(i-1)),h=(this.wrapper?this.wrapper.clientHeight-100:600)/(s*l+2*(s-1)),d=Math.min(c,h,1),u=a*d,m=l*d,g=i>=15||s>=10?0:2*d;e.style.gridTemplateColumns=`repeat(${i}, ${u}px)`,e.style.gridTemplateRows=`repeat(${s}, ${m}px)`,e.style.gap=`${g}px`,e.innerHTML="";for(let n=0;n<s;n++)for(let s=0;s<i;s++){const i=document.createElement("div");i.className="preview-grid-cell",i.dataset.row=n,i.dataset.col=s,t&&t[n]&&t[n][s]&&i.classList.add("selected"),e.appendChild(i)}}hideMainGrid(){const e=document.getElementById("grid");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0")}showPreviewGrid(){const e=document.getElementById("preview-grid");e&&(e.style.display="grid",e.style.visibility="visible",e.style.opacity="1")}hidePreviewGrid(){const e=document.getElementById("preview-grid");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0")}showMainGrid(){const e=document.getElementById("grid");e&&(e.style.display="grid",e.style.visibility="visible",e.style.opacity="1")}createModuleSelection(e,t,i,s=!1){const n=Array.from({length:i},()=>Array.from({length:t},()=>!1));if(s){const s=Math.ceil(e/2);let o=0;for(let i=0;i<Math.min(s,t)&&o<e;i++)n[0][i]=!0,o++;if(o<e&&i>2)for(let s=0;s<Math.min(e-o,t);s++)n[i-1][s]=!0,o++}else{let s=0;for(let o=0;o<i&&s<e;o++)for(let i=0;i<t&&s<e;i++)n[o][i]=!0,s++}return n}clearGridPreview(){const e=document.getElementById("grid"),t=document.getElementById("preview-grid");e&&e.classList.remove("grid-fade-out"),t&&t.classList.remove("grid-fade-in"),setTimeout(()=>{this.hidePreviewGrid(),this.showMainGrid(),this.originalPreviewState&&(this.selection=this.originalPreviewState.selection,this.cols=this.originalPreviewState.cols,this.rows=this.originalPreviewState.rows,this.orV&&this.orH&&null!==this.originalPreviewState.orientation&&(this.orV.checked=this.originalPreviewState.orientation,this.orH.checked=!this.originalPreviewState.orientation),this.wIn&&this.originalPreviewState.cellWidth&&(this.wIn.value=this.originalPreviewState.cellWidth),this.hIn&&this.originalPreviewState.cellHeight&&(this.hIn.value=this.originalPreviewState.cellHeight),this.updateSize(),this.buildGrid(),this.originalPreviewState=null),setTimeout(()=>{const e=document.getElementById("grid");e&&"none"===e.style.display&&this.showMainGrid()},100)},150)}setupResizeObserver(){this.wrapper&&window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(e=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.updateSize(),this.resizeTimeout=null},150)}),this.resizeObserver.observe(this.wrapper))}setupPinchToZoom(){if(!this.wrapper)return;let e=0,t=1;this.wrapper.addEventListener("touchstart",i=>{2===i.touches.length&&(i.preventDefault(),e=this.getTouchDistance(i.touches[0],i.touches[1]),t=this.zoomLevel)}),this.wrapper.addEventListener("touchmove",i=>{if(2===i.touches.length){i.preventDefault();const s=this.getTouchDistance(i.touches[0],i.touches[1])/e,n=Math.max(this.minZoom,Math.min(this.maxZoom,t*s));this.setZoom(n)}}),this.wrapper.addEventListener("touchend",i=>{i.touches.length<2&&(e=0,t=1)})}getTouchDistance(e,t){const i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}setZoom(e){this.zoomLevel=e,this.wrapper.style.transform=`scale(${e})`,this.wrapper.style.transformOrigin="center center"}cleanup(){this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null),this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.performanceMetrics&&(this.performanceMetrics=null),this.zoomObserver&&(this.zoomObserver=null),this.gridEl&&(this.gridEl.innerHTML=""),this.pdfGenerator&&(this.pdfGenerator=null)}}document.addEventListener("DOMContentLoaded",()=>{const e=new d;e.generateHiddenCartForms(),window.solarGrid=e}),window.addEventListener("beforeunload",()=>{o&&o.destroy(),window.solarGrid&&window.solarGrid.cleanup()})}();