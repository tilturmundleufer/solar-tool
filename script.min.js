!function(){const e={Endklemmen:100,Schrauben:100,Dachhaken:20,Mittelklemmen:100,Endkappen:50,Schienenverbinder:50,Schiene_240_cm:8,Schiene_360_cm:8,Solarmodul:1,MC4_Stecker:1,Solarkabel:1,Holzunterleger:1},t={Solarmodul:59,Endklemmen:20,Schrauben:5,Dachhaken:15,Mittelklemmen:18,Endkappen:9.99,Schienenverbinder:9.99,Schiene_240_cm:8.99,Schiene_360_cm:40,MC4_Stecker:99,Solarkabel:29.99,Holzunterleger:.5};const i=new class{constructor(){this.worker=null,this.pendingCalculations=new Map,this.calculationId=0,this.isWorkerReady=!1,this.initWorker()}initWorker(){try{this.worker=new Worker("./calculation-worker.js"),this.worker.onmessage=e=>{const{type:t,id:i,data:s,error:o}=e.data;if("ready"!==t){if("result"===t&&this.pendingCalculations.has(i)){const{resolve:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(s)}if("error"===t&&this.pendingCalculations.has(i)){const{reject:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(new Error(o.message))}}else this.isWorkerReady=!0},this.worker.onerror=e=>{this.isWorkerReady=!1}}catch(e){this.isWorkerReady=!1}}async calculate(e,t){return this.isWorkerReady&&this.worker?new Promise((i,s)=>{const o=++this.calculationId;this.pendingCalculations.set(o,{resolve:i,reject:s}),setTimeout(()=>{this.pendingCalculations.has(o)&&(this.pendingCalculations.delete(o),s(new Error("Calculation timeout")))},1e4),this.worker.postMessage({type:e,data:t,id:o})}):this.calculateSync(e,t)}calculateSync(e,t){switch(e){case"calculateParts":return this.calculatePartsSync(t);case"calculateExtendedParts":return this.calculateExtendedPartsSync(t);default:throw new Error(`Unsupported sync calculation: ${e}`)}}calculatePartsSync(e){const{selection:t,rows:i,cols:s,cellWidth:o,cellHeight:n,orientation:r}=e,a={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let l=0;l<s;l++)t[e]?.[l]?i++:i&&(this.processGroupSync(i,a,o,n,r),i=0);i&&this.processGroupSync(i,a,o,n,r)}return a}processGroupSync(e,t,i,s,o){const n=e*("vertical"===o?s:i),r=Math.floor(n/360),a=n-360*r,l=[{cnt360:r,cnt240:Math.ceil(a/240)},{cnt360:Math.ceil(n/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(n/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-n})),c=Math.min(...l.map(e=>e.rails)),h=l.filter(e=>e.rails===c).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:d,cnt240:u}=h;t.Schiene_360_cm+=2*d,t.Schiene_240_cm+=2*u,t.Schienenverbinder+=4*(d+u-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=t.Endklemmen,t.Solarmodul+=e,t.Schrauben+=2*t.Dachhaken}calculateExtendedPartsSync(e){let t=this.calculatePartsSync(e);const{options:i}=e;if(i.includeModules||delete t.Solarmodul,i.mc4Connectors){const i=e.selection.flat().filter(e=>e).length;t.MC4_Stecker=Math.ceil(i/30)}return i.solarkabel&&(t.Solarkabel=1),i.woodUnderlay&&(t.Holzunterleger=(t.Schiene_240_cm||0)+(t.Schiene_360_cm||0)),t}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingCalculations.clear(),this.isWorkerReady=!1}};const s={Solarmodul:{productId:"685003af0e41d945fb0198d8",variantId:"685003af4a8e88cb58c89d46"},Endklemmen:{productId:"6853c34fe99f6e3d878db38b",variantId:"6853c350edab8f13fc18c1b9"},Schrauben:{productId:"6853c2782b14f4486dd26f52",variantId:"6853c2798bf6755ddde26a8e"},Dachhaken:{productId:"6853c1d0f350bf620389664c",variantId:"6853c1d04d7c01769211b8d6"},Mittelklemmen:{productId:"68531088654d1468dca962c",variantId:"6853c1084c04541622ba3e26"},Endkappen:{productId:"6853be0895a5a578324f9682",variantId:"6853be0805e96b5a16c705cd"},Schienenverbinder:{productId:"6853c2018bf6755ddde216a8",variantId:"6853c202c488ee61eb51a3dc"},Schiene_240_cm:{productId:"6853bd882f00db0c9a42d653",variantId:"6853bd88c4173dbe72bab10f"},Schiene_360_cm:{productId:"6853bc8f3f6abf360c605142",variantId:"6853bc902f00db0c9a423d97"},MC4_Stecker:{productId:"687fcc9f66078f7098826ccc",variantId:"687fcca02c6537b9a9493fa7"},Solarkabel:{productId:"687fd60dc599f5e95d783f99",variantId:"687fd60dd3a8ae1f00a6d6d1"},Holzunterleger:{productId:"xxx-holz",variantId:"xxx-holz-v"}},o=new class{constructor(){this.cache=new Map,this.lastUpdate=null,this.cacheKey="solarTool_priceCache",this.timestampKey="solarTool_priceTimestamp",this.cacheDuration=864e5,this.isUpdating=!1,this.loadFromStorage(),this.scheduleNextUpdate()}loadFromStorage(){try{const e=localStorage.getItem(this.cacheKey),t=localStorage.getItem(this.timestampKey);if(e&&t){const i=JSON.parse(e);if(this.lastUpdate=parseInt(t,10),Date.now()-this.lastUpdate<this.cacheDuration)return void(this.cache=new Map(Object.entries(i)))}}catch(e){}this.updatePricesFromHTML()}saveToStorage(){try{const e=Object.fromEntries(this.cache);localStorage.setItem(this.cacheKey,JSON.stringify(e)),localStorage.setItem(this.timestampKey,this.lastUpdate.toString())}catch(e){}}async updatePricesFromHTML(){if(this.isUpdating)return;this.isUpdating=!0;const e=Object.keys(s).map(async e=>{const t=await this.getPriceFromHTMLAsync(e);return this.cache.set(e,t),{productKey:e,price:t}});try{const t=await Promise.all(e);this.lastUpdate=Date.now(),this.saveToStorage(),t.forEach(({productKey:e,price:t})=>{})}catch(e){}finally{this.isUpdating=!1}}async getPriceFromHTMLAsync(e){return new Promise(t=>{setTimeout(()=>{const i=this.extractPriceFromHTML(e);t(i)},0)})}extractPriceFromHTML(e){try{const i=s[e];if(!i)return t[e]||0;const o=i.productId,n=i.variantId,r=document.querySelector(`[data-commerce-product-id="${o}"]`)||document.querySelector(`[data-commerce-sku-id="${n}"]`);if(r){const e=r.querySelector('[data-wf-sku-bindings*="f_price_"]');if(e){let t=e.textContent||e.innerHTML;t=t.replace(/&nbsp;/g," ").replace(/&euro;/g,"€");const i=t.match(/(\d+(?:[.,]\d{1,2})?)/);if(i){return parseFloat(i[1].replace(",","."))}}}}catch(e){}return t[e]||0}getPrice(e){if(this.cache.has(e))return this.cache.get(e);return t[e]||0}scheduleNextUpdate(){const e=this.lastUpdate?this.lastUpdate+this.cacheDuration:Date.now()+this.cacheDuration,t=Math.max(0,e-Date.now());setTimeout(()=>{this.updatePricesFromHTML(),this.scheduleNextUpdate()},t)}forceUpdate(){return this.updatePricesFromHTML()}};function n(e){return o.getPrice(e)}window.debugPriceCache={forceUpdate:()=>o.forceUpdate(),getCache:()=>Object.fromEntries(o.cache),getCacheAge:()=>{if(!o.lastUpdate)return"Nie aktualisiert";const e=Date.now()-o.lastUpdate;return`${Math.round(e/36e5)} Stunden alt`},clearCache:()=>{localStorage.removeItem(o.cacheKey),localStorage.removeItem(o.timestampKey),o.cache.clear(),o.lastUpdate=null}};class r{constructor(e){this.solarGrid=e,this.jsPDF=window.jspdf?.jsPDF,this.html2canvas=window.html2canvas}isAvailable(){return!(!this.jsPDF||!this.html2canvas)}async generatePDFFromSnapshot(e){if(!this.isAvailable())return console.warn("PDF Libraries nicht verfügbar"),void this.solarGrid.showToast("PDF-Generierung nicht verfügbar",3e3);try{if(console.log("PDF-Generation startet mit Snapshot:",{totalConfigs:e.totalConfigs,timestamp:e.timestamp,configs:e.configs.map(e=>({name:e.name,dimensions:`${e.cols}x${e.rows}`,selectedCells:e.selectedCells,totalCells:e.totalCells}))}),!e.configs||0===e.configs.length)return void this.solarGrid.showToast("Keine Konfiguration zum Exportieren",3e3);const t=new this.jsPDF("p","mm","a4");let i=!0;for(const s of e.configs)i||t.addPage(),await this.addConfigurationToPDFFromSnapshot(t,s,i),i=!1;const s=this.generateFileName(e.configs);t.save(s),console.log("PDF erfolgreich generiert:",s)}catch(e){throw console.error("PDF-Generierung fehlgeschlagen:",e),this.solarGrid.showToast("PDF-Erstellung fehlgeschlagen",3e3),e}}async generatePDF(e="current"){if("current"===e){const e=[this.solarGrid.getCurrentConfigData()],t=new this.jsPDF("p","mm","a4");await this.addConfigurationToPDF(t,e[0],!0);const i=this.generateFileName(e);t.save(i),this.solarGrid.showToast("PDF erfolgreich erstellt ✅",3e3)}else{const e=this.solarGrid.createConfigSnapshot();await this.generatePDFFromSnapshot(e)}}async addConfigurationToPDF(e,t,i){const s={y:20},o=(t=15)=>s.y+t>277&&(e.addPage(),s.y=20,!0);e.setFontSize(20),e.setFont("helvetica","bold"),e.text("Solar-Konfiguration",20,s.y),e.setFontSize(12),e.setFont("helvetica","normal"),e.text((new Date).toLocaleDateString("de-DE"),170,s.y),s.y+=15,e.setFontSize(16),e.setFont("helvetica","bold"),e.text(`Konfiguration: ${t.name||"Unbenannt"}`,20,s.y),s.y+=10,e.setFontSize(11),e.setFont("helvetica","normal"),e.text(`Grid-Größe: ${t.cols} × ${t.rows}`,20,s.y),e.text("Orientierung: "+("vertical"===t.orientation?"Vertikal":"Horizontal"),120,s.y),s.y+=8;const n=t.selection?t.selection.flat().filter(e=>e).length:0;e.text(`Module: ${n} Stück`,20,s.y),s.y+=15;try{await new Promise(e=>setTimeout(e,200));const i=await this.captureGridVisualization(t);if(i){const t=120,n=90;o(n+10);const r=(210-t)/2;e.addImage(i,"PNG",r,s.y,t,n),s.y+=n+10}}catch(e){console.warn("Grid-Screenshot fehlgeschlagen:",e),s.y+=10}await new Promise(e=>setTimeout(e,100)),o(50),s.y=await this.addProductTable(e,t,s.y,o),o(60),s.y=this.addProductPerModuleInfo(e,s.y,o)}async addConfigurationToPDFFromSnapshot(e,t,i){const s={y:20},o=t=>s.y+t>277&&(e.addPage(),s.y=20,!0);console.log(`PDF-Seite für Konfiguration: ${t.name}`,{dimensions:`${t.cols}x${t.rows}`,selectedCells:t.selectedCells,totalCells:t.totalCells}),e.setFontSize(20),e.setFont("helvetica","bold"),e.text("Solar-Konfiguration",20,s.y),e.setFontSize(12),e.setFont("helvetica","normal");const n=(new Date).toLocaleDateString("de-DE"),r=e.getTextWidth(n);e.text(n,190-r,s.y),s.y+=20,e.setFontSize(16),e.setFont("helvetica","bold"),e.text(`Konfiguration: ${t.name}`,20,s.y),s.y+=15,e.setFontSize(12),e.setFont("helvetica","normal");e.text(`Grid-Größe: ${t.cols} x ${t.rows}`,20,s.y),e.text("Orientierung: "+("vertical"===t.orientation?"Vertikal":"Horizontal"),120,s.y),s.y+=10,e.text(`Module: ${t.selectedCells} Stück`,20,s.y),s.y+=15;try{const i=await this.captureGridVisualizationFromSnapshot(t);if(i){const t=120,n=90;o(n+10);const r=(210-t)/2;e.addImage(i,"PNG",r,s.y,t,n),s.y+=n+10}}catch(e){console.warn("Grid-Screenshot fehlgeschlagen:",e),s.y+=10}o(50),s.y=await this.addProductTableFromSnapshot(e,t,s.y,o),o(60),s.y=await this.addProductPerModuleInfo(e,s.y,o)}async captureGridVisualization(e){try{const t=e.selection||[],i=e.cols||5,s=e.rows||5,o=document.createElement("div");o.style.position="absolute",o.style.left="-10000px",o.style.top="-10000px",o.style.padding="20px",o.style.backgroundColor="#ffffff",document.body.appendChild(o);const n=50,r=2,a=document.createElement("div");a.style.display="grid",a.style.gap=`${r}px`,a.style.gridTemplateColumns=`repeat(${i}, ${n}px)`,a.style.gridTemplateRows=`repeat(${s}, ${n}px)`,a.style.padding="2px",a.style.backgroundColor="#ffffff",a.style.border="1px solid #000000",a.style.borderRadius="1rem";const l=Array.from({length:s},(e,s)=>Array.from({length:i},(e,i)=>!!(t[s]&&Array.isArray(t[s])&&i<t[s].length)&&!0===t[s][i]));console.log("Grid Debug - Normalized:",{originalRows:t.length,originalCols:t[0]?t[0].length:0,targetRows:s,targetCols:i,normalizedSelection:l});for(let e=0;e<s;e++)for(let t=0;t<i;t++){const o=document.createElement("div"),r=l[e][t];(e>=s-2||t>=i-2)&&console.log(`Cell [${e}][${t}]: isSelected =`,r),o.style.width=`${n}px`,o.style.height=`${n}px`,o.style.borderRadius="1rem",o.style.border="1px solid #000000",o.style.backgroundColor=r?"#072544":"#f3f4f6",a.appendChild(o)}o.appendChild(a),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,100));const c=await this.html2canvas(o,{backgroundColor:"#ffffff",scale:2,logging:!1,useCORS:!0,allowTaint:!0,width:o.offsetWidth,height:o.offsetHeight});return document.body.removeChild(o),c.toDataURL("image/png")}catch(e){return console.warn("Grid-Screenshot fehlgeschlagen:",e),null}}async captureGridVisualizationFromSnapshot(e){try{console.log(`Grid-Capture für ${e.name}:`,{dimensions:`${e.cols}x${e.rows}`,selectedCells:e.selectedCells,selection:e.selection.slice(0,3).map(e=>e.slice(0,5))});const t=e.selection||[],i=e.cols||5,s=e.rows||5,o=document.createElement("div");o.style.position="absolute",o.style.left="-10000px",o.style.top="-10000px",o.style.padding="20px",o.style.backgroundColor="#ffffff",o.style.zIndex="-1000",document.body.appendChild(o);const n="vertical"===e.orientation,r=40,a=n?.6*r:r,l=1,c=170,h=i*a+(i-1)*l+4,d=h>3.78*c?3.78*c/h:1,u=a*d,m=(n?r:.6*r)*d,g=l*d,f=document.createElement("div");f.style.display="grid",f.style.gap=`${g}px`,f.style.gridTemplateColumns=`repeat(${i}, ${u}px)`,f.style.gridTemplateRows=`repeat(${s}, ${m}px)`,f.style.padding="2px",f.style.backgroundColor="#ffffff",f.style.border="1px solid #000000",f.style.borderRadius="3px",f.style.imageRendering="crisp-edges",f.style.imageRendering="-webkit-optimize-contrast",f.style.transform="translateZ(0)",f.style.backfaceVisibility="hidden";for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=document.createElement("div"),o=t[e]&&!0===t[e][s];i.style.width=`${u}px`,i.style.height=`${m}px`,i.style.borderRadius="2px",i.style.border="1px solid #000000",i.style.imageRendering="crisp-edges",i.style.imageRendering="-webkit-optimize-contrast",i.style.transform="translateZ(0)",i.style.backfaceVisibility="hidden",i.style.backgroundColor=o?"#072544":"#f3f4f6",f.appendChild(i)}o.appendChild(f),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,100));const p=20,w=20,k=Math.ceil(i*u+(i-1)*g+p),b=Math.ceil(s*m+(s-1)*g+w);console.log("Grid Screenshot Debug:",{cols:i,rows:s,finalCellWidth:u,finalCellHeight:m,finalGap:g,calculatedWidth:k,calculatedHeight:b,paddingX:p,paddingY:w});const y=await this.html2canvas(f,{backgroundColor:"#ffffff",width:k,height:b,scale:4,logging:!1,useCORS:!0,allowTaint:!0,foreignObjectRendering:!1,removeContainer:!1,pixelRatio:window.devicePixelRatio||1,imageTimeout:15e3,onclone:e=>{const t=e.createElement("style");t.textContent="\n              * {\n                image-rendering: -webkit-optimize-contrast !important;\n                image-rendering: crisp-edges !important;\n                image-rendering: pixelated !important;\n                text-rendering: optimizeLegibility !important;\n                -webkit-font-smoothing: antialiased !important;\n                -moz-osx-font-smoothing: grayscale !important;\n              }\n            ",e.head.appendChild(t)}});return document.body.removeChild(o),y.toDataURL("image/jpeg",.95)}catch(e){return console.error("Grid-Screenshot fehlgeschlagen:",e),null}}async addProductTableFromSnapshot(t,i,s,o){try{console.log("addProductTableFromSnapshot called for:",i.name);const r=await this.calculatePartsFromSnapshot(i);if(console.log("Received parts:",r,"Keys count:",Object.keys(r||{}).length),!r||0===Object.keys(r).length)return console.log("No parts calculated, returning early"),s;t.setFontSize(14),t.setFont("helvetica","bold"),o(15)&&(t.setFontSize(14),t.setFont("helvetica","bold")),t.text("Benötigte Produkte:",20,s),s+=10,o(25)&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Benötigte Produkte:",20,s),s+=10),t.setFontSize(10),t.setFont("helvetica","bold"),t.text("Produkt",20,s),t.text("Benötigt",80,s),t.text("Packungen",120,s),t.text("Preis/Pack",160,s),t.text("Gesamt",190,s),s+=8,t.line(20,s-2,200,s-2),s+=5;let a=0;return t.setFont("helvetica","normal"),Object.entries(r).forEach(([i,r])=>{if(r>0){o(8)&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.text("Produkt",20,s),t.text("Benötigt",80,s),t.text("Packungen",120,s),t.text("Preis/Pack",160,s),t.text("Gesamt",190,s),s+=8,t.line(20,s-2,200,s-2),s+=5,t.setFont("helvetica","normal"));const l=i.replace(/_/g," "),c=Math.ceil(r/(e[i]||1)),h=n(i),d=c*h;a+=d,t.text(l,20,s),t.text(r.toString(),80,s),t.text(`${c}x`,120,s),t.text(`${h.toFixed(2)} €`,160,s),t.text(`${d.toFixed(2)} €`,190,s),s+=8}}),s+=5,t.line(160,s-2,200,s-2),t.setFont("helvetica","bold"),t.text(`Gesamtpreis: ${a.toFixed(2)} €`,160,s+5),s+15}catch(e){return console.error("Produkttabelle fehlgeschlagen:",e),s}}async calculatePartsFromSnapshot(e){try{console.log("Calculating parts for config:",e.name,{selectedCells:e.selectedCells,rows:e.rows,cols:e.cols,includeModules:e.includeModules});const t={selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation||"horizontal"};let s;try{s=await i.calculate("calculateParts",t)}catch(e){console.warn("calculationManager failed, using fallback:",e),s=this.calculatePartsDirectly(t)}if(console.log("Parts calculated:",s),e.includeModules||delete s.Solarmodul,e.mc4){const t=e.selectedCells;s.MC4_Stecker=Math.ceil(t/30)}return e.cable&&(s.Solarkabel=1),e.wood&&(s.Holzunterleger=(s.Schiene_240_cm||0)+(s.Schiene_360_cm||0)),console.log("Final parts after processing:",s),s}catch(e){return console.error("Part calculation from snapshot failed:",e),{}}}async addProductTable(t,i,s,o){t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Benötigte Produkte:",20,s),s+=10;const r=await this.calculateConfigParts(i);if(!r||0===Object.keys(r).length)return t.setFontSize(10),t.setFont("helvetica","normal"),t.text("Keine Produkte berechnet",20,s),s+10;t.setFontSize(10),t.setFont("helvetica","bold"),t.text("Produkt",20,s),t.text("Benötigt",80,s),t.text("Packungen",120,s),t.text("Preis/Pack",150,s),t.text("Gesamt",180,s),s+=8,t.line(20,s-2,200,s-2),s+=2;let a=0;return t.setFont("helvetica","normal"),Object.entries(r).forEach(([i,r])=>{if(r>0){o&&o(8)&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.text("Produkt",20,s),t.text("Benötigt",80,s),t.text("Packungen",120,s),t.text("Preis/Pack",150,s),t.text("Gesamt",180,s),s+=8,t.line(20,s-2,200,s-2),s+=2,t.setFont("helvetica","normal"));const l=e[i]||1,c=Math.ceil(r/l),h=n(i),d=c*h;a+=d;const u=i.replace(/_/g," ");t.text(u,20,s),t.text(r.toString(),80,s),t.text(`${c}×`,120,s),t.text(`${h.toFixed(2)} €`,150,s),t.text(`${d.toFixed(2)} €`,180,s),s+=6}}),s+=5,t.line(150,s-5,200,s-5),t.setFont("helvetica","bold"),t.text(`Gesamtpreis: ${a.toFixed(2)} €`,150,s),s+=15}addProductPerModuleInfo(e,t,i){e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Produkte pro Modul (Richtwerte):",20,t),t+=10,e.setFontSize(10),e.setFont("helvetica","normal");return["Endklemmen: 2 Stück (je Modulreihe)","Mittelklemmen: 1 Stück (zwischen Modulen)","Dachhaken: 1-2 Stück (je nach Dachtyp)","Schrauben: 4-6 Stück (je Dachhaken)","MC4-Stecker: 1 Packung pro 30 Module","Solarkabel: 1 Rolle pro Anlage","Holzunterleger: 1 Stück pro Schienenmeter"].forEach(s=>{i&&i(8)&&(e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Produkte pro Modul (Richtwerte) - Fortsetzung:",20,t),t+=10,e.setFontSize(10),e.setFont("helvetica","normal")),e.text(`• ${s}`,25,t),t+=6}),i&&i(15),t+=10,e.setFontSize(9),e.setFont("helvetica","italic"),e.text("Hinweis: Genaue Mengen hängen von der spezifischen Dachkonfiguration ab.",20,t),t+10}async calculateConfigParts(e){if(!e.selection||!e.cols||!e.rows)return{};const t={selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation};let s;try{s=await i.calculate("calculateParts",t)}catch(e){console.warn("calculationManager failed, using fallback:",e),s=this.calculatePartsDirectly(t)}if(e.includeModules||delete s.Solarmodul,e.mc4){const t=e.selection.flat().filter(e=>e).length;s.MC4_Stecker=Math.ceil(t/30)}return e.cable&&(s.Solarkabel=1),e.wood&&(s.Holzunterleger=(s.Schiene_240_cm||0)+(s.Schiene_360_cm||0)),s}processGroup(e,t,i,s,o){const n=e*("vertical"===o?s:i),r=Math.floor(n/360),a=n-360*r,l=Math.ceil(a/240),c=Math.ceil(n/360),h=Math.ceil(n/240);r+l<=Math.min(c,h)?(t.Schiene_360_cm+=r,t.Schiene_240_cm+=l):c<=h?t.Schiene_360_cm+=c:t.Schiene_240_cm+=h,t.Solarmodul+=e,t.Endklemmen+=2,t.Mittelklemmen+=Math.max(0,e-1),t.Dachhaken+=e,t.Schrauben+=4*e,t.Endkappen+=2;const d=(t.Schiene_240_cm||0)+(t.Schiene_360_cm||0);d>1&&(t.Schienenverbinder+=Math.max(0,d-e))}generateFileName(e){const t=new Date,i=t.toISOString().slice(0,10),s=t.toTimeString().slice(0,5).replace(":","-");let o="Solar-Konfiguration";return 1===e.length?o=e[0].name||"Konfiguration":e.length>1&&(o=`${e.length}-Konfigurationen`),o=o.replace(/[<>:"/\\|?*]/g,"-"),`${o}_${i}_${s}.pdf`}}class a{constructor(e){this.solarGrid=e,this.patterns={gridSize:/(\d+)\s*[x×]\s*(\d+)/i,moduleCount:/(\d+)\s*modul[e]?[n]?/i,moduleCheckbox:/(?:mit|ohne)[\s-]*modul[e]?[n]?(?!\s*\d)/i,orientation:/(?:horizontal|vertikal|vertical)/i,mc4:/(?:mit|ohne)[\s-]*mc4/i,cable:/(?:mit|ohne)[\s-]*(?:kabel|solarkabel)/i,wood:/(?:mit|ohne)[\s-]*holz(?:unterleger)?/i,rowPattern:/(?:(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?)\s*(?:mit|à|a)?\s*(\d+)\s*modul[e]?[n]?)|(?:(\d+)\s*modul[e]?[n]?\s*(?:in|auf)?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?))/i,spacing:/(?:(?:mit|ohne)\s*(?:abstand|lücke))|(?:(\d+)\s*(?:reihen?|zeilen?)\s*(?:abstand|lücke))/i,checkboxCombination:/(?:^|\s)(?:mit|und)\s+(.+?)(?:\s+und\s+(.+?))*(?:\s*$)/i,saveConfig:/^(?:(?:konfiguration|konfig|config)\s*)?(?:speichern|save)$/i,deleteConfig:/^(?:konfiguration|konfig|config)\s*(?:löschen|delete)$/i,deleteModules:/^modul[e]?[n]?\s*löschen$/i,resetGrid:/^(?:reset|zurücksetzen|zurücksetzen)$/i}}parseWordNumber(e){const t={ein:1,eine:1,zwei:2,drei:3,vier:4,"fünf":5,sechs:6,sieben:7,acht:8,neun:9,zehn:10};return"string"==typeof e&&t[e.toLowerCase()]?t[e.toLowerCase()]:parseInt(e)||0}parseCheckboxCombinations(e){const t={modules:null,mc4:null,cable:null,wood:null};let i=e.toLowerCase().replace(/modulen?/g,"module").replace(/solarkabeln?/g,"solarkabel").replace(/holzunterlegern?/g,"holzunterleger").split(/\s*(?:und|,)\s*/);i[0]&&(i[0].includes("mit ")||i[0].includes("ohne "))&&(i[0]=i[0].replace(/.*(?:mit|ohne)\s+/,"")),i=i.filter(e=>e.trim().length>0);for(const s of i){const i=s.trim();!/\bmodul[e]?[n]?\b/.test(i)||/\d+\s*modul/.test(i)||/reihen/.test(i)||(/\bohne[\s-]+modul[e]?[n]?\b/.test(i)||/\bohne[\s-]+modul[e]?[n]?\b/.test(e.toLowerCase())?t.modules=!1:t.modules=!0),/\bmc4\b/.test(i)&&(/\bohne[\s-]+mc4\b/.test(i)||/\bohne[\s-]+mc4\b/.test(e.toLowerCase())?t.mc4=!1:t.mc4=!0),/\b(?:kabel|solarkabel)\b/.test(i)&&(/\bohne[\s-]+(?:kabel|solarkabel)\b/.test(i)||/\bohne[\s-]+(?:kabel|solarkabel)\b/.test(e.toLowerCase())?t.cable=!1:t.cable=!0),/\b(?:holz|holzunterleger)\b/.test(i)&&(/\bohne[\s-]+(?:holz|holzunterleger)\b/.test(i)||/\bohne[\s-]+(?:holz|holzunterleger)\b/.test(e.toLowerCase())?t.wood=!1:t.wood=!0)}return t}parseInput(e){const t={},i=e.match(this.patterns.gridSize);if(i){t.cols=parseInt(i[1]),t.rows=parseInt(i[2]);const s=e.match(this.patterns.spacing);let o=0;if(s&&(s[0].toLowerCase().includes("mit")&&!s[1]?o=1:s[1]&&(o=parseInt(s[1])),o>=0)){if(this.solarGrid.selection&&this.solarGrid.selection.some(e=>e&&e.some(e=>!0===e)))t.adjustSpacing={spacing:o,targetCols:t.cols,targetRows:t.rows};else{const e=Math.ceil(t.rows/(1+Math.max(o,1))),i=t.cols*e;t.rowConfig={rows:e,modulesPerRow:t.cols,spacing:o,totalModules:i}}}}if(!i){const i=e.match(this.patterns.spacing);if(i){let e=0;i[0].toLowerCase().includes("ohne")?e=0:i[0].toLowerCase().includes("mit")&&!i[1]?e=1:i[1]&&(e=parseInt(i[1]));return this.solarGrid.selection&&this.solarGrid.selection.some(e=>e&&e.some(e=>!0===e))?(t.adjustSpacing={spacing:e,targetCols:null,targetRows:null},t):(this.solarGrid.showToast("⚠️ Keine Module vorhanden - erst Module auswählen, dann Abstand anpassen",3e3),{})}}const s=e.match(this.patterns.rowPattern);if(s){let i,o;if(s[1]&&s[2])i=this.parseWordNumber(s[1]),o=parseInt(s[2]);else if(s[3]&&s[4]){const e=parseInt(s[3]);i=this.parseWordNumber(s[4]),o=Math.ceil(e/i),t.intelligentDistribution={totalModules:e,numRows:i,baseModulesPerRow:Math.floor(e/i),extraModules:e%i}}if(i&&o){const s=e.match(this.patterns.spacing);let n=0;s&&(s[0].toLowerCase().includes("mit")&&!s[1]?n=1:s[1]&&(n=parseInt(s[1]))),t.rowConfig={rows:i,modulesPerRow:o,spacing:n,totalModules:i*o};const r=i+(i-1)*n;t.cols=o,t.rows=r}}else{const s=e.match(this.patterns.moduleCount);if(s&&!i){t.moduleCount=parseInt(s[1]);const i=e.match(this.patterns.spacing);let o=0;i&&(i[0].toLowerCase().includes("mit")&&!i[1]?o=1:i[1]&&(o=parseInt(i[1])));const n=this.calculateOptimalGrid(t.moduleCount);if(t.cols=n.cols,t.rows=n.rows,o>0){const e=Math.ceil(Math.sqrt(t.moduleCount/n.cols)),i=Math.ceil(t.moduleCount/e);t.rowConfig={rows:e,modulesPerRow:i,spacing:o,totalModules:t.moduleCount},t.rows=e+(e-1)*o,t.cols=Math.max(t.cols,i)}}}const o=e.match(this.patterns.orientation);o&&(t.orientation=o[0].toLowerCase().includes("vertikal")||o[0].toLowerCase().includes("vertical")?"vertical":"horizontal");const n=this.parseCheckboxCombinations(e);if(Object.values(n).some(e=>null!==e))null!==n.modules&&(t.includeModules=n.modules),null!==n.mc4&&(t.mc4=n.mc4),null!==n.cable&&(t.cable=n.cable),null!==n.wood&&(t.wood=n.wood);else{const i=e.match(this.patterns.moduleCheckbox);i&&(t.includeModules=i[0].toLowerCase().includes("mit"));const s=e.match(this.patterns.mc4);s&&(t.mc4=s[0].toLowerCase().includes("mit"));const o=e.match(this.patterns.cable);o&&(t.cable=o[0].toLowerCase().includes("mit"));const n=e.match(this.patterns.wood);n&&(t.wood=n[0].toLowerCase().includes("mit"))}if(e.match(this.patterns.saveConfig))return t.action="saveConfig",t;if(e.match(this.patterns.deleteConfig))return t.action="deleteConfig",t;if(e.match(this.patterns.deleteModules))return t.action="deleteModules",t;return e.match(this.patterns.resetGrid)?(t.action="resetGrid",t):t}calculateOptimalGrid(e){const t=[];for(let i=1;i<=Math.sqrt(e);i++)e%i===0&&t.push([i,e/i]);const i=t.reduce((e,t)=>Math.max(e[0],e[1])/Math.min(e[0],e[1])<=Math.max(t[0],t[1])/Math.min(t[0],t[1])?e:t);return{cols:Math.max(i[0],i[1]),rows:Math.min(i[0],i[1])}}applyConfiguration(e){const t=this.solarGrid.selection?this.solarGrid.selection.map(e=>[...e]):null,i=this.solarGrid.cols,s=this.solarGrid.rows;if(e.cols&&e.rows&&(this.solarGrid.cols=e.cols,this.solarGrid.rows=e.rows),e.orientation&&(this.solarGrid.orV.checked="vertical"===e.orientation,this.solarGrid.orH.checked="horizontal"===e.orientation),e.action)return void this.handleAction(e.action);e.hasOwnProperty("includeModules")&&(this.solarGrid.incM.checked=e.includeModules),e.hasOwnProperty("mc4")&&(this.solarGrid.mc4.checked=e.mc4),e.hasOwnProperty("cable")&&(this.solarGrid.solarkabel.checked=e.cable),e.hasOwnProperty("wood")&&(this.solarGrid.holz.checked=e.wood);let o;o=e.cols&&e.cols!==i||e.rows&&e.rows!==s?e.moduleCount||e.rowConfig?Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)):Array.from({length:this.solarGrid.rows},(e,i)=>Array.from({length:this.solarGrid.cols},(e,s)=>!!(t&&i<t.length&&s<t[i].length)&&t[i][s])):t||Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)),this.solarGrid.selection=o,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),e.adjustSpacing?this.adjustGridSpacing(e.adjustSpacing):e.rowConfig?this.applyRowConfiguration(e.rowConfig,e.intelligentDistribution):e.moduleCount&&this.autoSelectModules(e.moduleCount),this.hideHelpAfterFirstUse()}handleAction(e){switch(e){case"saveConfig":this.solarGrid.saveNewConfig(),this.solarGrid.showToast("💾 Konfiguration gespeichert",2e3);break;case"deleteConfig":if(this.solarGrid.configs.length<=1)return void this.solarGrid.showToast("⚠️ Kann letzte Konfiguration nicht löschen",3e3);null!==this.solarGrid.currentConfig&&(this.solarGrid.deleteConfig(this.solarGrid.currentConfig),this.solarGrid.showToast("🗑️ Konfiguration gelöscht",2e3));break;case"deleteModules":this.clearModuleSelection(),this.solarGrid.showToast("🔄 Module-Auswahl gelöscht",2e3);break;case"resetGrid":this.solarGrid.resetGridToDefault(),this.solarGrid.showToast("⚡ Grid zurückgesetzt",2e3);break;default:console.warn("Unbekannte Action:",e)}}clearModuleSelection(){for(let e=0;e<this.solarGrid.rows;e++)for(let t=0;t<this.solarGrid.cols;t++)this.solarGrid.selection[e]&&(this.solarGrid.selection[e][t]=!1);this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}hideHelpAfterFirstUse(){const e=document.querySelector(".bulk-selection-help");e&&(e.style.display="none",localStorage.setItem("solarTool_hideHelp","true"))}autoSelectModules(e){this.solarGrid.cols*this.solarGrid.rows<e&&this.expandGridForModules(e),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1));let t=0;for(let i=0;i<this.solarGrid.rows&&t<e;i++)for(let s=0;s<this.solarGrid.cols&&t<e;s++)this.solarGrid.selection[i][s]=!0,t++;this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForModules(e){if(this.solarGrid.cols*this.solarGrid.rows>=e)return;this.calculateOptimalGrid(e);let t=this.solarGrid.cols,i=this.solarGrid.rows;for(;t*i<e;)t<=i?t++:i++;this.solarGrid.cols=t,this.solarGrid.rows=i;const s=this.solarGrid.selection||[];this.solarGrid.selection=Array.from({length:i},(e,i)=>Array.from({length:t},(e,t)=>i<s.length&&t<s[i].length&&s[i][t])),this.solarGrid.updateSize()}adjustGridSpacing(e){const{spacing:t,targetCols:i,targetRows:s}=e,o=[];for(let e=0;e<this.solarGrid.rows;e++)if(this.solarGrid.selection[e]&&this.solarGrid.selection[e].some(e=>!0===e)){const t=[];for(let i=0;i<this.solarGrid.cols;i++)!0===this.solarGrid.selection[e][i]&&t.push(i);o.push({originalRow:e,modules:t})}if(0===o.length)return;let n;n=0===t?o.length:o.length+(o.length-1)*t;const r=Math.max(...o.map(e=>e.modules.length>0?Math.max(...e.modules):0)),a=Math.max(i||this.solarGrid.cols,r+1);this.solarGrid.cols=a,this.solarGrid.rows=n;const l=Array.from({length:n},()=>Array.from({length:a},()=>!1));let c=0;for(let e=0;e<o.length;e++){const i=o[e];for(const e of i.modules)e<a&&(l[c][e]=!0);e<o.length-1&&(c+=1+t)}this.solarGrid.selection=l,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),0===t?this.solarGrid.showToast(`🔧 Abstände entfernt - ${o.length} Reihen kompakt`,2e3):this.solarGrid.showToast(`📏 ${t} Reihen Abstand hinzugefügt - ${n} Reihen total`,2e3)}applyRowConfiguration(e,t=null){const{rows:i,modulesPerRow:s,spacing:o,totalModules:n}=e,r=i+(i-1)*o,a=s;(this.solarGrid.rows<r||this.solarGrid.cols<a)&&this.expandGridForRowConfig(a,r);for(let e=0;e<this.solarGrid.rows;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=0;t<this.solarGrid.cols;t++)this.solarGrid.selection[e][t]=!1}let l=0,c=0;for(let e=0;e<i;e++){let i;if(t){const{baseModulesPerRow:s,extraModules:o}=t;i=s+(e<o?1:0)}else i=Math.min(s,n-c);for(let e=0;e<i&&e<this.solarGrid.cols;e++)l<this.solarGrid.rows&&(this.solarGrid.selection[l]||(this.solarGrid.selection[l]=[]),this.solarGrid.selection[l][e]=!0,c++);l+=1+o}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForRowConfig(e,t){const i=this.solarGrid.selection||[];this.solarGrid.cols=Math.max(this.solarGrid.cols,e),this.solarGrid.rows=Math.max(this.solarGrid.rows,t),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},(e,t)=>Array.from({length:this.solarGrid.cols},(e,s)=>t<i.length&&s<i[t].length&&i[t][s])),this.solarGrid.updateSize()}}class l{constructor(e){this.solarGrid=e,this.firstClick=null,this.isSelecting=!1,this.bulkMode=!1,this.setupKeyListener()}setupKeyListener(){document.addEventListener("keydown",e=>{"Shift"!==e.key||e.repeat||this.toggleBulkMode()})}toggleBulkMode(){this.bulkMode=!this.bulkMode,this.bulkMode?(this.showBulkModeIndicator(!0),this.firstClick=null):(this.showBulkModeIndicator(!1),this.firstClick=null,this.clearHighlight())}showBulkModeIndicator(e){if(document.querySelectorAll(".bulk-mode-indicator").forEach(e=>e.remove()),e){const e=document.createElement("div");e.className="bulk-mode-indicator",e.innerHTML="🔄 Bulk-Modus aktiv - Klicke auf zwei Zellen um einen Bereich auszuwählen",e.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background: #f5a623;\n          color: white;\n          padding: 8px 16px;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: bold;\n          z-index: 1000;\n          box-shadow: 0 4px 12px rgba(245, 166, 35, 0.3);\n          animation: slideIn 0.3s ease;\n        ";const t=document.createElement("style");t.textContent="\n          @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n          }\n        ",document.head.appendChild(t),document.body.appendChild(e)}}initializeBulkSelection(){const e=this.solarGrid.buildGrid.bind(this.solarGrid);this.solarGrid.buildGrid=()=>{e(),setTimeout(()=>{this.addBulkSelectionToGrid()},10)},setTimeout(()=>{this.addBulkSelectionToGrid()},100)}addBulkSelectionToGrid(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach((e,t)=>{const i=t%this.solarGrid.cols,s=Math.floor(t/this.solarGrid.cols),o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.addEventListener("click",e=>{if(this.bulkMode)if(this.firstClick)this.selectRange(this.firstClick,{x:i,y:s}),this.bulkMode=!1,this.showBulkModeIndicator(!1),this.firstClick=null,this.clearFirstClickMarker();else{const e=this.solarGrid.selection[s]?.[i]||!1;this.firstClick={x:i,y:s,wasSelected:e},o.classList.add("first-click-marker")}else this.solarGrid.selection[s]||(this.solarGrid.selection[s]=[]),e.ctrlKey||e.metaKey,this.solarGrid.selection[s][i]=!this.solarGrid.selection[s][i],o.classList.toggle("selected"),this.solarGrid.trackInteraction(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}),o.addEventListener("mouseenter",e=>{this.bulkMode&&this.firstClick&&this.highlightRange(this.firstClick,{x:i,y:s})}),o.addEventListener("mouseleave",()=>{this.clearHighlight()})})}selectRange(e,t){const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),o=Math.min(e.y,t.y),n=Math.max(e.y,t.y),r=!e.wasSelected;for(let e=o;e<=n;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=i;t<=s;t++)this.solarGrid.selection[e][t]=r}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}highlightRange(e,t){this.clearHighlight();const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),o=Math.min(e.y,t.y),n=Math.max(e.y,t.y),r=this.solarGrid.gridEl.querySelectorAll(".grid-cell");for(let e=o;e<=n;e++)for(let t=i;t<=s;t++){const i=e*this.solarGrid.cols+t;r[i]&&r[i].classList.add("bulk-highlight")}}clearHighlight(){this.solarGrid.gridEl.querySelectorAll(".bulk-highlight").forEach(e=>e.classList.remove("bulk-highlight"))}clearFirstClickMarker(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach(e=>e.classList.remove("first-click-marker"))}}class c{constructor(){this.gridEl=document.getElementById("grid"),this.wrapper=document.querySelector(".grid-wrapper"),this.wIn=document.getElementById("width-input"),this.hIn=document.getElementById("height-input"),this.orH=document.getElementById("orient-h"),this.orV=document.getElementById("orient-v"),this.incM=document.getElementById("include-modules"),this.mc4=document.getElementById("mc4"),this.solarkabel=document.getElementById("solarkabel"),this.holz=document.getElementById("holz"),this.listHolder=document.querySelector(".produktliste-holder"),this.prodList=document.getElementById("produktliste"),this.summaryHolder=document.getElementById("summary-list-holder"),this.summaryList=document.getElementById("summary-list"),this.saveBtn=document.getElementById("save-config-btn"),this.addBtn=document.getElementById("add-to-cart-btn"),this.summaryBtn=document.getElementById("summary-add-cart-btn"),this.configListEl=document.getElementById("config-list"),this.resetBtn=document.getElementById("reset-btn"),this.continueLaterBtn=document.getElementById("continue-later-btn"),this.selection=[],this.configs=[],this.currentConfig=null,this.default={cols:5,rows:5,width:176,height:113},this.sessionId=this.generateSessionId(),this.sessionStartTime=Date.now(),this.firstInteractionTime=null,this.lastInteractionTime=Date.now(),this.interactionCount=0,this.webhookUrl="https://hook.eu2.make.com/c7lkudk1v2a2xsr291xbvfs2cb25b84k",this.pdfGenerator=new r(this),this.init()}generateSessionId(){return`session_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}trackInteraction(){this.firstInteractionTime||(this.firstInteractionTime=Date.now()),this.lastInteractionTime=Date.now(),this.interactionCount++}formatDuration(e){if(!e||e<0)return"00:00:00";const t=Math.floor(e/1e3),i=Math.floor(t/3600),s=Math.floor(t%3600/60),o=t%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}getSessionData(){const e=Date.now(),t=e-this.sessionStartTime,i=this.firstInteractionTime?this.firstInteractionTime-this.sessionStartTime:0,s=e-this.lastInteractionTime;return{sessionDuration:this.formatDuration(t),timeToFirstInteraction:this.formatDuration(i),timeSinceLastInteraction:this.formatDuration(s),interactionCount:this.interactionCount,sessionStartTime:this.sessionStartTime,firstInteractionTime:this.firstInteractionTime,lastInteractionTime:this.lastInteractionTime}}getProductSummary(){const t=this.calculateParts();this.incM.checked||delete t.Solarmodul,this.mc4.checked&&(t.MC4_Stecker=this.selection.flat().filter(e=>e).length),this.solarkabel.checked&&(t.Solarkabel=1),this.holz.checked&&(t.Holzunterleger=(t.Schiene_240_cm||0)+(t.Schiene_360_cm||0));const i=Object.entries(t).filter(([,e])=>e>0);let s=0;const o={};return i.forEach(([t,i])=>{const r=Math.ceil(i/e[t]),a=n(t);s+=r*a;const l=t.replace(/_/g,"");o[l]=i}),{productQuantities:o,totalPrice:s}}generateGridVisualization(e,t,i,s,o){let n=`<div class="grid" style="--cols: ${t}; --rows: ${i}; --cell-size: ${s}px; --cell-height: ${o}px; --cell-gap: 2px;">`;for(let s=0;s<i;s++)for(let i=0;i<t;i++){n+=`<div class="${e[s]&&e[s][i]?"cell selected":"cell"}"></div>`}n+="</div>";return{html:n,css:".grid { \n        display: grid; \n        gap: var(--cell-gap); \n        grid-template-columns: repeat(var(--cols), var(--cell-size)); \n        grid-template-rows: repeat(var(--rows), var(--cell-height)); \n        margin: auto; \n        background: transparent; \n      } \n      .cell { \n        background: #000000; \n        border-radius: 6px; \n        width: var(--cell-size); \n        height: var(--cell-height); \n        transition: all 0.15s ease; \n      } \n      .cell.selected { \n        background: #7f7f7f; \n      }"}}getConfigData(e=null){const t=e||{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked},i=this.getProductSummary(),s=this.generateGridVisualization(t.selection,t.cols,t.rows,t.cellWidth,t.cellHeight);return{timestamp:(new Date).toISOString(),sessionId:this.sessionId,sessionData:this.getSessionData(),config:{cols:t.cols,rows:t.rows,cellWidth:t.cellWidth,cellHeight:t.cellHeight,orientation:t.orientation,gridVisualization:s,options:{includeModules:t.incM,mc4Connectors:t.mc4,solarkabel:t.solarkabel,woodUnderlay:t.holz}},summary:i,analytics:{totalCells:t.cols*t.rows,selectedCells:t.selection.flat().filter(e=>e).length,selectionPercentage:(t.selection.flat().filter(e=>e).length/(t.cols*t.rows)*100).toFixed(2),gridArea:t.cols*t.rows,averageCellSize:((t.cellWidth+t.cellHeight)/2).toFixed(2)}}}async sendConfigToWebhook(e){try{return!!(await fetch(this.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(e){return!1}}async sendCurrentConfigToWebhook(){const e=this.getConfigData();return await this.sendConfigToWebhook(e)}async sendAllConfigsToWebhook(){const e=[];let t=0;for(let i=0;i<this.configs.length;i++){const s=this.configs[i];let o;o=i===this.currentConfig?{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked}:{cols:s.cols,rows:s.rows,cellWidth:s.cellWidth,cellHeight:s.cellHeight,orientation:s.orientation,selection:s.selection,incM:s.incM,mc4:s.mc4,solarkabel:s.solarkabel,holz:s.holz};const n=this.selection,r=this.orV.checked,a=this.solarkabel.checked,l=this.incM.checked,c=this.mc4.checked,h=this.holz.checked;this.selection=o.selection,this.orV.checked="vertical"===o.orientation,this.orH.checked=!this.orV.checked,this.solarkabel.checked=o.solarkabel,this.incM.checked=o.incM,this.mc4.checked=o.mc4,this.holz.checked=o.holz;const d=this.getConfigData(o);d.configIndex=i,d.configName=s.name,d.totalConfigsInSession=this.configs.length,this.selection=n,this.orV.checked=r,this.orH.checked=!r,this.solarkabel.checked=a,this.incM.checked=l,this.mc4.checked=c,this.holz.checked=h;try{const s=await this.sendConfigToWebhook(d);s&&t++,e.push(s),i<this.configs.length-1&&await new Promise(e=>setTimeout(e,100))}catch(t){e.push(!1)}}return t===this.configs.length}checkMobileDevice(){(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window&&window.innerWidth<=1024)&&this.showMobileWarning()}showMobileWarning(){const e=document.getElementById("mobile-warning"),t=document.getElementById("mobile-continue"),i=document.getElementById("mobile-close");if(e){sessionStorage.getItem("mobile-warning-seen")||(e.classList.remove("hidden"),t?.addEventListener("click",()=>{e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),i?.addEventListener("click",()=>{e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),e.addEventListener("click",t=>{t.target===e&&(e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true"))}))}}init(){this.checkMobileDevice();const e=new URLSearchParams(window.location.search).get("configData");if(e)try{const t=decodeURIComponent(atob(e)),i=JSON.parse(t);return void(Array.isArray(i)?(this.configs=i,this.loadConfig(0)):(this.configs.push(i),this.loadConfig(0)))}catch(e){}[this.wIn,this.hIn].forEach(e=>e.addEventListener("change",()=>{this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange()}));let t=this.orH.checked?"horizontal":"vertical";if([this.orH,this.orV].forEach(e=>e.addEventListener("change",()=>{if(!e.checked)return;const i=e===this.orH?"horizontal":"vertical";i!==t&&(this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange(),t=i)})),[this.incM,this.mc4,this.solarkabel,this.holz].forEach(e=>e.addEventListener("change",()=>{this.trackInteraction(),this.buildList(),this.updateSummaryOnChange(),this.renderProductSummary()})),document.querySelectorAll(".btn-add-col-right").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.addColumnRight()})}),document.querySelectorAll(".btn-remove-col-right").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.removeColumnRight()})}),document.querySelectorAll(".btn-add-col-left").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.addColumnLeft()})}),document.querySelectorAll(".btn-remove-col-left").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.removeColumnLeft()})}),document.querySelectorAll(".btn-add-row-bottom").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.addRowBottom()})}),document.querySelectorAll(".btn-remove-row-bottom").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.removeRowBottom()})}),document.querySelectorAll(".btn-add-row-top").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.addRowTop()})}),document.querySelectorAll(".btn-remove-row-top").forEach(e=>{e.addEventListener("click",()=>{this.trackInteraction(),this.removeRowTop()})}),this.saveBtn.addEventListener("click",()=>{this.trackInteraction(),this.saveNewConfig()}),this.addBtn.addEventListener("click",()=>{this.trackInteraction(),this.addCurrentToCart()}),this.summaryBtn.addEventListener("click",()=>{this.trackInteraction(),this.addAllToCart()}),this.resetBtn.addEventListener("click",()=>{this.trackInteraction(),this.resetGridToDefault()}),this.continueLaterBtn.addEventListener("click",()=>{this.trackInteraction(),this.generateContinueLink()}),window.addEventListener("resize",()=>{this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}),0===this.configs.length){this.cols=this.default.cols,this.rows=this.default.rows,this.setup();const e=this._makeConfigObject();this.configs.push(e),this.loadConfig(0)}this.initSmartConfigFeatures()}initSmartConfigFeatures(){this.smartParser=new a(this),this.bulkSelector=new l(this),this.bulkSelector.initializeBulkSelection(),this.initQuickConfigInterface(),this.ensurePermanentVisibility(),this.checkAndHideHelp(),this.initSmartConfigCloseButton()}ensurePermanentVisibility(){setTimeout(()=>{const e=document.querySelector(".usage-tips");e&&(e.style.display="block",e.classList.remove("hidden"));document.querySelectorAll(".smart-config-container").forEach(e=>{e.style.display="block",e.classList.remove("hidden")}),localStorage.removeItem("solarTool_hideHelp"),localStorage.removeItem("solarTool_hideSmartConfig")},100)}checkAndHideHelp(){}initSmartConfigCloseButton(){setTimeout(()=>{const e=document.getElementById("smart-config-close"),t=document.querySelector(".smart-config-container");e&&t&&e.addEventListener("click",()=>{})},600)}initQuickConfigInterface(){setTimeout(()=>{const e=document.getElementById("quick-config-input"),t=document.getElementById("apply-quick-config");e&&t&&(t.addEventListener("click",()=>{const t=e.value.trim();if(t)try{const i=this.smartParser.parseInput(t);this.smartParser.applyConfiguration(i),this.showToast(`Konfiguration "${t}" angewendet ✅`,2e3),e.value=""}catch(e){this.showToast("Fehler: Konfiguration konnte nicht angewendet werden ❌",2e3)}}),e.addEventListener("keypress",e=>{"Enter"===e.key&&t.click()}),e.addEventListener("input",e=>{const t=e.target.value.trim();if(t.length>3)try{const e=this.smartParser.parseInput(t);this.showConfigPreview(e)}catch(e){}}))},500)}initQuickConfigInterface(){setTimeout(()=>{const e=document.getElementById("quick-config-input"),t=document.getElementById("apply-quick-config");e&&t&&(t.addEventListener("click",()=>{const t=e.value.trim();if(t)try{const i=this.smartParser.parseInput(t);this.smartParser.applyConfiguration(i),this.showToast(`Konfiguration "${t}" angewendet ✅`,2e3),e.value=""}catch(e){this.showToast("Fehler: Konfiguration konnte nicht angewendet werden ❌",2e3)}}),e.addEventListener("keypress",e=>{"Enter"===e.key&&t.click()}),e.addEventListener("input",e=>{const t=e.target.value.trim();if(t.length>3)try{const e=this.smartParser.parseInput(t);this.showConfigPreview(e)}catch(e){}})),this.initializeSmartConfigHelp()},500)}showConfigPreview(e){const t=document.getElementById("config-preview");if(t&&(e.cols||e.moduleCount)){let i="";if(e.cols&&e.rows&&(i+=`${e.cols}×${e.rows} Grid`),e.moduleCount&&(i+=` (${e.moduleCount} Module)`),"horizontal"!==e.orientation&&(i+=`, ${e.orientation}`),e.mc4||e.cable||e.wood){const t=[];e.mc4&&t.push("MC4"),e.cable&&t.push("Kabel"),e.wood&&t.push("Holz"),i+=` + ${t.join(", ")}`}t.textContent=i,t.style.display=i?"block":"none"}}initializeSmartConfigHelp(){const e=document.getElementById("smart-help-trigger"),t=document.getElementById("smart-help-dropdown");if(!e||!t)return;let i=!1,s=null;const o=()=>{t.style.opacity="0",t.style.visibility="hidden",t.style.transform="translateY(-10px)"};e.addEventListener("mouseenter",()=>{i=!0,s&&clearTimeout(s),t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"}),e.addEventListener("mouseleave",()=>{i=!1,s=setTimeout(()=>{i||o()},100)}),t.addEventListener("mouseenter",()=>{i=!0,s&&clearTimeout(s)}),t.addEventListener("mouseleave",()=>{i=!1,s=setTimeout(()=>{i||o()},100)}),t.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("click",s=>{e.contains(s.target)||t.contains(s.target)||(i=!1,o())}),document.querySelectorAll(".example").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const s=document.getElementById("quick-config-input");if(s){if(s.value=e.textContent.replace(/"/g,""),s.focus(),s.value.length>3)try{const e=this.smartParser.parseInput(s.value);this.showConfigPreview(e)}catch(e){}i=!1,o(),setTimeout(()=>{s.scrollIntoView({behavior:"smooth",block:"center"})},100)}})})}setup(){if(this.cols&&this.rows||(this.cols=this.default.cols,this.rows=this.default.rows),this.cols&&this.rows){if(!Array.isArray(this.selection)||this.selection.length!==this.rows||this.selection[0]?.length!==this.cols){const e=this.selection;this.selection=Array.from({length:this.rows},(t,i)=>Array.from({length:this.cols},(t,s)=>e?.[i]?.[s]||!1))}this.listHolder.style.display="block",this.updateSize(),this.buildGrid(),this.buildList(),this.renderProductSummary(),this.updateSaveButtons()}else alert("Spalten und Zeilen müssen > 0 sein")}updateSaveButtons(){this.saveBtn.style.display="inline-block"}addColumnRight(){this.cols+=1;for(let e of this.selection)e.push(!1);this.updateGridAfterStructureChange()}removeColumnRight(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.pop();this.updateGridAfterStructureChange()}}addColumnLeft(){this.cols+=1;for(let e of this.selection)e.unshift(!1);this.updateGridAfterStructureChange()}removeColumnLeft(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.shift();this.updateGridAfterStructureChange()}}addRowBottom(){this.rows+=1,this.selection.push(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowBottom(){this.rows<=1||(this.rows-=1,this.selection.pop(),this.updateGridAfterStructureChange())}addRowTop(){this.rows+=1,this.selection.unshift(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowTop(){this.rows<=1||(this.rows-=1,this.selection.shift(),this.updateGridAfterStructureChange())}updateGridAfterStructureChange(){this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}updateSize(){parseFloat(getComputedStyle(document.documentElement).fontSize);const e=parseInt(this.wIn.value,10)||179,t=parseInt(this.hIn.value,10)||113,i=this.orV.checked,s=i?t:e,o=i?e:t,n=this.wrapper.clientWidth-100,r=this.wrapper.clientHeight-100,a=n/(this.cols*s+2*(this.cols-1)),l=r/(this.rows*o+2*(this.rows-1)),c=Math.min(a,l,1),h=s*c,d=o*c,u=this.cols>=15||this.rows>=10?0:2*c;document.documentElement.style.setProperty("--cell-size",h+"px"),document.documentElement.style.setProperty("--cell-width",h+"px"),document.documentElement.style.setProperty("--cell-height",d+"px"),document.documentElement.style.setProperty("--cell-gap",u+"px");const m=Math.min(this.cols*h+(this.cols-1)*u,n),g=Math.min(this.rows*d+(this.rows-1)*u,r);this.gridEl.style.width=m+"px",this.gridEl.style.height=g+"px"}buildGrid(){if(!Array.isArray(this.selection))return;this.gridEl.innerHTML="",document.documentElement.style.setProperty("--cols",this.cols),document.documentElement.style.setProperty("--rows",this.rows);const e=(this.cols-1)/2,t=(this.rows-1)/2;for(let i=0;i<this.rows;i++)if(Array.isArray(this.selection[i]))for(let s=0;s<this.cols;s++){const o=document.createElement("div");o.className="grid-cell animate-in",this.selection[i]?.[s]&&o.classList.add("selected"),o.addEventListener("click",()=>{this.selection[i]||(this.selection[i]=[]),this.selection[i][s]=!this.selection[i][s],o.classList.toggle("selected"),this.trackInteraction(),this.buildList(),this.updateSummaryOnChange()});const n=s-e,r=i-t,a=60*Math.sqrt(n*n+r*r);o.style.animationDelay=`${a}ms`,setTimeout(()=>o.classList.remove("animate-in"),400),this.gridEl.appendChild(o)}}async buildList(){try{const t=await this.calculateParts();if(this.incM.checked||delete t.Solarmodul,this.mc4.checked){const e=this.selection.flat().filter(e=>e).length;t.MC4_Stecker=Math.ceil(e/30)}this.solarkabel.checked&&(t.Solarkabel=1),this.holz.checked&&(t.Holzunterleger=(t.Schiene_240_cm||0)+(t.Schiene_360_cm||0));const i=Object.entries(t).filter(([,e])=>e>0);if(!i.length)return void(this.listHolder.style.display="none");this.listHolder.style.display="block",this.prodList.innerHTML=i.map(([t,i])=>`<div class="produkt-item">\n          <span>${Math.ceil(i/e[t])}×</span>\n          <img src="${this.mapImage(t)}" alt="${t}" onerror="this.src='https://via.placeholder.com/32?text=${encodeURIComponent(t)}'">\n          <span>${t.replace(/_/g," ")} (${i})</span>\n        </div>`).join(""),this.prodList.style.display="block"}catch(e){this.listHolder.style.display="none"}}resetGridToDefault(){const{cols:e,rows:t,width:i,height:s}=this.default,o=[];for(let i=0;i<t;i++){o[i]=[];for(let t=0;t<e;t++)o[i][t]=this.selection?.[i]?.[t]||!1}this.wIn.value=i,this.hIn.value=s;const n=document.getElementById("orient-v").hasAttribute("checked");this.orH.checked=!n,this.orV.checked=n,this.incM.checked=!1,this.mc4.checked=!1,this.solarkabel.checked=!1,this.holz.checked=!1,this.cols=e,this.rows=t,this.setup(),this.selection=o,this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}resetToDefaultGrid(){this.colsIn.value=this.default.cols,this.rowsIn.value=this.default.rows,this.wIn.value=this.default.width,this.hIn.value=this.default.height,this.orH.checked=!0,this.orV.checked=!1,this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup()}async calculateParts(){try{const e={selection:this.selection,rows:this.rows,cols:this.cols,cellWidth:parseInt(this.wIn.value,10)||179,cellHeight:parseInt(this.hIn.value,10)||113,orientation:this.orV.checked?"vertical":"horizontal"};return await i.calculate("calculateParts",e)}catch(e){return this.calculatePartsSync()}}calculatePartsSync(){const e={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0};for(let t=0;t<this.rows;t++){if(!Array.isArray(this.selection[t]))continue;let i=0;for(let s=0;s<this.cols;s++)this.selection[t]?.[s]?i++:i&&(this.processGroup(i,e),i=0);i&&this.processGroup(i,e)}return e}processGroup(e,t){const i=e*(this.orV.checked?parseInt(this.hIn.value,10)||113:parseInt(this.wIn.value,10)||179),s=Math.floor(i/360),o=i-360*s,n=[{cnt360:s,cnt240:Math.ceil(o/240)},{cnt360:Math.ceil(i/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(i/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-i})),r=Math.min(...n.map(e=>e.rails)),a=n.filter(e=>e.rails===r).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:l,cnt240:c}=a;t.Schiene_360_cm+=2*l,t.Schiene_240_cm+=2*c,t.Schienenverbinder+=4*(l+c-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=t.Endklemmen,t.Solarmodul+=e,t.Schrauben+=2*t.Dachhaken}mapImage(e){return{Solarmodul:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Endklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c316b21cb7d04ba2ed22_DSC04815-min.jpg",Schrauben:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg",Dachhaken:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c1c8a2835b7879f46811_DSC04760-min.jpg",Mittelklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c0d0c2d922d926976bd4_DSC04810-min.jpg",Endkappen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bdfbe7cffc653f6a4605_DSC04788-min.jpg",Schienenverbinder:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c21f0c39e927fce0db3b_DSC04780-min.jpg",Schiene_240_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bce018164af4b4a187f1_DSC04825-min.jpg",Schiene_360_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bcd5726d1d33d4b86ba4_DSC04824-min.jpg",MC4_Stecker:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fcdab153f840ea15b5e7b_iStock-2186771695.jpg",Solarkabel:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fd566bdbb6de2e5f362f0_DSC04851.jpg",Holzunterleger:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png"}[e]||""}loadConfig(e){const t=this.configs[e];this.currentConfig=e,this.wIn.value=t.cellWidth,this.hIn.value=t.cellHeight,this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.incM.checked=t.incM,this.mc4.checked=t.mc4,this.solarkabel.checked=t.solarkabel||!1,this.holz.checked=t.holz,this.cols=t.cols,this.rows=t.rows,this.selection=t.selection.map(e=>[...e]),this.setup(),this.renderConfigList(),this.updateSaveButtons()}showToast(e="Gespeichert ✅",t=1500){const i=document.getElementById("toast");i&&(i.textContent=e,i.classList.remove("hidden"),clearTimeout(this.toastTimeout),this.toastTimeout=setTimeout(()=>{i.classList.add("hidden")},t))}saveNewConfig(){null!==this.currentConfig&&this.updateConfig(),this.currentConfig=null;const e=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1));this.selection;this.selection=e;const t=this._makeConfigObject();this.configs.push(t),this.currentConfig=this.configs.length-1,this.setup(),this.renderConfigList(),this.updateSaveButtons(),this.showToast(`Neue Konfiguration "${t.name}" erstellt ✅`)}updateConfig(){const e=this.currentConfig;this.configs[e]=this._makeConfigObject(),this.renderConfigList(),this.updateSaveButtons()}deleteConfig(e){const t=this.configs[e].name;if(confirm(`Willst du "${t}" wirklich löschen?`)){if(this.configs.splice(e,1),this.configs.length>0)if(e===this.currentConfig){const t=Math.min(e,this.configs.length-1);this.loadConfig(t)}else e<this.currentConfig?(this.currentConfig--,this.renderConfigList()):this.renderConfigList();else this.createNewConfig();this.updateSaveButtons()}}createNewConfig(){this.currentConfig=null,this.resetGridToDefault(),this.renderConfigList(),this.updateSaveButtons()}_makeConfigObject(){let e;if(null!==this.currentConfig)e=this.configs[this.currentConfig].name;else{let t=1;for(;this.configs.some(e=>e.name===`Konfiguration ${t}`);)t++;e=`Konfiguration ${t}`}return{name:e,selection:this.selection.map(e=>[...e]),orientation:this.orV.checked?"vertical":"horizontal",incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10)}}renderConfigList(){this.configListEl.innerHTML="",this.configs.forEach((e,t)=>{const i=document.createElement("div");i.className="config-item"+(t===this.currentConfig?" active":""),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.gap="0.5rem";const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="0.25rem",s.style.flex="1";const o=document.createElement("span");o.textContent=e.name,o.style.cursor="pointer",o.addEventListener("click",()=>{null!==this.currentConfig&&this.currentConfig!==t&&this.updateConfig(),this.currentConfig!==t&&(this.loadConfig(t),this.showToast("Konfiguration geladen",1e3))});const n=document.createElement("button");n.innerHTML="✎",n.title="Namen bearbeiten",Object.assign(n.style,{border:"none",background:"none",cursor:"pointer",fontSize:"1rem",color:"#fff",padding:"0",marginLeft:"0.5rem",lineHeight:"1"}),n.addEventListener("click",t=>{t.stopPropagation();const i=document.createElement("input");i.type="text",i.value=e.name,i.style.flex="1",i.addEventListener("keydown",t=>{"Enter"===t.key&&(e.name=i.value.trim()||e.name,this.renderConfigList())}),i.addEventListener("blur",()=>{e.name=i.value.trim()||e.name,this.renderConfigList()}),s.replaceChild(i,o),i.focus()});let r=null;this.configs.length>1&&(r=document.createElement("button"),r.innerHTML="🗑️",r.title="Konfiguration löschen",Object.assign(r.style,{background:"none",border:"none",cursor:"pointer",fontSize:"1rem",color:"#fff",padding:"0",marginLeft:"0.5rem",lineHeight:"1"}),r.addEventListener("click",e=>{e.stopPropagation(),this.deleteConfig(t)}));const a=document.createElement("button");a.textContent="🔗",a.title="Später weitermachen - Link kopieren",Object.assign(a.style,{background:"none",border:"none",cursor:"pointer",color:"inherit"}),a.addEventListener("click",e=>{e.stopPropagation(),this.generateContinueLink()}),s.appendChild(o),s.appendChild(n),i.appendChild(s),r&&i.appendChild(r),i.appendChild(a),this.configListEl.appendChild(i)})}updateSummaryOnChange(){this.renderProductSummary()}async renderProductSummary(){const t=this.configs.map((e,t)=>t===this.currentConfig?{selection:this.selection.map(e=>[...e]),rows:this.rows,cols:this.cols,cellWidth:parseInt(this.wIn.value,10)||179,cellHeight:parseInt(this.hIn.value,10)||113,orientation:this.orV.checked?"vertical":"horizontal",incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked}:{selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth,cellHeight:e.cellHeight,orientation:e.orientation,incM:e.incM,mc4:e.mc4,solarkabel:e.solarkabel,holz:e.holz});null===this.currentConfig&&t.push({selection:this.selection.map(e=>[...e]),rows:this.rows,cols:this.cols,cellWidth:parseInt(this.wIn.value,10)||179,cellHeight:parseInt(this.hIn.value,10)||113,orientation:this.orV.checked?"vertical":"horizontal",incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked});const s={};try{(await Promise.all(t.map(async e=>{const t={selection:e.selection,rows:e.rows,cols:e.cols,cellWidth:e.cellWidth,cellHeight:e.cellHeight,orientation:e.orientation};let s;try{s=await i.calculate("calculateParts",t)}catch(e){s=this.calculatePartsDirectly(t)}if(e.incM||delete s.Solarmodul,e.mc4){const t=e.selection.flat().filter(e=>e).length;s.MC4_Stecker=Math.ceil(t/30)}return e.solarkabel&&(s.Solarkabel=1),e.holz&&(s.Holzunterleger=(s.Schiene_240_cm||0)+(s.Schiene_360_cm||0)),s}))).forEach(e=>{Object.entries(e).forEach(([e,t])=>{s[e]=(s[e]||0)+t})})}catch(e){console.error("Error in renderProductSummary:",e)}const o=Object.entries(s).filter(([,e])=>e>0),r=Math.ceil(o.length/4);let a=0,l="";for(let t=0;t<r;t++){l+=`<div class="summary-column">${o.slice(4*t,4*(t+1)).map(([t,i])=>{const s=Math.ceil(i/e[t]),o=s*n(t);return a+=o,`<div class="produkt-item">\n        \t\t<span>${s}×</span>\n        \t\t<img src="${this.mapImage(t)}" alt="${t}" onerror="this.src='https://via.placeholder.com/32?text=${encodeURIComponent(t)}'">\n        \t\t<span>${t.replace(/_/g," ")} (${i})</span>\n        \t\t<span style="margin-left:auto; font-weight:bold;">${o.toFixed(2)} €</span>\n      \t\t</div>`}).join("")}</div>`}l+=`<div class="summary-total">Gesamtpreis: ${a.toFixed(2)} €</div>`,this.summaryList.innerHTML=l,this.summaryHolder.style.display=o.length?"block":"none",this.summaryList.style.display=o.length?"flex":"none"}calculatePartsDirectly(e){const{selection:t,rows:i,cols:s,cellWidth:o,cellHeight:n,orientation:r}=e,a={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let l=0;l<s;l++)t[e]?.[l]?i++:i&&(this.processGroupDirectly(i,a,o,n,r),i=0);i&&this.processGroupDirectly(i,a,o,n,r)}return a}processGroupDirectly(e,t,i,s,o){const n=e*("vertical"===o?s:i),r=Math.floor(n/360),a=n-360*r,l=[{cnt360:r,cnt240:Math.ceil(a/240)},{cnt360:Math.ceil(n/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(n/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-n})),c=Math.min(...l.map(e=>e.rails)),h=l.filter(e=>e.rails===c).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:d,cnt240:u}=h;t.Schiene_360_cm+=2*d,t.Schiene_240_cm+=2*u,t.Schienenverbinder+=4*(d+u-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=t.Endklemmen,t.Solarmodul+=e,t.Schrauben+=2*t.Dachhaken}generateContinueLink(){null!==this.currentConfig&&this.updateConfig();const e=JSON.stringify(this.configs),t=btoa(encodeURIComponent(e)),i=`${window.location.origin}${window.location.pathname}?configData=${t}`;navigator.clipboard.writeText(i),this.showToast("Später-weitermachen Link kopiert ✅",2e3)}generateHiddenCartForms(){const e=document.querySelectorAll('form[data-node-type="commerce-add-to-cart-form"]');this.webflowFormMap={},e.forEach(e=>{const t=e.getAttribute("data-commerce-product-id"),i=e.getAttribute("data-commerce-sku-id"),o=Object.keys(s).find(e=>s[e].productId===t||s[e].variantId===i);o&&(this.webflowFormMap[o]=e)}),this.hideWebflowForms()}hideWebflowForms(){Object.values(this.webflowFormMap).forEach(e=>{e&&e.style&&(e.style.cssText="\n            position: absolute !important;\n            left: -9999px !important;\n            top: -9999px !important;\n            width: 1px !important;\n            height: 1px !important;\n            overflow: hidden !important;\n            clip: rect(0, 0, 0, 0) !important;\n            white-space: nowrap !important;\n            border: 0 !important;\n            margin: 0 !important;\n            padding: 0 !important;\n            visibility: hidden !important;\n          ")})}addProductToCart(e,t,i=!1){if(!s[e])return;const o=this.webflowFormMap[e];if(!o)return;const n=o.querySelector('input[name="commerce-add-to-cart-quantity-input"]');n&&(n.value=t);const r=o.querySelector('input[data-node-type="commerce-add-to-cart-button"]');r&&this.clickWebflowButtonSafely(o,r,e,t,i)}clickWebflowButtonSafely(e,t,i,s,o){const n=e.querySelector('input[name="commerce-add-to-cart-quantity-input"]');if(n&&(n.value=s),o)return void t.click();const r=document.createElement("iframe");r.name="safe-cart-"+Date.now()+Math.random(),r.style.cssText="\n        position: absolute;\n        left: -10000px;\n        top: -10000px;\n        width: 1px;\n        height: 1px;\n        border: none;\n        visibility: hidden;\n        opacity: 0;\n      ",document.body.appendChild(r);const a=e.target||"";e.target=r.name;let l=!1;r.onload=()=>{l||(l=!0,e.target=a,n&&(n.value=1),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},1e3))},r.onerror=()=>{e.target=a,document.body.contains(r)&&document.body.removeChild(r)},t.click()}addPartsListToCart(t){const i=Object.entries(t).filter(([e,t])=>t>0);if(!i.length)return;this.hideCartContainer();const s=i.slice(0,-1),o=i[i.length-1];s.forEach(([t,i])=>{const s=Math.ceil(i/e[t]);this.addProductToCart(t,s,!1)}),setTimeout(()=>{this.showCartContainer();const[t,i]=o,s=Math.ceil(i/e[t]);this.addProductToCart(t,s,!0)},500)}hideCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(e.style.display="none")}showCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(e.style.display="")}async addCurrentToCart(){try{const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked),t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return void this.showToast("Keine Produkte ausgewählt ⚠️",2e3);this.sendCurrentConfigToWebhook().then(e=>{}),this.addPartsListToCart(e),this.showToast(`${t} Produkte werden zum Warenkorb hinzugefügt...`,3e3),this.pdfGenerator&&this.pdfGenerator.isAvailable()&&setTimeout(()=>{this.pdfGenerator.generatePDF("current")},500)}catch(e){this.showToast("Fehler beim Berechnen der Produkte ❌",2e3)}}async addAllToCart(){try{null!==this.currentConfig&&this.updateConfig();const e=this.createConfigSnapshot();this.pdfGenerator&&this.pdfGenerator.isAvailable()&&(this.showToast("PDF wird erstellt...",2e3),await this.pdfGenerator.generatePDFFromSnapshot(e),this.showToast("PDF erfolgreich erstellt ✅",1500));const t=await Promise.all(this.configs.map(async(e,t)=>t===this.currentConfig?await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked):await this._buildPartsFor(e.selection,e.incM,e.mc4,e.solarkabel,e.holz)));if(null===this.currentConfig&&0===this.configs.length){const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked);t.push(e)}const i={};t.forEach(e=>{Object.entries(e).forEach(([e,t])=>{i[e]=(i[e]||0)+t})});const s=Object.values(i).reduce((e,t)=>e+t,0);if(0===s)return void this.showToast("Keine Konfigurationen vorhanden ⚠️",2e3);await this.sendAllConfigsToWebhook();this.addPartsListToCart(i),this.showToast(`${s} Produkte aus allen Konfigurationen werden hinzugefügt...`,3e3)}catch(e){console.error("Fehler in addAllToCart:",e),this.showToast("Fehler beim Berechnen der Konfigurationen ❌",2e3)}}async _buildPartsFor(e,t,i,s,o){const n=this.selection.map(e=>[...e]);try{this.selection=e;let n=await this.calculateParts();if(t||delete n.Solarmodul,i){const t=e.flat().filter(e=>e).length;n.MC4_Stecker=Math.ceil(t/30)}return s&&(n.Solarkabel=1),o&&(n.Holzunterleger=(n.Schiene_240_cm||0)+(n.Schiene_360_cm||0)),n}finally{this.selection=n}}_buildCartItems(t){return Object.entries(t).map(([t,i])=>{const o=Math.ceil(i/e[t]),n=s[t];return!n||o<=0?null:{productId:n.productId,variantId:n.variantId,quantity:o}}).filter(Boolean)}getCurrentConfigData(){return{name:null!==this.currentConfig&&this.configs[this.currentConfig]?this.configs[this.currentConfig].name:"Aktuelle Konfiguration",cols:this.cols,rows:this.rows,selection:this.selection.map(e=>[...e]),orientation:this.orV.checked?"vertical":"horizontal",includeModules:this.incM.checked,mc4:this.mc4.checked,cable:this.solarkabel.checked,wood:this.holz.checked}}createConfigSnapshot(){null!==this.currentConfig&&this.updateConfig();const e={timestamp:(new Date).toISOString(),totalConfigs:this.configs.length,currentConfigIndex:this.currentConfig,configs:[]};for(let t=0;t<this.configs.length;t++){const i=this.configs[t];let s,o,n,r,a,l,c,h,d,u;t===this.currentConfig?(s=this.selection?this.selection.map(e=>[...e]):[],o=this.cols,n=this.rows,r=this.orV.checked?"vertical":"horizontal",a=this.incM.checked,l=this.mc4.checked,c=this.solarkabel.checked,h=this.holz.checked,d=parseInt(this.wIn.value,10),u=parseInt(this.hIn.value,10)):(s=i.selection?i.selection.map(e=>[...e]):[],o=i.cols,n=i.rows,r=i.orientation,a=i.incM,l=i.mc4,c=i.solarkabel,h=i.holz,d=i.cellWidth,u=i.cellHeight);const m=Array.from({length:n||5},(e,t)=>Array.from({length:o||5},(e,i)=>!!(s[t]&&Array.isArray(s[t])&&i<s[t].length)&&!0===s[t][i])),g={name:i.name||`Konfiguration ${t+1}`,index:t,cols:o||5,rows:n||5,selection:m,cellWidth:d||179,cellHeight:u||113,orientation:r||"horizontal",includeModules:!1!==a,mc4:l||!1,cable:c||!1,wood:h||!1,selectedCells:m.flat().filter(e=>e).length,totalCells:(o||5)*(n||5)};e.configs.push(g)}return e}getAllConfigsData(){return this.createConfigSnapshot().configs}}document.addEventListener("DOMContentLoaded",()=>{const e=new c;e.generateHiddenCartForms(),window.solarGrid=e}),window.addEventListener("beforeunload",()=>{i&&i.destroy()})}();