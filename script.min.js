!function(){try{const e=function(){};"undefined"!=typeof console&&(console.log=e,console.info=e,console.debug=e)}catch(e){}class e{constructor(){this.cacheKey="solarTool_continueCache",this.cacheTimeout=864e5,this.debounceTimeout=null,this.debounceDelay=500}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return console.warn("localStorage nicht verfügbar:",e),!1}}saveData(e){this.isLocalStorageAvailable()?(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{try{const t={...e,timestamp:Date.now(),version:"1.0"};localStorage.setItem(this.cacheKey,JSON.stringify(t)),console.log("Cache gespeichert:",(new Date).toLocaleString())}catch(e){console.error("Fehler beim Speichern des Caches:",e)}},this.debounceDelay)):console.warn("localStorage nicht verfügbar - Cache wird nicht gespeichert")}loadData(){if(!this.isLocalStorageAvailable())return console.warn("localStorage nicht verfügbar - Cache wird nicht geladen"),null;try{const e=localStorage.getItem(this.cacheKey);if(!e)return console.log("Kein Cache gefunden"),null;const t=JSON.parse(e);return Date.now()-t.timestamp>this.cacheTimeout?(console.log("Cache ist abgelaufen (24h) - wird gelöscht"),this.clearCache(),null):(console.log("Cache geladen:",(new Date).toLocaleString()),t)}catch(e){return console.error("Fehler beim Laden des Caches:",e),this.clearCache(),null}}clearCache(){try{localStorage.removeItem(this.cacheKey),console.log("Cache gelöscht")}catch(e){console.error("Fehler beim Löschen des Caches:",e)}}isCacheValid(){return null!==this.loadData()}}const t={Endklemmen:20,Schrauben:50,Dachhaken:20,Mittelklemmen:20,Endkappen:50,Schienenverbinder:10,Schiene_240_cm:1,Schiene_360_cm:1,Solarmodul:1,UlicaSolarBlackJadeFlow:1,SolarmodulPalette:36,UlicaSolarBlackJadeFlowPalette:36,MC4_Stecker:50,Solarkabel:1,Holzunterleger:50,Erdungsklemme:1,Quetschkabelschuhe:1,Erdungsband:1,Tellerkopfschraube:100,HuaweiOpti:1,BRCOpti:1},i={Solarmodul:59.7,UlicaSolarBlackJadeFlow:67.9,SolarmodulPalette:2012.4,UlicaSolarBlackJadeFlowPalette:2264.4,Endklemmen:49.5,Schrauben:22,Dachhaken:69,Mittelklemmen:49.5,Endkappen:7,Schienenverbinder:65,Schiene_240_cm:11.99,Schiene_360_cm:17.49,MC4_Stecker:39.5,Solarkabel:86.9,Holzunterleger:17.5,Erdungsklemme:25,Quetschkabelschuhe:18.5,Erdungsband:8.7,Tellerkopfschraube:26,HuaweiOpti:39.68,BRCOpti:38.53},s={Schiene_240_cm:[{minPieces:40,pricePerPiece:11.59},{minPieces:80,pricePerPiece:11.25}],Schiene_360_cm:[],Mittelklemmen:[{minPieces:300,pricePerPiece:.95},{minPieces:1200,pricePerPiece:.79}],Endklemmen:[{minPieces:300,pricePerPiece:.95},{minPieces:1200,pricePerPiece:.79}],Endkappen:[{minPieces:300,pricePerPiece:.13},{minPieces:1200,pricePerPiece:.12}],Dachhaken:[{minPieces:100,pricePerPiece:3.42},{minPieces:720,pricePerPiece:3.39}],Schienenverbinder:[{minPieces:200,pricePerPiece:1.19},{minPieces:1e3,pricePerPiece:.99}],Schrauben:[{minPieces:1e3,pricePerPiece:.19},{minPieces:5e3,pricePerPiece:.18}],Tellerkopfschraube:[{minPieces:1e3,pricePerPiece:.25},{minPieces:5e3,pricePerPiece:.24}],Solarmodul:[{minPieces:36,pricePerPiece:55.9},{minPieces:360,pricePerPiece:54.9}],UlicaSolarBlackJadeFlow:[{minPieces:36,pricePerPiece:62.9},{minPieces:360,pricePerPiece:61.9}],MC4_Stecker:[{minPieces:1e3,pricePerPiece:.69},{minPieces:3e3,pricePerPiece:.65}],Solarkabel:[{minPieces:10,pricePerPiece:83.9},{minPieces:30,pricePerPiece:79.9}],Quetschkabelschuhe:[{minPieces:5,packPrice:17.9},{minPieces:20,packPrice:17.5}],Holzunterleger:[{minPieces:500,pricePerPiece:.29},{minPieces:2e3,pricePerPiece:.28}]},o=new Set([]);function n(){return"private"===function(){try{const e=localStorage.getItem("solarTool_customerType");if(!e)return null;const t=JSON.parse(e);return t&&t.type?"number"==typeof t.expiresAt&&Date.now()>t.expiresAt?(localStorage.removeItem("solarTool_customerType"),null):"private"===t.type?"private":"business":null}catch(e){return null}}()}function r(e){return Number.isFinite(e),e}const l={Solarmodul:{productId:"68c7ec7571df9723b8ef5050",variantId:"68c7ec7e71df9723b8ef53cd"},UlicaSolarBlackJadeFlow:{productId:"68c7ef7fbeeaadb13262a062",variantId:"68c7ef7ff397fcf9d6d7571e"},SolarmodulPalette:{productId:"68c7ec7471df9723b8ef5008",variantId:"68c7ec7c71df9723b8ef5160"},UlicaSolarBlackJadeFlowPalette:{productId:"68c7ec7471df9723b8ef5006",variantId:"68c7ec7d71df9723b8ef5187"},Quetschkabelschuhe:{productId:"68c7ec7471df9723b8ef502d",variantId:"68c7ec7c71df9723b8ef514b"},Solarkabel:{productId:"68c7ec7471df9723b8ef5031",variantId:"68c7ec7d71df9723b8ef5205"},Erdungsband:{productId:"68c7ec7471df9723b8ef5033",variantId:"68c7ec7c71df9723b8ef5159"},Endkappen:{productId:"68c7ec7471df9723b8ef5041",variantId:"68c7ec7e71df9723b8ef533e"},Mittelklemmen:{productId:"68c7ec7471df9723b8ef5043",variantId:"68c7ec7e71df9723b8ef53e0"},Dachhaken:{productId:"68c7ec7471df9723b8ef5045",variantId:"68c7ec7f71df9723b8ef54f9"},Schiene_360_cm:{productId:"68c7ec7471df9723b8ef5047",variantId:"68c7ec7e71df9723b8ef53d6"},Schienenverbinder:{productId:"68c7ec7471df9723b8ef5049",variantId:"68c7ec7e71df9723b8ef533b"},Schiene_240_cm:{productId:"68c7ec7471df9723b8ef504b",variantId:"68c7ec7e71df9723b8ef5387"},MC4_Stecker:{productId:"68c7ec7671df9723b8ef506e",variantId:"68c7ec7d71df9723b8ef5230"},Tellerkopfschraube:{productId:"68c7ec7671df9723b8ef5072",variantId:"68c7ec7f71df9723b8ef544a"},Schrauben:{productId:"68c7ec7771df9723b8ef5085",variantId:"68c7ec7f71df9723b8ef5406"},Endklemmen:{productId:"68c7ec7771df9723b8ef5087",variantId:"68c7ec7f71df9723b8ef542a"},Holzunterleger:{productId:"68c7f04a8fd58d9f974d6eb6",variantId:"68c7f04bb950895d194203e00"},HuaweiOpti:{productId:"68c7ec7471df9723b8ef501e",variantId:"68c7ec7e71df9723b8ef5335"},BRCOpti:{productId:"68c7ec7471df9723b8ef501a",variantId:"68c7ec7b71df9723b8ef510b"}};function a(e,i){const n=t[e]||1,l=g(e)||0;if("SolarmodulPalette"===e||"UlicaSolarBlackJadeFlowPalette"===e)return r(l);if(!o.has(e))return r(l);const a=s[e];if(!a||!Array.isArray(a)||0===a.length)return r(l);const c=Number(i)||0;let d=null;for(const e of a)c>=e.minPieces&&(!d||e.minPieces>d.minPieces)&&(d=e);return d?"number"==typeof d.packPrice?r(d.packPrice):"number"==typeof d.pricePerPiece?r(d.pricePerPiece*n):r(l):r(l)}const c={Solarmodul:{productId:"685003af0e41d945fb0198d8",variantId:"685003af4a8e88cb58c89d46"},UlicaSolarBlackJadeFlow:{productId:"689455ed543f0cbb26ba54e9",variantId:"689455ed7d7ddfd326d5dbf9"},SolarmodulPalette:{productId:"68b999a74abecff30536dee0",variantId:"68b999a873f9b0df7954ed8b"},UlicaSolarBlackJadeFlowPalette:{productId:"68b99932fb8af7a115bb2680",variantId:"68b999339e25d980ba33928d"},Endklemmen:{productId:"6853c34fe99f6e3d878db38b",variantId:"6853c350edab8f13fc18c1b9"},Schrauben:{productId:"6853c2782b14f4486dd26f52",variantId:"6853c2798bf6755ddde26a8e"},Dachhaken:{productId:"6853c1d0f350bf620389664c",variantId:"6853c1d04d7c01769211b8d6"},Mittelklemmen:{productId:"68531088654d1468dca962c",variantId:"6853c1084c04541622ba3e26"},Endkappen:{productId:"6853be0895a5a578324f9682",variantId:"6853be0805e96b5a16c705cd"},Schienenverbinder:{productId:"6853c2018bf6755ddde216a8",variantId:"6853c202c488ee61eb51a3dc"},Schiene_240_cm:{productId:"6853bd882f00db0c9a42d653",variantId:"6853bd88c4173dbe72bab10f"},Schiene_360_cm:{productId:"6853bc8f3f6abf360c605142",variantId:"6853bc902f00db0c9a423d97"},MC4_Stecker:{productId:"687fcc9f66078f7098826ccc",variantId:"687fcca02c6537b9a9493fa7"},Solarkabel:{productId:"687fd60dc599f5e95d783f99",variantId:"687fd60dd3a8ae1f00a6d6d1"},Holzunterleger:{productId:"688780821dbbf26153a85117",variantId:"688780ad795c82663cd6e69b"},Erdungsklemme:{productId:"6887e8aaa6ca43c15254d224",variantId:"6887e8abb439562cbc88db5d"},Quetschkabelschuhe:{productId:"68876153200e1a5e28a1b709",variantId:"6887615388988b2ccda11067"},Erdungsband:{productId:"688760e01c9c7973ee287386",variantId:"688760e0835845affc493354"},Tellerkopfschraube:{productId:"688760a7124e867cf2b20051",variantId:"688760a7f246d23f70575fb1"},HuaweiOpti:{productId:"68af2934de0a7fe5d316efbc",variantId:"68af2934c230bc1eaa972585"},BRCOpti:{productId:"68b1e02629cec71ebfc12f0e",variantId:"68b1e02ca05a6b4aca721dc8"}},d={Solarmodul:"Ulica Solar Black Jade-Flow 450 W",UlicaSolarBlackJadeFlow:"Ulica Solar Black Jade-Flow 500 W",SolarmodulPalette:"36x Ulica Solar Black Jade-Flow 450 W - Palette",UlicaSolarBlackJadeFlowPalette:"36x Ulica Solar Black Jade-Flow 500 W  - Palette",Endklemmen:"Endklemmen - 20 Stück",Mittelklemmen:"Mittelklemmen - 20 Stück",Endkappen:"Endkappen - 50 Stück",Dachhaken:"Dachhaken 3-fach verstellbar - 20 Stück",Schienenverbinder:"Schienenverbinder - 10 Stück",Schiene_360_cm:"Schiene 360 cm",Schiene_240_cm:"Schiene 240cm",MC4_Stecker:"MC4 Stecker - 50 Steckerpaare",Schrauben:"Schraube M10x25 - 50 Stück inkl. Muttern",Tellerkopfschraube:"Tellerkopfschraube 8x100 - 100 Stück",Quetschkabelschuhe:"Ringkabelschuhe - 100 Stück",Erdungsband:"Erdungsband - 6M",Solarkabel:"Solarkabel 100M",Holzunterleger:"Unterlegholz für Dachhacken - 50 Stück",HuaweiOpti:"Huawei Smart PV Optimierer 600W",BRCOpti:"BRC M600M Optimierer"},h={Solarmodul:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",UlicaSolarBlackJadeFlow:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",SolarmodulPalette:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",UlicaSolarBlackJadeFlowPalette:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Endklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c316b21cb7d04ba2ed22_DSC04815-min.jpg",Schrauben:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg",Dachhaken:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c1c8a2835b7879f46811_DSC04760-min.jpg",Mittelklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c0d0c2d922d926976bd4_DSC04810-min.jpg",Endkappen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bdfbe7cffc653f6a4605_DSC04788-min.jpg",Schienenverbinder:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c21f0c39e927fce0db3b_DSC04780-min.jpg",Schiene_240_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bce018164af4b4a187f1_DSC04825-min.jpg",Schiene_360_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bcd5726d1d33d4b86ba4_DSC04824-min.jpg",MC4_Stecker:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fcdab153f840ea15b5e7b_iStock-2186771695.jpg",Solarkabel:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fd566bdbb6de2e5f362f0_DSC04851.jpg",Holzunterleger:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Erdungsklemme:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Quetschkabelschuhe:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6887614c64676f0b0c8d5037_Kabelschuh%20Platzhalter.jpg",Erdungsband:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Tellerkopfschraube:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg"};const u=new class{constructor(){this.worker=null,this.pendingCalculations=new Map,this.calculationId=0,this.isWorkerReady=!1,this.initWorker()}initWorker(){try{this.worker=new Worker("./calculation-worker.js"),this.worker.onmessage=e=>{const{type:t,id:i,data:s,error:o}=e.data;if("ready"!==t){if("result"===t&&this.pendingCalculations.has(i)){const{resolve:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(s)}if("error"===t&&this.pendingCalculations.has(i)){const{reject:e}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),e(new Error(o.message))}"debug"===t&&console.log(...s)}else this.isWorkerReady=!0},this.worker.onerror=e=>{this.isWorkerReady=!1}}catch(e){this.isWorkerReady=!1}}async calculate(e,t){return this.isWorkerReady&&this.worker?new Promise((i,s)=>{const o=++this.calculationId;this.pendingCalculations.set(o,{resolve:i,reject:s}),setTimeout(()=>{this.pendingCalculations.has(o)&&(this.pendingCalculations.delete(o),s(new Error("Calculation timeout")))},1e4),this.worker.postMessage({type:e,data:t,id:o})}):this.calculateSync(e,t)}calculateSync(e,t){switch(e){case"calculateParts":return this.calculatePartsSync(t);case"calculateExtendedParts":return this.calculateExtendedPartsSync(t);default:throw new Error(`Unsupported sync calculation: ${e}`)}}calculatePartsSync(e){try{const{selection:t,rows:i,cols:s,cellWidth:o,cellHeight:n,orientation:r,options:l={}}=e,a={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let c=0;c<s;c++)t[e]?.[c]?i++:i&&(this.processGroupSync(i,a,o,n,r,l),i=0);i&&this.processGroupSync(i,a,o,n,r,l)}return a}catch(e){return console.error("calculatePartsSync error:",e),{Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0}}}processGroupSync(e,t,i,s,o,n={}){const r=e*("vertical"===o?s:i),l=Math.floor(r/360),a=r-360*l,c=[{cnt360:l,cnt240:Math.ceil(a/240)},{cnt360:Math.ceil(r/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(r/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-r})),d=Math.min(...c.map(e=>e.rails)),h=c.filter(e=>e.rails===d).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:u,cnt240:m}=h;t.Schiene_360_cm+=2*u,t.Schiene_240_cm+=2*m,t.Schienenverbinder+=4*(u+m-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,!0===n.ulicaModule&&(t.UlicaSolarBlackJadeFlow+=e),t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}calculateExtendedPartsSync(e){let i=this.calculatePartsSync(e);const{options:s}=e;if(s.includeModules||delete i.Solarmodul,!0!==s.ulicaModule&&delete i.UlicaSolarBlackJadeFlow,s.mc4Connectors){const s=e.selection.flat().filter(e=>e).length,o=t.MC4_Stecker||50,n=Math.ceil(s/30);i.MC4_Stecker=n*o}return s.solarkabel&&(i.Solarkabel=1),s.woodUnderlay&&(i.Holzunterleger=1),s.erdungsband,i}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingCalculations.clear(),this.isWorkerReady=!1}};const m=new class{constructor(){this.cache=new Map,this.lastUpdate=null,this.cacheKey="solarTool_priceCache",this.timestampKey="solarTool_priceTimestamp",this.cacheDuration=864e5,this.isUpdating=!1,this.loadFromStorage(),this.scheduleNextUpdate()}loadFromStorage(){try{const e=localStorage.getItem(this.cacheKey),t=localStorage.getItem(this.timestampKey);if(e&&t){const i=JSON.parse(e);if(this.lastUpdate=parseInt(t,10),Date.now()-this.lastUpdate<this.cacheDuration)return void(this.cache=new Map(Object.entries(i)))}}catch(e){}this.updatePricesFromHTML()}saveToStorage(){try{const e=Object.fromEntries(this.cache);localStorage.setItem(this.cacheKey,JSON.stringify(e)),localStorage.setItem(this.timestampKey,this.lastUpdate.toString())}catch(e){}}async updatePricesFromHTML(){if(!this.isUpdating){this.isUpdating=!0;try{Array.from(new Set([...Object.keys(i||{}),...Object.keys(c||{}),...Object.keys(l||{})])).forEach(e=>{const t=i[e];"number"==typeof t&&t>0&&this.cache.set(e,t)}),this.lastUpdate=Date.now(),this.saveToStorage()}catch(e){}finally{this.isUpdating=!1}}}async getPriceFromHTMLAsync(e){return new Promise(t=>{setTimeout(()=>{let i=this.extractPriceFromHTML(e);if(!i||0===i)try{const t=!(!l||!l[e])?c:l;t&&t[e]&&(i=this.extractPriceFromHTML(e))}catch(e){}t(i)},0)})}extractPriceFromHTML(e){return i[e]||0}getPrice(e){if(this.cache.has(e))return this.cache.get(e);return i[e]||0}scheduleNextUpdate(){const e=this.lastUpdate?this.lastUpdate+this.cacheDuration:Date.now()+this.cacheDuration,t=Math.max(0,e-Date.now());setTimeout(()=>{this.updatePricesFromHTML(),this.scheduleNextUpdate()},t)}forceUpdate(){return this.updatePricesFromHTML()}};function g(e){return m.getPrice(e)}window.debugPriceCache={forceUpdate:()=>m.forceUpdate(),getCache:()=>Object.fromEntries(m.cache),getCacheAge:()=>{if(!m.lastUpdate)return"Nie aktualisiert";const e=Date.now()-m.lastUpdate;return`${Math.round(e/36e5)} Stunden alt`},clearCache:()=>{localStorage.removeItem(m.cacheKey),localStorage.removeItem(m.timestampKey),m.cache.clear(),m.lastUpdate=null},testQuetschkabelschuhe:()=>(console.log("Testing Quetschkabelschuhe price..."),console.log("PRICE_MAP:",i.Quetschkabelschuhe),console.log("Cache value:",m.getPrice("Quetschkabelschuhe")),console.log("Direct fallback:",i.Quetschkabelschuhe||0),{priceMap:i.Quetschkabelschuhe,cacheValue:m.getPrice("Quetschkabelschuhe"),fallback:i.Quetschkabelschuhe||0}),resetAndReload:()=>{console.log("Resetting price cache..."),window.debugPriceCache.clearCache(),m.loadFromStorage(),m.forceUpdate(),console.log("Cache reset complete")}};class p{constructor(e){this.solarGrid=e,this.jsPDF=window.jspdf?.jsPDF,this.html2canvas=window.html2canvas,this.html2pdf=window.html2pdf,this.companyLogoUrl="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/688f3fff157b70cefcaa97df_Schneider%20logo.png",this.headerLogoBlueUrl="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6893249274128869974e58ec_schneider%20logo%20png.png"}isAvailable(){return!(!this.jsPDF||!this.html2canvas)}async generatePDFFromSnapshot(e){if(!this.jsPDF||!this.html2canvas)return console.error("jsPDF/html2canvas nicht verfügbar"),void this.solarGrid.showToast("PDF-Generierung nicht verfügbar",3e3);if(e?.configs?.length)try{await this.renderSnapshotIntoPdfTemplate(e);const t=document.getElementById("pdf-root");if(!t)throw new Error("#pdf-root nicht gefunden");const i=t.getAttribute("style")||"";t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.opacity="0.01",t.style.pointerEvents="none",t.style.zIndex="9999",t.style.background="#ffffff",await function(e){const t=Array.from(e.querySelectorAll("img"));return 0===t.length?Promise.resolve():Promise.all(t.map(e=>new Promise(t=>{if(e.complete&&e.naturalWidth>0)return t();const i=()=>t();e.addEventListener("load",i,{once:!0}),e.addEventListener("error",i,{once:!0})})))}(t),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,30));const s=Array.from(t.querySelectorAll(".pdf-page"));if(0===s.length)throw new Error("Keine .pdf-page Elemente");console.log("[PDF] capturing pages:",s.length);const o=new this.jsPDF({unit:"px",format:[794,1123],orientation:"portrait"});for(let e=0;e<s.length;e++){const t=s[e];t.style.width="794px",t.style.height="1123px",t.style.boxSizing="border-box";const i=await this.html2canvas(t,{scale:2,backgroundColor:"#ffffff",useCORS:!0,allowTaint:!0,logging:!0});console.log("[PDF] canvas created",{w:i.width,h:i.height});const n=i.toDataURL("image/jpeg",.98);e>0&&o.addPage(),o.addImage(n,"JPEG",0,0,794,1123)}const n=this.generateFileName(e.configs);o.save(n),t.setAttribute("style",i)}catch(e){console.error("PDF-Erstellung fehlgeschlagen:",e),this.solarGrid.showToast("PDF-Erstellung fehlgeschlagen",3e3)}else this.solarGrid.showToast("Keine Konfiguration zum Exportieren",3e3)}async renderSnapshotIntoPdfTemplate(e){const t=document.getElementById("pdf-root");if(!t)return;t.innerHTML="";const i=(new Date).toLocaleDateString("de-DE");for(let s=0;s<e.configs.length;s++){const o=e.configs[s],r=document.createElement("div");r.className="pdf-page",r.style.width="794px",r.style.minHeight="1123px",r.style.padding="48px 48px 64px 48px",r.style.boxSizing="border-box",r.style.position="relative",r.innerHTML=`\n          <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10mm;">\n            <div>\n              <div style="font-size:18pt; font-weight:700; color:#0e1e34;">${o.name||"Konfiguration"}</div>\n              <div style="font-size:10pt; color:#677; margin-top:2mm;">${i}</div>\n            </div>\n            <div style="display:flex; align-items:center; gap:8px; color:#0e1e34; font-size:10pt;"><img src="${this.headerLogoBlueUrl}" alt="Logo" style="height:12mm; width:auto;"/></div>\n          </header>\n          <section style="border:1px solid #e5e7eb; border-radius:8px; padding:6mm; margin-bottom:8mm;">\n            <div style="font-size:12pt; font-weight:700; color:#0e1e34;">Projekt</div>\n            <div style="font-size:10pt; color:#111; margin-top:2mm; display:flex; justify-content:space-between; gap:6mm;">\n              <div><span style="font-weight:700;">Projekttitel:</span> ${o.name||"Unbenannt"}</div>\n              <div><span style="font-weight:700;">Datum:</span> ${i}</div>\n            </div>\n            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:4mm;">\n              <div>\n                <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                  <div style="width:28mm; color:#0e1e34;">Name:</div>\n                  <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n                <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                  <div style="width:28mm; color:#0e1e34;">Firma:</div>\n                  <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n                <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                  <div style="width:28mm; color:#0e1e34;">Adresse:</div>\n                  <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n                <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                  <div style="width:28mm; color:#0e1e34;">Telefon:</div>\n                  <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n                <div style="display:flex; align-items:flex-end; gap:4mm;">\n                  <div style="width:28mm; color:#0e1e34;">E-Mail:</div>\n                  <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n              </div>\n              <div>\n                <div style="display:flex; align-items:flex-end; gap:4mm; margin-bottom:3mm;">\n                  <div style="flex:0 0 auto; font-weight:700; color:#0e1e34;">Weitere Informationen:</div>\n                  <div style="flex:1; height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n                </div>\n                <div style="height:6mm; border-bottom:1px solid #e5e7eb; margin-bottom:3mm;"></div>\n                <div style="height:6mm; border-bottom:1px solid #e5e7eb; margin-bottom:3mm;"></div>\n                <div style="height:6mm; border-bottom:1px solid #e5e7eb; margin-bottom:3mm;"></div>\n                <div style="height:6mm; border-bottom:1px solid #e5e7eb;"></div>\n              </div>\n            </div>\n          </section>\n          <section style="margin-bottom:8mm;">\n            <div style="font-size:11pt; font-weight:700; color:#0e1e34; margin-bottom:4mm;">Grid-Übersicht</div>\n            <div style="font-size:10pt; color:#111; margin-bottom:4mm;">\n              Grid: ${o.cols} × ${o.rows} Module (${o.selectedCells} ausgewählt) · Orientierung: ${"vertical"===o.orientation?"Vertikal":"Horizontal"}\n            </div>\n            <img class="pdf-grid-image" alt="Grid" style="width:100%; max-width:100%; border-radius:6px; border:1px solid #e5e7eb; box-shadow:0 2px 8px rgba(0,0,0,0.06);" />\n          </section>\n        `;try{const e=await this.captureGridVisualizationFromSnapshot(o);e&&(r.querySelector(".pdf-grid-image").src=e)}catch{}const l=document.createElement("div");l.className="pdf-page",l.style.width="794px",l.style.minHeight="1123px",l.style.padding="48px 48px 64px 48px",l.style.boxSizing="border-box",l.style.position="relative",l.innerHTML=`\n          <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10mm;">\n            <div>\n              <div style="font-size:18pt; font-weight:700; color:#0e1e34;">${o.name||"Konfiguration"}</div>\n              <div style="font-size:10pt; color:#677; margin-top:2mm;">${i}</div>\n            </div>\n            <div style="display:flex; align-items:center; gap:8px; color:#0e1e34; font-size:10pt;"><img src="${this.headerLogoBlueUrl}" alt="Logo" style="height:12mm; width:auto;"/></div>\n          </header>\n          <div style="background:#FFB101; color:#000; border-radius:8px; padding:6mm; font-weight:700; margin-bottom:6mm;">PRODUKT-LISTE</div>\n          <table style="width:100%; border-collapse:collapse; font-size:10pt;">\n            <thead>\n              <tr style="background:#0e1e34; color:#fff;">\n                <th style="text-align:left; padding:3mm 4mm; border-top-left-radius:6px; width:20mm;">Anzahl</th>\n                <th style="text-align:left; padding:3mm 4mm;">Produkt</th>\n                <th style="text-align:right; padding:3mm 4mm; width:35mm;">Benötigte Menge</th>\n                <th style="text-align:right; padding:3mm 4mm; border-top-right-radius:6px; width:30mm;">Preis</th>\n              </tr>\n            </thead>\n            <tbody class="pdf-table-body"></tbody>\n          </table>\n          <div class="pdf-total" style="margin-top:8mm; background:#0e1e34; color:#fff; border-radius:8px; padding:6mm; display:grid; grid-template-columns: 1fr auto; align-items:start; column-gap:6mm;">\n            <div style="font-weight:700; line-height:1; margin:0;">GESAMTPREIS</div>\n            <div class="pdf-total-price" style="font-size:14pt; font-weight:700; line-height:1; margin:0;"></div>\n          </div>\n        `;const a=l.querySelector(".pdf-total-price");if(a&&!n()){const e=l.querySelector(".pdf-total");if(e&&a.parentElement===e){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-end",t.appendChild(a);const i=document.createElement("div");i.textContent="(exkl. MwSt)",i.style.fontSize="9pt",i.style.fontWeight="400",i.style.marginTop="2mm",i.style.opacity="0.9",i.style.whiteSpace="nowrap",t.appendChild(i);const s=e.firstElementChild;s&&s.style&&(s.style.gridColumn="1 / 2",s.style.gridRow="1",s.style.alignSelf="start",s.style.marginTop="-1px"),t.style.gridColumn="2 / 3",t.style.gridRow="1",t.style.justifySelf="end",t.style.alignSelf="start",t.style.marginTop="-1px",e.appendChild(t),setTimeout(()=>{try{const t=i.getBoundingClientRect(),s=Math.ceil(t.height),o=window.getComputedStyle(e);(parseFloat(o.paddingBottom)||0)<s&&(e.style.paddingBottom=s+"px")}catch(e){}},0)}}await this.renderProductsIntoTable(o,l.querySelector(".pdf-table-body"),a,{htmlLayout:!0,excludeAdditionalProducts:!0});const c=l.querySelector(".pdf-table-body");c&&!c.innerHTML.trim()&&(c.innerHTML='<tr><td style="padding:3mm 4mm;" colspan="4">Keine Produkte ausgewählt</td></tr>');let d=null;try{const e=document.getElementById("pdf-root");e&&!l.parentNode&&e.appendChild(l);const t=e=>{const t=e&&e.getBoundingClientRect&&e.getBoundingClientRect().height||1123,i=e.querySelector(".pdf-total");let s=0;try{if(i){const e=i.style.display;"none"===e&&(i.style.display="");const t=i.getBoundingClientRect();s=Math.ceil(t.height)+8,i.style.display=e}}catch(e){s=80}const o=e.querySelector(".pdf-table-body"),n=e.querySelector("thead");e.querySelector(".pdf-total");if(!o||!n)return[e];const r=Array.from(o.querySelectorAll("tr"));if(0===r.length)return[e];const l=()=>{const t=e.cloneNode(!0),i=t.querySelector(".pdf-table-body");i&&(i.innerHTML="");const s=t.querySelector(".pdf-total");return s&&(s.style.display="none"),t},a=l();e.parentNode&&e.parentNode.replaceChild(a,e);const c=[a];let d=0;for(;d<r.length;){const e=c[c.length-1],i=e.querySelector(".pdf-table-body"),o=e.getBoundingClientRect(),n=(i.getBoundingClientRect().top,o.top,t-120-s);for(;d<r.length;){const e=r[d].cloneNode(!0);i.appendChild(e);if(e.getBoundingClientRect().bottom-o.top>n){i.removeChild(e);break}d++}if(d<r.length){const e=l();a.parentNode&&a.parentNode.appendChild(e),c.push(e)}}return c.forEach((e,t)=>{const i=e.querySelector(".pdf-total");i&&(i.style.display=t===c.length-1?"":"none")}),c};d=t(l),d&&d.length&&(l=d[0])}catch(e){console.warn("PDF-Paginierung fehlgeschlagen (fallback auf Einzel-Seite):",e)}const h=()=>{const e=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.height="18mm",e.style.background="#0e1e34",e.style.color="#fff",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="space-between",e.style.padding="0 16mm",e.style.boxSizing="border-box",e.style.fontSize="8pt";const t=document.createElement("div");t.textContent="Schneider Unterkonstruktion - Solar Konfigurator";const i=document.createElement("img");return i.src=this.companyLogoUrl,i.alt="Logo",i.style.height="12mm",i.style.width="auto",e.appendChild(t),e.appendChild(i),e};r.appendChild(h());const u=d&&d.length?d:[l];u.forEach(e=>{Array.from(e.children).some(e=>e.style&&"absolute"===e.style.position&&"0px"===e.style.bottom)||e.appendChild(h()),e.parentNode===t&&t.removeChild(e)}),t.appendChild(r),u.forEach(e=>t.appendChild(e))}try{const i=this.computeAdditionalProductsForSnapshot(e);if(Object.keys(i).filter(e=>i[e]>0).length>0){const i=(new Date).toLocaleDateString("de-DE"),s=document.createElement("div");s.className="pdf-page",s.style.width="794px",s.style.minHeight="1123px",s.style.padding="48px 48px 64px 48px",s.style.boxSizing="border-box",s.style.position="relative",s.innerHTML=`\n            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10mm;">\n              <div>\n                <div style="font-size:18pt; font-weight:700; color:#0e1e34;">Für alle Konfigurationen</div>\n                <div style="font-size:10pt; color:#677; margin-top:2mm;">${i}</div>\n              </div>\n              <div style="display:flex; align-items:center; gap:8px; color:#0e1e34; font-size:10pt;"><img src="${this.headerLogoBlueUrl}" alt="Logo" style="height:12mm; width:auto;"/></div>\n            </header>\n            <div style="background:#FFB101; color:#000; border-radius:8px; padding:6mm; font-weight:700; margin-bottom:6mm;">ZUSATZPRODUKTE</div>\n            <table style="width:100%; border-collapse:collapse; font-size:10pt;">\n              <thead>\n                <tr style="background:#0e1e34; color:#fff;">\n                  <th style="text-align:left; padding:3mm 4mm; border-top-left-radius:6px; width:20mm;">Anzahl</th>\n                  <th style="text-align:left; padding:3mm 4mm;">Produkt</th>\n                  <th style="text-align:right; padding:3mm 4mm; width:35mm;">Benötigte Menge</th>\n                  <th style="text-align:right; padding:3mm 4mm; border-top-right-radius:6px; width:30mm;">Preis</th>\n                </tr>\n              </thead>\n              <tbody class="pdf-additional-table-body"></tbody>\n            </table>\n            <div class="pdf-total" style="margin-top:8mm; background:#0e1e34; color:#fff; border-radius:8px; padding:6mm; display:grid; grid-template-columns: 1fr auto; align-items:start; column-gap:6mm; position:relative;">\n              <div style="font-weight:700; line-height:1; margin:0;">GESAMTPREIS</div>\n              <div class="pdf-additional-total-price" style="font-size:14pt; font-weight:700; line-height:1; margin:0;"></div>\n            </div>\n          `;const o=s.querySelector(".pdf-additional-total-price");if(o&&!n()){const e=s.querySelector(".pdf-total");if(e&&o.parentElement===e){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-end",t.appendChild(o);const i=document.createElement("div");i.textContent="(exkl. MwSt)",i.style.fontSize="9pt",i.style.fontWeight="400",i.style.marginTop="2mm",i.style.opacity="0.9",t.appendChild(i),e.appendChild(t),setTimeout(()=>{try{const s=e.firstElementChild;if(!s)return;const o=s.getBoundingClientRect().top,n=t.getBoundingClientRect().top-o;Math.abs(n)>.5&&(t.style.marginTop=-n+"px");const r=i.getBoundingClientRect(),l=Math.ceil(r.height),a=window.getComputedStyle(e);(parseFloat(a.paddingBottom)||0)<l&&(e.style.paddingBottom=l+"px")}catch(e){}},0)}}await this.renderAdditionalProductsIntoTable(e,s.querySelector(".pdf-additional-table-body"),o);const r=document.createElement("div");r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.bottom="0",r.style.height="18mm",r.style.background="#0e1e34",r.style.color="#fff",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="space-between",r.style.padding="0 16mm",r.style.boxSizing="border-box",r.style.fontSize="8pt";const l=document.createElement("div");l.textContent="Schneider Unterkonstruktion - Solar Konfigurator";const a=document.createElement("img");a.src=this.companyLogoUrl,a.alt="Logo",a.style.height="12mm",a.style.width="auto",r.appendChild(l),r.appendChild(a),s.appendChild(r),t.appendChild(s)}}catch(e){console.warn("Zusatzprodukte-Seite konnte nicht erzeugt werden:",e)}}async renderProductsIntoTable(e,i,s,o={}){const n={...await this.calculatePartsFromSnapshot(e)};try{const t=!0===e.ulicaModule,i=t?"UlicaSolarBlackJadeFlow":"Solarmodul",s=t?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",o=Number(n[i]||0);if(o>0){const e=Math.floor(o/36),t=o%36;e>0&&(n[s]=(n[s]||0)+36*e),n[i]=t}}catch(e){}let r=0;const l=[],c=new Set(["MC4_Stecker","Solarkabel","Holzunterleger","Quetschkabelschuhe"]);for(const[e,i]of Object.entries(n||{})){if(i<=0)continue;if(o.excludeAdditionalProducts&&c.has(e))continue;const s=t[e]||1,n=Math.ceil(i/s),d=n*a(e,i);r+=d,l.push({key:e,value:i,ve:s,packs:n,rowPrice:d})}l.sort((e,t)=>e.key.localeCompare(t.key)),o.htmlLayout?i.innerHTML=l.map(e=>{const t=d[e.key]||e.key.replace(/_/g," ");return`\n            <tr style="border-bottom:1px solid #eee;">\n              <td style="padding:3mm 4mm; width:20mm; font-weight:700;">${e.packs}x</td>\n              <td style="padding:3mm 4mm;">\n                <div style="font-weight:700; font-size:11pt;">${t}</div>\n                <div style="color:#888; font-size:9pt;">${e.ve} Stück</div>\n              </td>\n              <td style="padding:3mm 4mm; text-align:right; width:35mm;">${e.value}</td>\n              <td style="padding:3mm 4mm; text-align:right; width:30mm;">${e.rowPrice.toFixed(2)} €</td>\n            </tr>\n          `}).join(""):i.innerHTML=l.map(e=>`\n          <tr style="border-bottom:1px solid #eee;">\n            <td style="padding:3mm 4mm;">${e.key}</td>\n            <td style="padding:3mm 4mm; text-align:right;">${e.value}</td>\n            <td style="padding:3mm 4mm; text-align:right;">${e.ve}</td>\n            <td style="padding:3mm 4mm; text-align:right;">${e.rowPrice.toFixed(2)} €</td>\n          </tr>\n        `).join(""),s&&(s.textContent=`${r.toFixed(2)} €`)}computeAdditionalProductsForSnapshot(e){try{const t=Array.isArray(e?.configs)?e.configs:[],i=t.some(e=>!0===e.mc4),s=t.some(e=>!0===e.cable||!0===e.solarkabel),o=t.some(e=>!0===e.wood||!0===e.holz),n=t.some(e=>!0===e.quetschkabelschuhe),r=t.reduce((e,t)=>"number"==typeof t.selectedCells?e+t.selectedCells:Array.isArray(t.selection)?e+t.selection.flat().filter(Boolean).length:e,0),l={};return i&&(l.MC4_Stecker=Math.max(1,Math.ceil((r||0)/30))),s&&(l.Solarkabel=1),o&&(l.Holzunterleger=1),n&&(l.Quetschkabelschuhe=1),l}catch(e){return console.warn("computeAdditionalProductsForSnapshot failed:",e),{}}}async renderAdditionalProductsIntoTable(e,i,s){const o=this.computeAdditionalProductsForSnapshot(e);let n=0;const r=Object.entries(o).map(([e,i])=>{const s=t[e]||1,o=Math.ceil(i/s),r=o*a(e,i);return n+=r,{key:e,value:i,ve:s,packs:o,rowPrice:r}});r.sort((e,t)=>e.key.localeCompare(t.key)),i.innerHTML=r.map(e=>{const t=d[e.key]||e.key.replace(/_/g," ");return`\n          <tr style="border-bottom:1px solid #eee;">\n            <td style="padding:3mm 4mm; width:20mm; font-weight:700;">${e.packs}x</td>\n            <td style="padding:3mm 4mm;">\n              <div style="font-weight:700; font-size:11pt;">${t}</div>\n              <div style="color:#888; font-size:9pt;">${e.ve} Stück</div>\n            </td>\n            <td style="padding:3mm 4mm; text-align:right; width:35mm;">${e.value}</td>\n            <td style="padding:3mm 4mm; text-align:right; width:30mm;">${e.rowPrice.toFixed(2)} €</td>\n          </tr>\n        `}).join(""),s&&(s.textContent=`${n.toFixed(2)} €`)}async generatePDF(e="current"){if(!this.isAvailable())return console.warn("PDF Libraries nicht verfügbar"),void this.solarGrid?.showToast?.("PDF-Generierung nicht verfügbar",3e3);try{const t=this.solarGrid?.createConfigSnapshot?this.solarGrid.createConfigSnapshot():null;if(!t||!Array.isArray(t.configs)||0===t.configs.length)return void this.solarGrid?.showToast?.("Keine Konfiguration zum Exportieren",3e3);let i=t;if("current"===e){const e="number"==typeof t.currentConfigIndex?t.currentConfigIndex:0,s=t.configs[e]||t.configs[0];i={timestamp:t.timestamp,totalConfigs:1,currentConfigIndex:0,configs:[s]}}await this.generatePDFFromSnapshot(i)}catch(e){console.error("generatePDF wrapper failed:",e),this.solarGrid?.showToast?.("PDF-Erstellung fehlgeschlagen",3e3)}}addHeader(e,t,i){return e.setTextColor(14,30,52),e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Ihre Konfiguration",20,20),e.setFontSize(10),e.setFont("helvetica","normal"),e.text((new Date).toLocaleDateString("de-DE"),t-40,20),e.setTextColor(0,0,0),28}async getInvertedLogoBase64(e){return this._invertedLogoBase64Promise||(this._invertedLogoBase64Promise=new Promise((t,i)=>{try{const s=new Image;s.onload=()=>{try{const e=document.createElement("canvas");e.width=s.width,e.height=s.height;const i=e.getContext("2d");i.drawImage(s,0,0);const o=i.getImageData(0,0,e.width,e.height),n=o.data;for(let e=0;e<n.length;e+=4)n[e]=255-n[e],n[e+1]=255-n[e+1],n[e+2]=255-n[e+2];i.putImageData(o,0,0),t(e.toDataURL("image/png"))}catch(e){i(e)}},s.onerror=i,s.src=e}catch(e){i(e)}})),this._invertedLogoBase64Promise}async addFooter(e,t,i){const s=i-25;e.setFillColor(14,30,52),e.rect(0,s,t,25,"F"),e.setTextColor(255,255,255),e.setFontSize(8),e.setFont("helvetica","normal"),e.text("Schneider Unterkonstruktion - Solar Konfigurator",20,s+8),e.text("unterkonstruktion.de",20,s+15);try{const i=await this.loadImageAsBase64(this.companyLogoUrl),o=await this.getInvertedLogoBase64(i),n=15,r=3.1338028169*n,l=t-r-20,a=s+5;e.addImage(o,"PNG",l,a,r,n)}catch(i){console.warn("Logo konnte nicht geladen werden:",i),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("Schneider Unterkonstruktion",t-120,s+12)}}async loadImageAsBase64(e){return new Promise((t,i)=>{try{const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{try{const e=document.createElement("canvas");e.width=s.naturalWidth||s.width,e.height=s.naturalHeight||s.height;const i=e.getContext("2d");i.imageSmoothingEnabled=!0,i.drawImage(s,0,0),t(e.toDataURL("image/png"))}catch(e){i(e)}},s.onerror=i,s.src=e}catch(e){i(e)}})}async calculateTotalPriceFromSnapshot(e){const i=await this.calculatePartsFromSnapshot(e);let s=0;return Object.entries(i).forEach(([e,i])=>{if(i>0){const o=Math.ceil(i/(t[e]||1)),n=a(e,i);s+=o*n}}),s}async addConfigurationToPDFFromSnapshot(e,t,i){const s=210,o=297,n={y:25},r=async(i=20)=>n.y+i>267&&(await this.addFooter(e,s,o),e.addPage(),this.addHeader(e,s,t),n.y=28,!0);console.log(`PDF-Seite für Konfiguration: ${t.name}`,{dimensions:`${t.cols}x${t.rows}`,selectedCells:t.selectedCells,totalCells:t.totalCells}),n.y=this.addHeader(e,s,t),await r(20),e.setDrawColor(229,231,235),e.setLineWidth(.5),e.rect(15,n.y-4,180,14),e.setFont("helvetica","bold"),e.setFontSize(12),e.setTextColor(14,30,52),e.text(`Projekt: ${t.name||"Unbenannt"}`,20,n.y+6),e.setTextColor(0,0,0),n.y+=22,await r(20),e.setFontSize(11),e.setFont("helvetica","normal"),e.text(`Grid: ${t.cols} × ${t.rows} Module (${t.selectedCells} ausgewählt)`,20,n.y),e.text("Orientierung: "+("vertical"===t.orientation?"Vertikal":"Horizontal"),20,n.y+8),n.y+=20;try{const i=await this.captureGridVisualizationFromSnapshot(t);if(i){const t=Math.floor(148.5),o=170;let l=Math.round(3*o/4);if(l>t){const e=t/l;l=Math.round(l*e)}await r(l+15);const a=(s-o)/2,c=n.y;e.addImage(i,"PNG",a,c,o,l),n.y+=l+10}}catch(e){console.warn("Grid-Screenshot fehlgeschlagen:",e),n.y+=10}await this.addFooter(e,s,o),e.addPage(),this.addHeader(e,s,t),n.y=28,await r(60),n.y=await this.addProductTableFromSnapshot(e,t,n.y,r),await r(25);const l=await this.calculateTotalPriceFromSnapshot(t);e.setFillColor(14,30,52),e.rect(15,n.y-5,180,20,"F"),e.setTextColor(255,255,255),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("GESAMTPREIS:",20,n.y+8);const a=`${l.toFixed(2)} € (exkl. MwSt)`;e.text(a,170,n.y+8),e.setTextColor(0,0,0),n.y+=30,await this.addFooter(e,s,o)}async captureGridVisualization(e){try{const t=e.selection||[],i=e.cols||5,s=e.rows||5,o=document.createElement("div");o.style.position="absolute",o.style.left="-10000px",o.style.top="-10000px",o.style.padding="20px",o.style.backgroundColor="#ffffff",document.body.appendChild(o);const n=50,r=2,l=document.createElement("div");l.style.display="grid",l.style.gap=`${r}px`,l.style.gridTemplateColumns=`repeat(${i}, ${n}px)`,l.style.gridTemplateRows=`repeat(${s}, ${n}px)`,l.style.padding="2px",l.style.backgroundColor="#ffffff",l.style.border="1px solid #000000",l.style.borderRadius="1rem";const a=Array.from({length:s},(e,s)=>Array.from({length:i},(e,i)=>!!(t[s]&&Array.isArray(t[s])&&i<t[s].length)&&!0===t[s][i]));console.log("Grid Debug - Normalized:",{originalRows:t.length,originalCols:t[0]?t[0].length:0,targetRows:s,targetCols:i,normalizedSelection:a});for(let e=0;e<s;e++)for(let t=0;t<i;t++){const o=document.createElement("div"),r=a[e][t];(e>=s-2||t>=i-2)&&console.log(`Cell [${e}][${t}]: isSelected =`,r),o.style.width=`${n}px`,o.style.height=`${n}px`,o.style.borderRadius="1rem",o.style.border="1px solid #000000",o.style.backgroundColor=r?"#072544":"#f3f4f6",l.appendChild(o)}o.appendChild(l),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,100));const c=await this.html2canvas(o,{backgroundColor:"#ffffff",scale:2,logging:!1,useCORS:!0,allowTaint:!0,width:o.offsetWidth,height:o.offsetHeight});return document.body.removeChild(o),c.toDataURL("image/png")}catch(e){return console.warn("Grid-Screenshot fehlgeschlagen:",e),null}}async captureGridImageForWebhook(e){try{const t=e.selection||[],i=e.cols||5,s=e.rows||5,o=document.createElement("div");o.style.position="absolute",o.style.left="-10000px",o.style.top="-10000px",o.style.padding="20px",o.style.backgroundColor="#ffffff",document.body.appendChild(o);const n="vertical"===e.orientation,r=58,l=n?Math.round(.62*r):r,a=n?r:Math.round(.62*r),c=2,d=document.createElement("div");d.style.display="grid",d.style.gap=`${c}px`,d.style.gridTemplateColumns=`repeat(${i}, ${l}px)`,d.style.gridTemplateRows=`repeat(${s}, ${a}px)`,d.style.padding="16px",d.style.backgroundColor="#f5f7fa",d.style.border="1px solid #e5e7eb",d.style.borderRadius="12px",d.style.boxShadow="0 2px 8px rgba(0,0,0,0.08)";for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=document.createElement("div"),o=t[e]&&!0===t[e][s];if(i.style.width=`${l}px`,i.style.height=`${a}px`,i.style.borderRadius="6px",i.style.border="1px solid #d1d5db",i.style.transition="all 0.2s ease",o){i.style.backgroundColor="#0b0b0b",i.style.border="2px solid #cccccc",i.style.boxShadow="inset 0 2px 4px rgba(0,0,0,0.25)";const e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.background="linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0) 40%),\n                linear-gradient(135deg, #0b0b0b 0%, #111111 50%, #0b0b0b 100%)",e.style.borderRadius="4px",e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.top="2px",t.style.left="2px",t.style.right="2px",t.style.bottom="2px",t.style.backgroundImage="\n                linear-gradient(to right, rgba(255,255,255,0.08) 1px, transparent 1px),\n                linear-gradient(to bottom, rgba(255,255,255,0.08) 1px, transparent 1px)\n              ",t.style.backgroundSize="33% 50%",e.appendChild(t),i.appendChild(e)}else i.style.backgroundColor="#f3f4f6",i.style.border="1px solid #e5e7eb";d.appendChild(i)}o.appendChild(d),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,150));const h=document.createElement("canvas"),u=h.getContext("2d"),m=i*l+(i-1)*c+40,g=s*a+(s-1)*c+40;h.width=m,h.height=g,u.fillStyle="#ffffff",u.fillRect(0,0,h.width,h.height);const p=20,f=20;for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=p+s*(l+c),o=f+e*(a+c);if(t[e]&&!0===t[e][s]){u.fillStyle="#072544",u.fillRect(i,o,l,a),u.strokeStyle="#0a4d75",u.lineWidth=2,u.strokeRect(i,o,l,a),u.strokeStyle="rgba(255,255,255,0.2)",u.lineWidth=1;for(let e=1;e<3;e++){const t=i+l/3*e;u.beginPath(),u.moveTo(t,o+2),u.lineTo(t,o+a-2),u.stroke()}const e=o+a/2;u.beginPath(),u.moveTo(i+2,e),u.lineTo(i+l-2,e),u.stroke()}else u.fillStyle="#f8f9fa",u.fillRect(i,o,l,a),u.strokeStyle="#e9ecef",u.lineWidth=1,u.strokeRect(i,o,l,a)}u.strokeStyle="#e5e7eb",u.lineWidth=1,u.strokeRect(10,10,m-20,g-20);const b=h.toDataURL("image/png");return console.log("Canvas generated:",{canvasWidth:h.width,canvasHeight:h.height,dataURLLength:b.length,dataURLStart:b.substring(0,50)+"..."}),document.body.removeChild(o),b}catch(e){return console.error("Grid-Bild-Generierung fehlgeschlagen:",e),null}}async captureGridVisualizationFromSnapshot(e){try{const t=e.selection||[],i=e.cols||5,s=e.rows||5,o=698,n=Math.floor(561.5),r=Number(e.cellWidth||179),l=Number(e.cellHeight||113),a="vertical"===e.orientation,c=a?l:r,d=a?r:l,h=2,u=16,m=c*i+h*(i-1)+2*u,g=d*s+h*(s-1)+2*u,p=Math.min(o/m,n/g,1),f=Math.max(1,c*p),b=Math.max(1,d*p),y=Math.max(1,Math.round(h*p)),w=document.createElement("div");w.style.position="absolute",w.style.left="-10000px",w.style.top="-10000px",w.style.width=`${Math.ceil(i*f+(i-1)*y+2*u)}px`,w.style.height=`${Math.ceil(s*b+(s-1)*y+2*u)}px`;const k=document.createElement("div");k.className="canvas",k.style.width="100%",k.style.height="100%",k.style.padding=`${u}px`,k.style.background="#d0d0d0",k.style.borderRadius="6px",k.style.display="flex",k.style.alignItems="center",k.style.justifyContent="center",k.style.boxSizing="border-box";const v=document.createElement("div");v.style.overflow="hidden",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center";const C=document.createElement("div");C.style.display="grid",C.style.gap=`${y}px`,C.style.gridTemplateColumns=`repeat(${i}, ${Math.round(f)}px)`,C.style.gridTemplateRows=`repeat(${s}, ${Math.round(b)}px)`;for(let e=0;e<s;e++)for(let s=0;s<i;s++){const i=document.createElement("div");i.style.width=`${Math.round(f)}px`,i.style.height=`${Math.round(b)}px`,i.style.borderRadius="6px",i.style.boxSizing="border-box";!(!t[e]||!t[e][s])?(i.style.background="#0b0b0b",i.style.border="2px solid #cccccc"):(i.style.background="#f3f4f6",i.style.border="1px solid #e5e7eb"),C.appendChild(i)}v.appendChild(C),k.appendChild(v),w.appendChild(k),document.body.appendChild(w),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>setTimeout(e,50));const S=await this.html2canvas(w,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1});return document.body.removeChild(w),S.toDataURL("image/png")}catch(e){return console.error("Grid-Screenshot fehlgeschlagen:",e),null}}async addProductTableFromSnapshot(e,i,s,o){try{console.log("addProductTableFromSnapshot called for:",i.name);const n=await this.calculatePartsFromSnapshot(i);if(console.log("Received parts:",n,"Keys count:",Object.keys(n||{}).length),console.log("Parts entries:",Object.entries(n||{})),console.log("UlicaSolarBlackJadeFlow in parts:",n?.UlicaSolarBlackJadeFlow),!n||0===Object.keys(n).length)return console.log("No parts calculated, returning early"),s;await o(30),e.setFillColor(255,177,1),e.roundedRect?e.roundedRect(15,s-5,180,15,3,3,"F"):e.rect(15,s-5,180,15,"F"),e.setTextColor(255,255,255),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("PRODUKT-LISTE",20,s+5),e.setTextColor(0,0,0),s+=20,await o(15),e.setFillColor(14,30,52),e.roundedRect?e.roundedRect(15,s-3,180,12,3,3,"F"):e.rect(15,s-3,180,12,"F"),e.setTextColor(255,255,255),e.setFontSize(9),e.setFont("helvetica","bold"),e.text("Anzahl",20,s+3),e.text("Produkt",45,s+3),e.text("Benötigte Menge",120,s+3),e.text("Preis",170,s+3),e.setTextColor(0,0,0),s+=15,e.setFont("helvetica","normal"),e.setFontSize(8);let r=0,l=0;for(const[i,c]of Object.entries(n))if(console.log("Processing product:",i,"quantity:",c),c>0){console.log("Adding to PDF:",i,"quantity:",c),await o(12),l%2==1&&(e.setFillColor(245,245,245),e.rect(15,s-2,180,10,"F"));const n=d[i]||i.replace(/_/g," "),h=t[i]||1,u=Math.ceil(c/h),m=u*a(i,c);r+=m,e.setFont("helvetica","bold"),e.text(`${u}x`,22,s+2,{align:"left"}),e.setFont("helvetica","bold"),e.setFontSize(10),e.text(n,45,s+1),e.setFont("helvetica","normal"),e.setFontSize(8),e.setTextColor(128,128,128),e.text(`${h} Stück`,45,s+6),e.setTextColor(0,0,0),e.setFont("helvetica","normal"),e.setFontSize(9),e.text(`${c}`,140,s+2,{align:"right"}),e.setFont("helvetica","bold"),e.text(`${m.toFixed(2)} €`,190,s+2,{align:"right"}),s+=12,l++}return await o(15),e.setDrawColor(233,236,239),e.setLineWidth(1),e.line(15,s,195,s),s+=5}catch(e){return console.error("Produkttabelle fehlgeschlagen:",e),s}}async calculatePartsFromSnapshot(e){try{console.log("Calculating parts for config:",e.name,{selectedCells:e.selectedCells,rows:e.rows,cols:e.cols,includeModules:e.includeModules});const t={selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation||"horizontal",options:{erdungsband:e.erdungsband||!1,ulicaModule:!0===e.ulicaModule,includeModules:!0===e.includeModules||!0===e.incM}};let i;try{i=await u.calculate("calculateParts",t)}catch(e){console.warn("calculationManager failed, using fallback:",e),i=this.calculatePartsDirectly(t)}console.log("Parts calculated:",i),console.log("Config checkbox states:",{includeModules:e.includeModules,incM:e.incM,ulicaModule:e.ulicaModule}),console.log("Config object keys:",Object.keys(e)),console.log("Config ulicaModule value:",e.ulicaModule,"type:",typeof e.ulicaModule),console.log("CalculationData options:",t.options),e.includeModules||e.incM||(console.log("Deleting Solarmodul - both checkboxes false"),delete i.Solarmodul),!0!==e.ulicaModule?(console.log("Deleting UlicaSolarBlackJadeFlow - ulicaModule is not true"),delete i.UlicaSolarBlackJadeFlow):console.log("Keeping UlicaSolarBlackJadeFlow - ulicaModule is true"),e.mc4||(console.log("Deleting MC4 - mc4 checkbox false"),delete i.MC4),e.cable||(console.log("Deleting Solarkabel - cable checkbox false"),delete i.Solarkabel),e.wood||(console.log("Deleting Holzunterleger - wood checkbox false"),delete i.Holzunterleger),e.quetschkabelschuhe||(console.log("Deleting Quetschkabelschuhe - quetschkabelschuhe checkbox false"),delete i.Quetschkabelschuhe),e.erdungsband?i.Erdungsband=this.solarGrid.calculateErdungsband():delete i.Erdungsband;try{const t=!0===e.ulicaModule,s=t?"UlicaSolarBlackJadeFlow":"Solarmodul",o=t?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",n=Number(i[s]||0);if(n>0){const e=Math.floor(n/36),t=n%36;e>0&&(i[o]=(i[o]||0)+36*e),i[s]=t}}catch(e){}return console.log("Final parts after processing:",i),i}catch(e){return console.error("Part calculation from snapshot failed:",e),{}}}async addProductTable(e,i,s,o){await o(30),e.setFillColor(255,177,1),e.roundedRect?e.roundedRect(15,s-5,180,15,3,3,"F"):e.rect(15,s-5,180,15,"F"),e.setTextColor(14,30,52),e.setFontSize(12),e.setFont("helvetica","bold"),e.text("PRODUKT-LISTE",20,s+5),e.setTextColor(0,0,0),s+=20;const n=await this.calculateConfigParts(i);if(!n||0===Object.keys(n).length)return e.setFontSize(10),e.setFont("helvetica","italic"),e.text("Keine Produkte berechnet.",20,s),s+10;await o(15),e.setFillColor(14,30,52),e.roundedRect?e.roundedRect(15,s-3,180,12,3,3,"F"):e.rect(15,s-3,180,12,"F"),e.setTextColor(255,255,255),e.setFontSize(9),e.setFont("helvetica","bold"),e.text("Produkt",20,s+3),e.text("Menge",70,s+3),e.text("Pack",100,s+3),e.text("Preis/Pack",130,s+3),e.text("Gesamt",170,s+3),e.setTextColor(0,0,0),s+=15,e.setFont("helvetica","normal"),e.setFontSize(8);let r=0,l=0;for(const[i,c]of Object.entries(n))if(c>0){await o(12),l%2==1&&(e.setFillColor(245,245,245),e.rect(15,s-2,180,10,"F"));const n=t[i]||1,h=Math.ceil(c/n),u=a(i,c),m=h*u;r+=m;const g=d[i]||i.replace(/_/g," ");e.text(g,20,s+2),e.text(c.toString(),70,s+2),e.text(`${h}×`,100,s+2),e.text(`${u.toFixed(2)} €`,130,s+2),e.text(`${m.toFixed(2)} €`,170,s+2),s+=10,l++}return await o(15),e.setDrawColor(233,236,239),e.setLineWidth(1),e.line(15,s,195,s),s+=5}async calculateConfigParts(e){if(!e.selection||!e.cols||!e.rows)return{};const i={selection:e.selection.map(e=>[...e]),rows:e.rows,cols:e.cols,cellWidth:e.cellWidth||179,cellHeight:e.cellHeight||113,orientation:e.orientation,options:{erdungsband:e.erdungsband||!1,ulicaModule:!0===e.ulicaModule,includeModules:!0===e.includeModules||!0===e.incM}};let s;try{s=await u.calculate("calculateParts",i)}catch(e){console.warn("calculationManager failed, using fallback:",e),s=this.calculatePartsDirectly(i)}if(e.includeModules||e.incM||(console.log("Deleting Solarmodul - both includeModules and incM false"),delete s.Solarmodul),!0!==e.ulicaModule?(console.log("Deleting UlicaSolarBlackJadeFlow - ulicaModule is not true"),delete s.UlicaSolarBlackJadeFlow):console.log("Keeping UlicaSolarBlackJadeFlow - ulicaModule is true"),e.mc4){const i=e.selection.flat().filter(e=>e).length,o=t.MC4_Stecker||50,n=Math.ceil(i/30);s.MC4_Stecker=n*o,console.log("Added MC4_Stecker packs:",n,"=> pieces",s.MC4_Stecker,"for",i,"modules")}return e.cable&&(s.Solarkabel=1,console.log("Added Solarkabel: 1")),e.wood&&(s.Holzunterleger=1,console.log("Added Holzunterleger: 1")),s}generateFileName(e){const t=new Date,i=t.toISOString().slice(0,10),s=t.toTimeString().slice(0,5).replace(":","-");let o="Solar-Konfiguration";return 1===e.length?o=e[0].name||"Konfiguration":e.length>1&&(o=`${e.length}-Konfigurationen`),o=o.replace(/[<>:"/\\|?*]/g,"-"),`${o}_${i}_${s}.pdf`}}class f{constructor(e){this.solarGrid=e,this.patterns={gridSize:/(\d+)\s*[x×]\s*(\d+)(?!\s*mal)/i,moduleCount:/(\d+)\s*modul[e]?[n]?/i,moduleCountAlt:/(?:modul\s*anzahl|modulanzahl|anzahl\s*modul(?:e|en)?|module\s*anzahl)\s*(\d+)/i,moduleCheckbox:/(?:mit|ohne)[\s-]*modul[e]?[n]?(?!\s*\d)/i,orientation:/(?:horizontal|vertikal|vertical)/i,mc4:/(?:mit|ohne)[\s-]*mc4/i,cable:/(?:mit|ohne)[\s-]*(?:kabel|solarkabel)/i,wood:/(?:mit|ohne)[\s-]*holz(?:unterleger)?/i,quetschkabelschuhe:/(?:mit|ohne)[\s-]*(?:quetschkabelschuhe|kabelschuhe)/i,rowPattern:/(?:(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?)\s*(?:mit|à|a)?\s*(\d+)\s*modul[e]?[n]?)|(?:(\d+)\s*modul[e]?[n]?\s*(?:in|auf)?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?))|(?:(\d+)\s*mal\s*(\d+)\s*modul[e]?[n]?)/i,rowsOnly:/(?:reihen?|zeilen?)\s*(\d+)/i,spacing:/(?:(?:mit|ohne)\s*(?:doppelt\w*\s*)?(?:abstand|lücke))|(?:(\d+)\s*(?:reihen?|zeilen?)\s*(?:abstand|lücke))/i,gridCompact:/(?:kompakt|ohne\s*lücken)/i,gridSpaced:/(?:mit\s*lücken|mit\s*abstand)/i,checkboxCombination:/(?:^|\s)(?:mit|und)\s+(.+?)(?:\s+und\s+(.+?))*(?:\s*$)/i,saveConfig:/^(?:(?:konfiguration|konfig|config)\s*)?(?:speichern|save)$/i,deleteConfig:/^(?:(?:konfiguration|konfig|config)\s*)?(?:löschen|delete)$/i,deleteModules:/^modul[e]?[n]?\s*löschen$/i,newConfig:/^(?:neu(?:e|en)?[\s-]*(?:konfiguration|konfig|config)(?:[\s-]*(?:erstellen|anlegen))?|(?:konfiguration|konfig|config)[\s-]*neu(?:e|en)?(?:[\s-]*(?:erstellen|anlegen))?|new[\s-]*(?:config|configuration))$/i,deleteAllConfigs:/^(?:alle[\s-]*(?:konfigurationen|configs?|konfigs?)[\s-]*(?:löschen|entfernen)|(?:alles|alle)[\s-]*(?:löschen|zurücksetzen)|von[\s-]*(?:vorne|vorn)[\s-]*(?:beginnen|anfangen)|neu[\s-]*starten|start[\s-]*over|reset[\s-]*all)$/i,resetGrid:/^(?:reset|zurücksetzen|zurücksetzen)$/i,distributionEqual:/(?:gleich[-\s]*m[aä]ßig|gleichmaessig|gleich|optimal)/i,distributionRows:/(?:in\s*reihen|reihenweise)/i,distributionColumns:/(?:in\s*spalten|spaltenweise)/i,distributionRandom:/(?:zuf[aä]llig|zufaellig|random)/i,spacingDouble:/(?:doppelter|doppeltem)\s*abstand/i,spacingRowsOnly:/(?:nur\s*)?(?:zwischen\s*)?reihen/i,spacingColumnsOnly:/(?:nur\s*)?(?:zwischen\s*)?spalten/i,selectRowsExplicit:/mit\s*modul\w*\s*in\s*(?:reihe|zeile)n?\s*([0-9\s,–—\-a-z]+)/i,gapRowsExplicit:/mit\s*l[üu]cken\s*in\s*(?:reihe|zeile)n?\s*([0-9\s,–—\-a-z]+)/i,selectColumnsExplicit:/mit\s*modul\w*\s*in\s*(?:spalte|spalten)\s*([0-9\s,–—\-a-z]+)/i,gapColumnsExplicit:/mit\s*l[üu]cken\s*in\s*(?:spalte|spalten)\s*([0-9\s,–—\-a-z]+)/i,allRowsExcept:/alle\s*(?:reihen|zeilen)\s*(?:außer|ausser)\s*([0-9\s,–—\-a-z]+)/i,allColumnsExcept:/alle\s*spalten\s*(?:außer|ausser)\s*([0-9\s,–—\-a-z]+)/i,clearTopRow:/\b(?:oberste|oberer)\s*reihe\s*leer\b/i,clearBottomRow:/\b(?:unterste|unterer)\s*reihe\s*leer\b/i,fillFirstNColumns:/\berst(?:e|en|er)?\s*(\d+|ein|eine|eins|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*spalten?\s*f[üu]llen\b/i,clearFirstNColumns:/\berst(?:e|en|er)?\s*(\d+|ein|eine|eins|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*spalten?\s*leer\b/i,clearLastNColumns:/\bletzte[nr]?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*spalten?\s*leer\b/i,fillFirstNRows:/\berst(?:e|en|er)?\s*(\d+|ein|eine|eins|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*reihen?\s*f[üu]llen\b/i,clearFirstNRows:/\berst(?:e|en|er)?\s*(\d+|ein|eine|eins|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*reihen?\s*leer\b/i,fillLastNRows:/\bletzte[nr]?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*reihen?\s*f[üu]llen\b/i,clearLastNRows:/\bletzte[nr]?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)?\s*reihen?\s*leer\b/i,fillOnlyFrame:/\bnur\s*rand\s*f[üu]llen\b/i,fillBlock:/\bblock\s*(\d+)\s*[x×]\s*(\d+)\s*ab\s*reihe\s*(\d+)\s*,?\s*spalte\s*(\d+)\b/i,fillBlockRelative:/\bblock\s*(\d+)\s*[x×]\s*(\d+)\s*ab\s*reihe\s*von\s*unten\s*(\d+)\s*,?\s*spalte\s*von\s*rechts\s*(\d+)\b/i,checkboxAllExcept:/(?:alles\s*außer|alle\s*außer)/i,checkboxOnly:/(?:nur|only)/i,checkboxWithout:/(?:ohne\s*zubehör|ohne\s*extras)/i,checkboxWithAll:/(?:mit\s*allem|alles\s*mit)/i,allSimple:/^(?:alles)$/i,saveWithName:/(?:speichern\s*als\s*['"]?([^'"]+)['"]?)/i,ulicaModule:/ulica(?:\s*(500|450)\s*w?)?|black\s*jade(?:[-\s]*flow)?\s*(500|450)?/i,addModulesWatt:/\b(450|500)\s*(?:watt|w)\s*modul(?:e|en)?\s*hinzuf(?:ügen|uegen)\b/i,addComponents:/\b(?:mc4|kabel|holz|quetschkabelschuhe|erdungsband)(?:\s*(?:,|und)\s*(?:mc4|kabel|holz|quetschkabelschuhe|erdungsband))*\s*hinzuf(?:ügen|uegen)\b/i}}parseWordNumber(e){const t={ein:1,eine:1,zwei:2,drei:3,vier:4,"fünf":5,sechs:6,sieben:7,acht:8,neun:9,zehn:10};return"string"==typeof e&&t[e.toLowerCase()]?t[e.toLowerCase()]:parseInt(e)||0}parseCheckboxCombinations(e){const t={modules:null,mc4:null,cable:null,wood:null,quetschkabelschuhe:null};let i=e.toLowerCase().replace(/modulen?/g,"module").replace(/solarkabeln?/g,"solarkabel").replace(/holzunterlegern?/g,"holzunterleger").split(/\s*(?:und|,)\s*/);i[0]&&(i[0].includes("mit ")||i[0].includes("ohne "))&&(i[0]=i[0].replace(/.*(?:mit|ohne)\s+/,"")),i=i.filter(e=>e.trim().length>0);for(const s of i){const i=s.trim();!/\bmodul[e]?[n]?\b/.test(i)||/\d+\s*modul/.test(i)||/reihen/.test(i)||(/\bohne[\s-]+modul[e]?[n]?\b/.test(i)||/\bohne[\s-]+modul[e]?[n]?\b/.test(e.toLowerCase())?t.modules=!1:t.modules=!0),/\bmc4\b/.test(i)&&(/\bohne[\s-]+mc4\b/.test(i)||/\bohne[\s-]+mc4\b/.test(e.toLowerCase())?t.mc4=!1:t.mc4=!0),/\b(?:kabel|solarkabel)\b/.test(i)&&(/\bohne[\s-]+(?:kabel|solarkabel)\b/.test(i)||/\bohne[\s-]+(?:kabel|solarkabel)\b/.test(e.toLowerCase())?t.cable=!1:t.cable=!0),/\b(?:holz|holzunterleger)\b/.test(i)&&(/\bohne[\s-]+(?:holz|holzunterleger)\b/.test(i)||/\bohne[\s-]+(?:holz|holzunterleger)\b/.test(e.toLowerCase())?t.wood=!1:t.wood=!0),/\b(?:quetschkabelschuhe|kabelschuhe)\b/.test(i)&&(/\bohne[\s-]+(?:quetschkabelschuhe|kabelschuhe)\b/.test(i)||/\bohne[\s-]+(?:quetschkabelschuhe|kabelschuhe)\b/.test(e.toLowerCase())?t.quetschkabelschuhe=!1:t.quetschkabelschuhe=!0)}return t}parseInput(e){try{const t=e.match(this.patterns.gridSize);if(t){const e=parseInt(t[1],10);return{cols:e,rows:parseInt(t[2],10),forceClearSelection:!0}}return{}}catch(e){return console.error("SmartConfig parseInput error (test step 1):",e),{}}const t={};try{const i=e.match(this.patterns.gridSize);if(i){t.cols=parseInt(i[1]),t.rows=parseInt(i[2]);const s=e.match(this.patterns.spacing),o=e.match(this.patterns.spacingDouble);let n=0;if(s&&(o?n=2:s[0].toLowerCase().includes("mit")&&!s[1]?n=1:s[1]&&(n=parseInt(s[1])),n>=0)){if(this.solarGrid.selection&&this.solarGrid.selection.some(e=>e&&e.some(e=>!0===e)))t.adjustSpacing={spacing:n,targetCols:t.cols,targetRows:t.rows};else{const e=Math.ceil(t.rows/(1+Math.max(n,1))),i=t.cols*e;t.rowConfig={rows:e,modulesPerRow:t.cols,spacing:n,totalModules:i}}}const r=e.match(this.patterns.gridCompact),l=e.match(this.patterns.gridSpaced);r?t.gridCompact=!0:l&&(t.gridSpaced=!0)}const s=e.match(this.patterns.rowPattern);if(!(i||s||e.match(this.patterns.moduleCount))){const i=e.match(this.patterns.spacing),s=e.match(this.patterns.spacingDouble);if(i){let e=0;s?e=2:i[0].toLowerCase().includes("ohne")?e=0:i[0].toLowerCase().includes("mit")&&!i[1]?e=1:i[1]&&(e=parseInt(i[1]));return this.solarGrid.selection&&this.solarGrid.selection.some(e=>e&&e.some(e=>!0===e))?(t.adjustSpacing={spacing:e,targetCols:null,targetRows:null},t):(this.solarGrid.showToast("⚠️ Keine Module vorhanden - erst Module auswählen, dann Abstand anpassen",3e3),{})}}if(s){let i,o;if(s[1]&&s[2])i=this.parseWordNumber(s[1]),o=parseInt(s[2]);else if(s[3]&&s[4]){const e=parseInt(s[3]);i=this.parseWordNumber(s[4]),o=Math.ceil(e/i),t.intelligentDistribution={totalModules:e,numRows:i,baseModulesPerRow:Math.floor(e/i),extraModules:e%i}}else s[5]&&s[6]&&(i=parseInt(s[5]),o=parseInt(s[6]));if(i&&o){const s=e.match(this.patterns.spacing);let n=0;s&&(s[0].toLowerCase().includes("mit")&&!s[1]?n=1:s[1]&&(n=parseInt(s[1]))),t.rowConfig={rows:i,modulesPerRow:o,spacing:n,totalModules:i*o};const r=i+(i-1)*n;t.cols=o,t.rows=r}}const o=e.match(this.patterns.distributionEqual),n=e.match(this.patterns.distributionRows),r=e.match(this.patterns.distributionColumns),l=e.match(this.patterns.distributionRandom);if(o?(t.suppressAutoSelection=!0,t.deprecatedNotice="distributionEqual"):n?t.distribution="rows":r?t.distribution="columns":l&&(t.suppressAutoSelection=!0,t.deprecatedNotice="distributionRandom"),!s){let i=e.match(this.patterns.moduleCount);if(!i){const s=e.match(this.patterns.moduleCountAlt);s&&(i=[,s[1],s[1]],t.moduleCount=parseInt(s[1]))}if(i){t.moduleCount||(t.moduleCount=parseInt(i[1]));const s=e.match(this.patterns.spacing),o=e.match(this.patterns.spacingDouble),n=e.match(this.patterns.spacingRowsOnly),r=e.match(this.patterns.spacingColumnsOnly);let l=0;o?l=2:n?(l=1,t.spacingRowsOnly=!0):r?(l=1,t.spacingColumnsOnly=!0):s&&(s[0].toLowerCase().includes("mit")&&!s[1]?l=1:s[1]&&(l=parseInt(s[1])));const a=this.calculateOptimalGrid(t.moduleCount);if(t.cols=a.cols,t.rows=a.rows,l>0){const e=Math.ceil(Math.sqrt(t.moduleCount/a.cols)),i=Math.ceil(t.moduleCount/e);t.rowConfig={rows:e,modulesPerRow:i,spacing:l,totalModules:t.moduleCount},t.rows=e+(e-1)*l,t.cols=Math.max(t.cols,i)}}}const a=e.match(this.patterns.rowsOnly);if(!t.rowConfig&&a&&t.moduleCount){const e=parseInt(a[1],10);if(Number.isInteger(e)&&e>0){const i=Math.ceil(t.moduleCount/e);t.rowConfig={rows:e,modulesPerRow:i,spacing:0,totalModules:t.moduleCount},t.intelligentDistribution={totalModules:t.moduleCount,numRows:e,baseModulesPerRow:Math.floor(t.moduleCount/e),extraModules:t.moduleCount%e},t.rows=e,t.cols=Math.max(this.solarGrid?.cols||0,i)}}/\b(?:rahmen|rand)\s*(?:außen|aussen)\s*leer\b/i.test(e)&&(t.clearFrame=!0);const c=e.match(/\b(?:innen(?:bereich)?)\s*(?:reihe[n]?\s*([0-9\s,–—\-a-z]+))\s*(?:und|,)?\s*spalte[n]?\s*([0-9\s,–—\-a-z]+)/i);if(c){const e=e=>{const t=(e||"").replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),i=[];for(const e of t){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),s=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(s)){const t=Math.min(e,s),o=Math.max(e,s);for(let e=t;e<=o;e++)i.push(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&i.push(t)}}return Array.from(new Set(i))};t.selectAreaRows=e(c[1]),t.selectAreaCols=e(c[2])}/\blink[e]?\s*h[aä]lfte\s*f[üu]llen\b/i.test(e)&&(t.fillLeftHalf=!0),/\brecht[e]?\s*h[aä]lfte\s*leer\b/i.test(e)&&(t.clearRightHalf=!0);const d=e.match(/\bjede\s*zweite\s*reihe\s*f[üu]llen(?:.*?start\s*bei\s*(\d+))?/i);if(d){const e=parseInt(d[1]||"1",10);t.everySecondRowsStart=Number.isInteger(e)&&e>0?e:1}const h=e.match(this.patterns.orientation);h&&(t.orientation=h[0].toLowerCase().includes("vertikal")||h[0].toLowerCase().includes("vertical")?"vertical":"horizontal");const u=e.match(this.patterns.checkboxAllExcept),m=e.match(this.patterns.checkboxOnly),g=e.match(this.patterns.checkboxWithout),p=e.match(this.patterns.checkboxWithAll);if(u){const i=e.toLowerCase().match(/(?:alles\s*außer|alle\s*außer)\s+(\w+)/);if(i){const e=i[1];t.includeModules="module"!==e&&"modulen"!==e,t.mc4="mc4"!==e,t.cable="kabel"!==e&&"solarkabel"!==e,t.wood="holz"!==e&&"holzunterleger"!==e,t.quetschkabelschuhe="quetschkabelschuhe"!==e&&"kabelschuhe"!==e}}else if(m){const i=e.toLowerCase().match(/(?:nur|only)\s+(.+?)(?:\s+und\s+(.+?))*(?:\s*$)/);if(i){const e=[i[1],i[2]].filter(Boolean);t.includeModules=e.some(e=>e.includes("module")),t.mc4=e.some(e=>e.includes("mc4")),t.cable=e.some(e=>e.includes("kabel")||e.includes("solarkabel")),t.wood=e.some(e=>e.includes("holz")),t.quetschkabelschuhe=e.some(e=>e.includes("quetschkabelschuhe")||e.includes("kabelschuhe"))}}else if(g)t.includeModules=!0,t.mc4=!1,t.cable=!1,t.wood=!1,t.quetschkabelschuhe=!1;else if(p)t.includeModules=!0,t.mc4=!0,t.cable=!0,t.wood=!0,t.quetschkabelschuhe=!0,t.erdungsband=!0;else if(e.match(this.patterns.allSimple))t.includeModules=!0,t.mc4=!0,t.cable=!0,t.wood=!0,t.quetschkabelschuhe=!0,t.erdungsband=!0;else{const i=this.parseCheckboxCombinations(e);if(Object.values(i).some(e=>null!==e))null!==i.modules&&(t.includeModules=i.modules),null!==i.mc4&&(t.mc4=i.mc4),null!==i.cable&&(t.cable=i.cable),null!==i.wood&&(t.wood=i.wood),null!==i.quetschkabelschuhe&&(t.quetschkabelschuhe=i.quetschkabelschuhe);else{const i=e.match(this.patterns.moduleCheckbox);i&&(t.includeModules=i[0].toLowerCase().includes("mit"));const s=e.match(this.patterns.mc4);s&&(t.mc4=s[0].toLowerCase().includes("mit"));const o=e.match(this.patterns.cable);o&&(t.cable=o[0].toLowerCase().includes("mit"));const n=e.match(this.patterns.wood);n&&(t.wood=n[0].toLowerCase().includes("mit"));const r=e.match(this.patterns.quetschkabelschuhe);r&&(t.quetschkabelschuhe=r[0].toLowerCase().includes("mit"))}}const f=e.match(this.patterns.ulicaModule);if(f){t.ulicaModule=!0;const e=(f[1]||f[2]||"").toString();t.selectedModule="450"===e?"ulica-450":"ulica-500",t.includeModules=!1}const b=e.match(this.patterns.addModulesWatt);if(b){const e=b[1];t.ulicaModule=!0,t.selectedModule="450"===e?"ulica-450":"ulica-500",t.includeModules=!1}if(e.match(this.patterns.addComponents)){const i=e.toLowerCase().match(/(?:mc4|kabel|holz|quetschkabelschuhe|erdungsband)/g);i&&(i.includes("mc4")&&(t.mc4=!0),i.includes("kabel")&&(t.cable=!0),i.includes("holz")&&(t.wood=!0),i.includes("quetschkabelschuhe")&&(t.quetschkabelschuhe=!0),i.includes("erdungsband")&&(t.erdungsband=!0))}const y=e.match(this.patterns.saveWithName);if(y)return t.action="saveConfig",t.configName=y[1],t;if(e.match(this.patterns.saveConfig))return t.action="saveConfig",t;if(e.match(this.patterns.newConfig))return t.action="newConfig",t;if(e.match(this.patterns.deleteAllConfigs))return t.action="resetAllConfigs",t;const w=e.match(this.patterns.allRowsExcept);if(w){const e=this.solarGrid.rows,i=Array.from({length:e},(e,t)=>t+1),s=w[1]||"",o=s.replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),n=new Set;for(const e of o){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),i=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(i)){const t=Math.min(e,i),s=Math.max(e,i);for(let e=t;e<=s;e++)n.add(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&n.add(t)}}const r=i.filter(e=>!n.has(e));r.length>0&&(t.selectRows=r)}const k=e.match(this.patterns.allColumnsExcept);if(k){const e=this.solarGrid.cols,i=Array.from({length:e},(e,t)=>t+1),s=k[1]||"",o=s.replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),n=new Set;for(const e of o){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),i=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(i)){const t=Math.min(e,i),s=Math.max(e,i);for(let e=t;e<=s;e++)n.add(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&n.add(t)}}const r=i.filter(e=>!n.has(e));r.length>0&&(t.selectColumns=r)}const v=e.match(this.patterns.selectRowsExplicit);if(v){const e=v[1]||"",i=e.replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),s=[];for(const e of i){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),i=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(i)){const t=Math.min(e,i),o=Math.max(e,i);for(let e=t;e<=o;e++)s.push(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&s.push(t)}}s.length>0&&(t.selectRows=Array.from(new Set(s)))}const C=e.match(this.patterns.gapRowsExplicit);if(C){const e=C[1]||"",i=e.replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),s=[];for(const e of i){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),i=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(i)){const t=Math.min(e,i),o=Math.max(e,i);for(let e=t;e<=o;e++)s.push(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&s.push(t)}}s.length>0&&(t.gapRows=Array.from(new Set(s)))}const S=e.match(this.patterns.selectColumnsExplicit);if(S){const e=S[1]||"",i=e.replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),s=[];for(const e of i){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),i=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(i)){const t=Math.min(e,i),o=Math.max(e,i);for(let e=t;e<=o;e++)s.push(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&s.push(t)}}s.length>0&&(t.selectColumns=Array.from(new Set(s)))}const M=e.match(this.patterns.gapColumnsExplicit);if(M){const e=M[1]||"",i=e.replace(/[–—]/g,"-").replace(/\bund\b/gi,",").replace(/\bbis\b/gi,"-").split(",").map(e=>e.trim()).filter(Boolean),s=[];for(const e of i){const t=e.match(/^(\d+)\s*-\s*(\d+)$/);if(t){let e=parseInt(t[1],10),i=parseInt(t[2],10);if(Number.isInteger(e)&&Number.isInteger(i)){const t=Math.min(e,i),o=Math.max(e,i);for(let e=t;e<=o;e++)s.push(e)}}else{const t=parseInt(e,10);Number.isInteger(t)&&t>0&&s.push(t)}}s.length>0&&(t.gapColumns=Array.from(new Set(s)))}this.patterns.clearTopRow.test(e)&&(t.clearTopRow=!0),this.patterns.clearBottomRow.test(e)&&(t.clearBottomRow=!0);const x=e.match(this.patterns.fillFirstNColumns);x&&(t.fillFirstNColumns=this.parseWordNumber(x[1]||"1"));const I=e.match(this.patterns.clearFirstNColumns);I&&(t.clearFirstNColumns=this.parseWordNumber(I[1]||"1"));const E=e.match(this.patterns.clearLastNColumns);E&&(t.clearLastNColumns=parseInt(E[1]||"1",10)),this.patterns.fillOnlyFrame.test(e)&&(t.fillOnlyFrame=!0);const P=e.match(this.patterns.fillBlock);P&&(t.fillBlock={height:this.parseWordNumber(P[1]),width:this.parseWordNumber(P[2]),startRow:this.parseWordNumber(P[3]),startCol:this.parseWordNumber(P[4])});const L=e.match(this.patterns.fillBlockRelative);L&&(t.fillBlockRelative={height:this.parseWordNumber(L[1]),width:this.parseWordNumber(L[2]),fromBottom:this.parseWordNumber(L[3]),fromRight:this.parseWordNumber(L[4])});const G=e.match(this.patterns.fillFirstNRows);G&&(t.fillFirstNRows=this.parseWordNumber(G[1]||"1"));const F=e.match(this.patterns.clearFirstNRows);F&&(t.clearFirstNRows=this.parseWordNumber(F[1]||"1"));const T=e.match(this.patterns.fillLastNRows);T&&(t.fillLastNRows=this.parseWordNumber(T[1]||"1"));const B=e.match(this.patterns.clearLastNRows);B&&(t.clearLastNRows=this.parseWordNumber(B[1]||"1"));e.length<20&&!e.match(/\d/)&&(t.cols=this.solarGrid.cols,t.rows=this.solarGrid.rows,t.useCurrentGrid=!0);if(e.match(this.patterns.deleteConfig))return t.action="deleteConfig",t;if(e.match(this.patterns.deleteModules))return t.action="deleteModules",t;return e.match(this.patterns.resetGrid)?(t.action="resetGrid",t):t}catch(t){return console.error("Error parsing input:",e,t),{}}}calculateOptimalGrid(e){const t=[];for(let i=1;i<=Math.sqrt(e);i++)e%i===0&&t.push([i,e/i]);const i=t.reduce((e,t)=>Math.max(e[0],e[1])/Math.min(e[0],e[1])<=Math.max(t[0],t[1])/Math.min(t[0],t[1])?e:t);return{cols:Math.max(i[0],i[1]),rows:Math.min(i[0],i[1])}}applyConfiguration(e){const t=this.solarGrid.selection?this.solarGrid.selection.map(e=>[...e]):null,i=this.solarGrid.cols,s=this.solarGrid.rows;if(e.cols&&e.rows&&(this.solarGrid.cols=e.cols,this.solarGrid.rows=e.rows,!0===e.forceClearSelection&&(this.solarGrid.selection=Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)))),e.orientation){this.solarGrid.orV&&(this.solarGrid.orV.checked="vertical"===e.orientation),this.solarGrid.orH&&(this.solarGrid.orH.checked="horizontal"===e.orientation);const t=document.getElementById("orient-h"),i=document.getElementById("orient-v");t&&i&&(t.classList.toggle("active","horizontal"===e.orientation),i.classList.toggle("active","vertical"===e.orientation))}if(e.action)return void this.handleAction(e.action,e);e.hasOwnProperty("includeModules")&&this.solarGrid.incM&&(this.solarGrid.incM.checked=e.includeModules),e.hasOwnProperty("mc4")&&this.solarGrid.mc4&&(this.solarGrid.mc4.checked=e.mc4),e.hasOwnProperty("cable")&&this.solarGrid.solarkabel&&(this.solarGrid.solarkabel.checked=e.cable),e.hasOwnProperty("wood")&&this.solarGrid.holz&&(this.solarGrid.holz.checked=e.wood),e.hasOwnProperty("quetschkabelschuhe")&&this.solarGrid.quetschkabelschuhe&&(this.solarGrid.quetschkabelschuhe.checked=e.quetschkabelschuhe),e.hasOwnProperty("ulicaModule")&&(this.solarGrid.ulicaModule&&(this.solarGrid.ulicaModule.checked=!0===e.ulicaModule),!0===e.ulicaModule&&this.solarGrid.incM&&(this.solarGrid.incM.checked=!1)),e.selectedModule&&this.solarGrid.moduleSelect&&(this.solarGrid.moduleSelect.value=e.selectedModule,this.solarGrid.handleModuleSelectChange()),this.solarGrid.updateAllConfigurationsForCheckboxes();const o=e.cols&&e.cols!==i||e.rows&&e.rows!==s,n=e.selectRows||e.gapRows||e.selectColumns||e.gapColumns||e.selectAreaRows&&e.selectAreaCols||e.fillOnlyFrame||e.clearFrame||e.fillLeftHalf||e.clearRightHalf||e.everySecondRowsStart||e.clearTopRow||e.clearBottomRow||e.fillFirstNColumns||e.clearFirstNColumns||e.clearLastNColumns||e.fillFirstNRows||e.clearFirstNRows||e.fillLastNRows||e.clearLastNRows||e.fillBlock||e.fillBlockRelative;let r;if(r=o?e.moduleCount||e.rowConfig||n?Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)):Array.from({length:this.solarGrid.rows},(e,i)=>Array.from({length:this.solarGrid.cols},(e,s)=>!!(t&&i<t.length&&s<t[i].length)&&t[i][s])):t||Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1)),this.solarGrid.selection=r,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),e.adjustSpacing&&this.adjustGridSpacing(e.adjustSpacing),e.rowConfig&&this.applyRowConfiguration(e.rowConfig,e.intelligentDistribution),e.selectRows||e.gapRows||e.selectColumns||e.gapColumns||e.clearFrame||e.selectAreaRows&&e.selectAreaCols||e.fillLeftHalf||e.clearRightHalf||e.everySecondRowsStart||e.clearTopRow||e.clearBottomRow||e.fillFirstNColumns||e.clearFirstNColumns||e.clearLastNColumns||e.fillFirstNRows||e.clearFirstNRows||e.fillLastNRows||e.clearLastNRows||e.fillOnlyFrame||e.fillBlock||e.fillBlockRelative){const t=this.solarGrid.rows,i=this.solarGrid.cols,s=e=>{this.solarGrid.selection[e]||(this.solarGrid.selection[e]=Array.from({length:i},()=>!1))};if(e.clearFrame)for(let e=0;e<t;e++){s(e);for(let s=0;s<i;s++)0!==e&&e!==t-1&&0!==s&&s!==i-1||(this.solarGrid.selection[e][s]=!1)}if(Array.isArray(e.selectRows))for(const o of e.selectRows){const e=o-1;if(e<0||e>=t)this.solarGrid.showToast(`⚠️ Reihe ${o} existiert nicht (Grid ${i}×${t}).`,3e3);else{s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!0}}if(Array.isArray(e.gapRows))for(const o of e.gapRows){const e=o-1;if(e<0||e>=t)this.solarGrid.showToast(`⚠️ Reihe ${o} existiert nicht (Grid ${i}×${t}).`,3e3);else{s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!1}}if(Array.isArray(e.selectColumns))for(const o of e.selectColumns){const e=o-1;if(e<0||e>=i)this.solarGrid.showToast(`⚠️ Spalte ${o} existiert nicht (Grid ${i}×${t}).`,3e3);else for(let i=0;i<t;i++)s(i),this.solarGrid.selection[i][e]=!0}if(Array.isArray(e.gapColumns))for(const o of e.gapColumns){const e=o-1;if(e<0||e>=i)this.solarGrid.showToast(`⚠️ Spalte ${o} existiert nicht (Grid ${i}×${t}).`,3e3);else for(let i=0;i<t;i++)s(i),this.solarGrid.selection[i][e]=!1}if(Array.isArray(e.selectAreaRows)&&Array.isArray(e.selectAreaCols))for(const o of e.selectAreaRows){const n=o-1;if(!(n<0||n>=t)){s(n);for(const t of e.selectAreaCols){const e=t-1;e<0||e>=i||(this.solarGrid.selection[n][e]=!0)}}}if(e.fillLeftHalf){const e=Math.floor(i/2)-1;for(let i=0;i<t;i++){s(i);for(let t=0;t<=e;t++)this.solarGrid.selection[i][t]=!0}}if(e.clearRightHalf){const e=Math.ceil(i/2);for(let o=0;o<t;o++){s(o);for(let t=e;t<i;t++)this.solarGrid.selection[o][t]=!1}}if(e.clearTopRow){const e=0;s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!1}if(e.clearBottomRow){const e=t-1;s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!1}if(e.fillFirstNColumns&&e.fillFirstNColumns>0){const o=Math.min(i-1,e.fillFirstNColumns-1);for(let e=0;e<t;e++){s(e);for(let t=0;t<=o;t++)this.solarGrid.selection[e][t]=!0}}if(e.clearFirstNColumns&&e.clearFirstNColumns>0){const o=Math.min(i-1,e.clearFirstNColumns-1);for(let e=0;e<t;e++){s(e);for(let t=0;t<=o;t++)this.solarGrid.selection[e][t]=!1}}if(e.clearLastNColumns&&e.clearLastNColumns>0){const o=Math.max(0,i-e.clearLastNColumns);for(let e=0;e<t;e++){s(e);for(let t=o;t<i;t++)this.solarGrid.selection[e][t]=!1}}if(e.fillFirstNRows&&e.fillFirstNRows>0){const o=Math.min(t-1,e.fillFirstNRows-1);for(let e=0;e<=o;e++){s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!0}}if(e.clearFirstNRows&&e.clearFirstNRows>0){const o=Math.min(t-1,e.clearFirstNRows-1);for(let e=0;e<=o;e++){s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!1}}if(e.fillLastNRows&&e.fillLastNRows>0){for(let o=Math.max(0,t-e.fillLastNRows);o<t;o++){s(o);for(let e=0;e<i;e++)this.solarGrid.selection[o][e]=!0}}if(e.clearLastNRows&&e.clearLastNRows>0){for(let o=Math.max(0,t-e.clearLastNRows);o<t;o++){s(o);for(let e=0;e<i;e++)this.solarGrid.selection[o][e]=!1}}if(e.fillOnlyFrame)for(let e=0;e<t;e++){s(e);for(let s=0;s<i;s++){const o=0===e||e===t-1||0===s||s===i-1;this.solarGrid.selection[e][s]=o}}if(e.fillBlock){const{height:o,width:n,startRow:r,startCol:l}=e.fillBlock,a=Math.max(1,r)-1,c=Math.max(1,l)-1;for(let e=a;e<Math.min(t,a+o);e++){s(e);for(let t=c;t<Math.min(i,c+n);t++)this.solarGrid.selection[e][t]=!0}}if(e.fillBlockRelative){const{height:o,width:n,fromBottom:r,fromRight:l}=e.fillBlockRelative,a=Math.max(0,t-r),c=Math.max(0,i-l);for(let e=a;e<Math.min(t,a+o);e++){s(e);for(let t=c;t<Math.min(i,c+n);t++)this.solarGrid.selection[e][t]=!0}}if(e.everySecondRowsStart){for(let o=Math.max(1,e.everySecondRowsStart);o<=t;o+=2){const e=o-1;s(e);for(let t=0;t<i;t++)this.solarGrid.selection[e][t]=!0}}if(e.moduleCount&&e.rowConfig&&!e.selectRows&&!e.gapRows){const t=new Set;if(e.clearFirstNColumns&&e.clearFirstNColumns>0)for(let i=0;i<Math.min(this.solarGrid.cols,e.clearFirstNColumns);i++)t.add(i);if(Array.isArray(e.gapColumns))for(const i of e.gapColumns){const e=i-1;e>=0&&e<this.solarGrid.cols&&t.add(e)}const i=this.solarGrid.cols-t.size,s=this.solarGrid.rows,o=Math.ceil((e.moduleCount+t.size)/s);if(i*s<e.moduleCount){this.solarGrid.cols=Math.max(this.solarGrid.cols,o);for(let e=0;e<this.solarGrid.rows;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=this.solarGrid.selection[e].length;t<this.solarGrid.cols;t++)this.solarGrid.selection[e][t]=!1}}for(let e=0;e<this.solarGrid.rows;e++)for(let i=0;i<this.solarGrid.cols;i++)t.has(i)||(this.solarGrid.selection[e][i]=!1);let n=0;e:for(let i=0;i<this.solarGrid.rows;i++)for(let s=0;s<this.solarGrid.cols;s++)if(!t.has(s)&&(this.solarGrid.selection[i][s]=!0,n++,n>=e.moduleCount))break e}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}e.moduleCount&&!(e.selectRows||e.gapRows||e.selectColumns||e.gapColumns||e.selectAreaRows||e.selectAreaCols||e.fillBlock||e.fillBlockRelative||e.fillFirstNRows||e.clearFirstNRows||e.fillLastNRows||e.clearLastNRows||e.fillFirstNColumns||e.clearFirstNColumns||e.clearLastNColumns)&&(e.suppressAutoSelection?this.solarGrid.showToast('Hinweis: "gleichmäßig" ist nicht mehr verfügbar. Bitte geben Sie Reihen/Spalten oder Module pro Reihe an.',3500):e.distribution?this.distributeModules(e.moduleCount,e.distribution,e):this.autoSelectModules(e.moduleCount)),e.moduleCount||"distributionEqual"!==e.deprecatedNotice||this.solarGrid.showToast('Hinweis: "gleichmäßig" ist nicht mehr verfügbar. Nutzen Sie z. B. "3 Reihen mit 6 Modulen".',3500),e.moduleCount||"distributionRandom"!==e.deprecatedNotice||this.solarGrid.showToast('Hinweis: "zufällig" ist nicht mehr verfügbar. Nutzen Sie konkrete Reihen/Spalten-Angaben.',3500),this.hideHelpAfterFirstUse()}applyPreviewToMainGrid(e){this.solarGrid.hidePreviewGrid(),this.solarGrid.showMainGrid(),this.applyConfiguration(e)}handleAction(e,t={}){switch(e){case"saveConfig":t.configName?(this.solarGrid.renameCurrentConfig(t.configName),this.solarGrid.showToast(`Konfiguration umbenannt zu "${t.configName}"`,2e3)):(this.solarGrid.saveNewConfig(),this.solarGrid.showToast("Konfiguration gespeichert",2e3));break;case"deleteConfig":if(this.solarGrid.configs.length<=1)return void this.solarGrid.showToast("⚠️ Kann letzte Konfiguration nicht löschen",3e3);null!==this.solarGrid.currentConfig&&(this.solarGrid.deleteConfig(this.solarGrid.currentConfig),this.solarGrid.showToast("Konfiguration gelöscht",2e3));break;case"deleteModules":this.clearModuleSelection(),this.solarGrid.showToast("Module-Auswahl gelöscht",2e3);break;case"resetGrid":this.solarGrid.resetGridToDefault(),this.solarGrid.showToast("⚡ Grid zurückgesetzt",2e3);break;case"newConfig":this.solarGrid.saveNewConfig(),this.solarGrid.showToast("Neue Konfiguration erstellt",2e3);break;case"resetAllConfigs":this.solarGrid.resetAllConfigurations();break;default:console.warn("Unbekannte Action:",e)}}clearModuleSelection(){for(let e=0;e<this.solarGrid.rows;e++)for(let t=0;t<this.solarGrid.cols;t++)this.solarGrid.selection[e]&&(this.solarGrid.selection[e][t]=!1);this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}hideHelpAfterFirstUse(){const e=document.querySelector(".bulk-selection-help");e&&(e.style.display="none",localStorage.setItem("solarTool_hideHelp","true"))}autoSelectModules(e){this.solarGrid.cols*this.solarGrid.rows<e&&this.expandGridForModules(e),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1));let t=0;for(let i=0;i<this.solarGrid.rows&&t<e;i++)for(let s=0;s<this.solarGrid.cols&&t<e;s++)this.solarGrid.selection[i][s]=!0,t++;this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForModules(e){if(this.solarGrid.cols*this.solarGrid.rows>=e)return;this.calculateOptimalGrid(e);let t=this.solarGrid.cols,i=this.solarGrid.rows;for(;t*i<e;)t<=i?t++:i++;this.solarGrid.cols=t,this.solarGrid.rows=i;const s=this.solarGrid.selection||[];this.solarGrid.selection=Array.from({length:i},(e,i)=>Array.from({length:t},(e,t)=>i<s.length&&t<s[i].length&&s[i][t])),this.solarGrid.updateSize()}adjustGridSpacing(e){const{spacing:t,targetCols:i,targetRows:s}=e,o=[];for(let e=0;e<this.solarGrid.rows;e++)if(this.solarGrid.selection[e]&&this.solarGrid.selection[e].some(e=>!0===e)){const t=[];for(let i=0;i<this.solarGrid.cols;i++)!0===this.solarGrid.selection[e][i]&&t.push(i);o.push({originalRow:e,modules:t})}if(0===o.length)return;let n;n=0===t?o.length:o.length+(o.length-1)*t;const r=Math.max(...o.map(e=>e.modules.length>0?Math.max(...e.modules):0)),l=Math.max(i||this.solarGrid.cols,r+1);this.solarGrid.cols=l,this.solarGrid.rows=n;const a=Array.from({length:n},()=>Array.from({length:l},()=>!1));let c=0;for(let e=0;e<o.length;e++){const i=o[e];for(const e of i.modules)e<l&&(a[c][e]=!0);e<o.length-1&&(c+=1+t)}this.solarGrid.selection=a,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),0===t?this.solarGrid.showToast(`🔧 Abstände entfernt - ${o.length} Reihen kompakt`,2e3):this.solarGrid.showToast(`📏 ${t} Reihen Abstand hinzugefügt - ${n} Reihen total`,2e3)}applyRowConfiguration(e,t=null){const{rows:i,modulesPerRow:s,spacing:o,totalModules:n}=e,r=i+(i-1)*o,l=s;(this.solarGrid.rows<r||this.solarGrid.cols<l)&&this.expandGridForRowConfig(l,r);for(let e=0;e<this.solarGrid.rows;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=0;t<this.solarGrid.cols;t++)this.solarGrid.selection[e][t]=!1}let a=0,c=0;for(let e=0;e<i;e++){let i;if(t){const{baseModulesPerRow:s,extraModules:o}=t;i=s+(e<o?1:0)}else i=Math.min(s,n-c);for(let e=0;e<i&&e<this.solarGrid.cols;e++)a<this.solarGrid.rows&&(this.solarGrid.selection[a]||(this.solarGrid.selection[a]=[]),this.solarGrid.selection[a][e]=!0,c++);a+=1+o}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}distributeModules(e,t,i={}){this.solarGrid.cols*this.solarGrid.rows<e&&this.expandGridForModules(e),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},()=>Array.from({length:this.solarGrid.cols},()=>!1));const s=this.solarGrid.rows,o=this.solarGrid.cols,n=e=>{for(let t=0;t<s;t++){let i=e[t]||0;for(let e=0;e<o&&i>0;e++)this.solarGrid.selection[t][e]=!0,i--}};if("equal"===t){const t=Math.min(s,Math.ceil(Math.sqrt(e))),i=Math.floor(e/t),o=e%t;n(Array.from({length:s},(e,s)=>s<t?i+(s<o?1:0):0))}else if("rows"===t){const t=Math.floor(e/s),i=e%s;n(Array.from({length:s},(e,s)=>t+(s<i?1:0)))}else if("columns"===t){const t=Math.floor(e/o),i=e%o;for(let e=0;e<o;e++){let o=t+(e<i?1:0);for(let t=0;t<s&&o>0;t++)this.solarGrid.selection[t][e]=!0,o--}}else if("random"===t){let t=0;const i=[];for(let e=0;e<s;e++)for(let t=0;t<o;t++)i.push([e,t]);for(let e=i.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[i[e],i[t]]=[i[t],i[e]]}for(const[s,o]of i){if(t>=e)break;this.solarGrid.selection[s][o]=!0,t++}}else this.autoSelectModules(e);this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForRowConfig(e,t){const i=this.solarGrid.selection||[];this.solarGrid.cols=Math.max(this.solarGrid.cols,e),this.solarGrid.rows=Math.max(this.solarGrid.rows,t),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},(e,t)=>Array.from({length:this.solarGrid.cols},(e,s)=>t<i.length&&s<i[t].length&&i[t][s])),this.solarGrid.updateSize()}}class b{constructor(e){this.solarGrid=e,this.firstClick=null,this.isSelecting=!1,this.bulkMode=!1,this.isDragging=!1,this.dragStart=null,this.mousePressed=!1,this.setupKeyListener(),this.setupGlobalMouseEvents()}setupKeyListener(){}toggleBulkMode(){this.bulkMode=!this.bulkMode,this.bulkMode?(this.showBulkModeIndicator(!0),this.firstClick=null):(this.showBulkModeIndicator(!1),this.firstClick=null,this.clearHighlight())}showBulkModeIndicator(e){if(document.querySelectorAll(".bulk-mode-indicator").forEach(e=>e.remove()),e){const e=document.createElement("div");e.className="bulk-mode-indicator",e.innerHTML="🔄 Bulk-Modus aktiv - Klicke auf zwei Zellen um einen Bereich auszuwählen",e.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background: #f5a623;\n          color: white;\n          padding: 8px 16px;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: bold;\n          z-index: 1000;\n          box-shadow: 0 4px 12px rgba(245, 166, 35, 0.3);\n          animation: slideIn 0.3s ease;\n        ";const t=document.createElement("style");t.textContent="\n          @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n          }\n        ",document.head&&document.head.appendChild(t),document.body&&document.body.appendChild(e)}}initializeBulkSelection(){const e=this.solarGrid.buildGrid.bind(this.solarGrid);this.solarGrid.buildGrid=()=>{e(),setTimeout(()=>{this.addBulkSelectionToGrid()},10)},setTimeout(()=>{this.addBulkSelectionToGrid()},100)}addBulkSelectionToGrid(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach((e,t)=>{const i=t%this.solarGrid.cols,s=Math.floor(t/this.solarGrid.cols),o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.addEventListener("mousedown",e=>{e.preventDefault(),this.handleDragStart(e,i,s,o)}),o.addEventListener("touchstart",e=>{e.preventDefault(),this.handleDragStart(e,i,s,o)}),o.addEventListener("mouseenter",e=>{this.mousePressed&&this.dragStart&&(this.isDragging=!0,this.highlightRange(this.dragStart,{x:i,y:s}))}),o.addEventListener("touchmove",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.isDragging=!0,this.highlightRange(this.dragStart,{x:i,y:s}))}),o.addEventListener("mouseup",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.handleDragEnd(e,i,s))}),o.addEventListener("touchend",e=>{this.mousePressed&&this.dragStart&&(e.preventDefault(),this.handleDragEnd(e,i,s))}),o.addEventListener("click",e=>{this.isDragging||this.mousePressed&&this.dragStart||(this.solarGrid.selection[s]||(this.solarGrid.selection[s]=[]),e.ctrlKey||e.metaKey,this.solarGrid.selection[s][i]=!this.solarGrid.selection[s][i],o.classList.toggle("selected"),this.solarGrid.trackInteraction(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),null!==this.solarGrid.currentConfig&&(this.solarGrid.updateConfig(),this.solarGrid.updateConfigList()))}),o.addEventListener("mouseleave",()=>{this.mousePressed||this.clearHighlight()})})}selectRange(e,t){const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),o=Math.min(e.y,t.y),n=Math.max(e.y,t.y),r=!e.wasSelected;for(let e=o;e<=n;e++){this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]);for(let t=i;t<=s;t++)this.solarGrid.selection[e][t]=r}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}highlightRange(e,t){this.clearHighlight();const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),o=Math.min(e.y,t.y),n=Math.max(e.y,t.y),r=this.solarGrid.gridEl.querySelectorAll(".grid-cell"),l=void 0===e.wasSelected||!e.wasSelected;for(let e=o;e<=n;e++)for(let t=i;t<=s;t++){const i=e*this.solarGrid.cols+t;r[i]&&(r[i].classList.add("bulk-highlight"),l?r[i].classList.add("drag-preview-select"):r[i].classList.add("drag-preview-deselect"))}}clearHighlight(){this.solarGrid.gridEl.querySelectorAll(".bulk-highlight, .drag-preview-select, .drag-preview-deselect").forEach(e=>{e.classList.remove("bulk-highlight","drag-preview-select","drag-preview-deselect")});this.solarGrid.gridEl.querySelectorAll(".drag-start-marker, .drag-select-mode, .drag-deselect-mode").forEach(e=>{e.classList.remove("drag-start-marker","drag-select-mode","drag-deselect-mode")})}resetDragState(){this.mousePressed=!1,this.isDragging=!1,this.dragStart=null,this.clearHighlight()}calculateRangeSize(e,t){const i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),o=Math.min(e.y,t.y);return(s-i+1)*(Math.max(e.y,t.y)-o+1)}clearFirstClickMarker(){this.solarGrid.gridEl.querySelectorAll(".grid-cell").forEach(e=>e.classList.remove("first-click-marker"))}getClampedCellFromPointer(e){const t=this.solarGrid.gridEl.getBoundingClientRect(),i=e&&e.touches&&e.touches[0]||e&&e.changedTouches&&e.changedTouches[0]||e,s=i?i.clientX:0,o=i?i.clientY:0,n=Math.min(Math.max(s-t.left,0),t.width),r=Math.min(Math.max(o-t.top,0),t.height),l=t.width/this.solarGrid.cols,a=t.height/this.solarGrid.rows;return{x:Math.min(this.solarGrid.cols-1,Math.max(0,l>0?Math.floor(n/l):0)),y:Math.min(this.solarGrid.rows-1,Math.max(0,a>0?Math.floor(r/a):0))}}handleDragStart(e,t,i,s){const o=this.solarGrid.selection[i]?.[t]||!1;this.mousePressed=!0,this.isDragging=!1,this.dragStart={x:t,y:i,wasSelected:o},this.clearHighlight(),s.classList.add("drag-start-marker"),o?s.classList.add("drag-deselect-mode"):s.classList.add("drag-select-mode")}handleDragEnd(e,t,i){(this.isDragging||this.dragStart.x===t&&this.dragStart.y===i)&&this.selectRange(this.dragStart,{x:t,y:i}),this.resetDragState()}setupGlobalMouseEvents(){document.addEventListener("mousemove",e=>{if(this.mousePressed&&this.dragStart){this.isDragging=!0;const t=this.getClampedCellFromPointer(e);this.highlightRange(this.dragStart,t)}}),document.addEventListener("mouseup",e=>{if(this.mousePressed&&this.dragStart){const t=this.getClampedCellFromPointer(e);this.handleDragEnd(e,t.x,t.y)}}),document.addEventListener("touchmove",e=>{if(this.mousePressed&&this.dragStart){e.preventDefault(),this.isDragging=!0;const t=this.getClampedCellFromPointer(e);this.highlightRange(this.dragStart,t)}},{passive:!1}),document.addEventListener("touchend",e=>{if(this.mousePressed&&this.dragStart){const t=this.getClampedCellFromPointer(e);this.handleDragEnd(e,t.x,t.y)}}),this.solarGrid.gridEl.addEventListener("mouseleave",()=>{}),this.solarGrid.gridEl.addEventListener("touchcancel",()=>{}),this.solarGrid.gridEl.addEventListener("contextmenu",e=>{(this.isDragging||this.mousePressed)&&e.preventDefault()}),this.solarGrid.gridEl.addEventListener("touchmove",e=>{(this.isDragging||this.mousePressed)&&e.preventDefault()})}}class y{constructor(){this.gridEl=document.getElementById("grid"),this.wrapper=document.querySelector(".grid-wrapper"),this.wIn=document.getElementById("width-input"),this.hIn=document.getElementById("height-input"),this.orH=document.getElementById("orient-h"),this.orV=document.getElementById("orient-v"),this.incM=document.getElementById("include-modules"),this.mc4=document.getElementById("mc4"),this.solarkabel=document.getElementById("solarkabel"),this.holz=document.getElementById("holz"),this.quetschkabelschuhe=document.getElementById("quetschkabelschuhe"),this.erdungsband=document.getElementById("erdungsband"),this.ulicaModule=document.getElementById("ulica-module"),this.listHolder=document.querySelector(".product-section"),this.prodList=document.querySelector(".product-section #produktliste"),this.saveBtn=document.getElementById("save-config-btn"),this.addBtn=document.getElementById("add-to-cart-btn"),this.summaryBtn=document.getElementById("summary-add-cart-btn"),this.configListEl=document.getElementById("config-list"),this.resetBtn=document.getElementById("reset-btn"),this.continueLaterBtn=document.getElementById("continue-later-btn"),this.moduleSelect=document.getElementById("module-select"),this.moduleData={"ulica-500":{name:"Ulica Black Jade-Flow 500W",width:195.2,height:113.4},"ulica-450":{name:"Ulica Black Jade-Flow 450W",width:176.2,height:113.4},"trina-vertex-s-plus":{name:"Trina Vertex S+",width:176.2,height:113.4},"aiko-neostar-3s-plus":{name:"Aiko Neostar 3S+",width:176.2,height:113.4}},this.moduleCheckboxMapping={"include-modules":"ulica-450","ulica-module":"ulica-500"},this.selection=[],this.configs=[],this.currentConfig=null,this.default={cols:5,rows:5,width:176,height:113},this.updateTimeout=null,this.updateDelay=100,this.isAddingToCart=!1,this.webflowFormsObserver=null,this.cartAckObserver=null,this.cartAckResolve=null,this.resizeObserver=null,this.resizeTimeout=null,this.zoomLevel=1,this.minZoom=.5,this.maxZoom=3,this.zoomObserver=null,this.performanceMetrics={gridRenderTime:0,updateTime:0,memoryUsage:0,fps:0,errorCount:0},this.sessionId=this.generateSessionId(),this.sessionStartTime=Date.now(),this.firstInteractionTime=null,this.lastInteractionTime=Date.now(),this.interactionCount=0,this.webhookUrl="https://hook.eu2.make.com/c7lkudk1v2a2xsr291xbvfs2cb25b84k",this.pdfGenerator=new p(this),this.cacheManager=new e,this.loadingOverlay=null,this.loadingTextEl=null,this.init()}saveToUrl(){try{return}catch(e){return}}showLoading(e="Vorgang läuft… bitte warten"){try{this.loadingOverlay||(this.loadingOverlay=document.getElementById("loading-overlay")),this.loadingTextEl||(this.loadingTextEl=document.getElementById("loading-text")),this.loadingTextEl&&"string"==typeof e&&(this.loadingTextEl.textContent=e),this.loadingOverlay&&(this.loadingOverlay.style.display="flex")}catch(e){}}hideLoading(){try{this.loadingOverlay||(this.loadingOverlay=document.getElementById("loading-overlay")),this.loadingOverlay&&(this.loadingOverlay.style.display="none")}catch(e){}}generateSessionId(){return`session_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}trackInteraction(){this.firstInteractionTime||(this.firstInteractionTime=Date.now()),this.lastInteractionTime=Date.now(),this.interactionCount++}formatDuration(e){if(!e||e<0)return"00:00:00";const t=Math.floor(e/1e3),i=Math.floor(t/3600),s=Math.floor(t%3600/60),o=t%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}getSessionData(){const e=Date.now(),t=e-this.sessionStartTime,i=this.firstInteractionTime?this.firstInteractionTime-this.sessionStartTime:0,s=e-this.lastInteractionTime;return{sessionDuration:this.formatDuration(t),timeToFirstInteraction:this.formatDuration(i),timeSinceLastInteraction:this.formatDuration(s),interactionCount:this.interactionCount,sessionStartTime:this.sessionStartTime,firstInteractionTime:this.firstInteractionTime,lastInteractionTime:this.lastInteractionTime,performanceMetrics:this.performanceMetrics}}getProductSummary(){const e=this.calculateParts();this.incM.checked||delete e.Solarmodul;try{const t=!0===currentConfig.ulicaModule,i=t?"UlicaSolarBlackJadeFlow":"Solarmodul",s=t?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",o=Number(e[i]||0);if(o>0){const t=Math.floor(o/36),n=o%36;t>0&&(e[s]=(e[s]||0)+36*t),e[i]=n}}catch(e){}const i=Object.entries(e).filter(([,e])=>e>0);let s=0;const o={};return i.forEach(([e,i])=>{const n=Math.ceil(i/t[e]),r=a(e,i);s+=n*r;const l=e.replace(/_/g,"");o[l]=i}),{totalPrice:s}}generateGridVisualization(e,t,i,s,o){let n=`<div class="grid" style="--cols: ${t}; --rows: ${i}; --cell-size: ${s}px; --cell-height: ${o}px; --cell-gap: 2px;">`;for(let s=0;s<i;s++)for(let i=0;i<t;i++){n+=`<div class="${e[s]&&e[s][i]?"cell selected":"cell"}"></div>`}n+="</div>";return{html:n,css:".grid { \n        display: grid; \n        gap: var(--cell-gap); \n        grid-template-columns: repeat(var(--cols), var(--cell-size)); \n        grid-template-rows: repeat(var(--rows), var(--cell-height)); \n        margin: auto; \n        background: transparent; \n      } \n      .cell { \n        background: #000000; \n        border-radius: 6px; \n        width: var(--cell-size); \n        height: var(--cell-height); \n        transition: all 0.15s ease; \n      } \n      .cell.selected { \n        background: #7f7f7f; \n      }"}}getConfigData(e=null){const i=e||{cols:this.cols,rows:this.rows,cellWidth:parseFloat(this.wIn.value),cellHeight:parseFloat(this.hIn.value),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked},s=this.getProductSummary(),o=this.generateGridVisualization(i.selection,i.cols,i.rows,i.cellWidth,i.cellHeight),n=this.calculatePartsDirectly({selection:i.selection,cols:i.cols,rows:i.rows,cellWidth:i.cellWidth,cellHeight:i.cellHeight,orientation:i.orientation,incM:i.incM}),r={Solarmodul:n.Solarmodul||0,Endklemmen:n.Endklemmen||0,Schrauben:n.Schrauben||0,Dachhaken:n.Dachhaken||0,Mittelklemmen:n.Mittelklemmen||0,Endkappen:n.Endkappen||0,Schienenverbinder:n.Schienenverbinder||0,Schiene240cm:n.Schiene_240_cm||0,Schiene360cm:n.Schiene_360_cm||0},l=Object.fromEntries(Object.entries(r).filter(([,e])=>e>0)),c=[];for(let e=0;e<i.rows;e++){const t=i.selection[e]||[];for(let s=0;s<i.cols;s++)t[s]&&c.push([s,e])}const d={selectedCount:c.length,selectedCoords:c},h=Object.entries(l).reduce((e,[i,s])=>{const o="Schiene240cm"===i?"Schiene_240_cm":"Schiene360cm"===i?"Schiene_360_cm":i,n=t[o]||1;return e+Math.ceil(s/n)*a(o,s)},0);return{timestamp:(new Date).toISOString(),sessionId:this.sessionId,sessionData:this.getSessionData(),config:{cols:i.cols,rows:i.rows,cellWidth:i.cellWidth,cellHeight:i.cellHeight,orientation:i.orientation,gridVisualization:o,options:{includeModules:i.incM}},summary:s,productQuantities:r,productQuantitiesCompact:l,selectionMeta:d,totalPrice:Number.isFinite(h)?h:s.totalPrice,analytics:{totalCells:i.cols*i.rows,selectedCells:i.selection.flat().filter(e=>e).length,selectionPercentage:(i.selection.flat().filter(e=>e).length/(i.cols*i.rows)*100).toFixed(2),gridArea:i.cols*i.rows,averageCellSize:((i.cellWidth+i.cellHeight)/2).toFixed(2)}}}async sendConfigToWebhook(e){try{const t={sessionId:e.sessionId,timestamp:e.timestamp,config:{cols:e?.config?.cols,rows:e?.config?.rows,cellWidth:e?.config?.cellWidth,cellHeight:e?.config?.cellHeight,orientation:e?.config?.orientation},selection:e.selectionMeta||void 0,productQuantities:e.productQuantitiesCompact||e.productQuantities,totalPrice:e.totalPrice,session:{duration:e.sessionData?.sessionDuration,interactions:e.sessionData?.interactionCount}};("number"==typeof e.configIndex||e.configName||"number"==typeof e.totalConfigsInSession)&&(t.meta={configIndex:e.configIndex,configName:e.configName,totalConfigsInSession:e.totalConfigsInSession});return(await fetch(this.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok}catch(e){return console.error("Webhook send error:",e),!1}}async sendCurrentConfigToWebhook(){const e=this.getConfigData();return await this.sendConfigToWebhook(e)}async sendAllConfigsToWebhook(){const e=[];let t=0;for(let i=0;i<this.configs.length;i++){const s=this.configs[i];let o;o=i===this.currentConfig?{cols:this.cols,rows:this.rows,cellWidth:parseFloat(this.wIn.value),cellHeight:parseFloat(this.hIn.value),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked}:{cols:s.cols,rows:s.rows,cellWidth:parseFloat(s.cellWidth),cellHeight:parseFloat(s.cellHeight),orientation:s.orientation,selection:s.selection,incM:s.incM,mc4:s.mc4,solarkabel:s.solarkabel,holz:s.holz};const n=this.selection,r=!!this.orV&&this.orV.checked,l=!!this.solarkabel&&this.solarkabel.checked,a=!!this.incM&&this.incM.checked,c=!!this.mc4&&this.mc4.checked,d=!!this.holz&&this.holz.checked;this.selection=o.selection,this.orV&&(this.orV.checked="vertical"===o.orientation),this.orH&&(this.orH.checked=!("vertical"===o.orientation)),this.solarkabel&&(this.solarkabel.checked=o.solarkabel),this.incM&&(this.incM.checked=o.incM),this.mc4&&(this.mc4.checked=o.mc4),this.holz&&(this.holz.checked=o.holz);const h=this.getConfigData(o);h.configIndex=i,h.configName=s.name,h.totalConfigsInSession=this.configs.length,this.selection=n,this.orV&&(this.orV.checked=r),this.orH&&(this.orH.checked=!r),this.solarkabel&&(this.solarkabel.checked=l),this.incM&&(this.incM.checked=a),this.mc4&&(this.mc4.checked=c),this.holz&&(this.holz.checked=d);try{const s=await this.sendConfigToWebhook(h);s&&t++,e.push(s),i<this.configs.length-1&&await new Promise(e=>setTimeout(e,100))}catch(t){e.push(!1)}}return t===this.configs.length}checkMobileDevice(){(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window&&window.innerWidth<=1024)&&this.showMobileWarning()}showMobileWarning(){const e=document.getElementById("mobile-warning"),t=document.getElementById("mobile-continue"),i=document.getElementById("mobile-close");if(e){sessionStorage.getItem("mobile-warning-seen")||(e.classList.remove("hidden"),t?.addEventListener("click",()=>{e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),i?.addEventListener("click",()=>{e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),e.addEventListener("click",t=>{t.target===e&&(e.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true"))}))}}maybeShowIntroOverlay(e,t){try{const i=document.getElementById("intro-overlay");if(!i)return;if(e||t)return;const s=document.getElementById("intro-close"),o=document.getElementById("intro-ok"),n=()=>{i.classList.add("hidden"),i.setAttribute("aria-hidden","true")};i.classList.remove("hidden"),i.setAttribute("aria-hidden","false"),s?.addEventListener("click",n),o?.addEventListener("click",n),i.addEventListener("click",e=>{e.target===i&&n()}),i.addEventListener("click",e=>{const t=e.target;t&&("intro-ok"===t.id||t.closest&&t.closest("#intro-ok"))&&(e.preventDefault(),e.stopPropagation(),n())}),i.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),n()),"Enter"===e.key&&document.activeElement&&"intro-ok"===document.activeElement.id&&(e.preventDefault(),n())})}catch(e){console.warn("Intro Overlay konnte nicht initialisiert werden:",e)}}init(){this.checkMobileDevice();const e=this.loadFromCache();if(!e){const e=new URLSearchParams(window.location.search).get("configData");if(e)try{const t=decodeURIComponent(atob(e)),i=JSON.parse(t);Array.isArray(i)?(this.configs=i,this.loadConfig(0)):(this.configs.push(i),this.loadConfig(0))}catch(e){}}try{const t=new URLSearchParams(window.location.search).has("configData");this.maybeShowIntroOverlay(e,t)}catch(e){}this.setupAllEventListeners(),this.saveBtn&&this.saveBtn.addEventListener("click",()=>{this.trackInteraction(),this.saveNewConfig()}),this.addBtn&&this.addBtn.addEventListener("click",()=>{this.trackInteraction(),this.addCurrentToCart()}),this.summaryBtn&&this.summaryBtn.addEventListener("click",()=>{this.trackInteraction(),this.addAllToCart()}),this.resetBtn&&this.resetBtn.addEventListener("click",()=>{this.trackInteraction(),this.resetGridToDefault()}),this.continueLaterBtn&&this.continueLaterBtn.addEventListener("click",()=>{this.trackInteraction(),this.generateContinueLink()});document.getElementById("sidebar-toggle");if(this.initSidebarNavigation(),this.loadingOverlay=document.getElementById("loading-overlay"),this.loadingTextEl=document.getElementById("loading-text"),window.addEventListener("resize",()=>{this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}),0===this.configs.length){this.cols=this.default.cols,this.rows=this.default.rows,this.setup();const e=this._makeConfigObject();if(this.configs.push(e),this.loadConfig(0),this.orH&&this.orV){this.orH.checked=!1,this.orV.checked=!0;const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t&&(e.classList.remove("active"),t.classList.add("active"))}}this.setupResizeObserver(),this.setupPinchToZoom(),this.initSmartConfigFeatures(),this.loadingOverlay=document.getElementById("loading-overlay"),this.loadingTextEl=document.getElementById("loading-text"),this.initAutoSaveIndicator(),this.initConfigList()}initSidebarNavigation(){const e=document.getElementById("back-to-overview");document.getElementById("config-detail-view"),document.getElementById("config-overview");e&&e.addEventListener("click",()=>{this.showOverview()});const t=document.getElementById("edit-config-name");t&&t.addEventListener("click",()=>{this.editConfigName()});const i=document.getElementById("delete-current-config");i&&(i.addEventListener("click",()=>{this.deleteCurrentConfig()}),i.style.display=this.configs.length>=2?"":"none");const s=document.getElementById("express-checkout-btn");if(s){try{s.setAttribute("aria-label","Gesamte Auswahl in den Warenkorb")}catch(e){}try{s.setAttribute("title","Gesamte Auswahl in den Warenkorb")}catch(e){}s.addEventListener("click",()=>{this.addAllConfigsToCart()})}const o=document.getElementById("next-config-btn");o&&o.addEventListener("click",()=>{this.saveNewConfig()}),document.addEventListener("click",e=>{try{var t=e.target;if(!t||!t.closest)return;if(!t.closest('#add-all-to-cart-btn, .add-all-to-cart-btn, [data-action="add-all-to-cart"], [data-add-all-to-cart="true"]'))return;try{e.preventDefault()}catch(e){}this.addAllConfigsToCart()}catch(e){}},!0);const n=document.getElementById("continue-later-btn");n&&n.addEventListener("click",()=>{this.resetAllConfigurations()});const r=document.getElementById("add-config-btn");r&&r.addEventListener("click",()=>{this.saveNewConfig()})}showOverview(){null!==this.currentConfig&&this.updateConfig();const e=document.getElementById("config-detail-view"),t=document.getElementById("config-overview");e&&t&&(e.classList.remove("active"),t.classList.add("active"),this.clearAllInputFields(),this.updateConfigList())}clearAllInputFields(){const e=document.getElementById("current-config-title");if(e){e.parentNode.querySelectorAll(".config-title-input").forEach(e=>e.remove()),e.style.display="block"}document.querySelectorAll(".config-item").forEach(e=>{const t=e.querySelector(".config-item-name");if(t){t.parentNode.querySelectorAll('input[type="text"]').forEach(e=>e.remove()),t.style.display="block"}})}initConfigList(){document.getElementById("config-overview")?.classList.contains("active")&&this.updateConfigList(),this.initAdditionalProductsListeners()}showDetailView(e=null){const t=document.getElementById("config-detail-view"),i=document.getElementById("config-overview");if(t&&i){i.classList.remove("active"),t.classList.add("active"),null!==e&&this.loadConfig(e),this.updateDetailView();const s=document.getElementById("delete-current-config");s&&(s.style.display=this.configs.length>=2?"":"none")}}updateDetailView(){const e=this.configs[this.currentConfig];if(!e)return;const t=document.getElementById("current-config-title");t&&(t.textContent=e.name||`Konfiguration #${this.currentConfig+1}`),this.updateCurrentTotalPrice();const i=document.getElementById("delete-current-config");i&&(i.style.display=this.configs.length>=2?"":"none")}updateCurrentTotalPrice(){const e=document.getElementById("current-total-price");if(e){const t={selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?.value||"179"),cellHeight:parseInt(this.hIn?.value||"113"),orientation:this.orV?.checked?"vertical":"horizontal",ulicaModule:document.getElementById("ulica-module")?.checked||!1},i=this.calculateConfigPrice(t);e.textContent=`${i.toFixed(2).replace(".",",")} €`;const s=e.closest(".total-section"),o=s?s.querySelector(".total-subtitle"):null;o&&(o.style.display=n()?"none":"",o.textContent="exkl. MwSt")}}updateConfigList(){this.renderConfigList(),this.updateOverviewTotalPrice(),this.renderAdditionalProducts()}initAutoSaveIndicator(){this.autoSaveTimeout=null}showAutoSaveIndicator(){const e=document.getElementById("auto-save-indicator");if(!e)return;e.classList.remove("hidden");const t=e.querySelector(".save-icon");t&&(t.style.animation="none",t.offsetHeight,t.style.animation="rotate360 0.8s ease-in-out"),this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(()=>{e.classList.add("hidden")},1e3)}updateOverviewTotalPrice(){const e=document.getElementById("overview-total-price");if(!e)return;let t=0;this.configs.forEach(e=>{t+=this.calculateConfigPrice(e)});const i=this.calculateAdditionalProductsPrice();t+=i,e.textContent=`${t.toFixed(2).replace(".",",")} €`;const s=e.closest(".total-section"),o=s?s.querySelector(".total-subtitle"):null;o&&(o.style.display=n()?"none":"",o.textContent="exkl. MwSt")}calculateAdditionalProductsPrice(){let e=0;if(document.getElementById("mc4")?.checked){const t=this.configs.reduce((e,t)=>e+t.selection.flat().filter(e=>e).length,0);e+=Math.ceil(t/30)*a("MC4_Stecker",t)}if(document.getElementById("solarkabel")?.checked){e+=1*a("Solarkabel",1)}if(document.getElementById("holz")?.checked){e+=1*a("Holzunterleger",t.Holzunterleger)}if(document.getElementById("quetschkabelschuhe")?.checked){e+=1*a("Quetschkabelschuhe",1)}const i=document.getElementById("huawei-opti"),s=document.getElementById("brc-opti"),o=document.getElementById("opti-qty");if(i&&s&&o&&(i.checked||s.checked)){const t=s.checked?"BRCOpti":"HuaweiOpti";e+=Math.max(1,parseInt(o.value||"1",10))*a(t,1)}return e}renderAdditionalProducts(){const e=document.getElementById("additional-products-list");if(!e)return;if(e.innerHTML="",document.getElementById("mc4")?.checked){const i=this.configs.reduce((e,t)=>e+t.selection.flat().filter(e=>e).length,0),s=Math.ceil(i/30),o=s*a("MC4_Stecker",i),n=document.createElement("div");n.className="additional-product-item produkt-item",n.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">${s}×</span>\n\t\t\t\t\t\t<div class="item-info">\n\t\t\t\t\t\t\t<span class="item-name">MC4 Stecker</span>\n\t\t\t\t\t\t\t<span class="item-ve">${t.MC4_Stecker} Stück</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="item-price">${o.toFixed(2).replace(".",",")} €</span>\n\t\t\t\t`,e.appendChild(n)}if(document.getElementById("solarkabel")?.checked){const t=1*a("Solarkabel",1),i=document.createElement("div");i.className="additional-product-item produkt-item",i.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">1×</span>\n\t\t\t\t\t\t<div class="item-info">\n\t\t\t\t\t\t\t<span class="item-name">Solarkabel</span>\n\t\t\t\t\t\t\t<span class="item-ve">100 m</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="item-price">${t.toFixed(2).replace(".",",")} €</span>\n\t\t\t\t`,e.appendChild(i)}if(document.getElementById("holz")?.checked){const i=1*a("Holzunterleger",t.Holzunterleger),s=document.createElement("div");s.className="additional-product-item produkt-item",s.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">1×</span>\n\t\t\t\t\t\t<div class="item-info">\n\t\t\t\t\t\t\t<span class="item-name">Unterlegholz für Dachhaken</span>\n\t\t\t\t\t\t\t<span class="item-ve">${t.Holzunterleger} Stück</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="item-price">${i.toFixed(2).replace(".",",")} €</span>\n\t\t\t\t`,e.appendChild(s)}if(document.getElementById("quetschkabelschuhe")?.checked){const i=1*a("Quetschkabelschuhe",1),s=document.createElement("div");s.className="additional-product-item produkt-item",s.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">1×</span>\n\t\t\t\t\t\t<div class="item-info">\n\t\t\t\t\t\t\t<span class="item-name">Quetschkabelschuhe</span>\n\t\t\t\t\t\t\t<span class="item-ve">${t.Quetschkabelschuhe} Stück</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="item-price">${i.toFixed(2).replace(".",",")} €</span>\n\t\t\t\t`,e.appendChild(s)}const i=document.getElementById("huawei-opti"),s=document.getElementById("brc-opti"),o=document.getElementById("opti-qty");if(i&&s&&o&&(i.checked||s.checked)){const t=s.checked?"BRCOpti":"HuaweiOpti",i=Math.max(1,parseInt(o.value||"1",10)),n=i*a(t,1),r=document.createElement("div");r.className="additional-product-item produkt-item",r.innerHTML=`\n\t\t\t\t\t<div class="item-left">\n\t\t\t\t\t\t<span class="item-quantity">${i}×</span>\n\t\t\t\t\t\t<div class="item-info">\n\t\t\t\t\t\t\t<span class="item-name">${d[t]||t}</span>\n\t\t\t\t\t\t\t<span class="item-ve">1 Stück</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="item-price">${n.toFixed(2).replace(".",",")} €</span>\n\t\t\t\t`,e.appendChild(r)}}initAdditionalProductsListeners(){["mc4","solarkabel","holz","quetschkabelschuhe","huawei-opti","brc-opti","opti-qty"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{this.updateOverviewTotalPrice(),this.renderAdditionalProducts(),this.saveToCache?.()})});const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty"),s=()=>{e&&t&&i&&(i.style.display=e.checked||t.checked?"":"none",this.renderAdditionalProducts(),this.updateOverviewTotalPrice(),this.saveToCache?.())};e&&(e.addEventListener("click",()=>{e.checked&&t&&(t.checked=!1),s()}),e.addEventListener("change",s)),t&&(t.addEventListener("click",()=>{t.checked&&e&&(e.checked=!1),s()}),t.addEventListener("change",s)),i&&i.addEventListener("input",()=>{s()}),s()}editConfigName(){const e=document.getElementById("current-config-title");if(!e)return;e.parentNode.querySelectorAll(".config-title-input").forEach(e=>e.remove()),e.style.display="block";const t=document.createElement("input");t.type="text",t.value=e.textContent,t.className="config-title-input",t.style.cssText="\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 0;\n\t\t\t\tleft: 0;\n\t\t\t\tfont-size: 24px;\n\t\t\t\tfont-weight: bold;\n\t\t\t\tcolor: #000000;\n\t\t\t\tbackground: white;\n\t\t\t\tborder: 2px solid #FFB101;\n\t\t\t\tborder-radius: 8px;\n\t\t\t\tpadding: 4px 8px;\n\t\t\t\twidth: 200px;\n\t\t\t\toutline: none;\n\t\t\t\tz-index: 1000;\n\t\t\t",e.parentNode.appendChild(t),t.focus(),t.select();const i=function(){const i=t.value.trim();i&&null!==this.currentConfig&&(this.configs[this.currentConfig].name=i,e.textContent=i,this.updateConfigList(),this.updateConfig(),this.saveToCache(),this.showAutoSaveIndicator()),t.remove()}.bind(this),s=function(){t.remove()}.bind(this);t.addEventListener("blur",i),t.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),i()):"Escape"===e.key&&(e.preventDefault(),s())})}editConfigNameInList(e){const t=this.configs[e];if(!t)return;const i=document.querySelectorAll(".config-item")[e];if(!i)return;const s=i.querySelector(".config-item-name");if(!s)return;s.parentNode.querySelectorAll('input[type="text"]').forEach(e=>e.remove()),s.style.display="block";const o=document.createElement("input");o.type="text",o.value=s.textContent,o.className="inline-edit-input",s.appendChild(o),["click","mousedown","pointerdown"].forEach(e=>{o.addEventListener(e,e=>e.stopPropagation())}),o.focus(),o.select();const n=function(){const e=o.value.trim();e&&(t.name=e,s.textContent=e,this.updateConfig(),this.saveToCache(),this.showAutoSaveIndicator()),o.parentNode&&o.remove(),this.updateConfigList()}.bind(this),r=function(){o.parentNode&&o.remove()}.bind(this);o.addEventListener("blur",n),o.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),n()):"Escape"===e.key&&(e.preventDefault(),r())})}deleteCurrentConfig(){if(this.configs.length<=1)return void alert("Die letzte Konfiguration kann nicht gelöscht werden.");const e=this.configs[this.currentConfig],t=e?.name||`Konfiguration #${this.currentConfig+1}`;confirm(`Möchten Sie "${t}" wirklich löschen?`)&&(this.configs.splice(this.currentConfig,1),this.currentConfig>=this.configs.length&&(this.currentConfig=this.configs.length-1),this.loadConfig(this.currentConfig),this.saveToUrl(),this.showOverview())}deleteConfigFromList(e){if(this.configs.length<=1)return void alert("Die letzte Konfiguration kann nicht gelöscht werden.");const t=this.configs[e];confirm(`Möchten Sie "${t?.name||`Konfiguration #${e+1}`}" wirklich löschen?`)&&(this.configs.splice(e,1),this.currentConfig>=this.configs.length?this.currentConfig=this.configs.length-1:this.currentConfig>e&&this.currentConfig--,this.loadConfig(this.currentConfig),this.saveToUrl(),this.updateConfigList()),event.stopPropagation()}calculateConfigPrice(e){const i={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0,UlicaSolarBlackJadeFlow:0,SolarmodulPalette:0,UlicaSolarBlackJadeFlowPalette:0};for(let t=0;t<e.rows;t++){if(!Array.isArray(e.selection[t]))continue;let s=0;for(let o=0;o<e.cols;o++)e.selection[t]?.[o]?s++:s&&(this.processGroupDirectly(s,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1),s=0);s&&this.processGroupDirectly(s,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1)}const s=document.getElementById("include-modules")?.checked||!1,o=document.getElementById("ulica-module")?.checked||!1;s||delete i.Solarmodul,o||delete i.UlicaSolarBlackJadeFlow;try{const e=o?"UlicaSolarBlackJadeFlow":"Solarmodul",t=o?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",s=Number(i[e]||0);if(s>0){const o=Math.floor(s/36),n=s%36;o>0&&(i[t]=(i[t]||0)+36*o),i[e]=n}}catch(e){}let n=0;return Object.entries(i).forEach(([e,i])=>{if(i>0){const s=Math.ceil(i/(t[e]||1)),o=a(e,i);n+=s*o}}),n}addAllConfigsToCart(){this.addAllToCart()}initSmartConfigFeatures(){console.log("Initializing Smart Config Features..."),this.smartParser=new f(this),this.bulkSelector=new b(this),this.bulkSelector.initializeBulkSelection(),this.ensurePermanentVisibility(),this.initSmartConfigCloseButton(),this.initQuickConfigInterface(),console.log("Smart Config Features initialized")}ensurePermanentVisibility(){setTimeout(()=>{const e=document.querySelector(".usage-tips");e&&(e.style.display="block",e.classList.remove("hidden"));document.querySelectorAll(".smart-config-container").forEach(e=>{e.style.display="flex",e.classList.remove("hidden")}),localStorage.removeItem("solarTool_hideHelp"),localStorage.removeItem("solarTool_hideSmartConfig")},100)}checkAndHideHelp(){}initSmartConfigCloseButton(){setTimeout(()=>{const e=document.getElementById("smart-config-close"),t=document.querySelector(".smart-config-container");e&&t&&e.addEventListener("click",()=>{})},600)}initQuickConfigInterface(){const e=()=>{const t=document.getElementById("quick-config-input");if(!t)return console.warn("Smart Config Input Element nicht gefunden, versuche erneut..."),void setTimeout(e,100);console.log("Smart Config Interface initialisiert (ohne Button)");const i=t.cloneNode(!0);t.parentNode.replaceChild(i,t);const s=e=>{if(e&&e.trim())try{console.log("Smart Config Input:",e),this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null);const t=this.smartParser.parseInput(e);console.log("Parsed config:",t),Object.keys(t).length>0?(this.smartParser.applyPreviewToMainGrid(t),i.value="",this.showToast("✅ Konfiguration angewendet",1500)):this.showToast("⚠️ Keine gültige Konfiguration erkannt",2e3)}catch(e){console.error("Smart Config Error:",e),this.showToast(`❌ Fehler: ${e.message}`,3e3)}};i.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),s(i.value))}),i.addEventListener("blur",()=>{setTimeout(()=>{const e=i.value.trim();e&&s(e)},100)}),i.addEventListener("input",e=>{const t=e.target.value.trim();if(this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null),this.updateInputValidation(i,t),t.length>0)try{const e=this.smartParser.parseInput(t);if(e.cols||e.rows||e.moduleCount||e.orientation||e.adjustSpacing||e.rowConfig||e.action){this.showConfigPreview(e);const t=this;this.previewTimeout=setTimeout(()=>{t&&t.clearGridPreview&&(Object.keys(e).length>0&&(t.smartParser.applyPreviewToMainGrid(e),i.value="",t.showToast("✅ Konfiguration automatisch angewendet",1500)),t.clearGridPreview())},2e3)}else this.clearGridPreview()}catch(e){console.error("Smart Config Preview Error:",e),this.clearGridPreview()}else this.clearGridPreview()}),this.initializeSmartConfigHelp()};setTimeout(e,100),setTimeout(e,500),setTimeout(e,1e3),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",()=>{setTimeout(e,100)})}updateInputValidation(e,t){e.classList.remove("input-valid","input-invalid","input-loading"),0!==t.length&&(e.classList.add("input-loading"),setTimeout(()=>{try{const i=this.smartParser.parseInput(t);console.log("Input validation result:",i),i.cols||i.rows||i.moduleCount||i.orientation||i.adjustSpacing||i.rowConfig||i.action?(e.classList.remove("input-loading"),e.classList.add("input-valid"),console.log("Input is valid")):(e.classList.remove("input-loading"),e.classList.add("input-invalid"),console.log("Input is invalid"))}catch(t){console.error("Input validation error:",t),e.classList.remove("input-loading"),e.classList.add("input-invalid")}},100))}showConfigPreview(e){if(console.log("Showing config preview:",e),e.cols||e.rows||e.moduleCount||e.orientation||e.adjustSpacing||e.rowConfig||e.selectRows||e.gapRows||e.selectColumns||e.gapColumns||e.selectAreaRows||e.selectAreaCols||e.fillOnlyFrame||e.clearFrame||e.fillLeftHalf||e.clearRightHalf||e.everySecondRowsStart||e.clearTopRow||e.clearBottomRow||e.fillFirstNColumns||e.clearFirstNColumns||e.clearLastNColumns||e.fillFirstNRows||e.clearFirstNRows||e.fillLastNRows||e.clearLastNRows||e.fillBlock||e.fillBlockRelative)if(this&&"function"==typeof this.showGridPreview)try{this.showGridPreview(e),console.log("Grid preview shown successfully")}catch(e){console.error("Error showing grid preview:",e)}else console.error("showGridPreview method not available!");else console.log("No grid-affecting config found, skipping preview")}initializeSmartConfigHelp(){const e=document.getElementById("smart-help-trigger"),t=document.getElementById("smart-help-dropdown");if(!e||!t)return;let i=!1,s=null;const o=()=>{t.style.opacity="0",t.style.visibility="hidden",t.style.transform="translateY(-10px)"};e.addEventListener("mouseenter",()=>{i=!0,s&&clearTimeout(s),t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"}),e.addEventListener("mouseleave",()=>{i=!1,s=setTimeout(()=>{i||o()},100)}),t.addEventListener("mouseenter",()=>{i=!0,s&&clearTimeout(s)}),t.addEventListener("mouseleave",()=>{i=!1,s=setTimeout(()=>{i||o()},100)}),t.addEventListener("click",e=>{e.stopPropagation()}),document.querySelectorAll(".example").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=document.getElementById("quick-config-input");if(i){if(i.value=e.textContent.replace(/"/g,""),i.focus(),i.value.length>3)try{const e=this.smartParser.parseInput(i.value);this.showConfigPreview(e)}catch(e){}setTimeout(()=>{i.scrollIntoView({behavior:"smooth",block:"center"})},100)}})})}setup(){if(this.cols&&this.rows||(this.cols=this.default.cols,this.rows=this.default.rows),this.cols&&this.rows){if(!Array.isArray(this.selection)||this.selection.length!==this.rows||this.selection[0]?.length!==this.cols){const e=this.selection;this.selection=Array.from({length:this.rows},(t,i)=>Array.from({length:this.cols},(t,s)=>e?.[i]?.[s]||!1))}this.listHolder&&(this.listHolder.style.display="block"),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSaveButtons()}else alert("Spalten und Zeilen müssen > 0 sein")}setupAllEventListeners(){[this.wIn,this.hIn].filter(e=>e).forEach(e=>{e.removeEventListener("change",this.handleInputChange),e.addEventListener("change",this.handleInputChange.bind(this))}),this.moduleSelect&&(this.moduleSelect.removeEventListener("change",this.handleModuleSelectChange),this.moduleSelect.addEventListener("change",this.handleModuleSelectChange.bind(this))),this.orH&&this.orV&&([this.orH,this.orV].forEach(e=>{e.removeEventListener("change",this.handleOrientationChange),e.addEventListener("change",this.handleOrientationChange.bind(this))}),setTimeout(()=>{this.syncOrientationButtons()},10)),[this.incM,this.mc4,this.solarkabel,this.holz,this.quetschkabelschuhe,this.erdungsband,this.ulicaModule].filter(e=>e).forEach(e=>{e.removeEventListener("change",this.handleCheckboxChange),e.addEventListener("change",this.handleCheckboxChange.bind(this))}),document.querySelectorAll("#include-modules, #ulica-module").forEach(e=>{e.removeEventListener("change",this.handleCheckboxChange),e.addEventListener("change",this.handleCheckboxChange.bind(this))}),this.boundExpansionClick||(this.boundExpansionClick=this.handleExpansionClick.bind(this)),document.querySelectorAll('[data-dir="right"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)}),document.querySelectorAll('[data-dir="left"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)}),document.querySelectorAll('[data-dir="top"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)}),document.querySelectorAll('[data-dir="bottom"]').forEach(e=>{e.removeEventListener("click",this.boundExpansionClick),e.addEventListener("click",this.boundExpansionClick)});const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t?(this.boundOrientationClick||(this.boundOrientationClick=this.handleOrientationButtonClick.bind(this)),[e,t].forEach(e=>{e.removeEventListener("click",this.boundOrientationClick),e.addEventListener("click",this.boundOrientationClick)}),this.syncOrientationButtons()):setTimeout(()=>{const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t&&(this.boundOrientationClick||(this.boundOrientationClick=this.handleOrientationButtonClick.bind(this)),[e,t].forEach(e=>{e.removeEventListener("click",this.boundOrientationClick),e.addEventListener("click",this.boundOrientationClick)}),this.syncOrientationButtons())},50)}ensureOrientationButtonsSync(){const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");if(!(e&&t&&this.orH&&this.orV))return;const i=t.classList.contains("active"),s=e.classList.contains("active"),o=this.orV.checked,n=this.orH.checked;i===o&&s===n||this.syncOrientationButtons()}handleModuleSelectChange(){this.trackInteraction();const e=this.moduleSelect.value;if(""===e||"custom"===e)this.enableInputs(),this.updateSize(),this.buildList(),this.updateSummaryOnChange(),this.clearModuleCheckboxes();else if(this.moduleData[e]){const t=this.moduleData[e];this.wIn.value=t.width,this.hIn.value=t.height,null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=t.width,this.configs[this.currentConfig].cellHeight=t.height),this.disableInputs(),this.updateSize(),this.buildList(),this.updateSummaryOnChange(),this.clearModuleCheckboxes()}}handleModuleCheckboxChange(e){this.trackInteraction(),"include-modules"===e&&this.incM.checked?(this.ulicaModule&&(this.ulicaModule.checked=!1),this.moduleSelect&&(this.moduleSelect.value="ulica-450",this.wIn&&(this.wIn.value="176.2"),this.hIn&&(this.hIn.value="113.4"),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=176.2,this.configs[this.currentConfig].cellHeight=113.4),this.disableInputs())):"ulica-module"===e&&this.ulicaModule.checked&&(this.incM&&(this.incM.checked=!1),this.moduleSelect&&(this.moduleSelect.value="ulica-500",this.wIn&&(this.wIn.value="195.2"),this.hIn&&(this.hIn.value="113.4"),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].cellWidth=195.2,this.configs[this.currentConfig].cellHeight=113.4),this.disableInputs())),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange(),this.updateConfig(),this.updateAllConfigurationsForCheckboxes()}clearModuleCheckboxes(){this.incM&&(this.incM.checked=!1),this.ulicaModule&&(this.ulicaModule.checked=!1)}handleInputChange(){this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange()}handleOrientationChange(){this.trackInteraction(),this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}handleCheckboxChange(){this.trackInteraction();const e=event.target.id;"include-modules"===e||"ulica-module"===e?this.handleModuleCheckboxChange(e):this.updateAllConfigurationsForCheckboxes()}handleExpansionClick(e){this.trackInteraction();const t=e.target.dataset.dir,i=e.target.classList.contains("plus-btn");"right"===t?i?this.addColumnRight():this.removeColumnRight():"left"===t?i?this.addColumnLeft():this.removeColumnLeft():"top"===t?i?this.addRowTop():this.removeRowTop():"bottom"===t&&(i?this.addRowBottom():this.removeRowBottom())}handleOrientationButtonClick(e){const t=document.getElementById("orient-h"),i=document.getElementById("orient-v");if(!t||!i)return;if(this.orientationProcessing)return;this.orientationProcessing=!0;const s=e.currentTarget||e.target,o=s===i;t.classList.remove("active"),i.classList.remove("active"),s&&s.classList&&s.classList.add("active"),this.orV&&(this.orV.checked=o),this.orH&&(this.orH.checked=!o),this.trackInteraction(),this.updateSize(),this.buildGrid(),setTimeout(()=>{this.buildList(),this.updateSummaryOnChange(),this.orientationProcessing=!1,this.ensureOrientationButtonsSync()},10)}syncOrientationButtons(){const e=document.getElementById("orient-h"),t=document.getElementById("orient-v");e&&t&&this.orH&&this.orV&&(e.classList.remove("active"),t.classList.remove("active"),this.orV.checked?t.classList.add("active"):this.orH.checked?e.classList.add("active"):(this.orV.checked=!0,this.orH.checked=!1,t.classList.add("active")))}disableInputs(){this.wIn&&(this.wIn.disabled=!0,this.wIn.style.backgroundColor="#f0f0f0",this.wIn.style.cursor="not-allowed"),this.hIn&&(this.hIn.disabled=!0,this.hIn.style.backgroundColor="#f0f0f0",this.hIn.style.cursor="not-allowed")}enableInputs(){this.wIn&&(this.wIn.disabled=!1,this.wIn.style.backgroundColor="",this.wIn.style.cursor=""),this.hIn&&(this.hIn.disabled=!1,this.hIn.style.backgroundColor="",this.hIn.style.cursor="")}updateSaveButtons(){this.saveBtn&&(this.saveBtn.style.display="inline-block")}addColumnRight(){this.cols+=1;for(let e of this.selection)e.push(!1);this.updateGridAfterStructureChange()}removeColumnRight(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.pop();this.updateGridAfterStructureChange()}}addColumnLeft(){this.cols+=1;for(let e of this.selection)e.unshift(!1);this.updateGridAfterStructureChange()}removeColumnLeft(){if(!(this.cols<=1)){this.cols-=1;for(let e of this.selection)e.shift();this.updateGridAfterStructureChange()}}addRowBottom(){this.rows+=1,this.selection.push(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowBottom(){this.rows<=1||(this.rows-=1,this.selection.pop(),this.updateGridAfterStructureChange())}addRowTop(){this.rows+=1,this.selection.unshift(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowTop(){this.rows<=1||(this.rows-=1,this.selection.shift(),this.updateGridAfterStructureChange())}updateGridAfterStructureChange(){this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}updateSize(){parseFloat(getComputedStyle(document.documentElement).fontSize);const e=parseFloat(this.wIn?this.wIn.value:"179")||179,t=parseFloat(this.hIn?this.hIn.value:"113")||113,i=!!this.orV&&this.orV.checked,s=i?t:e,o=i?e:t,n=this.wrapper?this.wrapper.clientWidth-160:800,r=this.wrapper?this.wrapper.clientHeight-160:600,l=n/(this.cols*s+2*(this.cols-1)),a=r/(this.rows*o+2*(this.rows-1)),c=Math.min(l,a,1),d=s*c,h=o*c,u=this.cols>=15||this.rows>=10?0:2*c;document.documentElement.style.setProperty("--cell-size",d+"px"),document.documentElement.style.setProperty("--cell-width",d+"px"),document.documentElement.style.setProperty("--cell-height",h+"px"),document.documentElement.style.setProperty("--cell-gap",u+"px");const m=Math.min(this.cols*d+(this.cols-1)*u,n),g=Math.min(this.rows*h+(this.rows-1)*u,r);this.gridEl&&(this.gridEl.style.width=m+"px",this.gridEl.style.height=g+"px")}buildGrid(){if(!Array.isArray(this.selection))return;const e=document.createDocumentFragment();document.documentElement.style.setProperty("--cols",this.cols),document.documentElement.style.setProperty("--rows",this.rows);for(let t=0;t<this.rows;t++)if(Array.isArray(this.selection[t]))for(let i=0;i<this.cols;i++){const s=document.createElement("div");s.className="grid-cell",this.selection[t]?.[i]&&s.classList.add("selected"),s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.setAttribute("aria-label",`Modul ${i+1}, ${t+1} - ${this.selection[t]?.[i]?"ausgewählt":"nicht ausgewählt"}`),s.setAttribute("aria-pressed",this.selection[t]?.[i]?"true":"false"),s.addEventListener("click",()=>{this.selection[t]||(this.selection[t]=[]),this.selection[t][i]=!this.selection[t][i],s.classList.toggle("selected"),s.setAttribute("aria-pressed",this.selection[t][i]?"true":"false"),s.setAttribute("aria-label",`Modul ${i+1}, ${t+1} - ${this.selection[t][i]?"ausgewählt":"nicht ausgewählt"}`),null!==this.currentConfig&&this.configs[this.currentConfig]&&(this.configs[this.currentConfig].selection=this.selection,this.updateConfig()),this.trackInteraction(),this.buildList(),this.updateSummaryOnChange(),null!==this.currentConfig&&this.updateConfigList()}),s.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),s.click())}),e.appendChild(s)}this.gridEl.innerHTML="",this.gridEl.appendChild(e)}async buildList(){try{this.selection.flat().filter(e=>e).length;const e={selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?.value||"179"),cellHeight:parseInt(this.hIn?.value||"113"),orientation:this.orV?.checked?"vertical":"horizontal",ulicaModule:document.getElementById("ulica-module")?.checked||!1},i={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0,UlicaSolarBlackJadeFlow:0};for(let t=0;t<e.rows;t++){if(!Array.isArray(e.selection[t]))continue;let s=0;for(let o=0;o<e.cols;o++)e.selection[t]?.[o]?s++:s&&(this.processGroupDirectly(s,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1),s=0);s&&this.processGroupDirectly(s,i,e.cellWidth||179,e.cellHeight||113,e.orientation||"vertical",e.ulicaModule||!1)}const s=document.getElementById("include-modules")?.checked||!1,o=document.getElementById("ulica-module")?.checked||!1;s||delete i.Solarmodul,o||delete i.UlicaSolarBlackJadeFlow,this.erdungsband&&this.erdungsband.checked?i.Erdungsband=this.calculateErdungsband():delete i.Erdungsband;try{const e=o?"UlicaSolarBlackJadeFlow":"Solarmodul",t=o?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",s=Number(i[e]||0);if(s>0){const o=Math.floor(s/36),n=s%36;o>0&&(i[t]=(i[t]||0)+36*o),i[e]=n}}catch(e){}const n=Object.entries(i).filter(([,e])=>e>0);if(!n.length)return void(this.listHolder&&(this.listHolder.style.display="none"));if(this.listHolder&&(this.listHolder.style.display="block"),this.prodList){const e=document.createDocumentFragment();n.forEach(([i,s])=>{const o=Math.ceil(s/t[i]),n=o*a(i,s),r=document.createElement("div");r.className="produkt-item";let l=`(${s})`,c=`${t[i]} Stück`;"Erdungsband"===i&&this.erdungsbandtotal&&(l=`(${Number(this.erdungsbandtotal).toFixed(2)} cm)`,c="600 cm"),"Solarkabel"===i&&(c="100 m"),"MC4_Stecker"===i&&(c=`${t[i]} Stück`),r.innerHTML=`\n            <div class="item-left">\n              <span class="item-quantity">${o}×</span>\n              <div class="item-info">\n                <span class="item-name">${d[i]||i.replace(/_/g," ")}</span>\n                <span class="item-ve">${c}</span>\n              </div>\n              <span class="item-details">${l}</span>\n            </div>\n            <span class="item-price">${n.toFixed(2).replace(".",",")} €</span>\n          `,e.appendChild(r)}),this.prodList.innerHTML="",this.prodList.appendChild(e),this.prodList.style.display="block"}}catch(e){this.listHolder&&(this.listHolder.style.display="none")}}resetGridToDefault(){const{cols:e,rows:t,width:i,height:s}=this.default;this.wIn.value=i,this.hIn.value=s;const o=!0;this.orH&&(this.orH.checked=!1),this.orV&&(this.orV.checked=o);const n=document.getElementById("orient-h-setup"),r=document.getElementById("orient-v-setup");n&&r&&(n.checked=!1,r.checked=o),this.incM&&(this.incM.checked=!1),this.mc4&&(this.mc4.checked=!1),this.solarkabel&&(this.solarkabel.checked=!1),this.holz&&(this.holz.checked=!1),this.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=!1),this.erdungsband&&(this.erdungsband.checked=!1),this.ulicaModule&&(this.ulicaModule.checked=!1);try{const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty");e&&(e.checked=!1,e.dispatchEvent(new Event("change"))),t&&(t.checked=!1,t.dispatchEvent(new Event("change"))),i&&(i.value="1")}catch(e){}this.moduleSelect&&(this.moduleSelect.value="",this.enableInputs()),this.cols=e,this.rows=t,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}resetToDefaultGrid(){this.colsIn&&(this.colsIn.value=this.default.cols),this.rowsIn&&(this.rowsIn.value=this.default.rows),this.wIn&&(this.wIn.value=this.default.width),this.hIn&&(this.hIn.value=this.default.height),this.orH&&(this.orH.checked=!1),this.orV&&(this.orV.checked=!0),this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup()}async calculateParts(){return this.calculatePartsSync()}calculatePartsSync(){const e={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0,Erdungsband:0};for(let t=0;t<this.rows;t++){if(!Array.isArray(this.selection[t]))continue;let i=0;for(let s=0;s<this.cols;s++)this.selection[t]?.[s]?i++:i&&(this.processGroup(i,e),i=0);i&&this.processGroup(i,e)}return this.erdungsband&&this.erdungsband.checked&&(e.Erdungsband=this.calculateErdungsband()),e}processGroup(e,t){const i=this.orV?.checked,s=e*(i?parseFloat(this.hIn?.value||"113"):parseFloat(this.wIn?.value||"179")),o=Math.floor(s/360),n=s-360*o,r=[{cnt360:o,cnt240:Math.ceil(n/240)},{cnt360:Math.ceil(s/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(s/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-s})),l=Math.min(...r.map(e=>e.rails)),a=r.filter(e=>e.rails===l).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:c,cnt240:d}=a;t.Schiene_360_cm+=2*c,t.Schiene_240_cm+=2*d,t.Schienenverbinder+=4*(c+d-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,this.ulicaModule&&this.ulicaModule.checked&&(t.UlicaSolarBlackJadeFlow+=e),t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}mapImage(e){return h[e]||""}calculateErdungsband(){const e=this.orV?.checked,t=e?parseFloat(this.wIn?.value||"179"):parseFloat(this.hIn?.value||"113"),i=this.selection.map(e=>[...e]);let s=0;for(let e=0;e<this.rows;e++)for(let o=0;o<this.cols;o++){s+=this.analyzeFieldForErdungsband(o,e,i,t,2)}return this.erdungsbandtotal=s,Math.ceil(s/600)}analyzeFieldForErdungsband(e,t,i,s,o){return i[t]?.[e]?t+1>=this.rows||!i[t+1]?.[e]?0:0!==e&&i[t]?.[e-1]?t+1>=this.rows||!i[t+1]?.[e-1]?this.assignErdungsbandLength(e,t,i,s,o):this.checkLeftFieldsErdungsband(e,t,i,s,o):this.assignErdungsbandLength(e,t,i,s,o):0}checkLeftFieldsErdungsband(e,t,i,s,o){const n=i[t]?.[e-1],r=i[t+1]?.[e-1];return n&&r?"erdungsband"===n&&"erdungsband"===r?0:"erdungsband"===n&&"erdungsband"!==r?this.assignErdungsbandLength(e,t,i,s,o):this.checkLeftFieldsRecursive(e,t,i,s,o):this.assignErdungsbandLength(e,t,i,s,o)}checkLeftFieldsRecursive(e,t,i,s,o){let n=e-2;for(;n>=0;){if(!i[t]?.[n])return this.assignErdungsbandLength(e,t,i,s,o);if(t+1>=this.rows||!i[t+1]?.[n])return this.assignErdungsbandLength(e,t,i,s,o);const r=i[t]?.[n],l=i[t+1]?.[n];if("erdungsband"===r&&"erdungsband"===l)return 0;if("erdungsband"===r&&"erdungsband"!==l)return this.assignErdungsbandLength(e,t,i,s,o);n--}return this.assignErdungsbandLength(e,t,i,s,o)}assignErdungsbandLength(e,t,i,s,o){return"erdungsband"===i[t][e]?(i[t+1][e]="erdungsband",s+o):(i[t][e]="erdungsband",i[t+1][e]="erdungsband",2*s+o)}loadConfig(e){const t=this.configs[e];this.currentConfig=e,this.wIn.value=t.cellWidth,this.hIn.value=t.cellHeight,this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.syncOrientationButtons(),this.incM.checked=t.incM,this.mc4.checked=t.mc4,this.solarkabel.checked=t.solarkabel||!1,this.holz.checked=t.holz,this.quetschkabelschuhe.checked=t.quetschkabelschuhe||!1,this.erdungsband&&(this.erdungsband.checked=t.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=t.ulicaModule||!1),this.cols=t.cols,this.rows=t.rows,this.selection=t.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView()}loadConfigFromCache(e){const t=this.configs[e];this.currentConfig=e,this.wIn.value=t.cellWidth,this.hIn.value=t.cellHeight,this.orV&&this.orH&&"string"==typeof t.orientation&&(this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.syncOrientationButtons?.()),this.incM.checked=t.incM,this.mc4.checked=t.mc4,this.solarkabel.checked=t.solarkabel||!1,this.holz.checked=t.holz,this.quetschkabelschuhe.checked=t.quetschkabelschuhe||!1,this.erdungsband&&(this.erdungsband.checked=t.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=t.ulicaModule||!1),this.cols=t.cols,this.rows=t.rows,this.selection=t.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView()}loadFirstConfigFromCache(){if(0===this.configs.length)return;const e=this.configs[0];this.currentConfig=0,this.wIn.value=e.cellWidth,this.hIn.value=e.cellHeight,this.orV&&this.orH&&"string"==typeof e.orientation&&(this.orV.checked="vertical"===e.orientation,this.orH.checked=!this.orV.checked,this.syncOrientationButtons?.()),this.incM.checked=e.incM,this.mc4.checked=e.mc4,this.solarkabel.checked=e.solarkabel||!1,this.holz.checked=e.holz,this.quetschkabelschuhe.checked=e.quetschkabelschuhe||!1,this.erdungsband&&(this.erdungsband.checked=e.erdungsband||!1),this.ulicaModule&&(this.ulicaModule.checked=e.ulicaModule||!1),this.cols=e.cols,this.rows=e.rows,this.selection=e.selection.map(e=>[...e]),this.setup(),this.buildList(),this.updateSummaryOnChange(),this.renderConfigList(),this.updateSaveButtons(),this.updateDetailView()}updateFirstConfigOrientation(e){this.configs.length>0&&(this.configs[0].orientation=e)}showToast(e="Gespeichert",t=1500){const i=document.getElementById("toast");i&&(i.textContent=e,i.classList.remove("hidden"),clearTimeout(this.toastTimeout),this.toastTimeout=setTimeout(()=>{i.classList.add("hidden")},t))}saveNewConfig(e=null){null!==this.currentConfig&&this.updateConfig(),this.currentConfig=null,this.default&&(this.cols=this.default.cols,this.rows=this.default.rows,this.wIn&&(this.wIn.value=this.default.width),this.hIn&&(this.hIn.value=this.default.height)),this.orH&&this.orV&&(this.orH.checked=!1,this.orV.checked=!0,this.syncOrientationButtons?.());const t=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1));this.selection;this.selection=t;const i=this._makeConfigObject(e);this.configs.push(i),this.currentConfig=this.configs.length-1,this.setup(),this.showDetailView(this.currentConfig),this.renderConfigList(),this.updateConfigList(),this.updateSaveButtons(),this.updateDetailView(),this.showToast(`Neue Konfiguration "${i.name}" erstellt`)}renameCurrentConfig(e){if(null!==this.currentConfig&&this.currentConfig>=0&&this.currentConfig<this.configs.length){this.configs[this.currentConfig].name=e;const t=document.getElementById("current-config-title");if(t&&(t.textContent=e),this.configListEl){const t=this.configListEl.querySelectorAll(".config-item");if(t&&t[this.currentConfig]){const i=t[this.currentConfig].querySelector(".config-item-name");i&&(i.textContent=e)}}this.renderConfigList(),this.updateSaveButtons(),this.updateConfig(),this.saveToCache(),this.showAutoSaveIndicator()}}updateConfig(){const e=this.currentConfig;this.configs[e]=this._makeConfigObject(),this.renderConfigList(),this.updateSaveButtons()}deleteConfig(e){const t=this.configs[e].name;if(confirm(`Willst du "${t}" wirklich löschen?`)){if(this.configs.splice(e,1),this.configs.length>0)if(e===this.currentConfig){const t=Math.min(e,this.configs.length-1);this.loadConfig(t)}else e<this.currentConfig?(this.currentConfig--,this.renderConfigList()):this.renderConfigList();else this.createNewConfig();this.updateSaveButtons()}}createNewConfig(){this.currentConfig=null,this.resetGridToDefault();const e=this._makeConfigObject();this.configs.push(e),this.currentConfig=this.configs.length-1,this.renderConfigList(),this.updateSaveButtons()}_makeConfigObject(e=null){let t;if(e)t=e;else if(null!==this.currentConfig)t=this.configs[this.currentConfig].name;else{let e=1;for(;this.configs.some(t=>t.name===`Konfiguration ${e}`);)e++;t=`Konfiguration ${e}`}return{name:t,selection:this.selection.map(e=>[...e]),orientation:null===this.currentConfig||this.orV&&this.orV.checked?"vertical":"horizontal",incM:this.incM&&this.incM.checked,mc4:this.mc4&&this.mc4.checked,solarkabel:this.solarkabel&&this.solarkabel.checked,holz:this.holz&&this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked,cols:this.cols,rows:this.rows,cellWidth:parseFloat(this.wIn?this.wIn.value:"179"),cellHeight:parseFloat(this.hIn?this.hIn.value:"113")}}renderConfigList(){this.configListEl.innerHTML="",this.configs.forEach((e,t)=>{const i=document.createElement("div");i.className="config-item"+(t===this.currentConfig?" active":"");const s=this.calculateConfigPrice(e),o=this.configs.length>=2;i.innerHTML=`\n          <div class="config-item-info">\n            <div class="config-item-name">${e.name||`Konfiguration #${t+1}`}</div>\n            <div class="config-item-price">${s.toFixed(2).replace(".",",")} €</div>\n          </div>\n          <div class="config-item-actions">\n            <button class="icon-btn" onclick="solarGrid.editConfigNameInList(${t})" title="Bearbeiten">\n              <img src="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/689369877a18221f25a4b743_Pen.png" alt="Bearbeiten" style="width: 16px; height: 16px;">\n            </button>\n            ${o?`\n            <button class="icon-btn delete" onclick="solarGrid.deleteConfigFromList(${t})" title="Löschen">\n              <img src="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/68936c5481f2a4db850a01f5_Trashbin.png" alt="Löschen" style="width: 16px; height: 16px;">\n            </button>`:""}\n            <div class="config-item-arrow">\n              <img src="https://cdn.prod.website-files.com/68498852db79a6c114f111ef/68936986bd441749c46190e8_ChevronRight.png" alt="Pfeil" style="width: 10px; height: 16px;">\n            </div>\n          </div>\n        `,i.addEventListener("click",e=>{e.target.closest(".config-item-actions")||(null!==this.currentConfig&&this.currentConfig!==t&&this.updateConfig(),this.showDetailView(t),this.showToast("Konfiguration geladen",1e3))}),this.configListEl.appendChild(i)})}arraysEqual(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++){if(e[i].length!==t[i].length)return!1;for(let s=0;s<e[i].length;s++)if(e[i][s]!==t[i][s])return!1}return!0}updateSummaryOnChange(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(async()=>{const e=performance.now();this.showAutoSaveIndicator(),document.getElementById("config-detail-view")?.classList.contains("active")&&this.updateDetailView(),this.updateCurrentTotalPrice(),null!==this.currentConfig&&(this.updateConfig(),this.updateConfigList()),this.saveToCache(),this.performanceMetrics.updateTime=performance.now()-e,this.updateTimeout=null},this.updateDelay)}calculatePartsDirectly(e){const{selection:t,rows:i,cols:s,cellWidth:o,cellHeight:n,orientation:r,options:l}=e,a=!0===l?.ulicaModule,c={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Tellerkopfschraube:0};for(let e=0;e<i;e++){if(!Array.isArray(t[e]))continue;let i=0;for(let l=0;l<s;l++)t[e]?.[l]?i++:i&&(this.processGroupDirectly(i,c,o,n,r,a),i=0);i&&this.processGroupDirectly(i,c,o,n,r,a)}return c}processGroupDirectly(e,t,i,s,o,n=!1){const r=e*("vertical"===o?s:i),l=Math.floor(r/360),a=r-360*l,c=[{cnt360:l,cnt240:Math.ceil(a/240)},{cnt360:Math.ceil(r/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(r/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-r})),d=Math.min(...c.map(e=>e.rails)),h=c.filter(e=>e.rails===d).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:u,cnt240:m}=h;t.Schiene_360_cm+=2*u,t.Schiene_240_cm+=2*m,t.Schienenverbinder+=4*(u+m-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,n&&(t.UlicaSolarBlackJadeFlow+=e),t.Schrauben+=e>1?3*e:4,t.Tellerkopfschraube+=e>1?3*e*2:8}resetAllConfigurations(){if(confirm("Möchten Sie wirklich alle Konfigurationen löschen und von vorne anfangen?")){this.cacheManager.clearCache(),this.configs=[],this.currentConfig=null,this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.buildGrid(),this.wIn&&(this.wIn.value=this.default.width),this.hIn&&(this.hIn.value=this.default.height),this.orH&&this.orV&&(this.orH.checked=!0,this.orV.checked=!1),this.syncOrientationButtons(),this.incM&&(this.incM.checked=!1),this.mc4&&(this.mc4.checked=!1);try{const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),i=document.getElementById("opti-qty");e&&(e.checked=!1),t&&(t.checked=!1),i&&(i.value="1")}catch(e){}this.solarkabel&&(this.solarkabel.checked=!1),this.holz&&(this.holz.checked=!1),this.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=!1),this.erdungsband&&(this.erdungsband.checked=!1),this.ulicaModule&&(this.ulicaModule.checked=!1),this.moduleSelect&&(this.moduleSelect.value="",this.enableInputs()),this.createNewConfig(),this.syncOrientationButtons(),this.updateCurrentTotalPrice(),this.showToast("Alle Konfigurationen wurden zurückgesetzt",2e3)}}saveToCache(){try{const e={configs:this.configs,currentConfig:this.currentConfig,selection:this.selection,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10),orientation:this.orV&&this.orV.checked?"vertical":"horizontal",includeModules:!!this.incM&&this.incM.checked,mc4:!!this.mc4&&this.mc4.checked,solarkabel:!!this.solarkabel&&this.solarkabel.checked,holz:!!this.holz&&this.holz.checked,quetschkabelschuhe:!!this.quetschkabelschuhe&&this.quetschkabelschuhe.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked,huaweiOpti:document.getElementById("huawei-opti")?.checked||!1,brcOpti:document.getElementById("brc-opti")?.checked||!1,optiQty:parseInt(document.getElementById("opti-qty")?.value||"1",10),moduleSelectValue:this.moduleSelect?this.moduleSelect.value:"",gridStructure:{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10)}};this.cacheManager.saveData(e),this.showAutoSaveIndicator()}catch(e){console.error("Fehler beim Speichern des Caches:",e)}}loadFromCache(){try{const e=this.cacheManager.loadData();if(!e)return console.log("Kein Cache gefunden oder Cache abgelaufen"),!1;if(!this.cacheManager.isLocalStorageAvailable())return this.showToast("Es wurde nichts im Speicher gefunden",3e3),!1;if(e.configs&&Array.isArray(e.configs)){this.configs=e.configs,this.currentConfig=e.currentConfig,e.selection&&Array.isArray(e.selection)&&(this.selection=e.selection),e.cols&&e.rows&&(this.cols=e.cols,this.rows=e.rows),this.incM&&"boolean"==typeof e.includeModules&&(this.incM.checked=e.includeModules),this.mc4&&"boolean"==typeof e.mc4&&(this.mc4.checked=e.mc4),this.solarkabel&&"boolean"==typeof e.solarkabel&&(this.solarkabel.checked=e.solarkabel),this.holz&&"boolean"==typeof e.holz&&(this.holz.checked=e.holz),this.quetschkabelschuhe&&"boolean"==typeof e.quetschkabelschuhe&&(this.quetschkabelschuhe.checked=e.quetschkabelschuhe),this.erdungsband&&"boolean"==typeof e.erdungsband&&(this.erdungsband.checked=e.erdungsband),this.ulicaModule&&"boolean"==typeof e.ulicaModule&&(this.ulicaModule.checked=e.ulicaModule);try{const t=document.getElementById("huawei-opti"),i=document.getElementById("brc-opti"),s=document.getElementById("opti-qty");t&&"boolean"==typeof e.huaweiOpti&&(t.checked=e.huaweiOpti),i&&"boolean"==typeof e.brcOpti&&(i.checked=e.brcOpti),s&&"number"==typeof e.optiQty&&(s.value=String(Math.max(1,e.optiQty))),s&&(s.style.display=t&&t.checked||i&&i.checked?"":"none")}catch(e){}this.moduleSelect&&"string"==typeof e.moduleSelectValue&&(this.moduleSelect.value=e.moduleSelectValue,e.moduleSelectValue&&"custom"!==e.moduleSelectValue?this.disableInputs():this.enableInputs()),this.wIn&&e.cellWidth&&(this.wIn.value=e.cellWidth),this.hIn&&e.cellHeight&&(this.hIn.value=e.cellHeight);const t=Number.isInteger(e.currentConfig)&&e.currentConfig>=0&&e.currentConfig<this.configs.length?e.currentConfig:0;return this.configs.length>0&&this.loadConfigFromCache(t),this.setup(),this.buildGrid(),this.buildList(),this.setupAllEventListeners(),this.updateConfigList(),this.updateCurrentTotalPrice(),this.updateOverviewTotalPrice(),this.showToast("Konfiguration aus Cache geladen",2e3),!0}}catch(e){console.error("Fehler beim Laden des Caches:",e),this.cacheManager.clearCache(),this.showToast("Datei im Speicher ist beschädigt und konnte nicht geladen werden!",3e3)}return!1}generateHiddenCartForms(){const e=document.querySelectorAll('form[data-node-type="commerce-add-to-cart-form"]');this.webflowFormMap={},this.webflowFormMapBrutto={},e.forEach(e=>{const t=e.getAttribute("data-commerce-product-id"),i=e.getAttribute("data-commerce-sku-id"),s=Object.keys(c).find(e=>c[e].productId===t||c[e].variantId===i);s&&(this.webflowFormMap[s]=e);const o=Object.keys(l||{}).find(e=>{const s=l[e];return s&&(s.productId===t||s.variantId===i)});o&&(this.webflowFormMapBrutto[o]=e)}),this.hideWebflowForms();try{window.CartCompatibility&&"function"==typeof window.CartCompatibility.schedule&&window.CartCompatibility.schedule(150)}catch(e){}}hideWebflowForms(){document.querySelectorAll('form[data-node-type="commerce-add-to-cart-form"]').forEach(e=>{e&&e.style&&(e.style.cssText="\n            position: absolute !important;\n            left: -9999px !important;\n            top: -9999px !important;\n            width: 1px !important;\n            height: 1px !important;\n            overflow: hidden !important;\n            clip: rect(0, 0, 0, 0) !important;\n            white-space: nowrap !important;\n            border: 0 !important;\n            margin: 0 !important;\n            padding: 0 !important;\n            visibility: hidden !important;\n          ",e.setAttribute("aria-hidden","true"),e.setAttribute("tabindex","-1"))})}initFoxyFormMap(){this.foxyFormsByName=new Map;let e=15;const t=()=>{this.refreshFoxyFormMap(),0===this.foxyFormsByName.size&&e-- >0&&setTimeout(t,300)};t();try{this._foxyObserver&&this._foxyObserver.disconnect()}catch(e){}let i=null;const s=()=>{clearTimeout(i),i=setTimeout(()=>this.refreshFoxyFormMap(),60)};this._foxyObserver=new MutationObserver(e=>{for(const t of e)if(t.addedNodes&&t.addedNodes.length){s();break}}),this._foxyObserver.observe(document.body,{childList:!0,subtree:!0})}refreshFoxyFormMap(){const e=new Map,t=new Map;document.querySelectorAll('form[action*="foxycart.com/cart"]').forEach(i=>{const s=e=>{const t=i.querySelector(e);return t&&"string"==typeof t.value?t.value.trim():""},o=i.querySelector('input[name="name"]'),n=o&&"string"==typeof o.value?o.value.trim():"";n&&(e.set(n,i),t.set(n,{name:n,price:s('input[name="price"]'),code:s('input[name="code"]'),image:s('input[name="image"]'),url:s('input[name="url"]'),description:s('input[name="description"]'),weight:s('input[name="weight"]'),width:s('input[name="width"]'),height:s('input[name="height"]'),length:s('input[name="length"]')}))}),this.foxyFormsByName=e,this.foxyDataByName=t}findFoxyFormByName(e){const t=String(e||"").trim();if(!t)return null;const i=e=>e.replace(/[\u2013\u2014]/g,"-").replace(/\s+/g," ").trim().toLowerCase();if(this.foxyFormsByName&&this.foxyFormsByName.has(t))return this.foxyFormsByName.get(t);try{const e=`form[action*="foxycart.com/cart"] input[name="name"][value="${CSS.escape(t)}"]`,i=document.querySelector(e);if(i)return i.closest("form")}catch(e){}const s=document.querySelectorAll('form[action*="foxycart.com/cart"]'),o=i(t);let n=null;return s.forEach(e=>{const t=e.querySelector('input[name="name"]')?.value;t&&(i(t)!==o||n||(n=e))}),n||(s.forEach(e=>{if(n)return;const t=e.querySelector('input[name="name"]')?.value;t&&i(t).includes(o)&&(n=e)}),n)}addProductToCart(e,i){const s=d[e]||e.replace(/_/g," "),o=this.findFoxyFormByName?this.findFoxyFormByName(s):null;if(!o)try{this._ensureFoxySilentTarget();const o=document.createElement("form");o.action="https://unterkonstruktion.foxycart.com/cart",o.method="POST",o.target="foxy_silent",o.style.position="absolute",o.style.left="-9999px",o.style.top="-9999px";const n=a(e,t[e]||1);return o.innerHTML=`\n            <input type="hidden" name="name" value="${s}">\n            <input type="hidden" name="price" value="${Number(n).toFixed(2)}">\n            <input type="hidden" name="code" value="">\n            <input type="hidden" name="quantity" value="${Math.max(1,parseInt(i,10)||1)}">\n          `,document.body.appendChild(o),o.submit(),void setTimeout(()=>{try{o.remove()}catch(e){}},2e3)}catch(e){return void console.warn(`[SolarGrid] Foxy-Fallback fehlgeschlagen für '${s}':`,e)}try{const e=o.querySelector('input[name="quantity"]');e&&(e.value=Math.max(1,parseInt(i,10)||1));const t=o.querySelector('input[name="customer_type"]');try{const e=localStorage.getItem("solarTool_customerType");if(t&&e){const i=JSON.parse(e),s=i&&i.type?String(i.type):"";s&&(t.value=s)}}catch(e){}const s=o.querySelector("button[data-fc-add-to-cart]")||o.querySelector('button[type="submit"]');"function"==typeof o.requestSubmit?o.requestSubmit(s||void 0):s&&s.click()||o.submit()}catch(e){console.warn("[SolarGrid] Foxy-Submit Fehler:",e)}}_ensureFoxySilentTarget(){try{let e=document.getElementById("foxy_silent");e||(e=document.createElement("iframe"),e.name="foxy_silent",e.id="foxy_silent",e.width="1",e.height="1",e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",e.setAttribute("aria-hidden","true"),e.setAttribute("tabindex","-1"),document.body.appendChild(e))}catch(e){}}clickWebflowButtonSafely(e,t,i,s,o){const n=e.querySelector('input[name="commerce-add-to-cart-quantity-input"]');n&&(n.value=s);try{e.querySelectorAll("select[required]").forEach(e=>{if(!e.value){const t=e.querySelector('option[value]:not([value=""])');t&&(e.value=t.value)}})}catch(e){}t.click()}addPartsListToCart(e){const i=Object.entries(e).filter(([e,t])=>t>0);if(!i.length)return;if(!!document.querySelector('form[action*="foxycart.com/cart"]')){try{this.showLoading("Warenkorb wird vorbereitet…")}catch(e){}const e=e=>{const t="string"==typeof e?e.replace(/[^0-9.,-]/g,"").replace(/,/g,"."):String(e||""),i=parseFloat(t);return Number.isFinite(i)?i.toFixed(2):"0.00"},s=(e,t,i)=>{const s=document.createElement("input");s.type="hidden",s.name=t,s.value=null==i?"":String(i),e.appendChild(s)};try{const o=document.createElement("form");o.action="https://unterkonstruktion.foxycart.com/cart",o.method="POST",o.style.position="absolute",o.style.left="-9999px",o.style.top="-9999px";const n=e=>this.foxyDataByName&&this.foxyDataByName.get(e);try{const e=localStorage.getItem("solarTool_customerType");if(e){const t=JSON.parse(e),i=t&&t.type?String(t.type):"";i&&s(o,"customer_type",i)}}catch(e){}return i.forEach(([i,r])=>{const l=Math.ceil(r/(t[i]||1));if(!l||l<=0)return;const c=d[i]||i.replace(/_/g," "),h=n(c)||{},u=h.price?e(h.price):e(a(i,r));s(o,"name",c),s(o,"price",u),s(o,"code",h.code||""),s(o,"image",h.image||""),s(o,"url",h.url||""),s(o,"description",h.description||""),s(o,"weight",h.weight||""),s(o,"width",h.width||""),s(o,"height",h.height||""),s(o,"length",h.length||""),s(o,"quantity",String(l))}),document.body.appendChild(o),void o.submit()}finally{try{this.hideLoading()}catch(e){}}}const s=i.map(([e,t])=>({key:e,qty:t}));(async()=>{try{await this.ensureCartObservers();for(let e=0;e<s.length;e++){const{key:i,qty:o}=s[e],n=Math.ceil(o/t[i]);await this.addSingleItemAndWait(i,n,e===s.length-1)}}finally{this.showCartContainer(),this.hideLoading(),this.isAddingToCart=!1}})()}async addSingleItemAndWait(e,t,i){const s=!n()&&Object.prototype.hasOwnProperty.call(l,e);let o=null;if(s&&this.webflowFormMapBrutto&&(o=this.webflowFormMapBrutto[e]||null),!o&&this.webflowFormMap&&(o=this.webflowFormMap[e]||null),!o&&(await this.ensureWebflowFormsMapped(),s&&this.webflowFormMapBrutto&&(o=this.webflowFormMapBrutto[e]||null),!o&&this.webflowFormMap&&(o=this.webflowFormMap[e]||null),!o)){const t=function(e){return!n()&&Object.prototype.hasOwnProperty.call(l,e)?l[e]:c[e]}(e);t&&(o=document.querySelector(`[data-commerce-product-id="${t.productId}"]`)||document.querySelector(`[data-commerce-sku-id="${t.variantId}"]`))}if(!o)return void this.showToast(`Produktformular nicht gefunden: ${e}`,2e3);const r=o.querySelector('input[data-node-type="commerce-add-to-cart-button"]');if(!r)return void this.showToast(`Add-to-Cart Button fehlt: ${e}`,2e3);const a=this.waitForCartAcknowledge(1500);this.clickWebflowButtonSafely(o,r,e,t,i),await a}async ensureCartObservers(){if(!this.cartAckObserver){const e=document.querySelector(".w-commerce-commercecartlist")||document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(this.cartAckObserver=new MutationObserver(()=>{if(this.cartAckResolve){const e=this.cartAckResolve;this.cartAckResolve=null,e()}}),this.cartAckObserver.observe(e,{childList:!0,subtree:!0}))}this.webflowFormsObserver||(this.webflowFormsObserver=new MutationObserver(()=>{this.generateHiddenCartForms()}),this.webflowFormsObserver.observe(document.body,{childList:!0,subtree:!0})),await this.ensureWebflowFormsMapped()}waitForCartAcknowledge(e=1500){return new Promise(t=>{let i=!1;const s=setTimeout(()=>{i||(i=!0,this.cartAckResolve===t&&(this.cartAckResolve=null),t())},e);this.cartAckResolve=()=>{i||(i=!0,clearTimeout(s),t())}})}async ensureWebflowFormsMapped(){this.webflowFormMap&&0!==Object.keys(this.webflowFormMap).length&&this.webflowFormMapBrutto||(this.generateHiddenCartForms(),await new Promise(e=>setTimeout(e,50)))}hideCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");e&&(e.style.display="none",e.classList.add("st-cart-hidden"))}showCartContainer(){const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");if(e){e.style.display="",e.classList.remove("st-cart-hidden");try{const e=()=>{try{const e=document.querySelector(".w-commerce-commercecartcontainerwrapper");if(!e)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;if(document.body&&document.body.classList&&(document.body.classList.contains("w-commerce-commercecartopen")||document.body.classList.contains("wf-commerce-cart-open")))return!0;const i=e.querySelector('[role="dialog"], .w-commerce-commercecartcontainer');if(i){const e=window.getComputedStyle(i);if("none"!==e.display&&"hidden"!==e.visibility)return!0}return!1}catch(e){return!1}},t=e=>{if(!e)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;if(e.disabled)return!1;let i=e;for(;i;){const e=window.getComputedStyle(i);if("none"===e.display||"hidden"===e.visibility)return!1;i=i.parentElement}return null!==e.offsetParent||e.getClientRects().length>0},i=(s=0)=>{if(e())return;const o=['[data-node-type="commerce-cart-open-link"]',".w-commerce-commercecartopenlink",'[data-node-type*="cart-open"], [data-node-type*="commerce-cart-open"]','a[href="#cart"]'].join(","),n=Array.from(document.querySelectorAll(o)),r=n.find(t)||n[0]||null;if(r&&"function"==typeof r.click)return r.click(),void setTimeout(()=>{},0);s<8&&setTimeout(()=>i(s+1),160)};setTimeout(()=>i(0),80)}catch(e){}}}async addCurrentToCart(){try{this.showLoading("PDF wird erstellt und Warenkorb wird befüllt…");const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked,!!this.erdungsband&&this.erdungsband.checked,!!this.ulicaModule&&this.ulicaModule.checked),t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return this.showToast("Keine Produkte ausgewählt ⚠️",2e3),void this.hideLoading();this.sendCurrentConfigToWebhook().then(e=>{});try{const t=document.getElementById("huawei-opti"),i=document.getElementById("brc-opti"),s=document.getElementById("opti-qty");if(t&&i&&s&&(t.checked||i.checked)){const t=Math.max(1,parseInt(s.value||"1",10));i.checked?e.BRCOpti=(e.BRCOpti||0)+t:e.HuaweiOpti=(e.HuaweiOpti||0)+t}}catch(e){}this.addPartsListToCart(e),this.showToast(`${t} Produkte werden zum Warenkorb hinzugefügt...`,3e3),this.pdfGenerator&&this.pdfGenerator.isAvailable()&&setTimeout(()=>{this.pdfGenerator.generatePDF("current")},500)}catch(e){this.showToast("Fehler beim Berechnen der Produkte ❌",2e3),this.hideLoading()}}async addAllToCart(){try{this.showLoading("PDF wird erstellt und Warenkorb wird befüllt…");const e=this.createConfigSnapshot();this.pdfGenerator&&this.pdfGenerator.isAvailable()&&(this.showToast("PDF wird erstellt...",2e3),await this.pdfGenerator.generatePDFFromSnapshot(e),this.showToast("PDF erfolgreich erstellt",1500));const t=await Promise.all(this.configs.map(async(e,t)=>t===this.currentConfig?await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked,!!this.erdungsband&&this.erdungsband.checked,!!this.ulicaModule&&this.ulicaModule.checked):await this._buildPartsFor(e.selection,e.incM,e.mc4,e.solarkabel,e.holz,e.quetschkabelschuhe,e.erdungsband,e.ulicaModule)));if(null===this.currentConfig&&0===this.configs.length){const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked,this.quetschkabelschuhe.checked,!!this.erdungsband&&this.erdungsband.checked,!!this.ulicaModule&&this.ulicaModule.checked);t.push(e)}const i={};t.forEach(e=>{Object.entries(e).forEach(([e,t])=>{i[e]=(i[e]||0)+t})});try{const e=document.getElementById("huawei-opti"),t=document.getElementById("brc-opti"),s=document.getElementById("opti-qty");if(e&&t&&s&&(e.checked||t.checked)){const e=Math.max(1,parseInt(s.value||"1",10));t.checked?i.BRCOpti=(i.BRCOpti||0)+e:i.HuaweiOpti=(i.HuaweiOpti||0)+e}}catch(e){}const s=Object.values(i).reduce((e,t)=>e+t,0);if(0===s)return void this.showToast("Keine Konfigurationen vorhanden ⚠️",2e3);await this.sendAllConfigsToWebhook();this.addPartsListToCart(i),this.showToast(`${s} Produkte aus allen Konfigurationen werden hinzugefügt...`,3e3)}catch(e){console.error("Fehler in addAllToCart:",e),this.showToast("Fehler beim Berechnen der Konfigurationen ❌",2e3),this.hideLoading()}}async _buildPartsFor(e,i,s,o,n,r,l,a){const c=this.selection.map(e=>[...e]);try{this.selection=e;let c=await this.calculateParts();i||delete c.Solarmodul,a||delete c.UlicaSolarBlackJadeFlow;const d=(this.selection||[]).flat().filter(Boolean).length;if(s&&d>0){const e=t.MC4_Stecker||20,i=Math.ceil(d/30);c.MC4_Stecker=i*e}else delete c.MC4_Stecker;o?c.Solarkabel=1:delete c.Solarkabel,n?c.Holzunterleger=1:delete c.Holzunterleger,r?c.Quetschkabelschuhe=1:delete c.Quetschkabelschuhe,l?c.Erdungsband=this.calculateErdungsband():delete c.Erdungsband;try{const e=a?"UlicaSolarBlackJadeFlow":"Solarmodul",t=a?"UlicaSolarBlackJadeFlowPalette":"SolarmodulPalette",i=Number(c[e]||0);if(i>0){const s=Math.floor(i/36),o=i%36;s>0&&(c[t]=(c[t]||0)+36*s),c[e]=o}}catch(e){}return c}finally{this.selection=c}}_buildCartItems(e){return Object.entries(e).map(([e,i])=>{const s=t[e]||1,o=Math.ceil(i/s),r=!n()&&l[e]?l[e]:c[e];return!r||o<=0?null:{productId:r.productId,variantId:r.variantId,quantity:o}}).filter(Boolean)}getCurrentConfigData(){return{name:null!==this.currentConfig&&this.configs[this.currentConfig]?this.configs[this.currentConfig].name:"Aktuelle Konfiguration",cols:this.cols,rows:this.rows,selection:this.selection.map(e=>[...e]),orientation:this.orV.checked?"vertical":"horizontal",includeModules:this.incM.checked,mc4:this.mc4.checked,cable:this.solarkabel.checked,wood:this.holz.checked,quetschkabelschuhe:this.quetschkabelschuhe.checked,erdungsband:!!this.erdungsband&&this.erdungsband.checked,ulicaModule:!!this.ulicaModule&&this.ulicaModule.checked}}updateAllConfigurationsForCheckboxes(){this.configs.forEach((e,t)=>{e.incM=this.incM.checked,e.mc4=this.mc4.checked,e.solarkabel=this.solarkabel.checked,e.holz=this.holz.checked,e.quetschkabelschuhe=this.quetschkabelschuhe.checked,this.erdungsband&&(e.erdungsband=this.erdungsband.checked),this.ulicaModule&&(e.ulicaModule=this.ulicaModule.checked)}),this.updateSummaryOnChange(),this.buildList()}createConfigSnapshot(){null!==this.currentConfig&&this.updateConfig();const e={timestamp:(new Date).toISOString(),totalConfigs:this.configs.length,currentConfigIndex:this.currentConfig,configs:[]};for(let t=0;t<this.configs.length;t++){const i=this.configs[t];let s,o,n,r,l,a,c,d,h,u,m,g,p;t===this.currentConfig?(s=this.selection?this.selection.map(e=>[...e]):[],o=this.cols,n=this.rows,r=this.orV.checked?"vertical":"horizontal",l=this.incM.checked,a=this.mc4.checked,c=this.solarkabel.checked,d=this.holz.checked,h=this.quetschkabelschuhe.checked,u=!!this.erdungsband&&this.erdungsband.checked,m=!!this.ulicaModule&&this.ulicaModule.checked,console.log("Current ulicaModule checkbox state:",m),g=parseInt(this.wIn.value,10),p=parseInt(this.hIn.value,10)):(s=i.selection?i.selection.map(e=>[...e]):[],o=i.cols,n=i.rows,r=i.orientation,l=i.incM,a=i.mc4,c=i.solarkabel,d=i.holz,h=i.quetschkabelschuhe,u=i.erdungsband,m=i.ulicaModule,g=i.cellWidth,p=i.cellHeight);const f=Array.from({length:n||5},(e,t)=>Array.from({length:o||5},(e,i)=>!!(s[t]&&Array.isArray(s[t])&&i<s[t].length)&&!0===s[t][i])),b={name:i.name||`Konfiguration ${t+1}`,index:t,cols:o||5,rows:n||5,selection:f,cellWidth:g||179,cellHeight:p||113,orientation:r||"horizontal",includeModules:!0===l,mc4:a||!1,cable:c||!1,wood:d||!1,quetschkabelschuhe:h||!1,erdungsband:u||!1,ulicaModule:!0===m,selectedCells:f.flat().filter(e=>e).length,totalCells:(o||5)*(n||5)};e.configs.push(b)}return e}getAllConfigsData(){return this.createConfigSnapshot().configs}showGridPreview(e){console.log("showGridPreview called with config:",e),this.originalPreviewState={selection:this.selection?this.selection.map(e=>[...e]):null,cols:this.cols,rows:this.rows,orientation:!!this.orV&&this.orV.checked,cellWidth:parseInt(this.wIn?this.wIn.value:"179",10),cellHeight:parseInt(this.hIn?this.hIn.value:"113",10)},console.log("Original state saved:",this.originalPreviewState);try{this.createPreviewGrid(e),this.hideMainGrid(),this.showPreviewGrid();const t=document.getElementById("grid"),i=document.getElementById("preview-grid");t&&t.classList.add("grid-fade-out"),i&&i.classList.add("grid-fade-in"),console.log("Grid preview shown successfully")}catch(e){console.error("Error in showGridPreview:",e),this.showMainGrid()}}createPreviewGrid(e){console.log("createPreviewGrid called with config:",e);const t=document.getElementById("preview-grid");if(!t)return void console.error("Preview grid element not found");console.log("Preview grid element found, building preview...");let i=this.cols,s=this.rows,o=this.selection?this.selection.map(e=>[...e]):Array.from({length:s},()=>Array.from({length:i},()=>!1));if(e.useCurrentGrid)i=e.cols,s=e.rows,o=this.selection?this.selection.map(e=>[...e]):Array.from({length:s},()=>Array.from({length:i},()=>!1));else if(e.cols&&e.rows)i=e.cols,s=e.rows,o=e.moduleCount?this.createModuleSelection(e.moduleCount,i,s):Array.from({length:s},()=>Array.from({length:i},()=>!1));else if(e.moduleCount){const t="withSpacing"===e.adjustSpacing||e.rowConfig&&e.rowConfig.spacing;o=this.createModuleSelection(e.moduleCount,i,s,t)}else if(e.rowConfig){const{numRows:t,modulesPerRow:n,spacing:r}=e.rowConfig;s=t+(r?1:0),o=Array.from({length:s},(e,s)=>Array.from({length:i},(e,i)=>(!r||s!==Math.floor(t/2))&&(s<t&&i<n)))}else if(e.adjustSpacing&&"withSpacing"===e.adjustSpacing){const e=s+Math.ceil(s/2),t=Array.from({length:e},()=>Array.from({length:i},()=>!1));let n=0;for(let e=0;e<s;e++){for(let s=0;s<i;s++)o[e]&&o[e][s]&&(t[n][s]=!0);n+=2}s=e,o=t}this.buildPreviewGrid(t,o,i,s)}buildPreviewGrid(e,t,i,s){parseFloat(getComputedStyle(document.documentElement).fontSize);const o=parseInt(this.wIn?this.wIn.value:"179",10)||179,n=parseInt(this.hIn?this.hIn.value:"113",10)||113,r=!!this.orV&&this.orV.checked,l=r?n:o,a=r?o:n,c=(this.wrapper?this.wrapper.clientWidth-160:800)/(i*l+2*(i-1)),d=(this.wrapper?this.wrapper.clientHeight-160:600)/(s*a+2*(s-1)),h=Math.min(c,d,1),u=l*h,m=a*h,g=i>=15||s>=10?0:2*h;e.style.gridTemplateColumns=`repeat(${i}, ${u}px)`,e.style.gridTemplateRows=`repeat(${s}, ${m}px)`,e.style.gap=`${g}px`,e.innerHTML="";for(let o=0;o<s;o++)for(let s=0;s<i;s++){const i=document.createElement("div");i.className="preview-grid-cell",i.dataset.row=o,i.dataset.col=s,t&&t[o]&&t[o][s]&&i.classList.add("selected"),e.appendChild(i)}}hideMainGrid(){const e=document.getElementById("grid");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0")}showPreviewGrid(){const e=document.getElementById("preview-grid");e&&(e.style.display="grid",e.style.visibility="visible",e.style.opacity="1")}hidePreviewGrid(){const e=document.getElementById("preview-grid");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0")}showMainGrid(){const e=document.getElementById("grid");e&&(e.style.display="grid",e.style.visibility="visible",e.style.opacity="1")}createModuleSelection(e,t,i,s=!1){const o=Array.from({length:i},()=>Array.from({length:t},()=>!1));if(s){const s=Math.ceil(e/2);let n=0;for(let i=0;i<Math.min(s,t)&&n<e;i++)o[0][i]=!0,n++;if(n<e&&i>2)for(let s=0;s<Math.min(e-n,t);s++)o[i-1][s]=!0,n++}else{let s=0;for(let n=0;n<i&&s<e;n++)for(let i=0;i<t&&s<e;i++)o[n][i]=!0,s++}return o}clearGridPreview(){console.log("Clearing grid preview");const e=document.getElementById("grid"),t=document.getElementById("preview-grid");e&&e.classList.remove("grid-fade-out"),t&&t.classList.remove("grid-fade-in"),setTimeout(()=>{this.hidePreviewGrid(),this.showMainGrid(),this.originalPreviewState&&(this.selection=this.originalPreviewState.selection,this.cols=this.originalPreviewState.cols,this.rows=this.originalPreviewState.rows,this.orV&&this.orH&&null!==this.originalPreviewState.orientation&&(this.orV.checked=this.originalPreviewState.orientation,this.orH.checked=!this.originalPreviewState.orientation),this.wIn&&this.originalPreviewState.cellWidth&&(this.wIn.value=this.originalPreviewState.cellWidth),this.hIn&&this.originalPreviewState.cellHeight&&(this.hIn.value=this.originalPreviewState.cellHeight),this.updateSize(),this.buildGrid(),this.originalPreviewState=null,console.log("Grid preview cleared and original state restored")),setTimeout(()=>{const e=document.getElementById("grid");e&&"none"===e.style.display&&this.showMainGrid()},100)},150)}setupResizeObserver(){this.wrapper&&window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(e=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.updateSize(),this.resizeTimeout=null},150)}),this.resizeObserver.observe(this.wrapper))}setupPinchToZoom(){if(!this.wrapper)return;let e=0,t=1;this.wrapper.addEventListener("touchstart",i=>{2===i.touches.length&&(i.preventDefault(),e=this.getTouchDistance(i.touches[0],i.touches[1]),t=this.zoomLevel)}),this.wrapper.addEventListener("touchmove",i=>{if(2===i.touches.length){i.preventDefault();const s=this.getTouchDistance(i.touches[0],i.touches[1])/e,o=Math.max(this.minZoom,Math.min(this.maxZoom,t*s));this.setZoom(o)}}),this.wrapper.addEventListener("touchend",i=>{i.touches.length<2&&(e=0,t=1)})}getTouchDistance(e,t){const i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}setZoom(e){this.zoomLevel=e,this.wrapper.style.transform=`scale(${e})`,this.wrapper.style.transformOrigin="center center"}cleanup(){this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.previewTimeout&&(clearTimeout(this.previewTimeout),this.previewTimeout=null),this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.performanceMetrics&&(this.performanceMetrics=null),this.zoomObserver&&(this.zoomObserver=null),this.gridEl&&(this.gridEl.innerHTML=""),this.pdfGenerator&&(this.pdfGenerator=null)}}document.addEventListener("DOMContentLoaded",()=>{const e=new y;"function"==typeof e.initFoxyFormMap&&e.initFoxyFormMap();try{document.querySelectorAll(".w-dyn-list, .w-dyn-items, .w-dyn-item, .rt-component-section").forEach(e=>{e&&e.style&&(e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",e.style.width="1px",e.style.height="1px",e.style.overflow="hidden",e.style.clip="rect(0, 0, 0, 0)",e.style.whiteSpace="nowrap")})}catch(e){}window.solarGrid=e}),window.addEventListener("beforeunload",()=>{u&&u.destroy(),window.solarGrid&&window.solarGrid.cleanup()}),window.debugFoxy={list:()=>{const e=[];try{if(!window.solarGrid||!window.solarGrid.foxyDataByName)return e;window.solarGrid.foxyDataByName.forEach((t,i)=>e.push({key:i,...t}))}catch(e){}return console.table(e),e},get:e=>{try{if(window.solarGrid&&window.solarGrid.foxyDataByName)return window.solarGrid.foxyDataByName.get(e)||null}catch(e){}return null}}}();