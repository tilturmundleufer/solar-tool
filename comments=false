!function(){const t=400,e={Endklemmen:100,Schrauben:100,Dachhaken:20,Mittelklemmen:100,Endkappen:50,Schienenverbinder:50,Schiene_240_cm:8,Schiene_360_cm:8,Solarmodul:1,MC4_Stecker:1,Solarkabel:1,Holzunterleger:1},i={Solarmodul:120,Endklemmen:20,Schrauben:5,Dachhaken:15,Mittelklemmen:18,Endkappen:12,Schienenverbinder:10,Schiene_240_cm:30,Schiene_360_cm:40,MC4_Stecker:1,Solarkabel:29.99,Holzunterleger:.5};class CalculationManager{constructor(){this.worker=null,this.pendingCalculations=new Map,this.calculationId=0,this.isWorkerReady=!1,this.initWorker()}initWorker(){try{this.worker=new Worker("./calculation-worker.js"),this.worker.onmessage=t=>{const{type:e,id:i,data:s,error:o}=t.data;if("ready"!==e){if("result"===e&&this.pendingCalculations.has(i)){const{resolve:t}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),t(s)}if("error"===e&&this.pendingCalculations.has(i)){const{reject:t}=this.pendingCalculations.get(i);this.pendingCalculations.delete(i),t(new Error(o.message))}}else this.isWorkerReady=!0},this.worker.onerror=t=>{this.isWorkerReady=!1}}catch(t){this.isWorkerReady=!1}}async calculate(t,e){return this.isWorkerReady&&this.worker?new Promise((i,s)=>{const o=++this.calculationId;this.pendingCalculations.set(o,{resolve:i,reject:s}),setTimeout(()=>{this.pendingCalculations.has(o)&&(this.pendingCalculations.delete(o),s(new Error("Calculation timeout")))},1e4),this.worker.postMessage({type:t,data:e,id:o})}):this.calculateSync(t,e)}calculateSync(t,e){switch(t){case"calculateParts":return this.calculatePartsSync(e);case"calculateExtendedParts":return this.calculateExtendedPartsSync(e);default:throw new Error(`Unsupported sync calculation: ${t}`)}}calculatePartsSync(t){const{selection:e,rows:i,cols:s,cellWidth:o,cellHeight:n,orientation:r}=t,c={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0};for(let t=0;t<i;t++){if(!Array.isArray(e[t]))continue;let i=0;for(let a=0;a<s;a++)e[t]?.[a]?i++:i&&(this.processGroupSync(i,c,o,n,r),i=0);i&&this.processGroupSync(i,c,o,n,r)}return c}processGroupSync(t,e,i,s,o){const n="vertical"===o,r=n?s:i,c=t*r,a=Math.floor(c/360),l=c-360*a,h=Math.ceil(l/240),d=Math.ceil(c/360),u=Math.ceil(c/240),m=[{cnt360:a,cnt240:h},{cnt360:d,cnt240:0},{cnt360:0,cnt240:u}].map(t=>({...t,rails:t.cnt360+t.cnt240,waste:360*t.cnt360+240*t.cnt240-c})),p=Math.min(...m.map(t=>t.rails)),g=m.filter(t=>t.rails===p).reduce((t,e)=>t.waste<=e.waste?t:e),{cnt360:f,cnt240:k}=g;e.Schiene_360_cm+=2*f,e.Schiene_240_cm+=2*k,e.Schienenverbinder+=4*(f+k-1),e.Endklemmen+=4,e.Mittelklemmen+=t>1?2*(t-1):0,e.Dachhaken+=t>1?3*t:4,e.Endkappen+=e.Endklemmen,e.Solarmodul+=t,e.Schrauben+=2*e.Dachhaken}calculateExtendedPartsSync(t){let e=this.calculatePartsSync(t);const{options:i}=t;if(i.includeModules||delete e.Solarmodul,i.mc4Connectors){const i=t.selection.flat().filter(t=>t).length;e.MC4_Stecker=Math.ceil(i/30)}return i.solarkabel&&(e.Solarkabel=1),i.woodUnderlay&&(e.Holzunterleger=(e.Schiene_240_cm||0)+(e.Schiene_360_cm||0)),e}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingCalculations.clear(),this.isWorkerReady=!1}}const calculationManager=new CalculationManager;class PriceCache{constructor(){this.cache=new Map,this.lastUpdate=null,this.cacheKey="solarTool_priceCache",this.timestampKey="solarTool_priceTimestamp",this.cacheDuration=864e5,this.isUpdating=!1,this.loadFromStorage(),this.scheduleNextUpdate()}loadFromStorage(){try{const t=localStorage.getItem(this.cacheKey),e=localStorage.getItem(this.timestampKey);if(t&&e){const i=JSON.parse(t);if(this.lastUpdate=parseInt(e,10),Date.now()-this.lastUpdate<this.cacheDuration)return void(this.cache=new Map(Object.entries(i)))}}catch(t){}this.updatePricesFromHTML()}saveToStorage(){try{const t=Object.fromEntries(this.cache);localStorage.setItem(this.cacheKey,JSON.stringify(t)),localStorage.setItem(this.timestampKey,this.lastUpdate.toString())}catch(t){}}async updatePricesFromHTML(){if(this.isUpdating)return;this.isUpdating=!0;const t=Object.keys(s).map(async t=>{const e=await this.getPriceFromHTMLAsync(t);return this.cache.set(t,e),{productKey:t,price:e}});try{const e=await Promise.all(t);this.lastUpdate=Date.now(),this.saveToStorage(),e.forEach(({productKey:t,price:e})=>{})}catch(t){}finally{this.isUpdating=!1}}async getPriceFromHTMLAsync(t){return new Promise(e=>{setTimeout(()=>{const i=this.extractPriceFromHTML(t);e(i)},0)})}extractPriceFromHTML(t){try{const e=s[t];if(!e)return i[t]||0;const o=e.productId,n=e.variantId,r=document.querySelector(`[data-commerce-product-id="${o}"]`)||document.querySelector(`[data-commerce-sku-id="${n}"]`);if(r){const t=r.querySelector('[data-wf-sku-bindings*="f_price_"]');if(t){let e=t.textContent||t.innerHTML;e=e.replace(/&nbsp;/g," ").replace(/&euro;/g,"€");const i=e.match(/(\d+(?:[.,]\d{1,2})?)/);if(i){const t=parseFloat(i[1].replace(",","."));return t}}}}catch(t){}return i[t]||0}getPrice(t){if(this.cache.has(t))return this.cache.get(t);const e=i[t]||0;return e}scheduleNextUpdate(){const t=this.lastUpdate?this.lastUpdate+this.cacheDuration:Date.now()+this.cacheDuration,e=Math.max(0,t-Date.now());setTimeout(()=>{this.updatePricesFromHTML(),this.scheduleNextUpdate()},e)}forceUpdate(){return this.updatePricesFromHTML()}}const s={Solarmodul:{productId:"685003af0e41d945fb0198d8",variantId:"685003af4a8e88cb58c89d46"},Endklemmen:{productId:"6853c34fe99f6e3d878db38b",variantId:"6853c350edab8f13fc18c1b9"},Schrauben:{productId:"6853c2782b14f4486dd26f52",variantId:"6853c2798bf6755ddde26a8e"},Dachhaken:{productId:"6853c1d0f350bf620389664c",variantId:"6853c1d04d7c01769211b8d6"},Mittelklemmen:{productId:"68531088654d1468dca962c",variantId:"6853c1084c04541622ba3e26"},Endkappen:{productId:"6853be0895a5a578324f9682",variantId:"6853be0805e96b5a16c705cd"},Schienenverbinder:{productId:"6853c2018bf6755ddde216a8",variantId:"6853c202c488ee61eb51a3dc"},Schiene_240_cm:{productId:"6853bd882f00db0c9a42d653",variantId:"6853bd88c4173dbe72bab10f"},Schiene_360_cm:{productId:"6853bc8f3f6abf360c605142",variantId:"6853bc902f00db0c9a423d97"},MC4_Stecker:{productId:"687fcc9f66078f7098826ccc",variantId:"687fcca02c6537b9a9493fa7"},Solarkabel:{productId:"687fd60dc599f5e95d783f99",variantId:"687fd60dd3a8ae1f00a6d6d1"},Holzunterleger:{productId:"xxx-holz",variantId:"xxx-holz-v"}},priceCache=new PriceCache;function getPriceFromCache(t){return priceCache.getPrice(t)}function getPriceFromHTML(t){return getPriceFromCache(t)}window.debugPriceCache={forceUpdate:()=>priceCache.forceUpdate(),getCache:()=>Object.fromEntries(priceCache.cache),getCacheAge:()=>{if(!priceCache.lastUpdate)return"Nie aktualisiert";const t=Date.now()-priceCache.lastUpdate,e=Math.round(t/36e5);return`${e} Stunden alt`},clearCache:()=>{localStorage.removeItem(priceCache.cacheKey),localStorage.removeItem(priceCache.timestampKey),priceCache.cache.clear(),priceCache.lastUpdate=null}};class SmartConfigParser{constructor(t){this.solarGrid=t,this.patterns={gridSize:/(\d+)\s*[x×]\s*(\d+)/i,moduleCount:/(\d+)\s*modul[e]?[n]?/i,moduleCheckbox:/(?:mit|ohne)\s*modul[e]?[n]?(?!\s*\d)/i,orientation:/(?:horizontal|vertikal|vertical)/i,mc4:/(?:mit|ohne)\s*mc4/i,cable:/(?:mit|ohne)\s*(?:kabel|solarkabel)/i,wood:/(?:mit|ohne)\s*holz(?:unterleger)?/i,rowPattern:/(?:(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?)\s*(?:mit|à|a)?\s*(\d+)\s*modul[e]?[n]?)|(?:(\d+)\s*modul[e]?[n]?\s*(?:in|auf)?\s*(\d+|ein|eine|zwei|drei|vier|fünf|sechs|sieben|acht|neun|zehn)\s*(?:reihen?|zeilen?))/i,spacing:/(?:(?:mit|ohne)\s*(?:abstand|lücke))|(?:(\d+)\s*(?:reihen?|zeilen?)\s*(?:abstand|lücke))/i,checkboxCombination:/(?:^|\s)(?:mit|und)\s+(.+?)(?:\s+und\s+(.+?))*(?:\s*$)/i}}parseWordNumber(t){const e={ein:1,eine:1,zwei:2,drei:3,vier:4,"fünf":5,sechs:6,sieben:7,acht:8,neun:9,zehn:10};return"string"==typeof t&&e[t.toLowerCase()]?e[t.toLowerCase()]:parseInt(t)||0}parseCheckboxCombinations(t){const e={modules:!1,mc4:!1,cable:!1,wood:!1},i=t.toLowerCase().replace(/modulen?/g,"module").replace(/solarkabeln?/g,"solarkabel").replace(/holzunterlegern?/g,"holzunterleger");let s=i.split(/\s*(?:und|,)\s*/);s[0]&&s[0].includes("mit ")&&(s[0]=s[0].replace(/.*mit\s+/,"")),s=s.filter(t=>t.trim().length>0);for(const t of s){const i=t.trim();!/\bmodul[e]?[n]?\b/.test(i)||/\d+\s*modul/.test(i)||/reihen/.test(i)||(e.modules=!0),/\bmc4\b/.test(i)&&(e.mc4=!0),/\b(?:kabel|solarkabel)\b/.test(i)&&(e.cable=!0),/\b(?:holz|holzunterleger)\b/.test(i)&&(e.wood=!0)}return e}parseInput(t){const e={},i=t.match(this.patterns.gridSize);i&&(e.cols=parseInt(i[1]),e.rows=parseInt(i[2]));const s=t.match(this.patterns.rowPattern);if(s){let i,o;if(s[1]&&s[2])i=this.parseWordNumber(s[1]),o=parseInt(s[2]);else if(s[3]&&s[4]){const t=parseInt(s[3]);i=this.parseWordNumber(s[4]),o=Math.ceil(t/i),e.intelligentDistribution={totalModules:t,numRows:i,baseModulesPerRow:Math.floor(t/i),extraModules:t%i}}if(i&&o){const s=t.match(this.patterns.spacing);let n=0;s&&(s[0].toLowerCase().includes("mit")&&!s[1]?n=1:s[1]&&(n=parseInt(s[1]))),e.rowConfig={rows:i,modulesPerRow:o,spacing:n,totalModules:i*o};const r=i+(i-1)*n;e.cols=o,e.rows=r}}else{const s=t.match(this.patterns.moduleCount);if(s&&!i){e.moduleCount=parseInt(s[1]);const t=this.calculateOptimalGrid(e.moduleCount);e.cols=t.cols,e.rows=t.rows}}const o=t.match(this.patterns.orientation);o&&(e.orientation=o[0].toLowerCase().includes("vertikal")||o[0].toLowerCase().includes("vertical")?"vertical":"horizontal");const n=this.parseCheckboxCombinations(t);let r=Object.values(n).some(t=>t);if(r)n.modules&&(e.includeModules=!0),n.mc4&&(e.mc4=!0),n.cable&&(e.cable=!0),n.wood&&(e.wood=!0);else{const i=t.match(this.patterns.moduleCheckbox);i&&(e.includeModules=i[0].toLowerCase().includes("mit"));const s=t.match(this.patterns.mc4);s&&(e.mc4=s[0].toLowerCase().includes("mit"));const o=t.match(this.patterns.cable);o&&(e.cable=o[0].toLowerCase().includes("mit"));const n=t.match(this.patterns.wood);n&&(e.wood=n[0].toLowerCase().includes("mit"))}return e}calculateOptimalGrid(t){const e=[];for(let i=1;i<=Math.sqrt(t);i++)t%i===0&&e.push([i,t/i]);const i=e.reduce((t,e)=>{const i=Math.max(t[0],t[1])/Math.min(t[0],t[1]),s=Math.max(e[0],e[1])/Math.min(e[0],e[1]);return i<=s?t:e});return{cols:Math.max(i[0],i[1]),rows:Math.min(i[0],i[1])}}applyConfiguration(t){const e=this.solarGrid.selection?this.solarGrid.selection.map(t=>[...t]):null,i=this.solarGrid.cols,s=this.solarGrid.rows;t.cols&&t.rows&&(this.solarGrid.cols=t.cols,this.solarGrid.rows=t.rows),t.orientation&&(this.solarGrid.orV.checked="vertical"===t.orientation,this.solarGrid.orH.checked="horizontal"===t.orientation),t.hasOwnProperty("includeModules")&&(this.solarGrid.incM.checked=t.includeModules),t.hasOwnProperty("mc4")&&(this.solarGrid.mc4.checked=t.mc4),t.hasOwnProperty("cable")&&(this.solarGrid.solarkabel.checked=t.cable),t.hasOwnProperty("wood")&&(this.solarGrid.holz.checked=t.wood);const o=Array.from({length:this.solarGrid.rows},(t,i)=>Array.from({length:this.solarGrid.cols},(t,s)=>!!(e&&i<e.length&&s<e[i].length)&&e[i][s]));this.solarGrid.selection=o,this.solarGrid.updateSize(),this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange(),t.rowConfig?this.applyRowConfiguration(t.rowConfig,t.intelligentDistribution):!t.moduleCount||e&&!e.flat().every(t=>!t)||this.autoSelectModules(t.moduleCount),this.hideHelpAfterFirstUse()}hideHelpAfterFirstUse(){const t=document.querySelector(".bulk-selection-help");t&&(t.style.display="none",localStorage.setItem("solarTool_hideHelp","true"))}autoSelectModules(t){const e=this.solarGrid.cols*this.solarGrid.rows;e<t&&this.expandGridForModules(t);let i=0;for(let e=0;e<this.solarGrid.rows&&i<t;e++)for(let s=0;s<this.solarGrid.cols&&i<t;s++)this.solarGrid.selection[e]||(this.solarGrid.selection[e]=[]),this.solarGrid.selection[e][s]=!0,i++;this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForModules(t){const e=this.solarGrid.cols*this.solarGrid.rows;if(e>=t)return;const i=this.calculateOptimalGrid(t);let s=this.solarGrid.cols,o=this.solarGrid.rows;for(;s*o<t;)s<=o?s++:o++;this.solarGrid.cols=s,this.solarGrid.rows=o;const n=this.solarGrid.selection||[];this.solarGrid.selection=Array.from({length:o},(t,e)=>Array.from({length:s},(t,i)=>e<n.length&&i<n[e].length&&n[e][i])),this.solarGrid.updateSize()}applyRowConfiguration(t,e=null){const{rows:i,modulesPerRow:s,spacing:o,totalModules:n}=t,r=i+(i-1)*o,c=s;(this.solarGrid.rows<r||this.solarGrid.cols<c)&&this.expandGridForRowConfig(c,r);for(let t=0;t<this.solarGrid.rows;t++)for(let e=0;e<this.solarGrid.cols;e++)this.solarGrid.selection[t]||(this.solarGrid.selection[t]=[]),this.solarGrid.selection[t][e]=!1;let a=0,l=0;for(let t=0;t<i;t++){let i;if(e){const{baseModulesPerRow:s,extraModules:o}=e;i=s+(t<o?1:0)}else i=Math.min(s,n-l);for(let t=0;t<i&&t<this.solarGrid.cols;t++)a<this.solarGrid.rows&&(this.solarGrid.selection[a][t]=!0,l++);a+=1+o}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}expandGridForRowConfig(t,e){const i=this.solarGrid.selection||[];this.solarGrid.cols=Math.max(this.solarGrid.cols,t),this.solarGrid.rows=Math.max(this.solarGrid.rows,e),this.solarGrid.selection=Array.from({length:this.solarGrid.rows},(t,e)=>Array.from({length:this.solarGrid.cols},(t,s)=>e<i.length&&s<i[e].length&&i[e][s])),this.solarGrid.updateSize()}}class BulkSelector{constructor(t){this.solarGrid=t,this.firstClick=null,this.isSelecting=!1,this.bulkMode=!1,this.setupKeyListener()}setupKeyListener(){document.addEventListener("keydown",t=>{"Shift"!==t.key||t.repeat||this.toggleBulkMode()})}toggleBulkMode(){this.bulkMode=!this.bulkMode,this.bulkMode?(this.showBulkModeIndicator(!0),this.firstClick=null):(this.showBulkModeIndicator(!1),this.firstClick=null,this.clearHighlight())}showBulkModeIndicator(t){if(document.querySelectorAll(".bulk-mode-indicator").forEach(t=>t.remove()),t){const t=document.createElement("div");t.className="bulk-mode-indicator",t.innerHTML="🔄 Bulk-Modus aktiv - Klicke auf zwei Zellen um einen Bereich auszuwählen",t.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background: #f5a623;\n          color: white;\n          padding: 8px 16px;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: bold;\n          z-index: 1000;\n          box-shadow: 0 4px 12px rgba(245, 166, 35, 0.3);\n          animation: slideIn 0.3s ease;\n        ";const e=document.createElement("style");e.textContent="\n          @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n          }\n        ",document.head.appendChild(e),document.body.appendChild(t)}}initializeBulkSelection(){const t=this.solarGrid.buildGrid.bind(this.solarGrid);this.solarGrid.buildGrid=()=>{t(),setTimeout(()=>{this.addBulkSelectionToGrid()},10)},setTimeout(()=>{this.addBulkSelectionToGrid()},100)}addBulkSelectionToGrid(){const t=this.solarGrid.gridEl.querySelectorAll(".grid-cell");t.forEach((t,e)=>{const i=e%this.solarGrid.cols,s=Math.floor(e/this.solarGrid.cols),o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",t=>{if(this.bulkMode)if(this.firstClick)this.selectRange(this.firstClick,{x:i,y:s}),this.bulkMode=!1,this.showBulkModeIndicator(!1),this.firstClick=null,this.clearFirstClickMarker();else{const t=this.solarGrid.selection[s]?.[i]||!1;this.firstClick={x:i,y:s,wasSelected:t},o.classList.add("first-click-marker")}else this.solarGrid.selection[s]||(this.solarGrid.selection[s]=[]),t.ctrlKey||t.metaKey,this.solarGrid.selection[s][i]=!this.solarGrid.selection[s][i],o.classList.toggle("selected"),this.solarGrid.trackInteraction(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}),o.addEventListener("mouseenter",t=>{this.bulkMode&&this.firstClick&&this.highlightRange(this.firstClick,{x:i,y:s})}),o.addEventListener("mouseleave",()=>{this.clearHighlight()})})}selectRange(t,e){const i=Math.min(t.x,e.x),s=Math.max(t.x,e.x),o=Math.min(t.y,e.y),n=Math.max(t.y,e.y),r=!t.wasSelected;for(let t=o;t<=n;t++){this.solarGrid.selection[t]||(this.solarGrid.selection[t]=[]);for(let e=i;e<=s;e++)this.solarGrid.selection[t][e]=r}this.solarGrid.buildGrid(),this.solarGrid.buildList(),this.solarGrid.updateSummaryOnChange()}highlightRange(t,e){this.clearHighlight();const i=Math.min(t.x,e.x),s=Math.max(t.x,e.x),o=Math.min(t.y,e.y),n=Math.max(t.y,e.y),r=this.solarGrid.gridEl.querySelectorAll(".grid-cell");for(let t=o;t<=n;t++)for(let e=i;e<=s;e++){const i=t*this.solarGrid.cols+e;r[i]&&r[i].classList.add("bulk-highlight")}}clearHighlight(){const t=this.solarGrid.gridEl.querySelectorAll(".bulk-highlight");t.forEach(t=>t.classList.remove("bulk-highlight"))}clearFirstClickMarker(){const t=this.solarGrid.gridEl.querySelectorAll(".grid-cell");t.forEach(t=>t.classList.remove("first-click-marker"))}}class SolarGrid{constructor(){this.gridEl=document.getElementById("grid"),this.wrapper=document.querySelector(".grid-wrapper"),this.wIn=document.getElementById("width-input"),this.hIn=document.getElementById("height-input"),this.orH=document.getElementById("orient-h"),this.orV=document.getElementById("orient-v"),this.incM=document.getElementById("include-modules"),this.mc4=document.getElementById("mc4"),this.solarkabel=document.getElementById("solarkabel"),this.holz=document.getElementById("holz"),this.listHolder=document.querySelector(".produktliste-holder"),this.prodList=document.getElementById("produktliste"),this.summaryHolder=document.getElementById("summary-list-holder"),this.summaryList=document.getElementById("summary-list"),this.saveBtn=document.getElementById("save-config-btn"),this.addBtn=document.getElementById("add-to-cart-btn"),this.summaryBtn=document.getElementById("summary-add-cart-btn"),this.configListEl=document.getElementById("config-list"),this.resetBtn=document.getElementById("reset-btn"),this.continueLaterBtn=document.getElementById("continue-later-btn"),this.selection=[],this.configs=[],this.currentConfig=null,this.default={cols:5,rows:5,width:176,height:113},this.sessionId=this.generateSessionId(),this.sessionStartTime=Date.now(),this.firstInteractionTime=null,this.lastInteractionTime=Date.now(),this.interactionCount=0,this.webhookUrl="https://hook.eu2.make.com/c7lkudk1v2a2xsr291xbvfs2cb25b84k",this.init()}generateSessionId(){const t=Date.now().toString(36),e=Math.random().toString(36).substr(2,9);return`session_${t}_${e}`}trackInteraction(){this.firstInteractionTime||(this.firstInteractionTime=Date.now()),this.lastInteractionTime=Date.now(),this.interactionCount++}formatDuration(t){if(!t||t<0)return"00:00:00";const e=Math.floor(t/1e3),i=Math.floor(e/3600),s=Math.floor(e%3600/60),o=e%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}getSessionData(){const t=Date.now(),e=t-this.sessionStartTime,i=this.firstInteractionTime?this.firstInteractionTime-this.sessionStartTime:0,s=t-this.lastInteractionTime;return{sessionDuration:this.formatDuration(e),timeToFirstInteraction:this.formatDuration(i),timeSinceLastInteraction:this.formatDuration(s),interactionCount:this.interactionCount,sessionStartTime:this.sessionStartTime,firstInteractionTime:this.firstInteractionTime,lastInteractionTime:this.lastInteractionTime}}getProductSummary(){const t=this.calculateParts();this.incM.checked||delete t.Solarmodul,this.mc4.checked&&(t.MC4_Stecker=this.selection.flat().filter(t=>t).length),this.solarkabel.checked&&(t.Solarkabel=1),this.holz.checked&&(t.Holzunterleger=(t.Schiene_240_cm||0)+(t.Schiene_360_cm||0));const i=Object.entries(t).filter(([,t])=>t>0);let s=0;const o={};return i.forEach(([t,i])=>{const n=Math.ceil(i/e[t]),r=getPriceFromCache(t),c=n*r;s+=c;const a=t.replace(/_/g,"");o[a]=i}),{productQuantities:o,totalPrice:s}}generateGridVisualization(t,e,i,s,o){let n=`<div class="grid" style="--cols: ${e}; --rows: ${i}; --cell-size: ${s}px; --cell-height: ${o}px; --cell-gap: 2px;">`;for(let s=0;s<i;s++)for(let i=0;i<e;i++){const e=t[s]&&t[s][i],o=e?"cell selected":"cell";n+=`<div class="${o}"></div>`}n+="</div>";const r=".grid { \n        display: grid; \n        gap: var(--cell-gap); \n        grid-template-columns: repeat(var(--cols), var(--cell-size)); \n        grid-template-rows: repeat(var(--rows), var(--cell-height)); \n        margin: auto; \n        background: transparent; \n      } \n      .cell { \n        background: #000000; \n        border-radius: 6px; \n        width: var(--cell-size); \n        height: var(--cell-height); \n        transition: all 0.15s ease; \n      } \n      .cell.selected { \n        background: #7f7f7f; \n      }";return{html:n,css:r}}getConfigData(t=null){const e=t||{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked},i=this.getProductSummary(),s=this.generateGridVisualization(e.selection,e.cols,e.rows,e.cellWidth,e.cellHeight);return{timestamp:(new Date).toISOString(),sessionId:this.sessionId,sessionData:this.getSessionData(),config:{cols:e.cols,rows:e.rows,cellWidth:e.cellWidth,cellHeight:e.cellHeight,orientation:e.orientation,gridVisualization:s,options:{includeModules:e.incM,mc4Connectors:e.mc4,solarkabel:e.solarkabel,woodUnderlay:e.holz}},summary:i,analytics:{totalCells:e.cols*e.rows,selectedCells:e.selection.flat().filter(t=>t).length,selectionPercentage:(e.selection.flat().filter(t=>t).length/(e.cols*e.rows)*100).toFixed(2),gridArea:e.cols*e.rows,averageCellSize:((e.cellWidth+e.cellHeight)/2).toFixed(2)}}}async sendConfigToWebhook(t){try{const e=await fetch(this.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return!!e.ok}catch(t){return!1}}async sendCurrentConfigToWebhook(){const t=this.getConfigData();return await this.sendConfigToWebhook(t)}async sendAllConfigsToWebhook(){const t=[];let e=0;for(let i=0;i<this.configs.length;i++){const s=this.configs[i];let o;o=i===this.currentConfig?{cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10),orientation:this.orV.checked?"vertical":"horizontal",selection:this.selection,incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked}:{cols:s.cols,rows:s.rows,cellWidth:s.cellWidth,cellHeight:s.cellHeight,orientation:s.orientation,selection:s.selection,incM:s.incM,mc4:s.mc4,solarkabel:s.solarkabel,holz:s.holz};const n=this.selection,r=this.orV.checked,c=this.solarkabel.checked,a=this.incM.checked,l=this.mc4.checked,h=this.holz.checked;this.selection=o.selection,this.orV.checked="vertical"===o.orientation,this.orH.checked=!this.orV.checked,this.solarkabel.checked=o.solarkabel,this.incM.checked=o.incM,this.mc4.checked=o.mc4,this.holz.checked=o.holz;const d=this.getConfigData(o);d.configIndex=i,d.configName=s.name,d.totalConfigsInSession=this.configs.length,this.selection=n,this.orV.checked=r,this.orH.checked=!r,this.solarkabel.checked=c,this.incM.checked=a,this.mc4.checked=l,this.holz.checked=h;try{const s=await this.sendConfigToWebhook(d);s&&e++,t.push(s),i<this.configs.length-1&&await new Promise(t=>setTimeout(t,100))}catch(e){t.push(!1)}}return e===this.configs.length}checkMobileDevice(){const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window&&window.innerWidth<=1024;t&&this.showMobileWarning()}showMobileWarning(){const t=document.getElementById("mobile-warning"),e=document.getElementById("mobile-continue"),i=document.getElementById("mobile-close");if(t){const s=sessionStorage.getItem("mobile-warning-seen");s||(t.classList.remove("hidden"),e?.addEventListener("click",()=>{t.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),i?.addEventListener("click",()=>{t.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true")}),t.addEventListener("click",e=>{e.target===t&&(t.classList.add("hidden"),sessionStorage.setItem("mobile-warning-seen","true"))}))}}init(){this.checkMobileDevice();const t=new URLSearchParams(window.location.search),e=t.get("configData");if(e)try{const t=decodeURIComponent(atob(e)),i=JSON.parse(t);return void(Array.isArray(i)?(this.configs=i,this.loadConfig(0)):(this.configs.push(i),this.loadConfig(0)))}catch(t){}[this.wIn,this.hIn].forEach(t=>t.addEventListener("change",()=>{this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange()}));let i=this.orH.checked?"horizontal":"vertical";if([this.orH,this.orV].forEach(t=>t.addEventListener("change",()=>{if(!t.checked)return;const e=t===this.orH?"horizontal":"vertical";e!==i&&(this.trackInteraction(),this.updateSize(),this.buildList(),this.updateSummaryOnChange(),i=e)})),[this.incM,this.mc4,this.solarkabel,this.holz].forEach(t=>t.addEventListener("change",()=>{this.trackInteraction(),this.buildList(),this.updateSummaryOnChange(),this.renderProductSummary()})),document.querySelectorAll(".btn-add-col-right").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.addColumnRight()})}),document.querySelectorAll(".btn-remove-col-right").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.removeColumnRight()})}),document.querySelectorAll(".btn-add-col-left").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.addColumnLeft()})}),document.querySelectorAll(".btn-remove-col-left").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.removeColumnLeft()})}),document.querySelectorAll(".btn-add-row-bottom").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.addRowBottom()})}),document.querySelectorAll(".btn-remove-row-bottom").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.removeRowBottom()})}),document.querySelectorAll(".btn-add-row-top").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.addRowTop()})}),document.querySelectorAll(".btn-remove-row-top").forEach(t=>{t.addEventListener("click",()=>{this.trackInteraction(),this.removeRowTop()})}),this.saveBtn.addEventListener("click",()=>{this.trackInteraction(),this.saveNewConfig()}),this.addBtn.addEventListener("click",()=>{this.trackInteraction(),this.addCurrentToCart()}),this.summaryBtn.addEventListener("click",()=>{this.trackInteraction(),this.addAllToCart()}),this.resetBtn.addEventListener("click",()=>{this.trackInteraction(),this.resetGridToDefault()}),this.continueLaterBtn.addEventListener("click",()=>{this.trackInteraction(),this.generateContinueLink()}),window.addEventListener("resize",()=>{this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}),0===this.configs.length){this.cols=this.default.cols,this.rows=this.default.rows,this.setup();const t=this._makeConfigObject();this.configs.push(t),this.loadConfig(0)}this.initSmartConfigFeatures()}initSmartConfigFeatures(){this.smartParser=new SmartConfigParser(this),this.bulkSelector=new BulkSelector(this),this.bulkSelector.initializeBulkSelection(),this.initQuickConfigInterface(),this.ensurePermanentVisibility(),this.checkAndHideHelp(),this.initSmartConfigCloseButton()}ensurePermanentVisibility(){setTimeout(()=>{const t=document.querySelector(".usage-tips");t&&(t.style.display="block",t.classList.remove("hidden"));const e=document.querySelectorAll(".smart-config-container");e.forEach(t=>{t.style.display="block",t.classList.remove("hidden")}),localStorage.removeItem("solarTool_hideHelp"),localStorage.removeItem("solarTool_hideSmartConfig")},100)}checkAndHideHelp(){}initSmartConfigCloseButton(){setTimeout(()=>{const t=document.getElementById("smart-config-close"),e=document.querySelector(".smart-config-container");t&&e&&t.addEventListener("click",()=>{})},600)}initQuickConfigInterface(){setTimeout(()=>{const t=document.getElementById("quick-config-input"),e=document.getElementById("apply-quick-config");t&&e&&(e.addEventListener("click",()=>{const e=t.value.trim();if(e)try{const i=this.smartParser.parseInput(e);this.smartParser.applyConfiguration(i),this.showToast(`Konfiguration "${e}" angewendet ✅`,2e3),t.value=""}catch(t){this.showToast("Fehler: Konfiguration konnte nicht angewendet werden ❌",2e3)}}),t.addEventListener("keypress",t=>{"Enter"===t.key&&e.click()}),t.addEventListener("input",t=>{const e=t.target.value.trim();if(e.length>3)try{const t=this.smartParser.parseInput(e);this.showConfigPreview(t)}catch(t){}}))},500)}showConfigPreview(t){const e=document.getElementById("config-preview");if(e&&(t.cols||t.moduleCount)){let i="";if(t.cols&&t.rows&&(i+=`${t.cols}×${t.rows} Grid`),t.moduleCount&&(i+=` (${t.moduleCount} Module)`),"horizontal"!==t.orientation&&(i+=`, ${t.orientation}`),t.mc4||t.cable||t.wood){const e=[];t.mc4&&e.push("MC4"),t.cable&&e.push("Kabel"),t.wood&&e.push("Holz"),i+=` + ${e.join(", ")}`}e.textContent=i,e.style.display=i?"block":"none"}}initQuickConfigInterface(){setTimeout(()=>{const t=document.getElementById("quick-config-input"),e=document.getElementById("apply-quick-config");t&&e&&(e.addEventListener("click",()=>{const e=t.value.trim();if(e)try{const i=this.smartParser.parseInput(e);this.smartParser.applyConfiguration(i),this.showToast(`Konfiguration "${e}" angewendet ✅`,2e3),t.value=""}catch(t){this.showToast("Fehler: Konfiguration konnte nicht angewendet werden ❌",2e3)}}),t.addEventListener("keypress",t=>{"Enter"===t.key&&e.click()}),t.addEventListener("input",t=>{const e=t.target.value.trim();if(e.length>3)try{const t=this.smartParser.parseInput(e);this.showConfigPreview(t)}catch(t){}}))},500)}showConfigPreview(t){const e=document.getElementById("config-preview");if(e&&(t.cols||t.moduleCount)){let i="";if(t.cols&&t.rows&&(i+=`${t.cols}×${t.rows} Grid`),t.moduleCount&&(i+=` (${t.moduleCount} Module)`),"horizontal"!==t.orientation&&(i+=`, ${t.orientation}`),t.mc4||t.cable||t.wood){const e=[];t.mc4&&e.push("MC4"),t.cable&&e.push("Kabel"),t.wood&&e.push("Holz"),i+=` + ${e.join(", ")}`}e.textContent=i,e.style.display=i?"block":"none"}}setup(){if(this.cols&&this.rows||(this.cols=this.default.cols,this.rows=this.default.rows),this.cols&&this.rows){if(!Array.isArray(this.selection)||this.selection.length!==this.rows||this.selection[0]?.length!==this.cols){const t=this.selection;this.selection=Array.from({length:this.rows},(e,i)=>Array.from({length:this.cols},(e,s)=>t?.[i]?.[s]||!1))}this.listHolder.style.display="block",this.updateSize(),this.buildGrid(),this.buildList(),this.renderProductSummary(),this.updateSaveButtons()}else alert("Spalten und Zeilen müssen > 0 sein")}updateSaveButtons(){this.saveBtn.style.display="inline-block"}addColumnRight(){this.cols+=1;for(let t of this.selection)t.push(!1);this.updateGridAfterStructureChange()}removeColumnRight(){if(!(this.cols<=1)){this.cols-=1;for(let t of this.selection)t.pop();this.updateGridAfterStructureChange()}}addColumnLeft(){this.cols+=1;for(let t of this.selection)t.unshift(!1);this.updateGridAfterStructureChange()}removeColumnLeft(){if(!(this.cols<=1)){this.cols-=1;for(let t of this.selection)t.shift();this.updateGridAfterStructureChange()}}addRowBottom(){this.rows+=1,this.selection.push(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowBottom(){this.rows<=1||(this.rows-=1,this.selection.pop(),this.updateGridAfterStructureChange())}addRowTop(){this.rows+=1,this.selection.unshift(Array(this.cols).fill(!1)),this.updateGridAfterStructureChange()}removeRowTop(){this.rows<=1||(this.rows-=1,this.selection.shift(),this.updateGridAfterStructureChange())}updateGridAfterStructureChange(){this.updateSize(),this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}updateSize(){const t=2,e=parseFloat(getComputedStyle(document.documentElement).fontSize),i=parseInt(this.wIn.value,10)||179,s=parseInt(this.hIn.value,10)||113,o=this.orV.checked,n=o?s:i,r=o?i:s,c=this.wrapper.clientWidth-100,a=this.wrapper.clientHeight-100,l=this.cols*n+2*(this.cols-1),h=this.rows*r+2*(this.rows-1),d=c/l,u=a/h,m=Math.min(d,u,1),p=n*m,g=r*m,f=this.cols>=15||this.rows>=10,k=f?0:2*m;document.documentElement.style.setProperty("--cell-size",p+"px"),document.documentElement.style.setProperty("--cell-width",p+"px"),document.documentElement.style.setProperty("--cell-height",g+"px"),document.documentElement.style.setProperty("--cell-gap",k+"px");const b=Math.min(this.cols*p+(this.cols-1)*k,c),w=Math.min(this.rows*g+(this.rows-1)*k,a);this.gridEl.style.width=b+"px",this.gridEl.style.height=w+"px"}buildGrid(){if(!Array.isArray(this.selection))return;this.gridEl.innerHTML="",document.documentElement.style.setProperty("--cols",this.cols),document.documentElement.style.setProperty("--rows",this.rows);const t=(this.cols-1)/2,e=(this.rows-1)/2,i=60;for(let s=0;s<this.rows;s++)if(Array.isArray(this.selection[s]))for(let o=0;o<this.cols;o++){const n=document.createElement("div");n.className="grid-cell animate-in",this.selection[s]?.[o]&&n.classList.add("selected"),n.addEventListener("click",()=>{this.selection[s]||(this.selection[s]=[]),this.selection[s][o]=!this.selection[s][o],n.classList.toggle("selected"),this.trackInteraction(),this.buildList(),this.updateSummaryOnChange()});const r=o-t,c=s-e,a=Math.sqrt(r*r+c*c),l=a*i;n.style.animationDelay=`${l}ms`,setTimeout(()=>n.classList.remove("animate-in"),400),this.gridEl.appendChild(n)}}async buildList(){try{const t=await this.calculateParts();if(this.incM.checked||delete t.Solarmodul,this.mc4.checked){const e=this.selection.flat().filter(t=>t).length;t.MC4_Stecker=Math.ceil(e/30)}this.solarkabel.checked&&(t.Solarkabel=1),this.holz.checked&&(t.Holzunterleger=(t.Schiene_240_cm||0)+(t.Schiene_360_cm||0));const i=Object.entries(t).filter(([,t])=>t>0);if(!i.length)return void(this.listHolder.style.display="none");this.listHolder.style.display="block",this.prodList.innerHTML=i.map(([t,i])=>{const s=Math.ceil(i/e[t]);return`<div class="produkt-item">\n            <span>${s}×</span>\n            <img src="${this.mapImage(t)}" alt="${t}" onerror="this.src='https://via.placeholder.com/32?text=${encodeURIComponent(t)}'">\n            <span>${t.replace(/_/g," ")} (${i})</span>\n          </div>`}).join(""),this.prodList.style.display="block"}catch(t){this.listHolder.style.display="none"}}resetGridToDefault(){const{cols:t,rows:e,width:i,height:s}=this.default,o=[];for(let i=0;i<e;i++){o[i]=[];for(let e=0;e<t;e++)o[i][e]=this.selection?.[i]?.[e]||!1}this.wIn.value=i,this.hIn.value=s;const n=document.getElementById("orient-v").hasAttribute("checked");this.orH.checked=!n,this.orV.checked=n,this.incM.checked=!1,this.mc4.checked=!1,this.solarkabel.checked=!1,this.holz.checked=!1,this.cols=t,this.rows=e,this.setup(),this.selection=o,this.buildGrid(),this.buildList(),this.updateSummaryOnChange()}resetToDefaultGrid(){this.colsIn.value=this.default.cols,this.rowsIn.value=this.default.rows,this.wIn.value=this.default.width,this.hIn.value=this.default.height,this.orH.checked=!0,this.orV.checked=!1,this.cols=this.default.cols,this.rows=this.default.rows,this.selection=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),this.setup()}async calculateParts(){try{const t={selection:this.selection,rows:this.rows,cols:this.cols,cellWidth:parseInt(this.wIn.value,10)||179,cellHeight:parseInt(this.hIn.value,10)||113,orientation:this.orV.checked?"vertical":"horizontal"},e=await calculationManager.calculate("calculateParts",t);return e}catch(t){return this.calculatePartsSync()}}calculatePartsSync(){const t={Solarmodul:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0};for(let e=0;e<this.rows;e++){if(!Array.isArray(this.selection[e]))continue;let i=0;for(let s=0;s<this.cols;s++)this.selection[e]?.[s]?i++:i&&(this.processGroup(i,t),i=0);i&&this.processGroup(i,t)}return t}processGroup(t,e){const i=this.orV.checked,s=i?parseInt(this.hIn.value,10)||113:parseInt(this.wIn.value,10)||179,o=t*s,n=Math.floor(o/360),r=o-360*n,c=Math.ceil(r/240),a=Math.ceil(o/360),l=Math.ceil(o/240),h=[{cnt360:n,cnt240:c},{cnt360:a,cnt240:0},{cnt360:0,cnt240:l}].map(t=>({...t,rails:t.cnt360+t.cnt240,waste:360*t.cnt360+240*t.cnt240-o})),d=Math.min(...h.map(t=>t.rails)),u=h.filter(t=>t.rails===d).reduce((t,e)=>t.waste<=e.waste?t:e),{cnt360:m,cnt240:p}=u;e.Schiene_360_cm+=2*m,e.Schiene_240_cm+=2*p,e.Schienenverbinder+=4*(m+p-1),e.Endklemmen+=4,e.Mittelklemmen+=t>1?2*(t-1):0,e.Dachhaken+=t>1?3*t:4,e.Endkappen+=e.Endklemmen,e.Solarmodul+=t,e.Schrauben+=2*e.Dachhaken}mapImage(t){const e={Solarmodul:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png",Endklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c316b21cb7d04ba2ed22_DSC04815-min.jpg",Schrauben:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c2704f5147533229ccde_DSC04796-min.jpg",Dachhaken:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c1c8a2835b7879f46811_DSC04760-min.jpg",Mittelklemmen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c0d0c2d922d926976bd4_DSC04810-min.jpg",Endkappen:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bdfbe7cffc653f6a4605_DSC04788-min.jpg",Schienenverbinder:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853c21f0c39e927fce0db3b_DSC04780-min.jpg",Schiene_240_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bce018164af4b4a187f1_DSC04825-min.jpg",Schiene_360_cm:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/6853bcd5726d1d33d4b86ba4_DSC04824-min.jpg",MC4_Stecker:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fcdab153f840ea15b5e7b_iStock-2186771695.jpg",Solarkabel:"https://cdn.prod.website-files.com/684989b78146a1d9194e7b47/687fd566bdbb6de2e5f362f0_DSC04851.jpg",Holzunterleger:"https://cdn.prod.website-files.com/68498852db79a6c114f111ef/6859af7eeb0350c3aa298572_Solar%20Panel.png"};return e[t]||""}loadConfig(t){const e=this.configs[t];this.currentConfig=t,this.wIn.value=e.cellWidth,this.hIn.value=e.cellHeight,this.orV.checked="vertical"===e.orientation,this.orH.checked=!this.orV.checked,this.incM.checked=e.incM,this.mc4.checked=e.mc4,this.solarkabel.checked=e.solarkabel||!1,this.holz.checked=e.holz,this.cols=e.cols,this.rows=e.rows,this.selection=e.selection.map(t=>[...t]),this.setup(),this.renderConfigList(),this.updateSaveButtons()}showToast(t="Gespeichert ✅",e=1500){const i=document.getElementById("toast");i&&(i.textContent=t,i.classList.remove("hidden"),clearTimeout(this.toastTimeout),this.toastTimeout=setTimeout(()=>{i.classList.add("hidden")},e))}saveNewConfig(){null!==this.currentConfig&&this.updateConfig(),this.currentConfig=null;const t=Array.from({length:this.rows},()=>Array.from({length:this.cols},()=>!1)),e=this.selection;this.selection=t;const i=this._makeConfigObject();this.configs.push(i),this.currentConfig=this.configs.length-1,this.setup(),this.renderConfigList(),this.updateSaveButtons(),this.showToast(`Neue Konfiguration "${i.name}" erstellt ✅`)}updateConfig(){const t=this.currentConfig;this.configs[t]=this._makeConfigObject(),this.renderConfigList(),this.updateSaveButtons()}deleteConfig(t){const e=this.configs[t].name;if(confirm(`Willst du "${e}" wirklich löschen?`)){if(this.configs.splice(t,1),this.configs.length>0)if(t===this.currentConfig){const e=Math.min(t,this.configs.length-1);this.loadConfig(e)}else t<this.currentConfig?(this.currentConfig--,this.renderConfigList()):this.renderConfigList();else this.createNewConfig();this.updateSaveButtons()}}createNewConfig(){this.currentConfig=null,this.resetGridToDefault(),this.renderConfigList(),this.updateSaveButtons()}_makeConfigObject(){let t;if(null!==this.currentConfig)t=this.configs[this.currentConfig].name;else{let e=1;for(;this.configs.some(t=>t.name===`Konfiguration ${e}`);)e++;t=`Konfiguration ${e}`}return{name:t,selection:this.selection.map(t=>[...t]),orientation:this.orV.checked?"vertical":"horizontal",incM:this.incM.checked,mc4:this.mc4.checked,solarkabel:this.solarkabel.checked,holz:this.holz.checked,cols:this.cols,rows:this.rows,cellWidth:parseInt(this.wIn.value,10),cellHeight:parseInt(this.hIn.value,10)}}renderConfigList(){this.configListEl.innerHTML="",this.configs.forEach((t,e)=>{const i=document.createElement("div");i.className="config-item"+(e===this.currentConfig?" active":""),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.gap="0.5rem";const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="0.25rem",s.style.flex="1";const o=document.createElement("span");o.textContent=t.name,o.style.cursor="pointer",o.addEventListener("click",()=>{null!==this.currentConfig&&this.currentConfig!==e&&this.updateConfig(),this.currentConfig!==e&&(this.loadConfig(e),this.showToast("Konfiguration geladen",1e3))});const n=document.createElement("button");n.innerHTML="✎",n.title="Namen bearbeiten",Object.assign(n.style,{border:"none",background:"none",cursor:"pointer",fontSize:"1rem",color:"#fff",padding:"0",marginLeft:"0.5rem",lineHeight:"1"}),n.addEventListener("click",e=>{e.stopPropagation();const i=document.createElement("input");i.type="text",i.value=t.name,i.style.flex="1",i.addEventListener("keydown",e=>{"Enter"===e.key&&(t.name=i.value.trim()||t.name,this.renderConfigList())}),i.addEventListener("blur",()=>{t.name=i.value.trim()||t.name,this.renderConfigList()}),s.replaceChild(i,o),i.focus()});let r=null;this.configs.length>1&&(r=document.createElement("button"),r.innerHTML="🗑️",r.title="Konfiguration löschen",Object.assign(r.style,{background:"none",border:"none",cursor:"pointer",fontSize:"1rem",color:"#fff",padding:"0",marginLeft:"0.5rem",lineHeight:"1"}),r.addEventListener("click",t=>{t.stopPropagation(),this.deleteConfig(e)}));const c=document.createElement("button");c.textContent="🔗",c.title="Später weitermachen - Link kopieren",Object.assign(c.style,{background:"none",border:"none",cursor:"pointer",color:"inherit"}),c.addEventListener("click",t=>{t.stopPropagation(),this.generateContinueLink()}),s.appendChild(o),s.appendChild(n),i.appendChild(s),r&&i.appendChild(r),i.appendChild(c),this.configListEl.appendChild(i)})}updateSummaryOnChange(){this.renderProductSummary()}async renderProductSummary(){const t=this.incM.checked,i=this.mc4.checked,s=this.solarkabel.checked,o=this.holz.checked,n=this.configs.map((e,n)=>n===this.currentConfig?{selection:this.selection,orientation:this.orV.checked?"vertical":"horizontal",incM:t,mc4:i,solarkabel:s,holz:o}:{selection:e.selection,orientation:e.orientation,incM:e.incM,mc4:e.mc4,solarkabel:e.solarkabel,holz:e.holz});null===this.currentConfig&&n.push({selection:this.selection,orientation:this.orV.checked?"vertical":"horizontal",incM:t,mc4:i,holz:o});const r=this.orV.checked,c=this.selection.map(t=>[...t]),a={},l=n.map(async t=>{this.orV.checked="vertical"===t.orientation,this.orH.checked=!this.orV.checked,this.selection=t.selection,this.updateSize();let e=await this.calculateParts();if(t.incM||delete e.Solarmodul,t.mc4){const i=t.selection.flat().filter(t=>t).length;e.MC4_Stecker=Math.ceil(i/30)}return t.solarkabel&&(e.Solarkabel=1),t.holz&&(e.Holzunterleger=(e.Schiene_240_cm||0)+(e.Schiene_360_cm||0)),e});try{const t=await Promise.all(l);t.forEach(t=>{Object.entries(t).forEach(([t,e])=>{a[t]=(a[t]||0)+e})})}catch(t){}this.orV.checked=r,this.orH.checked=!r,this.selection=c,this.updateSize();const h=Object.entries(a).filter(([,t])=>t>0),d=4,u=Math.ceil(h.length/4);let m=0,p="";for(let t=0;t<u;t++){const i=h.slice(4*t,4*(t+1)),s=i.map(([t,i])=>{const s=Math.ceil(i/e[t]),o=getPriceFromCache(t),n=s*o;return m+=n,`<div class="produkt-item">\n        \t\t<span>${s}×</span>\n        \t\t<img src="${this.mapImage(t)}" alt="${t}" onerror="this.src='https://via.placeholder.com/32?text=${encodeURIComponent(t)}'">\n        \t\t<span>${t.replace(/_/g," ")} (${i})</span>\n        \t\t<span style="margin-left:auto; font-weight:bold;">${n.toFixed(2)} €</span>\n      \t\t</div>`}).join("");p+=`<div class="summary-column">${s}</div>`}p+=`<div class="summary-total">Gesamtpreis: ${m.toFixed(2)} €</div>`,this.summaryList.innerHTML=p,this.summaryHolder.style.display=h.length?"block":"none",this.summaryList.style.display=h.length?"flex":"none"}generateContinueLink(){null!==this.currentConfig&&this.updateConfig();const t=JSON.stringify(this.configs),e=btoa(encodeURIComponent(t)),i=`${window.location.origin}${window.location.pathname}?configData=${e}`;navigator.clipboard.writeText(i),this.showToast("Später-weitermachen Link kopiert ✅",2e3)}generateHiddenCartForms(){const t=document.querySelectorAll('form[data-node-type="commerce-add-to-cart-form"]');this.webflowFormMap={},t.forEach(t=>{const e=t.getAttribute("data-commerce-product-id"),i=t.getAttribute("data-commerce-sku-id"),o=Object.keys(s).find(t=>s[t].productId===e||s[t].variantId===i);o&&(this.webflowFormMap[o]=t)}),this.hideWebflowForms()}hideWebflowForms(){Object.values(this.webflowFormMap).forEach(t=>{t&&t.style&&(t.style.cssText="\n            position: absolute !important;\n            left: -9999px !important;\n            top: -9999px !important;\n            width: 1px !important;\n            height: 1px !important;\n            overflow: hidden !important;\n            clip: rect(0, 0, 0, 0) !important;\n            white-space: nowrap !important;\n            border: 0 !important;\n            margin: 0 !important;\n            padding: 0 !important;\n            visibility: hidden !important;\n          ")})}addProductToCart(t,e,i=!1){const o=s[t];if(!o)return;const n=this.webflowFormMap[t];if(!n)return;const r=n.querySelector('input[name="commerce-add-to-cart-quantity-input"]');r&&(r.value=e);const c=n.querySelector('input[data-node-type="commerce-add-to-cart-button"]');c&&this.clickWebflowButtonSafely(n,c,t,e,i)}clickWebflowButtonSafely(t,e,i,s,o){const n=t.querySelector('input[name="commerce-add-to-cart-quantity-input"]');if(n&&(n.value=s),o)return void e.click();const r=document.createElement("iframe");r.name="safe-cart-"+Date.now()+Math.random(),r.style.cssText="\n        position: absolute;\n        left: -10000px;\n        top: -10000px;\n        width: 1px;\n        height: 1px;\n        border: none;\n        visibility: hidden;\n        opacity: 0;\n      ",document.body.appendChild(r);const c=t.target||"";t.target=r.name;let a=!1;r.onload=()=>{a||(a=!0,t.target=c,n&&(n.value=1),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},1e3))},r.onerror=()=>{t.target=c,document.body.contains(r)&&document.body.removeChild(r)},e.click()}addPartsListToCart(t){const i=Object.entries(t).filter(([t,e])=>e>0);if(!i.length)return;this.hideCartContainer();const s=i.slice(0,-1),o=i[i.length-1];s.forEach(([t,i])=>{const s=Math.ceil(i/e[t]);this.addProductToCart(t,s,!1)}),setTimeout(()=>{this.showCartContainer();const[t,i]=o,s=Math.ceil(i/e[t]);this.addProductToCart(t,s,!0)},500)}hideCartContainer(){const t=document.querySelector(".w-commerce-commercecartcontainerwrapper");t&&(t.style.display="none")}showCartContainer(){const t=document.querySelector(".w-commerce-commercecartcontainerwrapper");t&&(t.style.display="")}async addCurrentToCart(){try{const t=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked),e=Object.values(t).reduce((t,e)=>t+e,0);if(0===e)return void this.showToast("Keine Produkte ausgewählt ⚠️",2e3);this.sendCurrentConfigToWebhook().then(t=>{}),this.addPartsListToCart(t),this.showToast(`${e} Produkte werden zum Warenkorb hinzugefügt...`,3e3)}catch(t){this.showToast("Fehler beim Berechnen der Produkte ❌",2e3)}}async addAllToCart(){try{null!==this.currentConfig&&this.updateConfig();const t=await Promise.all(this.configs.map(async(t,e)=>e===this.currentConfig?await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked):await this._buildPartsFor(t.selection,t.incM,t.mc4,t.solarkabel,t.holz)));if(null===this.currentConfig&&0===this.configs.length){const e=await this._buildPartsFor(this.selection,this.incM.checked,this.mc4.checked,this.solarkabel.checked,this.holz.checked);t.push(e)}const e={};t.forEach(t=>{Object.entries(t).forEach(([t,i])=>{e[t]=(e[t]||0)+i})});const i=Object.values(e).reduce((t,e)=>t+e,0);if(0===i)return void this.showToast("Keine Konfigurationen vorhanden ⚠️",2e3);this.sendAllConfigsToWebhook().then(t=>{}),this.addPartsListToCart(e),this.showToast(`${i} Produkte aus allen Konfigurationen werden hinzugefügt...`,3e3)}catch(t){this.showToast("Fehler beim Berechnen der Konfigurationen ❌",2e3)}}async _buildPartsFor(t,e,i,s,o){const n=this.selection.map(t=>[...t]);try{this.selection=t;let n=await this.calculateParts();if(e||delete n.Solarmodul,i){const e=t.flat().filter(t=>t).length;n.MC4_Stecker=Math.ceil(e/30)}return s&&(n.Solarkabel=1),o&&(n.Holzunterleger=(n.Schiene_240_cm||0)+(n.Schiene_360_cm||0)),n}finally{this.selection=n}}_buildCartItems(t){return Object.entries(t).map(([t,i])=>{const o=Math.ceil(i/e[t]),n=s[t];return!n||o<=0?null:{productId:n.productId,variantId:n.variantId,quantity:o}}).filter(Boolean)}}document.addEventListener("DOMContentLoaded",()=>{const t=new SolarGrid;t.generateHiddenCartForms(),window.solarGrid=t}),window.addEventListener("beforeunload",()=>{calculationManager&&calculationManager.destroy()})}();