self.onmessage=function(e){const{type:t,data:n,id:a}=e.data;if("calculateParts"===t){const e=calculateParts(n.selection,n.rows,n.cols,n.cellWidth,n.cellHeight,n.orientation,n.options);self.postMessage({type:"result",id:a,data:e})}};const VE_VALUES={Endklemmen:100,Schrauben:100,Dachhaken:20,Mittelklemmen:100,Endkappen:50,Schienenverbinder:50,Schiene_240_cm:8,Schiene_360_cm:8,Solarmodul:1,UlicaSolarBlackJadeFlow:1,MC4_Stecker:1,Solarkabel:1,Holzunterleger:50,Erdungsklemme:1,Quetschkabelschuhe:100,Erdungsband:1,Tellerkopfschraube:100};function calculateParts(e,t,n,a,c,s,l={}){const r={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Erdungsband:0};for(let o=0;o<t;o++){if(!Array.isArray(e[o]))continue;let t=0;for(let i=0;i<n;i++)e[o]?.[i]?t++:t&&(processGroup(t,r,a,c,s,l),t=0);t&&processGroup(t,r,a,c,s,l)}return l&&l.erdungsband&&(r.Erdungsband=calculateErdungsband(e,t,n,a,c,s)),r}function processGroup(e,t,n,a,c,s={}){const l=e*("vertical"===c?a:n),r=Math.floor(l/360),o=l-360*r,i=[{cnt360:r,cnt240:Math.ceil(o/240)},{cnt360:Math.ceil(l/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(l/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-l})),d=Math.min(...i.map(e=>e.rails)),u=i.filter(e=>e.rails===d).reduce((e,t)=>e.waste<=t.waste?e:t),{cnt360:g,cnt240:h}=u;t.Schiene_360_cm+=2*g,t.Schiene_240_cm+=2*h,t.Schienenverbinder+=4*(g+h-1),t.Endklemmen+=4,t.Mittelklemmen+=e>1?2*(e-1):0,t.Dachhaken+=e>1?3*e:4,t.Endkappen+=4,t.Solarmodul+=e,s&&s.ulicaModule&&(t.UlicaSolarBlackJadeFlow+=e);const b=e>1?3*e:4;t.Schrauben+=1*b,t.Tellerkopfschraube+=2*b}function calculateExtendedParts(e,t,n,a,c,s,l){let r=calculateParts(e,t,n,a,c,s,l);if(l.includeModules||delete r.Solarmodul,!0!==l.ulicaModule&&delete r.UlicaSolarBlackJadeFlow,l.mc4Connectors){const t=e.flat().filter(e=>e).length;r.MC4_Stecker=Math.ceil(t/30)}return l.solarkabel&&(r.Solarkabel=1),l.woodUnderlay&&(r.Holzunterleger=(r.Schiene_240_cm||0)+(r.Schiene_360_cm||0)),l.erdungsband&&(r.Erdungsband=calculateErdungsband(e,t,n,a,c,s)),r}function calculateTotalCost(e,t){let n=0;const a={};return Object.entries(e).forEach(([e,c])=>{if(c>0){const s=Math.ceil(c/VE_VALUES[e]),l=t[e]||0,r=s*l;n+=r,a[e]={quantity:c,packs:s,pricePerPack:l,itemTotal:r}}}),{totalCost:n,packDetails:a}}function calculateMultipleConfigs(e,t){const n=[];let a=0;const c={};e.forEach((e,s)=>{const l=calculateExtendedParts(e.selection,e.rows,e.cols,e.cellWidth,e.cellHeight,e.orientation,e.options),r=calculateTotalCost(l,t);Object.entries(l).forEach(([e,t])=>{c[e]=(c[e]||0)+t}),a+=r.totalCost,n.push({configIndex:s,configName:e.name,parts:l,...r})});const s=calculateTotalCost(c,t);return{individualResults:n,combined:{parts:c,...s},grandTotal:a}}function optimizeRailCombination(e){const t=[];for(let n=0;n<=Math.ceil(e/360)+1;n++){const a=e-360*n;if(a<=0)t.push({cnt360:n,cnt240:0,totalLength:360*n,waste:360*n-e,cost360:n,cost240:0});else{const c=Math.ceil(a/240);t.push({cnt360:n,cnt240:c,totalLength:360*n+240*c,waste:360*n+240*c-e,cost360:n,cost240:c})}}return t.sort((e,t)=>{const n=e.cost360+e.cost240,a=t.cost360+t.cost240;return n!==a?n-a:e.waste-t.waste}),t[0]}function calculateErdungsband(e,t,n,a,c,s){const l="vertical"===s?a:c,r=e.map(e=>[...e]);let o=0;for(let a=0;a<t;a++)for(let c=0;c<n;c++){o+=analyzeFieldForErdungsband(c,a,r,e,t,n,l,2)}return Math.ceil(o/600)}function analyzeFieldForErdungsband(e,t,n,a,c,s,l,r){return n[t]?.[e]?t+1>=c||!n[t+1]?.[e]?0:0!==e&&n[t]?.[e-1]?t+1>=c||!n[t+1]?.[e-1]?assignErdungsbandLength(e,t,n,l,r):checkLeftFieldsErdungsband(e,t,n,a,c,s,l,r):assignErdungsbandLength(e,t,n,l,r):0}function checkLeftFieldsErdungsband(e,t,n,a,c,s,l,r){const o=n[t]?.[e-1],i=n[t+1]?.[e-1];return o&&i?"erdungsband"===o&&"erdungsband"===i?0:"erdungsband"===o&&"erdungsband"!==i?assignErdungsbandLength(e,t,n,l,r):checkLeftFieldsRecursive(e,t,n,a,c,s,l,r):assignErdungsbandLength(e,t,n,l,r)}function checkLeftFieldsRecursive(e,t,n,a,c,s,l,r){let o=e-2;for(;o>=0;){if(!n[t]?.[o])return assignErdungsbandLength(e,t,n,l,r);if(t+1>=c||!n[t+1]?.[o])return assignErdungsbandLength(e,t,n,l,r);const a=n[t]?.[o],s=n[t+1]?.[o];if("erdungsband"===a&&"erdungsband"===s)return 0;if("erdungsband"===a&&"erdungsband"!==s)return assignErdungsbandLength(e,t,n,l,r);o--}return assignErdungsbandLength(e,t,n,l,r)}function assignErdungsbandLength(e,t,n,a,c){return"erdungsband"===n[t][e]?(n[t+1][e]="erdungsband",a+c):(n[t][e]="erdungsband",n[t+1][e]="erdungsband",2*a+c)}self.addEventListener("message",function(e){const{type:t,data:n,id:a}=e.data;try{let e;switch(t){case"calculateParts":e=calculateParts(n.selection,n.rows,n.cols,n.cellWidth,n.cellHeight,n.orientation);break;case"calculateExtendedParts":e=calculateExtendedParts(n.selection,n.rows,n.cols,n.cellWidth,n.cellHeight,n.orientation,n.options);break;case"calculateTotalCost":e=calculateTotalCost(n.parts,n.prices);break;case"calculateMultipleConfigs":e=calculateMultipleConfigs(n.configs,n.prices);break;case"optimizeRailCombination":e=optimizeRailCombination(n.totalLength);break;default:throw new Error(`Unknown calculation type: ${t}`)}self.postMessage({type:"result",id:a,data:e})}catch(e){self.postMessage({type:"error",id:a,error:{message:e.message,stack:e.stack}})}}),self.postMessage({type:"ready",message:"Calculation Worker bereit f√ºr Berechnungen"});