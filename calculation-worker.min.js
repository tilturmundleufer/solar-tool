const VE_VALUES={Endklemmen:100,Schrauben:100,Dachhaken:20,Mittelklemmen:100,Endkappen:50,Schienenverbinder:50,Schiene_240_cm:8,Schiene_360_cm:8,Solarmodul:1,UlicaSolarBlackJadeFlow:1,MC4_Stecker:1,Solarkabel:1,Holzunterleger:50,Erdungsklemme:1,Quetschkabelschuhe:100,Erdungsband:1,Tellerkopfschraube:100};function calculateParts(e,n,t,a,c,l,s={}){const r={Solarmodul:0,UlicaSolarBlackJadeFlow:0,Endklemmen:0,Mittelklemmen:0,Dachhaken:0,Schrauben:0,Endkappen:0,Schienenverbinder:0,Schiene_240_cm:0,Schiene_360_cm:0,Erdungsband:0};for(let o=0;o<n;o++){if(!Array.isArray(e[o]))continue;let n=0;for(let i=0;i<t;i++)e[o]?.[i]?n++:n&&(processGroup(n,r,a,c,l,s),n=0);n&&processGroup(n,r,a,c,l,s)}return s&&s.erdungsband&&(r.Erdungsband=calculateErdungsband(e,n,t,a,c,l)),r}function processGroup(e,n,t,a,c,l={}){const s=e*("vertical"===c?a:t),r=Math.floor(s/360),o=s-360*r,i=[{cnt360:r,cnt240:Math.ceil(o/240)},{cnt360:Math.ceil(s/360),cnt240:0},{cnt360:0,cnt240:Math.ceil(s/240)}].map(e=>({...e,rails:e.cnt360+e.cnt240,waste:360*e.cnt360+240*e.cnt240-s})),d=Math.min(...i.map(e=>e.rails)),u=i.filter(e=>e.rails===d).reduce((e,n)=>e.waste<=n.waste?e:n),{cnt360:g,cnt240:h}=u;n.Schiene_360_cm+=2*g,n.Schiene_240_cm+=2*h,n.Schienenverbinder+=4*(g+h-1),n.Endklemmen+=4,n.Mittelklemmen+=e>1?2*(e-1):0,n.Dachhaken+=e>1?3*e:4,n.Endkappen+=4,n.Solarmodul+=e,l&&l.ulicaModule&&(n.UlicaSolarBlackJadeFlow+=e);const b=e>1?3*e:4;n.Schrauben+=1*b,n.Tellerkopfschraube+=2*b}function calculateExtendedParts(e,n,t,a,c,l,s){let r=calculateParts(e,n,t,a,c,l,s);if(s.includeModules||delete r.Solarmodul,!0!==s.ulicaModule&&delete r.UlicaSolarBlackJadeFlow,s.mc4Connectors){const n=e.flat().filter(e=>e).length;r.MC4_Stecker=Math.ceil(n/30)}return s.solarkabel&&(r.Solarkabel=1),s.woodUnderlay&&(r.Holzunterleger=(r.Schiene_240_cm||0)+(r.Schiene_360_cm||0)),s.erdungsband&&(r.Erdungsband=calculateErdungsband(e,n,t,a,c,l)),r}function calculateTotalCost(e,n){let t=0;const a={};return Object.entries(e).forEach(([e,c])=>{if(c>0){const l=Math.ceil(c/VE_VALUES[e]),s=n[e]||0,r=l*s;t+=r,a[e]={quantity:c,packs:l,pricePerPack:s,itemTotal:r}}}),{totalCost:t,packDetails:a}}function calculateMultipleConfigs(e,n){const t=[];let a=0;const c={};e.forEach((e,l)=>{const s=calculateExtendedParts(e.selection,e.rows,e.cols,e.cellWidth,e.cellHeight,e.orientation,e.options),r=calculateTotalCost(s,n);Object.entries(s).forEach(([e,n])=>{c[e]=(c[e]||0)+n}),a+=r.totalCost,t.push({configIndex:l,configName:e.name,parts:s,...r})});const l=calculateTotalCost(c,n);return{individualResults:t,combined:{parts:c,...l},grandTotal:a}}function optimizeRailCombination(e){const n=[];for(let t=0;t<=Math.ceil(e/360)+1;t++){const a=e-360*t;if(a<=0)n.push({cnt360:t,cnt240:0,totalLength:360*t,waste:360*t-e,cost360:t,cost240:0});else{const c=Math.ceil(a/240);n.push({cnt360:t,cnt240:c,totalLength:360*t+240*c,waste:360*t+240*c-e,cost360:t,cost240:c})}}return n.sort((e,n)=>{const t=e.cost360+e.cost240,a=n.cost360+n.cost240;return t!==a?t-a:e.waste-n.waste}),n[0]}function calculateErdungsband(e,n,t,a,c,l){const s="vertical"===l?a:c,r=e.map(e=>[...e]);let o=0;for(let a=0;a<n;a++)for(let c=0;c<t;c++){o+=analyzeFieldForErdungsband(c,a,r,e,n,t,s,2)}return Math.ceil(o/600)}function analyzeFieldForErdungsband(e,n,t,a,c,l,s,r){return t[n]?.[e]?n+1>=c||!t[n+1]?.[e]?0:0!==e&&t[n]?.[e-1]?n+1>=c||!t[n+1]?.[e-1]?assignErdungsbandLength(e,n,t,s,r):checkLeftFieldsErdungsband(e,n,t,a,c,l,s,r):assignErdungsbandLength(e,n,t,s,r):0}function checkLeftFieldsErdungsband(e,n,t,a,c,l,s,r){const o=t[n]?.[e-1],i=t[n+1]?.[e-1];return o&&i?"erdungsband"===o&&"erdungsband"===i?0:"erdungsband"===o&&"erdungsband"!==i?assignErdungsbandLength(e,n,t,s,r):checkLeftFieldsRecursive(e,n,t,a,c,l,s,r):assignErdungsbandLength(e,n,t,s,r)}function checkLeftFieldsRecursive(e,n,t,a,c,l,s,r){let o=e-2;for(;o>=0;){if(!t[n]?.[o])return assignErdungsbandLength(e,n,t,s,r);if(n+1>=c||!t[n+1]?.[o])return assignErdungsbandLength(e,n,t,s,r);const a=t[n]?.[o],l=t[n+1]?.[o];if("erdungsband"===a&&"erdungsband"===l)return 0;if("erdungsband"===a&&"erdungsband"!==l)return assignErdungsbandLength(e,n,t,s,r);o--}return assignErdungsbandLength(e,n,t,s,r)}function assignErdungsbandLength(e,n,t,a,c){return"erdungsband"===t[n][e]?(t[n+1][e]="erdungsband",a+c):(t[n][e]="erdungsband",t[n+1][e]="erdungsband",2*a+c)}self.addEventListener("message",function(e){const{type:n,data:t,id:a}=e.data;try{let e;switch(n){case"calculateParts":e=calculateParts(t.selection,t.rows,t.cols,t.cellWidth,t.cellHeight,t.orientation);break;case"calculateExtendedParts":e=calculateExtendedParts(t.selection,t.rows,t.cols,t.cellWidth,t.cellHeight,t.orientation,t.options);break;case"calculateTotalCost":e=calculateTotalCost(t.parts,t.prices);break;case"calculateMultipleConfigs":e=calculateMultipleConfigs(t.configs,t.prices);break;case"optimizeRailCombination":e=optimizeRailCombination(t.totalLength);break;default:throw new Error(`Unknown calculation type: ${n}`)}self.postMessage({type:"result",id:a,data:e}),"calculateMultipleConfigs"!==n&&"optimizeRailCombination"!==n||"object"==typeof e&&null!==e&&Object.keys(e).forEach(n=>{Array.isArray(e[n])&&e[n].length>1e3&&(e[n]=null)})}catch(e){self.postMessage({type:"error",id:a,error:{message:e.message,stack:e.stack}})}}),self.postMessage({type:"ready",message:"Calculation Worker bereit f√ºr Berechnungen"});